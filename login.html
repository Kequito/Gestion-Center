<!DOCTYPE html>
<html lang="es" data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gestión Center — Acceso</title>

    <!-- Página pública: permitir ver sin sesión -->
    <script>window.GC_PUBLIC_PAGE = true;</script>

    <!-- Ocultar hasta que shell/guard habiliten -->
    <style>html{visibility:hidden}</style>

    <script type="module">
      // ===== Loader robusto para shell + guard (con BASE de GitHub Pages o dominio propio)
      const isGh  = location.hostname.endsWith('github.io');
      const parts = location.pathname.split('/').filter(Boolean);
      const repo  = isGh ? (parts[0] || '') : '';
      const BASE  = (isGh ? `/${repo}/` : '/');

      // Exponer BASE al ecosistema por si alguien lo necesita
      window.__GC_BASE__ = location.origin + BASE;

      // Helper para rutas absolutas seguras
      const abs = (p) => new URL(p.replace(/^\//, ''), window.__GC_BASE__).href;

      // Failsafe: si nada revela la página, muéstrala igual
      const watchdog = setTimeout(() => {
        if (getComputedStyle(document.documentElement).visibility === 'hidden') {
          document.documentElement.style.visibility = 'visible';
          console.warn('[login] failsafe: html visible por watchdog');
        }
      }, 2500);

      // Cargar shell y guard en paralelo (si uno falla, el otro puede revelar)
      try {
        await Promise.all([
          import(abs('assets/bw/shell.js')),
          import(abs('assets/guard.js')).catch(e => {
            console.warn('[login] guard.js no cargó, continuo solo con shell:', e);
          })
        ]);
      } catch (e) {
        console.error('[login] error cargando shell/guard:', e);
      } finally {
        clearTimeout(watchdog);
        // Si shell/guard no revelaron todavía, revelar aquí
        if (getComputedStyle(document.documentElement).visibility === 'hidden') {
          document.documentElement.style.visibility = 'visible';
        }
      }
    </script>

    <!-- Estilos locales del card (usa tokens del ecosistema) -->
    <style>
      :root{
        --radius:16px; --radius-sm:12px; --radius-xs:10px;
        --font-title:'Outfit', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        --font-body:'Lexend', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        --t-fast:.15s; --t-med:.25s; --t-slow:.6s; --curve:cubic-bezier(.2,.7,.2,1);
        --elev-1:0 6px 20px rgba(0,0,0,.25);
      }
      [data-theme="dark"]{
        --bg-app:#070b1a;
        --bg-card:linear-gradient(160deg, rgba(17,24,49,.88), rgba(17,24,49,.7));
        --txt:#e9f1ff; --txt-muted:#b8c6de; --stroke:rgba(255,255,255,.10);
        --primary:#5b8bff; --accent:#7ae3ff;
      }
      /* Fondo cuadriculado sutil (opcional) */
      #bg-grid{
        position:fixed; inset:0; z-index:-1; opacity:.07; pointer-events:none;
        background:
          linear-gradient(color-mix(in oklab, var(--txt) 9%, transparent) 1px, transparent 1px) 0 0 / 28px 28px,
          linear-gradient(90deg, color-mix(in oklab, var(--txt) 9%, transparent) 1px, transparent 1px) 0 0 / 28px 28px;
      }

      /* ====== LOGIN CARD ====== */
      .login-wrap{ min-height:70dvh; display:grid; place-items:center; }
      .login-card{
        width:100%; max-width:520px;
        background:var(--bg-card); border:1px solid var(--stroke);
        border-radius:22px; padding:28px; box-shadow:var(--elev-1);
      }
      .login-card h2{ margin:0 0 10px; font:700 24px/1.1 var(--font-title) }
      .login-card p{ margin:0 0 18px; color:var(--txt-muted) }

      .stack{display:flex; flex-direction:column; gap:14px;}
      .field{display:flex; flex-direction:column; gap:8px;}
      label{color:#cbd5e1; font-size:14px; letter-spacing:.2px}
      input{
        width:100%; height:48px; padding:12px 14px; border-radius:12px;
        border:1px solid #314057; background:#0b1220; color:var(--txt);
        outline:none; transition:border-color .15s ease, box-shadow .15s ease;
      }
      input::placeholder{color:#6b7b93}
      input:focus{
        border-color:color-mix(in oklab, var(--accent) 70%, white);
        box-shadow:0 0 0 3px color-mix(in oklab, var(--accent) 22%, transparent);
      }

      .actions{display:flex; flex-direction:column; gap:12px; margin-top:6px;}
      .btn{
        width:100%; height:48px; border-radius:14px; border:0; cursor:pointer;
        font-weight:700; letter-spacing:.2px; display:inline-flex; align-items:center; justify-content:center; gap:10px;
        transition:transform .12s ease, filter .15s ease, opacity .15s ease;
      }
      .btn:active{ transform:translateY(1px) }
      .btn.primary{
        color:#0b1022;
        background:linear-gradient(180deg, var(--accent), color-mix(in oklab, var(--accent) 55%, white));
        border:1px solid color-mix(in oklab, var(--accent) 60%, white);
      }
      .btn.primary:hover{ filter:brightness(1.03) }
      .btn.ghost{ color:#e5e7eb; background:#0b1220; border:1px solid #334155; }
      .btn.ghost:hover{ filter:brightness(1.05) }
      .btn[disabled]{opacity:.65; cursor:not-allowed}

      .meta{ display:flex; justify-content:space-between; gap:14px; margin-top:8px; flex-wrap:wrap; }
      .link{color:#93c5fd; cursor:pointer; text-decoration:none}
      .link:hover{text-decoration:underline}

      .msg{margin-top:10px;font-size:14px}
      .msg.err{color:#f87171}
      .msg.ok{color:#22c55e}

      .showpass{
        position:absolute; right:10px; top:50%; transform:translateY(-50%);
        font-size:12px; color:#93c5fd; cursor:pointer; user-select:none;
      }

      @media (prefers-reduced-motion:no-preference){
        .reveal{opacity:0; transform:translateY(8px); will-change:transform,opacity; transition:opacity var(--t-slow) ease, transform var(--t-slow) ease}
        .reveal.show{opacity:1; transform:none}
      }
      .spinner{width:16px;height:16px;border-radius:999px;border:2px solid #0b1022;border-top-color:transparent;animation:spin .8s linear infinite}
      .btn.ghost .spinner{border-color:#e5e7eb;border-top-color:transparent}
      @keyframes spin{to{transform:rotate(360deg)}}
    </style>
  </head>
  <body>
    <div id="bg-grid" aria-hidden="true"></div>

    <!-- Login sin sidebar ni hero -->
    <gc-shell no-aside hero="off">
      <!-- OJO: NO usamos <main> aquí; el shell inyecta su propio <main> -->
      <section class="login-wrap">
        <article class="login-card reveal">
          <h2>Inicia sesión</h2>
          <p>Usa tu cuenta corporativa o Google.</p>

          <form id="form" onsubmit="return false;" class="stack">
            <div class="field">
              <label for="email">Email</label>
              <input id="email" type="email" placeholder="tucorreo@empresa.com" autocomplete="username" required/>
            </div>

            <div class="field" style="position:relative">
              <label for="pass">Contraseña</label>
              <input id="pass" type="password" placeholder="••••••••" autocomplete="current-password" minlength="6" required/>
              <span id="togglePass" class="showpass">mostrar</span>
            </div>

            <div class="actions">
              <button id="btnEmail" class="btn primary" onclick="loginEmail()">
                <span>Entrar con Email</span>
              </button>

              <button id="btnGoogle" type="button" class="btn ghost" onclick="loginGoogle()">
                <span>Entrar con Google</span>
              </button>
            </div>

            <div class="meta">
              <a class="link" onclick="signUp()">Crear cuenta (prueba)</a>
              <a class="link" onclick="resetPass()">¿Olvidaste tu contraseña?</a>
            </div>

            <div id="msg" class="msg" role="alert" aria-live="polite"></div>
          </form>
        </article>
      </section>
    </gc-shell>

    <!-- Reveal + mostrar/ocultar contraseña -->
    <script type="module">
      const reduced = matchMedia('(prefers-reduced-motion: reduce)').matches;
      if(!reduced && 'IntersectionObserver' in window){
        const io = new IntersectionObserver((entries)=>{
          for(const e of entries){ if(e.isIntersecting){ e.target.classList.add('show'); io.unobserve(e.target); } }
        }, {threshold:.12, rootMargin:'0px 0px -10% 0px'});
        document.querySelectorAll('.reveal').forEach(el=>io.observe(el));
      } else {
        document.querySelectorAll('.reveal').forEach(el=>el.classList.add('show'));
      }
      const pass = document.getElementById('pass');
      const tgl  = document.getElementById('togglePass');
      tgl?.addEventListener('click', ()=>{
        const was = pass.type === 'password';
        pass.type = was ? 'text' : 'password';
        tgl.textContent = was ? 'ocultar' : 'mostrar';
        pass.focus();
      });
    </script>

    <!-- ====== AUTH (Firebase) ====== -->
    <script type="module">
      import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getAuth, onAuthStateChanged, signInWithEmailAndPassword,
        createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup,
        signOut, setPersistence, browserLocalPersistence, sendPasswordResetEmail
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCHBsq9AdVZEMVryQWReX7oaPparo9lK8M",
        authDomain: "gestioncenterdata.firebaseapp.com",
        projectId: "gestioncenterdata",
        storageBucket: "gestioncenterdata.firebasestorage.app",
        messagingSenderId: "628401314464",
        appId: "1:628401314464:web:0671233dfd801ee43587c5",
        measurementId: "G-NBFZYTN094"
      };

      const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db   = getFirestore(app);
      try { await setPersistence(auth, browserLocalPersistence); } catch(e) {}

      const $ = (id)=>document.getElementById(id);
      const msgEl = $("msg");
      const btnEmail  = $("btnEmail");
      const btnGoogle = $("btnGoogle");
      const form = $("form");

      // Foco inicial en email
      document.getElementById('email')?.focus();

      function setLoading(el, loading=true){
        if(!el) return;
        if(loading){
          el.setAttribute("disabled","true");
          if(!el.querySelector(".spinner")){
            const sp = document.createElement("span");
            sp.className = "spinner";
            el.prepend(sp);
          }
        }else{
          el.removeAttribute("disabled");
          el.querySelector(".spinner")?.remove();
        }
      }
      function showMsg(text, type="err"){
        msgEl.textContent = text || "";
        msgEl.className = "msg " + (type === "ok" ? "ok" : "err");
      }

      async function ensureUserDoc(user){
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);
        if(!snap.exists()){
          await setDoc(ref, {
            email: user.email || null,
            displayName: user.displayName || "",
            createdAt: serverTimestamp(),
            perop: "", teamId: ""
          });
        }
      }

      const ERR_MAP = {
        "auth/invalid-email": "El email no es válido.",
        "auth/missing-password": "Ingresa tu contraseña.",
        "auth/invalid-credential": "Credenciales inválidas.",
        "auth/user-disabled": "Tu usuario está deshabilitado.",
        "auth/user-not-found": "No existe una cuenta con ese email.",
        "auth/wrong-password": "Contraseña incorrecta.",
        "auth/popup-closed-by-user": "Se cerró la ventana de Google.",
        "auth/too-many-requests": "Demasiados intentos. Intenta más tarde.",
        "auth/email-already-in-use": "Ese email ya está registrado.",
        "auth/weak-password": "La contraseña es muy débil (mín. 6).",
        "auth/network-request-failed": "Problemas de red. Revisa tu conexión.",
        "auth/popup-blocked": "El navegador bloqueó la ventana de Google."
      };
      const mapError = (e)=>ERR_MAP[e?.code] || e?.message || "Ocurrió un error. Intenta de nuevo.";

      // Gate anti-doble submit
      let _busy = false;
      const gate = (fn) => { if(_busy) return; _busy = true; return Promise.resolve(fn()).finally(()=>{_busy=false;}); };

      async function loginEmailImpl(){
        showMsg("");
        const email = $("email").value.trim().toLowerCase();
        const pass  = $("pass").value.trim();
        if(!email || !pass) { showMsg("Completa email y contraseña."); return; }
        setLoading(btnEmail, true);
        try{
          const { user } = await signInWithEmailAndPassword(auth, email, pass);
          await ensureUserDoc(user);
          goHome();
        }catch(e){ showMsg(mapError(e)); }
        finally{ setLoading(btnEmail, false); }
      }
      async function loginGoogleImpl(){
        showMsg("");
        setLoading(btnGoogle, true);
        try{
          const provider = new GoogleAuthProvider();
          const { user } = await signInWithPopup(auth, provider);
          await ensureUserDoc(user);
          goHome();
        }catch(e){ showMsg(mapError(e)); }
        finally{ setLoading(btnGoogle, false); }
      }
      async function signUpImpl(){
        showMsg("");
        const email = $("email").value.trim().toLowerCase();
        const pass  = $("pass").value.trim();
        if(!email || !pass) { showMsg("Completa email y contraseña."); return; }
        setLoading(btnEmail, true);
        try{
          const { user } = await createUserWithEmailAndPassword(auth, email, pass);
          await ensureUserDoc(user);
          showMsg("Cuenta creada. Redirigiendo…", "ok");
          goHome();
        }catch(e){ showMsg(mapError(e)); }
        finally{ setLoading(btnEmail, false); }
      }
      async function resetPassImpl(){
        showMsg("");
        const email = $("email").value.trim().toLowerCase();
        if(!email){ showMsg("Ingresa tu email para enviar el enlace de recuperación."); return; }
        setLoading(btnEmail, true);
        try{
          await sendPasswordResetEmail(auth, email);
          showMsg("Te enviamos un enlace para restablecer la contraseña.", "ok");
        }catch(e){ showMsg(mapError(e)); }
        finally{ setLoading(btnEmail, false); }
      }

      // Exponer con gate
      window.loginEmail  = ()=> gate(loginEmailImpl);
      window.loginGoogle = ()=> gate(loginGoogleImpl);
      window.signUp      = ()=> gate(signUpImpl);
      window.resetPass   = ()=> gate(resetPassImpl);

      // Submit con Enter
      form.addEventListener("keydown",(ev)=>{
        if(ev.key==="Enter"){ ev.preventDefault(); window.loginEmail(); }
      });

      // ===== Navegación segura hacia Home (usa BASE del shell si existe) =====
      const PREFERRED_REPO = "Gestion-Center";
      function isValidAbsoluteBase(u){
        try{ const url = new URL(u); return url.origin===location.origin && !/\.html($|\/)/i.test(url.pathname);}
        catch{ return false;}
      }
      function computeBase(){
        if (isValidAbsoluteBase(window.__GC_BASE__)) return window.__GC_BASE__.endsWith('/')?window.__GC_BASE__:window.__GC_BASE__+'/';
        const host = location.hostname, segs = location.pathname.split('/').filter(Boolean);
        if (host.endsWith('github.io')){
          const first = segs[0] || "";
          if (first && !/\.html?$/i.test(first)) return `${location.origin}/${first}/`;
          return `${location.origin}/${PREFERRED_REPO}/`;
        }
        return `${location.origin}/`;
      }
      function defaultHome(){ return computeBase(); }
      function sanitizeTarget(to){
        if(!to) return defaultHome();
        let dest; try{ dest = new URL(to, location.origin); }catch{return defaultHome();}
        if(dest.origin !== location.origin) return defaultHome();
        const baseUrl = new URL(defaultHome());
        const basePath = baseUrl.pathname.endsWith('/') ? baseUrl.pathname : (baseUrl.pathname + '/');
        if(!dest.pathname.startsWith(basePath)) return defaultHome();
        return dest.href;
      }
      function goHome(){
        const stored = localStorage.getItem("redirectAfterLogin");
        const qTo = new URLSearchParams(location.search).get("to");
        const dest = sanitizeTarget(stored || qTo || defaultHome());
        try { localStorage.removeItem("redirectAfterLogin"); } catch {}
        location.replace(dest);
      }

      // Ya logueado → home
      onAuthStateChanged(auth, (user)=>{ if(user){ goHome(); } });
      // debug
      window._logout = ()=>signOut(auth);
    </script>
  </body>
</html>

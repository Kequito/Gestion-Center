<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GestiÃ³n Center â€“ Plan de trabajo</title>
  <link href="https://fonts.googleapis.com/css2?family=Lexend&display=swap" rel="stylesheet">
  <style>
    /* ===== Tema base ===== */
    :root{
      --bg-app:#1c2a45; --bg-aside:#152035; --txt:#ffffff; --txt-muted:#cfd8dc; --hover:#1c2a45;
      --primary-color:#0D47A1; --accent-color:#42a5f5; --surface:#22314f; --border:#2f446a; --header-bg:#0d47a1;
      --green:#2e7d32; --red:#c62828; --orange:#f57c00; --yellow:#fbc02d; --chip:#1b2a48;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:'Lexend',sans-serif; background:var(--bg-app); color:var(--txt); display:flex; min-height:100vh; }

    /* ===== Sidebar ===== */
    aside{ background:var(--bg-aside); width:220px; height:100vh; padding:40px 20px; display:flex; flex-direction:column; position:fixed; left:0; top:0; }
    .logo{ font-size:22px; font-weight:700; margin-bottom:32px; text-align:center; line-height:1.2; }
    nav a{ color:var(--txt); margin:14px 0; text-decoration:none; font-size:15px; padding:10px 12px; border-radius:8px; transition:background-color .25s,transform .05s; display:flex; align-items:flex-start; gap:10px; width:100%; white-space:normal; line-height:1.2; overflow-wrap:anywhere; word-break:break-word; }
    nav a:hover{ background:var(--hover); }
    nav a.active{ background:var(--hover); box-shadow:inset 0 0 0 1px rgba(255,255,255,.12); }
    .spacer{ flex:1; }

    /* ===== Main ===== */
    main{ margin-left:220px; padding:28px; width:calc(100% - 220px); }
    .page-title{ display:flex; align-items:center; gap:12px; font-size:24px; font-weight:700; margin:0 0 4px; }
    .subtitle{ margin:0 0 10px; color:var(--txt-muted); font-size:14px; display:flex; align-items:center; gap:10px; }
    .datetime{ font-size:14px; font-weight:600; margin:6px 0 16px; opacity:.9; }

    /* ===== KPIs ===== */
    .kpis{ display:grid; grid-template-columns:repeat(4,minmax(160px,1fr)); gap:10px; margin:12px 0 8px; }
    .kpi{ background:rgba(255,255,255,.05); border:1px solid var(--border); border-radius:12px; padding:10px 12px; }
    .kpi .label{ font-size:12px; color:var(--txt-muted); }
    .kpi .value{ font-size:18px; font-weight:800; margin-top:4px; }

    /* ===== Topbar ===== */
    .topbar{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin:8px 0 16px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; background:rgba(255,255,255,.04); border:1px solid var(--border); border-radius:999px; padding:8px 12px; font-size:14px; }
    .select{ background:var(--surface); color:var(--txt); border:1px solid var(--primary-color); border-radius:10px; padding:8px 12px; height:38px; }
    button{ padding:10px 14px; font-size:14px; cursor:pointer; border:none; border-radius:10px; background:var(--primary-color); color:#fff; box-shadow:0 2px 6px rgba(0,0,0,.25); transition:background .2s,transform .03s; }
    button:hover{ background:var(--accent-color); }
    button:active{ transform:translateY(1px); }

    /* ===== Progreso ===== */
    .progress{ flex:1; min-width:240px; background:rgba(255,255,255,.06); border:1px solid var(--border); border-radius:999px; height:12px; overflow:hidden; position:relative; }
    .progress>span{ display:block; height:100%; width:0%; transition:width .35s ease, background .25s; }
    .progress-label{ font-size:12px; color:var(--txt-muted); min-width:140px; text-align:right; }

    /* ===== Secciones ===== */
    .section{ background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:16px; margin:14px 0; box-shadow:0 4px 10px rgba(0,0,0,.18); }
    .section-header{ display:flex; align-items:center; gap:10px; cursor:pointer; user-select:none; }
    .section-header h2{ font-size:18px; margin:0; }
    .section-header .time{ color:var(--txt-muted); font-size:13px; margin-left:auto; }
    .section.collapsed .section-body{ display:none; }

    /* ===== Tareas ===== */
    .task{ display:grid; grid-template-columns:28px 1fr 240px; gap:12px; align-items:start; padding:12px; border:1px solid var(--border); border-radius:12px; background:rgba(0,0,0,.12); margin:10px 0; }
    .task:hover{ background:rgba(0,0,0,.16); }
    .task.done{ background:rgba(46,125,50,.22); border-color:#2e7d3270; }
    .task .chk{ width:18px; height:18px; margin-top:2px; }
    .task .title{ font-weight:700; display:flex; align-items:center; gap:8px; }
    .status-dot{ width:10px; height:10px; border-radius:999px; display:inline-block; box-shadow:0 0 0 2px rgba(0,0,0,.2) inset; }
    .status-pending{ background:#fbc02d; }
    .status-done{ background:#2e7d32; }
    .task .desc{ color:var(--txt-muted); font-size:13px; margin-top:3px; }
    .task .meta{ font-size:12px; color:#cfe3ff; }
    .task .tools{ display:flex; gap:8px; align-items:center; justify-content:flex-end; }
    .chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:var(--chip); white-space:nowrap; }

    /* ===== Tooltip ===== */
    .tip-btn{ background:transparent; border:1px solid var(--border); color:#fff; border-radius:8px; padding:4px 8px; font-size:12px; cursor:pointer; }
    .tip{ display:none; margin-top:8px; background:rgba(0,0,0,.25); border:1px solid var(--border); border-radius:10px; padding:8px 10px; font-size:12px; color:#e4f1ff; }
    .tip.visible{ display:block; }

    /* ===== PDF Viewer ===== */
    .pdf{ width:100%; height:560px; border:none; }

    /* ===== Toast ===== */
    #toast{ position:fixed; bottom:18px; right:20px; background:#222; color:#fff; padding:12px 18px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,.35); display:none; z-index:1000; }

    /* ===== Modal HistÃ³rico ===== */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:1100; }
    .modal{ background:#1f2f50; border:1px solid var(--border); width:min(720px,92vw); border-radius:14px; padding:16px; }
    .modal h3{ margin:0 0 8px; }
    .log-list{ max-height:50vh; overflow:auto; display:grid; gap:8px; }
    .log-item{ background:rgba(255,255,255,.05); border:1px solid var(--border); border-radius:10px; padding:8px 10px; }
    .log-meta{ color:#cfd8dc; font-size:12px; }
  </style>
</head>
<body>
  <!-- ===== Sidebar ===== -->
  <aside>
    <div class="logo">ğŸ§­ GestiÃ³n Center</div>
    <nav>
      <a href="index.html">ğŸ  Inicio</a>
      <a class="active" href="plandetrabajo.html">âœ… Plan de trabajo</a>
      <a href="distribucion.html">ğŸ“‹ DistribuciÃ³n</a>
      <a href="estadisticas.html">ğŸ“ˆ EstadÃ­sticas</a>
      <a href="cobertura.html">ğŸŒ Cobertura</a>
      <a href="camprev.html">ğŸ‘¥ Selector de Apoyo Ver 2.0</a>
      <a href="postsale.html">ğŸšš Post-Sale New Report </a>
      <a href="opo11.html">ğŸ§° New Report CC PerÃº</a>
      <a href="#contacto">ğŸ“¬ Contacto</a>
    </nav>
    <div class="spacer"></div>
  </aside>

  <!-- ===== Main ===== -->
  <main>
    <h1 class="page-title">âœ… Plan de Trabajo â€“ Team Leaders</h1>
    <p class="subtitle">Basado en la versiÃ³n vigente Â· Turno AM/PM equivalente Â· ayudas didÃ¡cticas y progreso con recordatorios</p>
    <div id="fechaHora" class="datetime"></div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="kpi"><div class="label">Tareas con horario</div><div class="value" id="kpiTimed">0 / 0</div></div>
      <div class="kpi"><div class="label">% Avance</div><div class="value" id="kpiPct">0%</div></div>
      <div class="kpi"><div class="label">Turno seleccionado</div><div class="value" id="kpiShift">AM</div></div>
      <div class="kpi"><div class="label">Tiempo restante del turno</div><div class="value" id="kpiTimeLeft">--:--</div></div>
    </div>

    <div class="topbar">
      <div class="pill">
        <strong>Turno:</strong>
        <select id="selTurno" class="select">
          <option value="AM">AM (7:00â€“4:00)</option>
          <option value="PM">PM (1:00â€“10:00)</option>
        </select>
      </div>
      <button id="btnResetDay">ğŸ§¹ Reset del dÃ­a</button>
      <button id="btnClearAll">ğŸ—‘ï¸ Borrar guardado</button>
      <button id="btnLog">ğŸ“œ Ver HistÃ³rico del DÃ­a</button>
      <div class="progress" title="Avance de tareas con horario"><span id="progBar"></span></div>
      <div class="progress-label" id="progLabel">0% completado</div>
    </div>

    <!-- Secciones renderizadas por JS -->
    <div id="sections"></div>

    <h2 style="margin-top:24px; font-size:18px; color:#cfd8dc;">ğŸ“„ Plan de trabajo completo (PDF)</h2>
    <!-- Embed robusto con fallback -->
    <div style="border-radius:12px; overflow:hidden; box-shadow:0 6px 12px rgba(0,0,0,.25); border:1px solid var(--border);">
      <object data="Plan_de_trabajo_TEAM_LEADER.pdf#view=FitH" type="application/pdf" class="pdf">
        <div style="padding:16px">
          <p>No se pudo cargar el PDF desde <code>Plan_de_trabajo_TEAM_LEADER.pdf</code>.</p>
          <p>
            âœ Ver/descargar:
            <a href="Plan_de_trabajo_TEAM_LEADER.pdf" target="_blank" style="color:#80d6ff; text-decoration:underline;">
              abrir en nueva pestaÃ±a
            </a>
          </p>
          <small style="color:#cfd8dc">
            Sugerencia: asegÃºrate de que el archivo estÃ© en la misma carpeta que <code>plandetrabajo.html</code>
            y que el nombre coincida exactamente (mayÃºsculas y guiones bajos).
          </small>
        </div>
      </object>
    </div>
  </main>

  <div id="toast"></div>

  <!-- Modal HistÃ³rico -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <h3>ğŸ“œ HistÃ³rico del DÃ­a</h3>
        <div style="display:flex; gap:8px;">
          <button id="btnExportLog" class="tip-btn">â¬‡ï¸ Exportar .txt</button>
          <button id="btnCloseModal" class="tip-btn">âœ–ï¸ Cerrar</button>
        </div>
      </div>
      <p class="subtitle" id="logDate"></p>
      <div id="logList" class="log-list"></div>
    </div>
  </div>

  <script>
    /* ===== Utilidades ===== */
    const STORAGE_KEY='plan_vigente_v4';
    const LOG_KEY_PREFIX='plan_log_';
    const toast=(m)=>{const t=document.getElementById('toast');t.textContent=m;t.style.display='block';setTimeout(()=>{t.style.opacity=0;},2600);setTimeout(()=>{t.style.display='none';t.style.opacity=1;},3200);};
    const pad=n=>String(n).padStart(2,'0');
    const todayStr=()=>{const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`};
    function actualizarFechaHora(){ const ahora=new Date(); const fecha=ahora.toLocaleDateString('es-PE',{weekday:'long',year:'numeric',month:'long',day:'numeric'}); const hora=ahora.toLocaleTimeString('es-PE',{hour:'2-digit',minute:'2-digit',second:'2-digit'}); document.getElementById('fechaHora').textContent=`ğŸ“… ${fecha} â€“ ğŸ•’ ${hora}`; }
    actualizarFechaHora(); setInterval(actualizarFechaHora,1000);

    /* ===== Plan (sin notas y con dos tareas eliminadas) ===== */
    const PLAN = {
      blocks:[
        { id:'primera', title:'ğŸ“Œ Primera hora de gestiÃ³n', time:{AM:'7:00â€“8:00',PM:'1:00â€“2:00'}, tasks:[
          {id:'1.1', title:'Good Day (Registro de Asistencia)', desc:'Registrar asistencia oficial de todos los operadores.', tip:`Status permitidos: A, B, VA, OFF, Fa, FJ, Fe, NL, DLT, DM, S, LF, LM.`},
        ]},
        { id:'segunda', title:'ğŸ“Œ Segunda hora de gestiÃ³n', time:{AM:'8:00â€“9:00',PM:'2:00â€“3:00'}, tasks:[
          {id:'1.2', title:'Planilla (Registro de Horas del DÃ­a Anterior)', desc:'Completar planilla con base en BI-844.', tip:`Reglas de redondeo: >45 min â†’ 1h; desde 4:45h sumar 1h por break.`},
          {id:'1.3', title:'Control de Asistencia Diaria (Tiempo Incompleto)', desc:'Documento diario para quienes no completaron su jornada.', tip:`Verificar PEROP1AMs, identificar operadores, motivo del tiempo incompleto.`},
        ]},
        { id:'tercera', title:'ğŸ“Œ Tercera hora de gestiÃ³n', time:{AM:'9:00â€“10:00',PM:'3:00â€“4:00'}, tasks:[
          {id:'1.4', title:'Horas Rusia', desc:'Carga de conexiÃ³n, llamadas y SAVE con base en BI-844 (dÃ­a anterior).', tip:`Se realiza con informaciÃ³n del dÃ­a anterior.`},
          {id:'1.5', title:'ProgramaciÃ³n (BI-247)', desc:'Asegurar programaciÃ³n correcta y coherencia de horarios.', tip:`1) Nadie gestionando sin programar. 2) Ausentes se desprograman. 3) Coherencia horario oficial/real.`},
        ]},
        { id:'ultima', title:'ğŸ“Œ Ãšltima hora de gestiÃ³n', time:{AM:'3:00â€“4:00',PM:'9:00â€“10:00'}, tasks:[
          {id:'1.6', title:'VerificaciÃ³n de Recalls (BI-82 y BI-91)', desc:'Todo recall con informaciÃ³n se gestiona el mismo dÃ­a.', tip:`Objetivo: cierre limpio de jornada.`},
        ]},
      ],
      continuous:[
        // Eliminadas: Leads Daily y Ã“rdenes con mala publicidad
        {id:'c.2', title:'VerificaciÃ³n de estadÃ­sticas de campaÃ±as', desc:'Monitoreo de leads, conectados, ACD, ventas, SAVE, etc.'},
      ],
      policy:[
        '1) Primer incumplimiento: recordatorio inmediato.',
        '2) Segundo incumplimiento: llamado de atenciÃ³n formal.',
        '3) Reincidencia: informe a RRHH para evaluaciÃ³n.'
      ]
    };

    /* ===== Persistencia ===== */
    function loadState(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY))||{} }catch{ return {} } }
    function saveState(state){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    function defaultState(){
      const st={ shift:'AM', tasks:{}, collapsed:{}, lastReminder:'' };
      PLAN.blocks.forEach(b=>b.tasks.forEach(t=>{ st.tasks[t.id]=false; }));
      PLAN.continuous.forEach(t=>{ st.tasks[t.id]=false; });
      return st;
    }
    let state = Object.assign(defaultState(), loadState());

    /* ===== HistÃ³rico ===== */
    function getLog(dateStr=todayStr()){
      try{ return JSON.parse(localStorage.getItem(LOG_KEY_PREFIX+dateStr)) || [] }catch{ return [] }
    }
    function pushLog(entry, dateStr=todayStr()){
      const arr=getLog(dateStr);
      arr.push(entry);
      localStorage.setItem(LOG_KEY_PREFIX+dateStr, JSON.stringify(arr));
    }

    /* ===== Render ===== */
    const sectionsEl = document.getElementById('sections');

    function render(){
      document.getElementById('selTurno').value = state.shift;
      sectionsEl.innerHTML='';

      // Bloques con horario
      PLAN.blocks.forEach(block=>{
        const sec=document.createElement('section'); sec.className='section';
        if(state.collapsed[block.id]) sec.classList.add('collapsed');

        const head=document.createElement('div'); head.className='section-header';
        head.innerHTML=`<h2>${block.title}</h2><div class="time">${state.shift} Â· ${block.time[state.shift]}</div>`;
        head.addEventListener('click',()=>{ state.collapsed[block.id]=!state.collapsed[block.id]; saveState(state); render(); });

        const body=document.createElement('div'); body.className='section-body';

        block.tasks.forEach(task=>{
          const done=!!state.tasks[task.id];
          const el=document.createElement('div'); el.className='task'+(done?' done':'');

          el.innerHTML=`
            <input class="chk" id="chk-${task.id}" type="checkbox" ${done?'checked':''}>
            <div>
              <div class="title">
                <span class="status-dot ${done?'status-done':'status-pending'}"></span>
                ${task.id} Â· ${task.title}
                <button class="tip-btn" data-tip="tip-${task.id}" title="Ver tip">â„¹ï¸</button>
              </div>
              <div class="desc">${task.desc||''}</div>
              <div class="meta">${state.shift} Â· ${block.time[state.shift]}</div>
              <div id="tip-${task.id}" class="tip">${task.tip?task.tip:''}</div>
            </div>
            <div class="tools">
              <span class="chip">â±ï¸ Bloque</span>
              <span class="chip">ğŸ’¾ Auto-guardado</span>
            </div>`;

          el.querySelector('.chk').addEventListener('change',ev=>{
            const checked=ev.target.checked;
            state.tasks[task.id]=checked; saveState(state);
            el.classList.toggle('done',checked);
            el.querySelector('.status-dot').className = 'status-dot ' + (checked?'status-done':'status-pending');
            updateProgress();
            const now=new Date();
            pushLog({ts:now.toISOString(), task:task.id, title:task.title, action:checked?'Completada':'Pendiente', block:block.id, time:block.time[state.shift], shift:state.shift});
            toast(checked?'âœ… Tarea completada':'â†©ï¸ Tarea pendiente');
            updateKPIs();
          });

          el.querySelector('.tip-btn').addEventListener('click',ev=>{
            ev.preventDefault();
            const id=ev.currentTarget.dataset.tip;
            const tip=document.getElementById(id);
            tip.classList.toggle('visible');
          });

          body.appendChild(el);
        });

        sec.appendChild(head); sec.appendChild(body);
        sectionsEl.appendChild(sec);
      });

      // Tareas continuas (solo 1)
      const secC=document.createElement('section'); secC.className='section';
      if(state.collapsed['continuas']) secC.classList.add('collapsed');
      const headC=document.createElement('div'); headC.className='section-header';
      headC.innerHTML=`<h2>ğŸ” Tareas de actualizaciÃ³n continua</h2><div class="time">Todo el dÃ­a</div>`;
      headC.addEventListener('click',()=>{ state.collapsed['continuas']=!state.collapsed['continuas']; saveState(state); render(); });

      const bodyC=document.createElement('div'); bodyC.className='section-body';
      PLAN.continuous.forEach(task=>{
        const done=!!state.tasks[task.id];
        const el=document.createElement('div'); el.className='task'+(done?' done':'');

        el.innerHTML=`
          <input class="chk" id="chk-${task.id}" type="checkbox" ${done?'checked':''}>
          <div>
            <div class="title">
              <span class="status-dot ${done?'status-done':'status-pending'}"></span>
              ${task.title}
            </div>
            <div class="desc">${task.desc||''}</div>
            <div class="meta">â³ Sin horario fijo</div>
          </div>
          <div class="tools">
            <span class="chip">ğŸ—‚ï¸ Seguimiento</span>
            <span class="chip">ğŸ’¾ Auto-guardado</span>
          </div>`;

        el.querySelector('.chk').addEventListener('change',ev=>{
          const checked=ev.target.checked;
          state.tasks[task.id]=checked; saveState(state);
          el.classList.toggle('done',checked);
          el.querySelector('.status-dot').className = 'status-dot ' + (checked?'status-done':'status-pending');
          pushLog({ts:new Date().toISOString(), task:task.id, title:task.title, action:checked?'Completada':'Pendiente', block:'continuas', time:'-', shift:state.shift});
          updateProgress();
          updateKPIs();
        });

        bodyC.appendChild(el);
      });
      secC.appendChild(headC); secC.appendChild(bodyC); sectionsEl.appendChild(secC);

      // PolÃ­tica
      const secP=document.createElement('section'); secP.className='section';
      const headP=document.createElement('div'); headP.className='section-header';
      headP.innerHTML=`<h2>âš ï¸ PolÃ­tica de incumplimiento</h2><div class="time">AplicaciÃ³n gradual</div>`;
      const bodyP=document.createElement('div'); bodyP.className='section-body';
      const ul=document.createElement('ul'); ul.style.margin='6px 0 0 16px'; ul.style.padding='0';
      PLAN.policy.forEach(p=>{ const li=document.createElement('li'); li.style.margin='8px 0'; li.textContent=p; ul.appendChild(li); });
      bodyP.appendChild(ul); secP.appendChild(headP); secP.appendChild(bodyP); sectionsEl.appendChild(secP);

      updateProgress();
      updateKPIs();
    }

    /* ===== Progreso y KPIs ===== */
    function updateProgress(){
      const timedIds = PLAN.blocks.flatMap(b=>b.tasks.map(t=>t.id));
      const total = timedIds.length;
      const done = timedIds.filter(id=>!!state.tasks[id]).length;
      const pct = total? Math.round(done*100/total) : 0;
      const bar=document.getElementById('progBar');
      bar.style.width=pct+'%';
      bar.style.background = pct<50 ? 'linear-gradient(90deg,#c62828,#ef5350)'
                        : pct<80 ? 'linear-gradient(90deg,#fbc02d,#ffd54f)'
                                 : 'linear-gradient(90deg,#42a5f5,#80d6ff)';
      document.getElementById('progLabel').textContent=pct+"% completado";
      document.getElementById('kpiTimed').textContent = `${done} / ${total}`;
      document.getElementById('kpiPct').textContent = `${pct}%`;
    }

    function updateKPIs(){
      document.getElementById('kpiShift').textContent = state.shift;
      const now=new Date();
      const end = new Date();
      if(state.shift==='AM'){ end.setHours(16,0,0,0); }
      else { end.setHours(22,0,0,0); }
      let diffMs = end - now;
      if(diffMs<0) diffMs=0;
      const hh = Math.floor(diffMs/3600000);
      const mm = Math.floor((diffMs%3600000)/60000);
      document.getElementById('kpiTimeLeft').textContent = `${pad(hh)}:${pad(mm)}`;
    }

    /* ===== Recordatorios 10 min antes del bloque ===== */
    const REMIND_MIN = 10;
    function parseBlockRange(label){ const [start,end] = label.split('â€“').map(s=>s.trim()); return [start,end]; }
    function asTodayTime(hhmm){ const [h,m] = hhmm.split(':').map(Number); const d = new Date(); d.setHours(h,m,0,0); return d; }
    function remindersTick(){
      const now=new Date();
      PLAN.blocks.forEach(b=>{
        const [from] = parseBlockRange(b.time[state.shift]);
        const start = asTodayTime(from);
        const remindAt = new Date(start - REMIND_MIN*60000);
        const key = `${todayStr()}_${state.shift}_${b.id}`;
        if(now>=remindAt && now - remindAt < 30000 && state.lastReminder!==key){
          state.lastReminder=key; saveState(state);
          toast(`â° En ${REMIND_MIN} min: ${b.title} (${b.time[state.shift]})`);
        }
      });
    }
    setInterval(remindersTick, 5000);

    /* ===== Eventos globales ===== */
    document.getElementById('selTurno').addEventListener('change',e=>{ state.shift=e.target.value; saveState(state); render(); });
    document.getElementById('btnResetDay').addEventListener('click',()=>{
      PLAN.blocks.forEach(b=>b.tasks.forEach(t=> state.tasks[t.id]=false ));
      saveState(state); render(); toast('ğŸ§¹ Tareas con horario reseteadas');
    });
    document.getElementById('btnClearAll').addEventListener('click',()=>{
      localStorage.removeItem(STORAGE_KEY);
      state=defaultState(); render(); toast('ğŸ—‘ï¸ Guardado eliminado');
    });

    /* ===== Modal HistÃ³rico ===== */
    const backdrop=document.getElementById('modalBackdrop');
    const logList=document.getElementById('logList');
    document.getElementById('btnLog').addEventListener('click',()=>{
      backdrop.style.display='flex';
      document.getElementById('logDate').textContent = `Fecha: ${todayStr()} Â· Turno actual: ${state.shift}`;
      renderLog();
    });
    document.getElementById('btnCloseModal').addEventListener('click',()=>{ backdrop.style.display='none'; });

    function renderLog(){
      const rows = getLog(todayStr());
      logList.innerHTML = rows.length? '' : '<div class="log-item">Sin registros todavÃ­a.</div>';
      rows.slice().reverse().forEach(r=>{
        const d=new Date(r.ts);
        const el=document.createElement('div'); el.className='log-item';
        el.innerHTML = `
          <div><strong>${r.action}</strong> â€” ${r.task}${r.title?` Â· ${r.title}`:''}</div>
          <div class="log-meta">Bloque: ${r.block} Â· Horario: ${r.time} Â· Turno: ${r.shift} Â· ${d.toLocaleTimeString('es-PE',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}</div>
        `;
        logList.appendChild(el);
      });
    }

    document.getElementById('btnExportLog').addEventListener('click',()=>{
      const rows = getLog(todayStr());
      const lines = [
        `HistÃ³rico del dÃ­a ${todayStr()} (Turno: ${state.shift})`,
        '---------------------------------------------',
        ...rows.map(r=>{
          const d=new Date(r.ts);
          const hhmmss = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
          return `[${hhmmss}] ${r.action} - ${r.task} ${r.title?('Â· '+r.title):''} | Bloque:${r.block} | Horario:${r.time} | Turno:${r.shift}`;
        })
      ];
      const blob=new Blob([lines.join('\n')],{type:'text/plain;charset=utf-8'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=`historico_${todayStr()}_${state.shift}.txt`;
      a.click();
      URL.revokeObjectURL(a.href);
    });

    /* ===== Init ===== */
    function init(){ render(); updateKPIs(); }
    init();
  </script>
</body>
</html>


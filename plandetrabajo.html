<!DOCTYPE html>
<html lang="es" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GestiÃ³n Center â€” v2.0 Â· Plan de trabajo</title>

    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=Lexend:wght@300;400;600;700&display=swap" rel="stylesheet"/>

    <!-- ğŸ”’ Ocultar hasta validar sesiÃ³n -->
    <style>html{visibility:hidden}</style>
    <script type="module" src="./assets/guard.js"></script>

    <style>
      /* =========================
         DESIGN SYSTEM â€” v2.0  (idÃ©ntico al ecosistema)
         ========================= */
      :root{
        --radius:16px;
        --radius-sm:12px;
        --radius-xs:10px;

        /* TipografÃ­a */
        --font-title:'Outfit', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        --font-body:'Lexend', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;

        /* Duraciones y curvas */
        --t-fast:.15s;
        --t-med:.25s;
        --t-slow:.6s;
        --curve:cubic-bezier(.2,.7,.2,1);

        /* ElevaciÃ³n */
        --elev-1:0 6px 20px rgba(0,0,0,.25);
        --elev-2:0 12px 34px rgba(0,0,0,.35);
      }

      /* Tema oscuro (default) */
      [data-theme="dark"]{
        --bg-app:#070b1a;
        --bg-aside:#0c1228;
        --bg-card:linear-gradient(160deg, rgba(17,24,49,.88), rgba(17,24,49,.7));
        --txt:#e9f1ff;
        --txt-muted:#b8c6de;
        --stroke:rgba(255,255,255,.10);

        --primary:#5b8bff;
        --accent:#7ae3ff;

        --chip-ok:#22c55e; --chip-warn:#f59e0b; --chip-bad:#ef4444;
      }

      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0; font-family:var(--font-body); color:var(--txt);
        background:
          radial-gradient(1100px 1100px at 10% -10%, color-mix(in oklab, var(--primary) 30%, transparent), transparent 60%),
          radial-gradient(900px 900px at 90% 0%, color-mix(in oklab, var(--accent) 35%, transparent), transparent 55%),
          var(--bg-app);
        overflow-x:hidden;
      }

      /* Accesibilidad: respetar reducciÃ³n de movimiento */
      @media (prefers-reduced-motion:no-preference){
        .reveal{opacity:0; transform:translateY(8px); will-change:transform,opacity; transition:opacity var(--t-slow) ease, transform var(--t-slow) ease}
        .reveal.show{opacity:1; transform:none}
      }

      /* ====== Sidebar (idÃ©ntico) ====== */
      aside{
        position:fixed; inset:0 auto 0 0; width:280px; z-index:25;
        backdrop-filter:saturate(120%) blur(8px);
        background:color-mix(in oklab, var(--bg-aside) 96%, transparent);
        border-right:1px solid var(--stroke);
        display:flex; flex-direction:column; padding:22px 14px; gap:12px; overflow:auto;
      }
      .logo{
        display:flex; align-items:center; justify-content:center; gap:10px;
        font-family:var(--font-title); font-size:20px; font-weight:700; letter-spacing:.2px;
        padding:12px; border-radius:var(--radius); border:1px solid var(--stroke);
        background:linear-gradient(132deg, color-mix(in oklab, var(--primary) 18%, transparent), color-mix(in oklab, var(--accent) 12%, transparent));
        position:relative; isolation:isolate;
      }
      .logo::after{
        content:""; position:absolute; inset:0; border-radius:var(--radius); pointer-events:none;
        box-shadow:0 0 28px color-mix(in oklab, var(--primary) 35%, transparent),
                   0 0 42px color-mix(in oklab, var(--accent) 22%, transparent);
        opacity:.18;
      }
      nav{ position:relative; display:flex; flex-direction:column; gap:8px; }
      nav a{
        display:flex; align-items:center; gap:10px; padding:11px 12px; border-radius:12px;
        text-decoration:none; color:var(--txt); font-size:15px; border:1px solid transparent;
        transition:background var(--t-med) ease, transform var(--t-fast) ease;
      }
      nav a:hover{ background:color-mix(in oklab, var(--bg-aside) 80%, transparent); transform:translateX(2px) }
      nav a.active{
        background:linear-gradient(90deg, color-mix(in oklab, var(--primary) 20%, transparent), color-mix(in oklab, var(--accent) 14%, transparent));
        border-color:var(--stroke);
      }
      .nav-indicator{
        position:absolute; left:0; width:4px; height:40px; border-radius:0 3px 3px 0;
        background:linear-gradient(180deg, var(--primary), var(--accent));
        box-shadow:0 0 16px color-mix(in oklab, var(--accent) 65%, transparent);
        transition:transform var(--t-med) var(--curve), height var(--t-med) ease; will-change:transform,height;
      }
      .spacer{flex:1}
      .logout{
        width:100%; border:1px solid var(--stroke);
        background:linear-gradient(180deg, #ef4444, #d62c2c); color:#fff;
        padding:12px; border-radius:12px; cursor:pointer; font-weight:700;
        transition:transform var(--t-fast) ease, filter var(--t-med) ease;
      }
      .logout:hover{filter:brightness(1.05)} .logout:active{transform:translateY(1px)}

      /* ====== Main ====== */
      main{ margin-left:280px; padding:24px 22px 40px; }

      /* ====== Cabecera Plan ====== */
      .hero-plan{
        position:relative; border-radius:var(--radius); padding:18px 18px 18px 20px;
        background:linear-gradient(135deg, color-mix(in oklab, var(--primary) 14%, transparent), color-mix(in oklab, var(--accent) 12%, transparent));
        border:1px solid var(--stroke); overflow:hidden; margin-bottom:16px;
      }
      .hero-plan h1{margin:0 0 6px; font:700 24px/1.2 var(--font-title)}
      .hero-plan p{margin:0; color:var(--txt-muted); font-size:14px}
      .pill{
        display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
        background:linear-gradient(180deg, var(--accent), color-mix(in oklab, var(--accent) 50%, white));
        color:#0b1022; font-weight:700; border:1px solid color-mix(in oklab, var(--accent) 65%, white);
        box-shadow:0 8px 24px color-mix(in oklab, var(--accent) 35%, transparent), inset 0 1px 0 rgba(255,255,255,.6);
      }
      .blob{
        position:absolute; right:-90px; top:-90px; width:240px; height:240px; border-radius:50%;
        background:radial-gradient(circle at 30% 30%, color-mix(in oklab, var(--accent) 40%, transparent), transparent 60%);
        filter:blur(18px); pointer-events:none; transform:translateZ(0);
      }

      /* ====== Widgets Plan (portado y adaptado al DS v2.0) ====== */
      .kpis{ display:grid; grid-template-columns:repeat(4,minmax(220px,1fr)); gap:12px; margin:12px 0 10px; }
      .kpi{ background:var(--bg-card); border:1px solid var(--stroke); border-radius:var(--radius-sm); padding:12px; box-shadow:var(--elev-1); }
      .kpi .label{ font-size:12px; color:var(--txt-muted); }
      .kpi .value{ font-size:18px; font-weight:800; margin-top:4px; }

      .topbar{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin:10px 0 16px; }
      .select{
        background:color-mix(in oklab, var(--bg-aside) 85%, transparent);
        color:var(--txt); border:1px solid var(--stroke); border-radius:var(--radius-xs);
        padding:10px 12px; height:40px;
      }
      .btn{
        padding:10px 14px; font-size:14px; cursor:pointer; border:none; border-radius:var(--radius-xs);
        background:linear-gradient(180deg, color-mix(in oklab, var(--primary) 85%, #2b59ff), var(--primary));
        color:#fff; box-shadow:0 6px 16px rgba(0,0,0,.25); transition:transform var(--t-fast) ease, filter var(--t-med) ease;
      }
      .btn:hover{ filter:brightness(1.05) } .btn:active{ transform:translateY(1px) }

      .progress{ flex:1; min-width:240px; background:rgba(255,255,255,.08); border:1px solid var(--stroke); border-radius:999px; height:12px; overflow:hidden; position:relative; }
      .progress>span{ display:block; height:100%; width:0%; transition:width .35s var(--curve), background .25s; }
      .progress-label{ font-size:12px; color:var(--txt-muted); min-width:140px; text-align:right; }

      .section{ background:var(--bg-card); border:1px solid var(--stroke); border-radius:var(--radius); padding:16px; margin:14px 0; box-shadow:var(--elev-1); }
      .section-header{ display:flex; align-items:center; gap:10px; cursor:pointer; user-select:none; }
      .section-header h2{ font-size:18px; margin:0; font-family:var(--font-title); }
      .section-header .time{ color:var(--txt-muted); font-size:13px; margin-left:auto; }
      .section.collapsed .section-body{ display:none; }

      .task{ display:grid; grid-template-columns:28px 1fr 240px; gap:12px; align-items:start; padding:12px; border:1px solid var(--stroke); border-radius:12px; background:rgba(0,0,0,.12); margin:10px 0; }
      .task:hover{ background:rgba(0,0,0,.16); }
      .task.done{ background:rgba(34,197,94,.16); border-color:#22c55e66; }
      .task .chk{ width:18px; height:18px; margin-top:2px; }
      .task .title{ font-weight:700; display:flex; align-items:center; gap:8px; font-family:var(--font-title); }
      .status-dot{ width:10px; height:10px; border-radius:999px; display:inline-block; box-shadow:0 0 0 2px rgba(0,0,0,.2) inset; }
      .status-pending{ background:#eab308; }
      .status-done{ background:#22c55e; }
      .task .desc{ color:var(--txt-muted); font-size:13px; margin-top:3px; }
      .task .meta{ font-size:12px; color:#cfe3ff; }
      .task .tools{ display:flex; gap:8px; align-items:center; justify-content:flex-end; }
      .chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid var(--stroke); background:color-mix(in oklab, var(--bg-aside) 85%, transparent); white-space:nowrap; }

      .tip-btn{ background:transparent; border:1px solid var(--stroke); color:#fff; border-radius:8px; padding:4px 8px; font-size:12px; cursor:pointer; }
      .tip{ display:none; margin-top:8px; background:rgba(0,0,0,.25); border:1px solid var(--stroke); border-radius:10px; padding:8px 10px; font-size:12px; color:#e4f1ff; }
      .tip.visible{ display:block; }

      .pdf{ width:100%; height:560px; border:none; border-radius:var(--radius-sm); overflow:hidden; }

      #toast{ position:fixed; bottom:18px; right:20px; background:#0b1022; color:#fff; padding:12px 18px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.35); display:none; z-index:1000; transition:opacity .2s ease; border:1px solid var(--stroke); }

      .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:1100; }
      .modal{ background:var(--bg-card); border:1px solid var(--stroke); width:min(760px,92vw); border-radius:var(--radius); padding:16px; box-shadow:var(--elev-2); }
      .modal h3{ margin:0 0 8px; font-family:var(--font-title); }
      .log-list{ max-height:50vh; overflow:auto; display:grid; gap:8px; }
      .log-item{ background:rgba(255,255,255,.05); border:1px solid var(--stroke); border-radius:10px; padding:8px 10px; }

      /* Responsive */
      @media (max-width:1080px){
        main{margin-left:0; padding:16px}
        aside{position:sticky; width:auto; inset:auto; border-right:none; border-bottom:1px solid var(--stroke)}
        .task{ grid-template-columns:24px 1fr; }
        .task .tools{ justify-content:flex-start; }
        .kpis{ grid-template-columns:1fr 1fr; }
      }
      @media (max-width:680px){
        .kpis{ grid-template-columns:1fr; }
      }
    </style>
  </head>
  <body>
    <!-- Fondo cuadrÃ­cula sutil (parallax) -->
    <div id="bg-grid" aria-hidden="true" style="
      position:fixed; inset:0; z-index:-1; opacity:.07; pointer-events:none;
      background:
        linear-gradient(color-mix(in oklab, var(--txt) 9%, transparent) 1px, transparent 1px) 0 0 / 28px 28px,
        linear-gradient(90deg, color-mix(in oklab, var(--txt) 9%, transparent) 1px, transparent 1px) 0 0 / 28px 28px;">
    </div>

    <!-- ===== SIDEBAR (idÃ©ntico al ecosistema) ===== -->
    <aside class="reveal">
      <div class="logo">ğŸ§­ GestiÃ³n Center</div>
      <nav role="navigation" aria-label="NavegaciÃ³n principal">
        <div class="nav-indicator" aria-hidden="true"></div>

        <a href="./index.html" class="nav-item">ğŸ  <span>Inicio</span></a>
        <a href="./plandetrabajo.html" class="nav-item">âœ… <span>Plan de trabajo</span></a>
        <a href="./distribucion.html" class="nav-item">ğŸ“‹ <span>DistribuciÃ³n</span></a>
        <a href="./estadisticas.html" class="nav-item">ğŸ“ˆ <span>EstadÃ­sticas</span></a>
        <a href="./cobertura.html" class="nav-item">ğŸŒ <span>Cobertura</span></a>
        <a href="./camprev.html" class="nav-item">ğŸ‘¥ <span>Selector de Apoyo Ver 2.0</span></a>
        <a href="./postsale.html" class="nav-item">ğŸšš <span>Post-Sale New Report</span></a>
        <a href="./opo11.html" class="nav-item">ğŸ§° <span>New Report CC PerÃº</span></a>
        <a href="./pintado.html" class="nav-item">ğŸ§® <span>Queues Heatmap</span></a>
        <a href="#contacto" class="nav-item">ğŸ“¬ <span>Contacto</span></a>
        <a href="./newcobertura.html" class="nav-item">ğŸ§­ <span>New Cobertura 1.1</span></a>
        <a href="./tablita.html" class="nav-item">ğŸ“„ <span>Tablita :3</span></a>
        <a href="./login.html" class="nav-item">ğŸ§ª <span>Test</span></a>
      </nav>
      <div class="spacer"></div>
      <button class="logout" onclick="gcLogout()">Salir</button>
    </aside>

    <!-- ===== CONTENIDO PLAN ===== -->
    <main>
      <section class="hero-plan reveal">
        <div class="blob" aria-hidden="true"></div>
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap">
          <div>
            <h1>âœ… Plan de Trabajo â€“ Team Leaders</h1>
            <p id="fechaHora">Cargando fecha/horaâ€¦</p>
          </div>
          <div class="pill">SesiÃ³n verificada â€¢ Operaciones</div>
        </div>
      </section>

      <!-- KPIs -->
      <section class="reveal" style="--delay:.05s">
        <div class="kpis" role="region" aria-label="Indicadores clave del plan">
          <div class="kpi"><div class="label">Tareas con horario</div><div class="value" id="kpiTimed">0 / 0</div></div>
          <div class="kpi"><div class="label">% Avance</div><div class="value" id="kpiPct">0%</div></div>
          <div class="kpi"><div class="label">Turno seleccionado</div><div class="value" id="kpiShift">AM</div></div>
          <div class="kpi"><div class="label">Estado del turno</div><div class="value" id="kpiTimeLeft">--</div></div>
        </div>

        <div class="topbar">
          <div class="pill" style="background:transparent; border:1px solid var(--stroke); box-shadow:none; color:var(--txt)">
            <strong>Turno:&nbsp;</strong>
            <select id="selTurno" class="select" aria-label="Seleccionar turno">
              <option value="AM">AM (7:00â€“16:00)</option>
              <option value="PM">PM (13:00â€“22:00)</option>
            </select>
          </div>
          <button id="btnResetDay" class="btn" title="Marcar como pendientes las tareas con horario">ğŸ§¹ Reset del dÃ­a</button>
          <button id="btnClearAll" class="btn" title="Borrar guardado local (estado y colapsados)">ğŸ—‘ï¸ Borrar guardado</button>
          <button id="btnLog" class="btn" title="Ver historial de acciones del dÃ­a">ğŸ“œ Ver HistÃ³rico del DÃ­a</button>
          <div class="progress" title="Avance de tareas con horario"><span id="progBar"></span></div>
          <div class="progress-label" id="progLabel">0% completado</div>
        </div>
      </section>

      <!-- Secciones renderizadas por JS -->
      <section id="sections" class="reveal" style="--delay:.1s"></section>

      <!-- PDF -->
      <section class="reveal" style="--delay:.15s">
        <h2 style="margin:18px 0 10px; font:700 18px var(--font-title);">ğŸ“„ Plan de trabajo completo (PDF)</h2>
        <div style="border-radius:var(--radius-sm); overflow:hidden; box-shadow:var(--elev-1); border:1px solid var(--stroke);">
          <object data="Plan_de_trabajo_TEAM_LEADER.pdf#view=FitH" type="application/pdf" class="pdf" aria-label="Visor PDF Plan de trabajo">
            <div style="padding:16px">
              <p>No se pudo cargar el PDF desde <code>Plan_de_trabajo_TEAM_LEADER.pdf</code>.</p>
              <p>
                âœ Ver/descargar:
                <a href="Plan_de_trabajo_TEAM_LEADER.pdf" target="_blank" style="color:#80d6ff; text-decoration:underline;">
                  abrir en nueva pestaÃ±a
                </a>
              </p>
              <small style="color:var(--txt-muted)">
                AsegÃºrate de que el archivo estÃ© en la misma carpeta que <code>plandetrabajo.html</code>
                y que el nombre coincida exactamente (mayÃºsculas y guiones bajos).
              </small>
            </div>
          </object>
        </div>
      </section>

      <!-- Contacto -->
      <section id="contacto" class="reveal" style="--delay:.2s">
        <article class="section">
          <div class="section-header" style="cursor:default">
            <h2>ğŸ“¬ Contacto</h2>
          </div>
          <div class="section-body">
            <p class="muted" style="margin:.4rem 0 0; color:var(--txt-muted)">
              Â¿Ideas para mejorar el plan? EscrÃ­beme y lo iteramos :3
            </p>
          </div>
        </article>
      </section>
    </main>

    <div id="toast" role="status" aria-live="polite"></div>

    <!-- Modal HistÃ³rico -->
    <div id="modalBackdrop" class="modal-backdrop">
      <div class="modal">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
          <h3>ğŸ“œ HistÃ³rico del DÃ­a</h3>
          <div style="display:flex; gap:8px;">
            <button id="btnClearLog" class="tip-btn" title="Vaciar historial del dÃ­a">ğŸ§½ Limpiar</button>
            <button id="btnExportLog" class="tip-btn" title="Exportar historial a .txt">â¬‡ï¸ Exportar .txt</button>
            <button id="btnCloseModal" class="tip-btn" title="Cerrar">âœ–ï¸ Cerrar</button>
          </div>
        </div>
        <p class="subtitle" id="logDate" style="color:var(--txt-muted); margin:6px 0 10px"></p>
        <div id="logList" class="log-list"></div>
      </div>
    </div>

    <script type="module">
      // ========= Nave activo + indicador (idÃ©ntico al ecosistema) =========
      const items = [...document.querySelectorAll('nav .nav-item')];
      const indicator = document.querySelector('.nav-indicator');
      const current = (location.pathname.split('/').pop() || 'index.html').toLowerCase();
      function setActive(){
        let active = items[0];
        items.forEach(a=>{
          const href = (a.getAttribute('href')||'').split('#')[0].split('/').pop().toLowerCase();
          if(href && href === current) active = a;
          a.classList.toggle('active', a===active);
          a.toggleAttribute('aria-current', a===active ? 'page' : false);
        });
        const rect = active.getBoundingClientRect();
        const p = active.parentElement.getBoundingClientRect();
        const y = rect.top - p.top + active.parentElement.scrollTop;
        indicator.style.height = rect.height + 'px';
        indicator.style.transform = `translateY(${y}px)`;
      }
      setActive();
      const nav = document.querySelector('nav');
      nav.addEventListener('scroll', setActive);
      window.addEventListener('resize', setActive);

      // ========= Reveal al scroll =========
      const reduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if(!reduced && 'IntersectionObserver' in window){
        const io = new IntersectionObserver((entries)=>{
          for(const e of entries){
            if(e.isIntersecting){ e.target.classList.add('show'); io.unobserve(e.target); }
          }
        }, {threshold:.12, rootMargin:'0px 0px -10% 0px'});
        document.querySelectorAll('.reveal').forEach(el=>{
          const delay = el.style.getPropertyValue('--delay') || '0s';
          el.style.transitionDelay = delay; io.observe(el);
        });
      } else {
        document.querySelectorAll('.reveal').forEach(el=>el.classList.add('show'));
      }

      // ========= Parallax sutil del fondo =========
      const bg=document.getElementById('bg-grid');
      let rafId=null;
      function parallax(e){
        const x=(e.clientX / window.innerWidth - .5)*6;
        const y=(e.clientY / window.innerHeight - .5)*6;
        if(rafId) cancelAnimationFrame(rafId);
        rafId=requestAnimationFrame(()=>{ bg.style.transform=`translate(${x}px, ${y}px)`; });
      }
      if(!reduced) window.addEventListener('mousemove', parallax);

      // ========= Seguridad: logout expuesto por guard.js =========
      if (typeof window.gcLogout !== 'function') {
        console.warn('gcLogout no estÃ¡ definido. En guard.js expÃ³n la funciÃ³n global: window.gcLogout = async () => { /* signOut + redirect */ }');
      }
      // Nota: guard.js debe hacer document.documentElement.style.visibility='visible' al validar sesiÃ³n.
    </script>

    <!-- ====== LÃ“GICA DEL PLAN (portada desde tu versiÃ³n mejorada) ====== -->
    <script>
      /* ===== Utilidades ===== */
      const STORAGE_KEY='plan_vigente_v4';
      const LOG_KEY_PREFIX='plan_log_';
      const toastQueue = [];
      let toastLock = false;

      const toast=(m)=>{
        toastQueue.push(m);
        if (toastLock) return;
        const t=document.getElementById('toast');
        const showNext=()=>{
          if (!toastQueue.length) { toastLock=false; t.style.display='none'; return; }
          toastLock=true;
          const msg=toastQueue.shift();
          t.textContent=msg;
          t.style.display='block';
          t.style.opacity=1;
          setTimeout(()=>{ t.style.opacity=0; }, 2200);
          setTimeout(()=>{ showNext(); }, 2600);
        };
        showNext();
      };

      const pad=n=>String(n).padStart(2,'0');
      const todayStr=()=>{const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`};

      function actualizarFechaHora(){
        const ahora=new Date();
        const fecha=ahora.toLocaleDateString('es-PE',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
        const hora=ahora.toLocaleTimeString('es-PE',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
        document.getElementById('fechaHora').textContent=`ğŸ“… ${fecha} â€“ ğŸ•’ ${hora}`;
      }
      actualizarFechaHora(); setInterval(actualizarFechaHora,1000);

      /* ===== Plan (sin notas y con dos tareas eliminadas) ===== */
      const PLAN = {
        blocks:[
          { id:'primera', title:'ğŸ“Œ Primera hora de gestiÃ³n', time:{AM:'7:00â€“8:00',PM:'13:00â€“14:00'}, tasks:[
            {id:'1.1', title:'Good Day (Registro de Asistencia)', desc:'Registrar asistencia oficial de todos los operadores.', tip:`Status permitidos: A, B, VA, OFF, Fa, FJ, Fe, NL, DLT, DM, S, LF, LM.`},
          ]},
          { id:'segunda', title:'ğŸ“Œ Segunda hora de gestiÃ³n', time:{AM:'8:00â€“9:00',PM:'14:00â€“15:00'}, tasks:[
            {id:'1.2', title:'Planilla (Registro de Horas del DÃ­a Anterior)', desc:'Completar planilla con base en BI-844.', tip:`Reglas de redondeo: >45 min â†’ 1h; desde 4:45h sumar 1h por break.`},
            {id:'1.3', title:'Control de Asistencia Diaria (Tiempo Incompleto)', desc:'Documento diario para quienes no completaron su jornada.', tip:`Verificar PEROP1AMs, identificar operadores, motivo del tiempo incompleto.`},
          ]},
          { id:'tercera', title:'ğŸ“Œ Tercera hora de gestiÃ³n', time:{AM:'9:00â€“10:00',PM:'15:00â€“16:00'}, tasks:[
            {id:'1.4', title:'Horas Rusia', desc:'Carga de conexiÃ³n, llamadas y SAVE con base en BI-844 (dÃ­a anterior).', tip:`Se realiza con informaciÃ³n del dÃ­a anterior.`},
            {id:'1.5', title:'ProgramaciÃ³n (BI-247)', desc:'Asegurar programaciÃ³n correcta y coherencia de horarios.', tip:`1) Nadie gestionando sin programar. 2) Ausentes se desprograman. 3) Coherencia horario oficial/real.`},
          ]},
          { id:'ultima', title:'ğŸ“Œ Ãšltima hora de gestiÃ³n', time:{AM:'15:00â€“16:00',PM:'21:00â€“22:00'}, tasks:[
            {id:'1.6', title:'VerificaciÃ³n de Recalls (BI-82 y BI-91)', desc:'Todo recall con informaciÃ³n se gestiona el mismo dÃ­a.', tip:`Objetivo: cierre limpio de jornada.`},
          ]},
        ],
        continuous:[
          {id:'c.2', title:'VerificaciÃ³n de estadÃ­sticas de campaÃ±as', desc:'Monitoreo de leads, conectados, ACD, ventas, SAVE, etc.'},
        ],
        policy:[
          '1) Primer incumplimiento: recordatorio inmediato.',
          '2) Segundo incumplimiento: llamado de atenciÃ³n formal.',
          '3) Reincidencia: informe a RRHH para evaluaciÃ³n.'
        ]
      };

      /* ===== Persistencia ===== */
      function loadState(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY))||{} }catch{ return {} } }
      function saveState(state){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
      function autoShift(){ return (new Date().getHours()>=12? 'PM':'AM'); }
      function defaultState(){
        const st={ shift:autoShift(), tasks:{}, collapsed:{}, lastReminder:'' };
        PLAN.blocks.forEach(b=>b.tasks.forEach(t=>{ st.tasks[t.id]=false; }));
        PLAN.continuous.forEach(t=>{ st.tasks[t.id]=false; });
        return st;
      }
      let state = Object.assign(defaultState(), loadState());
      if (!('shift' in loadState())) { saveState(state); }

      /* ===== HistÃ³rico ===== */
      function getLog(dateStr=todayStr()){
        try{ return JSON.parse(localStorage.getItem(LOG_KEY_PREFIX+dateStr)) || [] }catch{ return [] }
      }
      function setLog(arr,dateStr=todayStr()){
        localStorage.setItem(LOG_KEY_PREFIX+dateStr, JSON.stringify(arr||[]));
      }
      function pushLog(entry, dateStr=todayStr()){
        const arr=getLog(dateStr);
        arr.push(entry);
        setLog(arr,dateStr);
      }

      /* ===== Render ===== */
      const sectionsEl = document.getElementById('sections');

      function render(){
        document.getElementById('selTurno').value = state.shift;
        sectionsEl.innerHTML='';

        // Bloques con horario
        PLAN.blocks.forEach(block=>{
          const sec=document.createElement('article'); sec.className='section';
          if(state.collapsed[block.id]) sec.classList.add('collapsed');

          const head=document.createElement('div'); head.className='section-header';
          head.innerHTML=`<h2>${block.title}</h2><div class="time">${state.shift} Â· ${block.time[state.shift]}</div>`;
          head.addEventListener('click',()=>{ state.collapsed[block.id]=!state.collapsed[block.id]; saveState(state); render(); });

          const body=document.createElement('div'); body.className='section-body';

          block.tasks.forEach(task=>{
            const done=!!state.tasks[task.id];
            const el=document.createElement('div'); el.className='task'+(done?' done':'');

            el.innerHTML=`
              <input class="chk" id="chk-${task.id}" type="checkbox" ${done?'checked':''} aria-label="Marcar ${task.title}">
              <div>
                <div class="title">
                  <span class="status-dot ${done?'status-done':'status-pending'}"></span>
                  ${task.id} Â· ${task.title}
                  <button class="tip-btn" data-tip="tip-${task.id}" title="Ver tip" aria-expanded="false">â„¹ï¸</button>
                </div>
                <div class="desc">${task.desc||''}</div>
                <div class="meta">${state.shift} Â· ${block.time[state.shift]}</div>
                <div id="tip-${task.id}" class="tip" role="note">${task.tip?task.tip:''}</div>
              </div>
              <div class="tools">
                <span class="chip">â±ï¸ Bloque</span>
                <span class="chip">ğŸ’¾ Auto-guardado</span>
              </div>`;

            el.querySelector('.chk').addEventListener('change',ev=>{
              const checked=ev.target.checked;
              state.tasks[task.id]=checked; saveState(state);
              el.classList.toggle('done',checked);
              el.querySelector('.status-dot').className = 'status-dot ' + (checked?'status-done':'status-pending');
              updateProgress();
              const now=new Date();
              pushLog({ts:now.toISOString(), task:task.id, title:task.title, action:checked?'Completada':'Pendiente', block:block.id, time:block.time[state.shift], shift:state.shift});
              toast(checked?'âœ… Tarea completada':'â†©ï¸ Tarea pendiente');
              updateKPIs();
            });

            el.querySelector('.tip-btn').addEventListener('click',ev=>{
              ev.preventDefault();
              const btn=ev.currentTarget;
              const id=btn.dataset.tip;
              const tip=document.getElementById(id);
              const visible = tip.classList.toggle('visible');
              btn.setAttribute('aria-expanded', visible?'true':'false');
            });

            body.appendChild(el);
          });

          sec.appendChild(head); sec.appendChild(body);
          sectionsEl.appendChild(sec);
        });

        // Tareas continuas
        const secC=document.createElement('article'); secC.className='section';
        if(state.collapsed['continuas']) secC.classList.add('collapsed');
        const headC=document.createElement('div'); headC.className='section-header';
        headC.innerHTML=`<h2>ğŸ” Tareas de actualizaciÃ³n continua</h2><div class="time">Todo el dÃ­a</div>`;
        headC.addEventListener('click',()=>{ state.collapsed['continuas']=!state.collapsed['continuas']; saveState(state); render(); });

        const bodyC=document.createElement('div'); bodyC.className='section-body';
        PLAN.continuous.forEach(task=>{
          const done=!!state.tasks[task.id];
          const el=document.createElement('div'); el.className='task'+(done?' done':'');

          el.innerHTML=`
            <input class="chk" id="chk-${task.id}" type="checkbox" ${done?'checked':''} aria-label="Marcar ${task.title}">
            <div>
              <div class="title">
                <span class="status-dot ${done?'status-done':'status-pending'}"></span>
                ${task.title}
              </div>
              <div class="desc">${task.desc||''}</div>
              <div class="meta">â³ Sin horario fijo</div>
            </div>
            <div class="tools">
              <span class="chip">ğŸ—‚ï¸ Seguimiento</span>
              <span class="chip">ğŸ’¾ Auto-guardado</span>
            </div>`;

          el.querySelector('.chk').addEventListener('change',ev=>{
            const checked=ev.target.checked;
            state.tasks[task.id]=checked; saveState(state);
            el.classList.toggle('done',checked);
            el.querySelector('.status-dot').className = 'status-dot ' + (checked?'status-done':'status-pending');
            pushLog({ts:new Date().toISOString(), task:task.id, title:task.title, action:checked?'Completada':'Pendiente', block:'continuas', time:'-', shift:state.shift});
            updateProgress();
            updateKPIs();
          });

          bodyC.appendChild(el);
        });
        secC.appendChild(headC); secC.appendChild(bodyC); sectionsEl.appendChild(secC);

        // PolÃ­tica
        const secP=document.createElement('article'); secP.className='section';
        const headP=document.createElement('div'); headP.className='section-header';
        headP.innerHTML=`<h2>âš ï¸ PolÃ­tica de incumplimiento</h2><div class="time">AplicaciÃ³n gradual</div>`;
        const bodyP=document.createElement('div'); bodyP.className='section-body';
        const ul=document.createElement('ul'); ul.style.margin='6px 0 0 16px'; ul.style.padding='0';
        PLAN.policy.forEach(p=>{ const li=document.createElement('li'); li.style.margin='8px 0'; li.textContent=p; ul.appendChild(li); });
        bodyP.appendChild(ul); secP.appendChild(headP); secP.appendChild(bodyP); sectionsEl.appendChild(secP);

        updateProgress();
        updateKPIs();
      }

      /* ===== Progreso y KPIs ===== */
      function updateProgress(){
        const timedIds = PLAN.blocks.flatMap(b=>b.tasks.map(t=>t.id));
        const total = timedIds.length;
        const done = timedIds.filter(id=>!!state.tasks[id]).length;
        const pct = total? Math.round(done*100/total) : 0;
        const bar=document.getElementById('progBar');
        bar.style.width=pct+'%';
        bar.style.background = pct<50 ? 'linear-gradient(90deg,#ef4444,#f87171)'
                          : pct<80 ? 'linear-gradient(90deg,#eab308,#fde047)'
                                   : 'linear-gradient(90deg,#60a5fa,#93c5fd)';
        document.getElementById('progLabel').textContent=pct+"% completado";
        document.getElementById('kpiTimed').textContent = `${done} / ${total}`;
        document.getElementById('kpiPct').textContent = `${pct}%`;
      }

      function shiftBounds(shift){
        const dStart = new Date(), dEnd = new Date();
        if(shift==='AM'){ dStart.setHours(7,0,0,0); dEnd.setHours(16,0,0,0); }
        else { dStart.setHours(13,0,0,0); dEnd.setHours(22,0,0,0); }
        return [dStart,dEnd];
      }

      function updateKPIs(){
        document.getElementById('kpiShift').textContent = state.shift;
        const now=new Date();
        const [start,end]=shiftBounds(state.shift);
        let label='';
        if (now<start){
          const diffMs = start-now;
          const hh = Math.floor(diffMs/3600000);
          const mm = Math.floor((diffMs%3600000)/60000);
          label = `Por iniciar en ${pad(hh)}:${pad(mm)}`;
        } else if (now>=start && now<=end){
          const diffMs = end-now;
          const hh = Math.floor(diffMs/3600000);
          const mm = Math.floor((diffMs%3600000)/60000);
          label = `En curso Â· Restante ${pad(hh)}:${pad(mm)}`;
        } else {
          label = 'Fuera de turno';
        }
        document.getElementById('kpiTimeLeft').textContent = label;
      }

      /* ===== Recordatorios 10 min antes del bloque ===== */
      const REMIND_MIN = 10;
      function parseBlockRange(label){ const [start,end] = label.split('â€“').map(s=>s.trim()); return [start,end]; }
      function asTodayTime(hhmm){ const [h,m] = hhmm.split(':').map(Number); const d = new Date(); d.setHours(h,m,0,0); return d; }
      function remindersTick(){
        const now=new Date();
        PLAN.blocks.forEach(b=>{
          const [from] = parseBlockRange(b.time[state.shift]);
          const start = asTodayTime(from);
          const remindAt = new Date(start - REMIND_MIN*60000);
          const key = `${todayStr()}_${state.shift}_${b.id}`;
          if(now>=remindAt && now - remindAt < 25000 && state.lastReminder!==key){
            state.lastReminder=key; saveState(state);
            toast(`â° En ${REMIND_MIN} min: ${b.title} (${b.time[state.shift]})`);
          }
        });
      }
      setInterval(remindersTick, 5000);

      /* ===== Eventos globales ===== */
      document.getElementById('selTurno').addEventListener('change',e=>{ state.shift=e.target.value; saveState(state); render(); });

      document.getElementById('btnResetDay').addEventListener('click',()=>{
        PLAN.blocks.forEach(b=>b.tasks.forEach(t=> state.tasks[t.id]=false ));
        saveState(state); render(); toast('ğŸ§¹ Tareas con horario reseteadas');
      });

      document.getElementById('btnClearAll').addEventListener('click',()=>{
        localStorage.removeItem(STORAGE_KEY);
        state=defaultState(); render(); toast('ğŸ—‘ï¸ Guardado eliminado');
      });

      /* ===== Modal HistÃ³rico ===== */
      const backdrop=document.getElementById('modalBackdrop');
      const logList=document.getElementById('logList');
      document.getElementById('btnLog').addEventListener('click',()=>{
        backdrop.style.display='flex';
        document.getElementById('logDate').textContent = `Fecha: ${todayStr()} Â· Turno actual: ${state.shift}`;
        renderLog();
      });
      document.getElementById('btnCloseModal').addEventListener('click',()=>{ backdrop.style.display='none'; });

      function renderLog(){
        const rows = getLog(todayStr());
        logList.innerHTML = rows.length? '' : '<div class="log-item">Sin registros todavÃ­a.</div>';
        rows.slice().reverse().forEach(r=>{
          const d=new Date(r.ts);
          const hhmmss = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
          const el=document.createElement('div'); el.className='log-item';
          el.innerHTML = `
            <div><strong>${r.action}</strong> â€” ${r.task}${r.title?(` Â· ${r.title}`):''}</div>
            <div class="log-meta">Bloque: ${r.block} Â· Horario: ${r.time} Â· Turno: ${r.shift} Â· ${hhmmss}</div>
          `;
          logList.appendChild(el);
        });
      }

      document.getElementById('btnExportLog').addEventListener('click',()=>{
        const rows = getLog(todayStr());
        const lines = [
          `HistÃ³rico del dÃ­a ${todayStr()} (Turno: ${state.shift})`,
          '---------------------------------------------',
          ...rows.map(r=>{
            const d=new Date(r.ts);
            const hhmmss = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
            return `[${hhmmss}] ${r.action} - ${r.task} ${r.title?('Â· '+r.title):''} | Bloque:${r.block} | Horario:${r.time} | Turno:${r.shift}`;
          })
        ];
        const blob=new Blob([lines.join('\n')],{type:'text/plain;charset=utf-8'});
        const a=document.createElement('a');
        a.href=URL.createObjectURL(blob);
        a.download=`historico_${todayStr()}_${state.shift}.txt`;
        a.click();
        URL.revokeObjectURL(a.href);
      });

      document.getElementById('btnClearLog').addEventListener('click',()=>{
        setLog([], todayStr());
        renderLog();
        toast('ğŸ§½ HistÃ³rico del dÃ­a limpiado');
      });

      /* ===== Init ===== */
      function init(){ render(); updateKPIs(); }
      init();
    </script>

    <!-- ğŸ”’ Normalizador de enlaces del sidebar (GH Pages de proyecto / dominio propio) -->
    <script>
    (() => {
      const isGhProject = location.hostname.endsWith('github.io');
      const PROJECT_SLUG = 'Gestion-Center'; // Â¡respeta mayÃºsculas!
      const base = isGhProject ? `/${PROJECT_SLUG}/` : '/';

      document.querySelectorAll('nav a.nav-item[href]').forEach(a => {
        const href = a.getAttribute('href');
        if (!href) return;
        if (href.startsWith('#')) return;                 // Anclas internas
        if (/^https?:\/\//i.test(href)) return;          // Absolutos
        const clean = href.replace(/^\.?\//, '');        // Relativo normalizado
        a.setAttribute('href', base + clean);
      });
    })();
    </script>
  </body>
</html>

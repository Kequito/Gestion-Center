<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gesti√≥n Center ‚Äì PS Auto (Resumen por pa√≠s)</title>
  <link href="https://fonts.googleapis.com/css2?family=Lexend&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-app:#1c2a45; --bg-aside:#152035; --txt:#ffffff; --txt-muted:#cfd8dc; --hover:#1c2a45;
      --primary-color:#0d47a1; --accent-color:#42a5f5; --table-bg:#22314f; --table-border:#2f446a; --header-bg:#0d47a1;
      --green-color:#2e7d32; --red-color:#c62828; --orange-color:#f57c00;
    }
    body{ margin:0; font-family:'Lexend',sans-serif; background:var(--bg-app); color:var(--txt); display:flex; min-height:100vh; }
    aside{ background:var(--bg-aside); width:220px; height:100vh; padding:40px 20px; box-sizing:border-box; display:flex; flex-direction:column; position:fixed; left:0; top:0; }
    .logo{ font-size:22px; font-weight:700; margin-bottom:32px; text-align:center; line-height:1.2; }
    nav a{ color:var(--txt); margin:14px 0; text-decoration:none; font-size:15px; padding:10px 12px; border-radius:8px; transition:background-color .25s,transform .05s; display:flex; gap:10px; }
    nav a:hover{ background:var(--hover); }
    nav a.active{ background:var(--hover); box-shadow:inset 0 0 0 1px rgba(255,255,255,.12); }
    .spacer{ flex:1; }

    main{ margin-left:220px; padding:28px; width:calc(100% - 220px); box-sizing:border-box; }
    .page-title{ display:flex; align-items:center; gap:10px; font-size:24px; font-weight:700; margin:0 0 4px; }
    .subtitle{ margin:0 0 8px; color:var(--txt-muted); font-size:14px; display:flex; gap:10px; align-items:center; }
    .badge{ font-size:12px; padding:4px 8px; border-radius:999px; background:#334766; border:1px solid #2a3d5e; }
    .badge.ok{ background:#1b5e20; border-color:#1b5e20; }
    .badge.warn{ background:#8d2a2a; border-color:#8d2a2a; }

    .datetime{ font-size:14px; font-weight:600; margin:8px 0 6px; opacity:.9; }

    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 10px; align-items:center; }
    button{ padding:10px 14px; font-size:14px; cursor:pointer; border:none; border-radius:10px; background:var(--primary-color); color:#fff;
      box-shadow:0 2px 6px rgba(0,0,0,.25); transition:background .2s,transform .03s; }
    button:hover{ background:var(--accent-color); }
    button:active{ transform:translateY(1px); }
    button[disabled]{ opacity:.55; cursor:not-allowed; }

    .last-update{ font-size:13px; color:var(--txt-muted); margin:6px 0 8px; }
    .lock-msg{ font-size:12px; color:#ffd180; margin-left:6px; }

    textarea{ width:100%; min-height:160px; font-family:ui-monospace,Menlo,Consolas,monospace; padding:12px;
      border:1px solid var(--accent-color); background:var(--table-bg); color:var(--txt); border-radius:12px; }

    table{ margin-top:16px; border-collapse:separate; border-spacing:0; width:100%; background:var(--table-bg);
      border:1px solid var(--table-border); border-radius:12px; overflow:hidden; box-shadow:0 4px 10px rgba(0,0,0,.18); }
    th,td{ border-bottom:1px solid var(--table-border); padding:10px; text-align:center; }
    thead th{ background:var(--header-bg); color:#fff; }
    thead th:first-child, tbody td:first-child{ text-align:left; }
    tfoot td{ font-weight:800; background:rgba(66,165,245,.16); border-top:2px solid var(--table-border); }

    .flag{ width:20px; height:14px; margin-right:6px; vertical-align:middle; border-radius:2px; box-shadow:0 0 0 1px rgba(0,0,0,.15); }

    /* Colores intensos con borde */
    .green{ background:var(--green-color); border:1px solid var(--green-color); color:#fff; }
    .red{ background:var(--red-color); border:1px solid var(--red-color); color:#fff; }
    .orange{ background:var(--orange-color); border:1px solid var(--orange-color); color:#fff; }

    /* ---- Acciones e HIST√ìRICO ---- */
    .history-actions{ display:flex; gap:10px; flex-wrap:wrap; margin:14px 0 10px; justify-content:flex-start; }
    .filters{ display:flex; align-items:center; gap:22px; flex-wrap:wrap; background:rgba(255,255,255,.04); border:1px solid var(--table-border); border-radius:12px; padding:10px 12px; margin-top:8px; }
    .filter-group{ display:flex; align-items:center; gap:10px; }
    .filter-group label{ display:flex; align-items:center; gap:8px; font-weight:700; margin:0; }
    .filter-group select, .filter-group input[type="date"]{ padding:8px 12px; border-radius:10px; border:1px solid var(--primary-color); background:var(--table-bg); color:var(--txt); min-width:140px; line-height:1; height:38px; }
    .filter-group .clear-btn{ background:#344768; border:1px solid var(--table-border); }
    .filter-group .clear-btn:hover{ background:#3e577f; }

    /* M√©tricas r√°pidas */
    .quick-metrics{ display:flex; gap:10px; flex-wrap:wrap; margin:12px 0; }
    .metric{ background:rgba(255,255,255,.05); border:1px solid var(--table-border); padding:10px 12px; border-radius:10px; min-width:150px; }
    .metric .title{ font-size:12px; color:var(--txt-muted); margin-bottom:4px; }
    .metric .value{ font-size:18px; font-weight:800; }
    .metric .delta.up{ color:#76ff7a; }
    .metric .delta.down{ color:#ff9e9e; }

    #toast{ position:fixed; bottom:18px; right:20px; background:#222; color:#fff; padding:12px 18px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,.35); display:none; z-index:1000; }
  </style>
</head>
<body>
  <aside>
    <div class="logo">üß≠ Gesti√≥n Center</div>
    <nav>
        <a href="index.html">üè† Inicio</a>
        <a href="plandetrabajo.html">‚úÖ Plan de trabajo</a>
        <a href="distribucion.html">üìã Distribuci√≥n</a>
        <a href="estadisticas.html">üìà Estad√≠sticas</a>
        <a href="cobertura.html">üåé Cobertura</a>
        <a href="camprev.html">üë• Selector de Apoyo Ver 2.0</a>
        <a class="active" href="#">üöö Post-Sale New Report</a>
        <a href="opo11.html">üß∞ New Report CC Per√∫</a>
        <a href="#contacto">üì¨ Contacto</a>
    </nav>
    <div class="spacer"></div>
  </aside>

  <main>
    <div class="page-title">üöö Post-Sale Auto ‚Äì Resumen por pa√≠s</div>
    <p class="subtitle">
      Pega el bloque (tabulado) y genera la tabla ¬∑ Historial por hora compartido
      <span id="fbBadge" class="badge">Conectando‚Ä¶</span>
    </p>

    <div class="datetime" id="fechaHora"></div>

    <div class="toolbar">
      <button id="btnProcesar">‚öôÔ∏è Procesar</button>
      <button id="btnLimpiar">üßπ Limpiar</button>
      <button id="btnMapeo">üß≠ Cambiar mapeo</button>
      <button id="btnFuente" title="Abrir panel en nueva pesta√±a">üîó Fuente (Panel)</button>
      <button id="btnRegistrar">üìå Registrar ahora</button>
      <span id="lockMsg" class="lock-msg"></span>
    </div>

    <div class="last-update" id="lastUpdate">√öltima actualizaci√≥n: ‚Äî</div>

    <textarea id="input" placeholder="Pega aqu√≠ las filas con encabezados (Country, Description/Name, Number of operators, Capacity, Orders)‚Ä¶"></textarea>

    <table id="out">
      <thead>
        <tr>
          <th>Country</th>
          <th>Queues</th>
          <th>Number of operators</th>
          <th>Orders available</th>
          <th>Total orders</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td style="font-weight:800">TOTAL</td>
          <td></td>
          <td id="t_ops"></td>
          <td id="t_av"></td>
          <td id="t_tot"></td>
        </tr>
      </tfoot>
    </table>

    <div class="history-actions">
      <button id="btnExport">‚¨áÔ∏è Exportar hist√≥rico (CSV)</button>
    </div>

    <!-- Filtros (como en opo11) -->
    <div class="filters">
      <div class="filter-group">
        <label for="filtroPais">üåé Pa√≠s:</label>
        <select id="filtroPais">
          <option value="todos">üåç Todos</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="presetRango">üóìÔ∏è Rango:</label>
        <select id="presetRango">
          <option value="dia">D√≠a espec√≠fico</option>
          <option value="hoy">Hoy</option>
          <option value="ayer">Ayer</option>
          <option value="7d">√öltimos 7 d√≠as</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="filtroFecha">üìÖ Fecha:</label>
        <input type="date" id="filtroFecha"/>
        <button class="clear-btn" id="btnFechaTodos">Todos</button>
      </div>
    </div>

    <!-- M√©tricas r√°pidas (adaptadas a Orders available) -->
    <div id="quickMetrics" class="quick-metrics" style="display:none;">
      <div class="metric">
        <div class="title">Min Orders avail</div>
        <div id="mMin" class="value">‚Äì</div>
      </div>
      <div class="metric">
        <div class="title">Mediana Orders avail</div>
        <div id="mMed" class="value">‚Äì</div>
      </div>
      <div class="metric">
        <div class="title">Max Orders avail</div>
        <div id="mMax" class="value">‚Äì</div>
      </div>
      <div class="metric">
        <div class="title">Œî vs hora previa</div>
        <div id="mDelta" class="value">‚Äì</div>
      </div>
    </div>

    <h3 class="page-title" style="font-size:18px; margin-top:6px;">üìã Registro hist√≥rico por hora</h3>
    <table id="tablaHistorico">
      <thead>
        <tr>
          <th>Hora</th>
          <th>Fecha</th>
          <th>Pa√≠s</th>
          <th>Orders avail</th>
          <th>Total orders</th>
          <th>Ops</th>
          <th>Ult. act. datos</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <div id="toast"></div>

  <script type="module">
    /* ====== CONFIG EDITABLE ====== */
    const SOURCE_URL = "https://panel.2wcall.com/queue/control/index?QueueSearch%5Bid%5D=&QueueSearch%5Bname%5D=auto&QueueSearch%5Bpartner_id%5D=&QueueSearch%5Bcountry_id%5D%5B%5D=26&QueueSearch%5Bcountry_id%5D%5B%5D=88&QueueSearch%5Bcountry_id%5D%5B%5D=3&QueueSearch%5Bcountry_id%5D%5B%5D=39&QueueSearch%5Bpriorities%5D=&QueueSearch%5Btype_primary%5D=&QueueSearch%5Bis_primary%5D=0";
    const FIRE_COLLECTION_CURRENT = "psauto_current"; // doc √∫nico con el estado compartido
    const FIRE_DOC_ID            = "state";
    const FIRE_COLLECTION_HIST   = "psauto_history";  // hist√≥rico por hora

    /* ===== Firebase v12 (mismo stack que opo11) ===== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp,
             collection, addDoc, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCHBsq9AdVZEMVryQWReX7oaPparo9lK8M",
      authDomain: "gestioncenterdata.firebaseapp.com",
      projectId: "gestioncenterdata",
      storageBucket: "gestioncenterdata.firebasestorage.app",
      messagingSenderId: "628401314464",
      appId: "1:628401314464:web:0671233dfd801ee43587c5",
      measurementId: "G-NBFZYTN094"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const fbBadge = document.getElementById('fbBadge');
    const setBadge=(txt, cls='')=>{ fbBadge.textContent=txt; fbBadge.className='badge '+cls; }

    try{ await signInAnonymously(auth); }catch(e){ console.error(e); setBadge('Solo lectura (auth fall√≥)','warn'); toast('‚ö†Ô∏è Auth: '+(e.code||e.message)); }
    onAuthStateChanged(auth, (u)=> setBadge(u?'Conectado ‚úì':'Solo lectura', u?'ok':'') );

    /* ===== Utilidades ===== */
    const pad2=n=>String(n).padStart(2,'0');
    function nowStrings(){
      const d=new Date();
      const fecha=d.toLocaleDateString('es-PE',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
      const hora =d.toLocaleTimeString('es-PE',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
      return {fecha, hora, d};
    }
    function actualizarFechaHora(){ const {fecha,hora}=nowStrings(); document.getElementById('fechaHora').textContent=`üìÖ ${fecha} ‚Äì üïí ${hora}`; }
    actualizarFechaHora(); setInterval(actualizarFechaHora,1000);
    const toast=(msg)=>{ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; t.style.opacity=1; setTimeout(()=>{t.style.transition='opacity .5s'; t.style.opacity=0;},2200); setTimeout(()=>{t.style.display='none'; t.style.transition='';},2800); };

    /* ===== Elementos ===== */
    const input = document.getElementById('input');
    const tbody = document.querySelector('#out tbody');
    const t_ops = document.getElementById('t_ops');
    const t_av  = document.getElementById('t_av');
    const t_tot = document.getElementById('t_tot');
    const lastUpdateEl = document.getElementById('lastUpdate');
    const lockMsg = document.getElementById('lockMsg');

    document.getElementById('btnFuente').onclick = ()=> window.open(SOURCE_URL,'_blank');
    document.getElementById('btnMapeo').onclick  = ()=>{ MAP._alt=!MAP._alt; alert(MAP._alt?'Orders avail = Capacity (derecha)':'Orders avail = Capacity (izquierda)'); };
    document.getElementById('btnLimpiar').onclick = limpiar;
    document.getElementById('btnProcesar').onclick= procesar;
    document.getElementById('btnRegistrar').onclick= registrarManual;

    /* ===== Parsing ===== */
    let MAP = { queues:"Description|Name", operators:"Number of operators", capacity:"Capacity", orders:"Orders", _alt:false };

    const flagCode=(pais)=>({ "Chile":"cl","Ecuador":"ec","Mexico":"mx","Peru":"pe","Colombia":"co","Costa Rica":"cr","Paraguay":"py","Uruguay":"uy","Venezuela":"ve","Bolivia":"bo" }[pais]||"");
    const getIdx=(headers, names)=>{ const list=names.split('|').map(s=>s.trim().toLowerCase()); for(let i=0;i<headers.length;i++){ if(list.includes(headers[i].trim().toLowerCase())) return i; } return -1; }
    const num = x => { if(x==null) return 0; const m=String(x).match(/-?\d+/); return m?parseInt(m[0],10):0; };
    const pair=(text,splitter)=>{ const parts=String(text||'').split(splitter).map(t=>num(t)); return [parts[0]||0, parts[1]||0]; };
    const clase=(v)=> v<=0?'red': v<=5?'orange':'green';

    function limpiar(){
      input.value=''; tbody.innerHTML=''; t_ops.textContent=''; t_av.textContent=''; t_tot.textContent=''; lastUpdateEl.textContent='√öltima actualizaci√≥n: ‚Äî';
    }

    /* ===== Estado compartido ===== */
    let currentState = null;           // lo que mostramos
    let lastDataUpdateISO = null;      // ‚Äú√ölt. act. datos‚Äù
    let writeLockUntil = 0;            // bloqueo escritura

    const currentRef = doc(db, "psauto_current", "state");
    onSnapshot(currentRef, (snap)=>{
      if(!snap.exists()) return;
      const data=snap.data(); currentState=data; writeLockUntil=data.writeLockUntil||0;
      renderFromState(data); updateLockUI();
    });

    function updateLockUI(){
      const now=Date.now();
      if(now<writeLockUntil){
        const secs = Math.max(0, Math.ceil((writeLockUntil-now)/1000));
        lockMsg.textContent = `‚è≥ Bloqueo de escritura: ${secs}s`;
        document.getElementById('btnProcesar').disabled = true;
        document.getElementById('btnRegistrar').disabled = true;
      }else{
        lockMsg.textContent = '';
        document.getElementById('btnProcesar').disabled = false;
        document.getElementById('btnRegistrar').disabled = false;
      }
    }
    setInterval(updateLockUI, 500);

    function renderFromState(st){
      // Tabla principal
      tbody.innerHTML='';
      (st.rows||[]).forEach(row=>{
        const flag = row.code? `<img class="flag" src="https://flagcdn.com/w40/${row.code}.png" alt="">` : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${flag}${row.country}</strong></td>
          <td>${row.queues}</td>
          <td>${row.opsTxt || '‚Äì'}</td>
          <td class="${clase(row.ordersAvail)}">${row.ordersAvail}</td>
          <td class="${row.totalOrd===0?'red': (row.totalOrd<10?'orange':'green')}">${row.totalOrd}</td>
        `;
        tbody.appendChild(tr);
      });
      t_ops.textContent = `${st.totals?.opsL||0} | ${st.totals?.opsR||0}`;
      t_av.textContent  = st.totals?.avail||0;
      t_tot.textContent = st.totals?.orders||0;

      if(st.lastUpdatedISO){
        const d=new Date(st.lastUpdatedISO);
        const fecha=d.toLocaleDateString('es-PE',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
        const hora =d.toLocaleTimeString('es-PE',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
        lastUpdateEl.textContent = `√öltima actualizaci√≥n: ${fecha} ‚Äì ${hora}`;
      }
    }

    async function guardarEstadoCompartido(state){
      const now=Date.now();
      if(now < writeLockUntil){ toast('‚õî Bloqueado por 30s para evitar choques.'); return; }
      const newLock = now + 30_000;
      await setDoc(currentRef, { ...state, writeLockUntil:newLock, serverTS: serverTimestamp() });
      writeLockUntil = newLock; updateLockUI();
    }

    /* ===== Procesar pega ===== */
    function procesar(){
      const raw = input.value.trim();
      if(!raw){ toast('Pega el bloque con encabezados.'); return; }
      const lines = raw.split('\n').map(r=>r.split('\t'));
      const headers = lines[0]||[];

      const ixCountry = getIdx(headers, 'Country');
      const ixQueues  = getIdx(headers, MAP.queues);
      const ixOps     = getIdx(headers, MAP.operators);
      const ixCap     = getIdx(headers, MAP.capacity);
      const ixOrders  = getIdx(headers, MAP.orders);
      if([ixCountry,ixQueues,ixOps,ixCap,ixOrders].some(x=>x<0)){ toast('Faltan columnas (Country, Description/Name, Number of operators, Capacity, Orders).'); return; }

      const rows=[];
      let opsL=0, opsR=0, avail=0, orders=0;

      for(let i=1;i<lines.length;i++){
        const r=lines[i]; if(!r || !r.length) continue;
        const firstCell=(r[0]||'').trim(); if(firstCell==='‚ò∞') continue;

        const countryRaw=(r[ixCountry]||'').toString().trim();
        const queues=(r[ixQueues]||'').toString().trim();
        const opsTxt=(r[ixOps]||'').toString().trim();
        const capTxt=(r[ixCap]||'').toString().trim();
        const ordTxt=(r[ixOrders]||'').toString().trim();

        if(!(countryRaw && queues && capTxt && ordTxt)) continue;

        const country=countryRaw.replace(/^\s*\d+\.\s*/,'').trim();
        const cap=pair(capTxt,'->');
        const ord=pair(ordTxt,'|');
        const ordersAvail = MAP._alt? cap[1]: cap[0];
        const totalOrd = ord[0];

        const op = pair(opsTxt,'|'); opsL+=op[0]; opsR+=op[1];
        avail+=ordersAvail; orders+=totalOrd;

        rows.push({ country, queues, opsTxt, ordersAvail, totalOrd, code:flagCode(country) });
      }

      const state={
        rows,
        totals:{ opsL, opsR, avail, orders },
        lastUpdatedISO: new Date().toISOString(),  // ‚Äú√ölt. act. datos‚Äù
      };
      lastDataUpdateISO = state.lastUpdatedISO;

      renderFromState(state);
      guardarEstadoCompartido(state);
      toast('‚úÖ Datos procesados y compartidos.');
    }

    /* ===== Registro hist√≥rico ===== */
    function hhmm(d){ return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`; }
    function ddmmyyyy(d){ return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`; }

    async function registrarHistoricoAuto(){
      if(!currentState || !(currentState.rows||[]).length) return;
      const dNow = new Date();
      const ultimaActISO = lastDataUpdateISO || currentState.lastUpdatedISO || dNow.toISOString();
      const dAct = new Date(ultimaActISO);

      const batch = currentState.rows.map(row=>({
        fecha: ddmmyyyy(dNow),
        fechaISO: dNow.toISOString().slice(0,10),
        hora: hhmm(dNow),
        hora24: hhmm(dNow),
        ts: dNow.getTime(),
        pais: row.country,
        ordersAvail: row.ordersAvail,
        totalOrders: row.totalOrd,
        ops: row.opsTxt || '0 | 0',
        ultimaActualizacion: hhmm(dAct)
      }));

      try{
        const col = collection(db, FIRE_COLLECTION_HIST);
        await Promise.all(batch.map(b=>addDoc(col, b)));
        toast('üïí Hist√≥rico guardado.');
        renderHistoricoTabla();
      }catch(e){ console.error(e); toast('‚ö†Ô∏è No se pudo guardar hist√≥rico.'); }
    }
    function registrarManual(){ registrarHistoricoAuto(); }

    // Horarios programados: 07:15, luego 08:00 ‚Ä¶ 17:00
    const SLOTS = (()=> { const arr=[{h:7,m:15}]; for(let h=8;h<=17;h++) arr.push({h,m:0}); return arr; })();
    function msToNextSlot(){
      const now=new Date();
      for(const s of SLOTS){ const t=new Date(); t.setHours(s.h,s.m,0,0); if(t>now) return t-now; }
      const t=new Date(now); t.setDate(now.getDate()+1); t.setHours(7,15,0,0); return t-now;
    }
    function programarAutoSave(){ setTimeout(async ()=>{ await registrarHistoricoAuto(); programarAutoSave(); }, msToNextSlot()); }
    programarAutoSave();

    /* ====== FILTROS y M√âTRICAS (como en opo11) ====== */
    const filtroPaisEl   = document.getElementById('filtroPais');
    const filtroFechaEl  = document.getElementById('filtroFecha');
    const presetEl       = document.getElementById('presetRango');
    document.getElementById('btnFechaTodos').onclick = ()=>{ filtroFechaEl.value=""; renderHistoricoTabla(true); };

    document.getElementById('btnExport').onclick = exportarHistoricoCSV;

    const quickBox = document.getElementById('quickMetrics');
    const mMin = document.getElementById('mMin');
    const mMed = document.getElementById('mMed');
    const mMax = document.getElementById('mMax');
    const mDelta = document.getElementById('mDelta');

    function rangeFromPreset(preset, dateISO){
      const now=new Date();
      const todayISO = `${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}`;
      const startOf=(iso)=> new Date(`${iso}T00:00:00`).getTime();
      const addDays=(iso,days)=>{ const d=new Date(`${iso}T00:00:00`); d.setDate(d.getDate()+days); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; };
      if(preset==='hoy'){ const s=startOf(todayISO), e=startOf(addDays(todayISO,1)); return {start:s,end:e}; }
      if(preset==='ayer'){ const y=addDays(todayISO,-1); return {start:startOf(y),end:startOf(todayISO)}; }
      if(preset==='7d'){ const s=addDays(todayISO,-6); return {start:startOf(s),end:startOf(addDays(todayISO,1))}; }
      if(preset==='dia' && dateISO){ return {start:startOf(dateISO),end:startOf(addDays(dateISO,1))}; }
      return {start:null, end:null};
    }

    function ddmmyyyyToISO(s){ if(!s) return ""; const m=/^\s*(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})\s*$/.exec(s); if(!m) return ""; return `${m[3]}-${pad2(+m[2])}-${pad2(+m[1])}`; }
    function toHora24(str){
      if(!str) return "";
      let s=str.toString().trim().toLowerCase().replace(/\s+/g,'').replace(/[\.]/g,'');
      const m24=s.match(/^(\d{1,2}):(\d{2})$/); if(m24) return `${pad2(+m24[1])}:${pad2(+m24[2])}`;
      const m12=s.match(/^(\d{1,2}):(\d{2})(am|pm)$/);
      if(m12){ let h=+m12[1]%12, min=+m12[2]; if(m12[3]==='pm') h+=12; return `${pad2(h)}:${pad2(min)}`; }
      return str;
    }

    let cloudHistorico=[];
    function normalizeRows(rows){
      rows.forEach(r=>{
        const iso  = r.fechaISO || ddmmyyyyToISO(r.fecha);
        const hh   = r.hora24 || toHora24(r.hora);
        if(!r.ts && iso && hh){ r.ts = new Date(`${iso}T${hh}:00`).getTime(); }
        r.hora = hh || r.hora;
      });
      rows.sort((a,b)=>(a.ts||0)-(b.ts||0));
      return rows;
    }

    async function ensurePaisesOptions(){
      // a√±ade pa√≠ses vistos (del hist√≥rico y del estado actual)
      const set = new Set();
      try{
        const snap = await getDocs(collection(db, FIRE_COLLECTION_HIST));
        snap.forEach(d=>{ const p=d.data().pais; if(p) set.add(p); });
      }catch{}
      if(currentState && currentState.rows){ currentState.rows.forEach(r=>set.add(r.country)); }
      const existing = new Set([...filtroPaisEl.options].map(o=>o.value));
      [...set].forEach(p=>{ if(!existing.has(p)){ const o=document.createElement('option'); o.value=p; o.textContent=p; filtroPaisEl.appendChild(o); } });
    }

    async function fetchHistorico(fp, startTs, endTs){
      const base = collection(db, FIRE_COLLECTION_HIST);
      try{
        let qy;
        if(fp!=='todos' && startTs!=null && endTs!=null){
          qy = query(base, where('pais','==',fp), where('ts','>=',startTs), where('ts','<',endTs), orderBy('ts','asc'));
        }else if(startTs!=null && endTs!=null){
          qy = query(base, where('ts','>=',startTs), where('ts','<',endTs), orderBy('ts','asc'));
        }else if(fp!=='todos'){
          qy = query(base, where('pais','==',fp), orderBy('ts','asc'));
        }else{
          qy = query(base, orderBy('ts','asc'));
        }
        const snap=await getDocs(qy); const rows=[]; snap.forEach(d=>rows.push(d.data())); return normalizeRows(rows);
      }catch(e){
        // fallback sin orderBy (si falta √≠ndice)
        const snap=await getDocs(base); let rows=[]; snap.forEach(d=>rows.push(d.data()));
        if(startTs!=null && endTs!=null) rows=rows.filter(r=> (r.ts||0)>=startTs && (r.ts||0)<endTs);
        if(fp!=='todos') rows=rows.filter(r=> r.pais===fp);
        return normalizeRows(rows);
      }
    }

    function calcMedian(arr){
      if(!arr.length) return 0;
      const v=[...arr].sort((a,b)=>a-b);
      const m=Math.floor(v.length/2);
      return v.length%2?v[m]:(v[m-1]+v[m])/2;
    }

    function renderQuickMetricsFrom(rows){
      if(!rows.length){ quickBox.style.display='none'; return; }
      const vals = rows.map(r=>Number(r.ordersAvail||0));
      if(!vals.length){ quickBox.style.display='none'; return; }
      const min = Math.min(...vals);
      const med = calcMedian(vals);
      const max = Math.max(...vals);
      mMin.textContent = String(min);
      mMed.textContent = String(med);
      mMax.textContent = String(max);

      let deltaTxt='‚Äì', cls='';
      if(vals.length>=2){
        const d = (vals[vals.length-1] - vals[vals.length-2]);
        deltaTxt = `${d>=0?'‚Üë':'‚Üì'} ${Math.abs(d)}`;
        cls = d>=0? 'delta up':'delta down';
      }
      mDelta.className = 'value ' + cls;
      mDelta.textContent = deltaTxt;
      quickBox.style.display='flex';
    }

    async function renderHistoricoTabla(forceEnsure=false){
      if(forceEnsure) await ensurePaisesOptions();

      // Habilitar/deshabilitar datepicker por preset
      filtroFechaEl.disabled = (presetEl.value!=='dia');

      const {start, end} = rangeFromPreset(presetEl.value, filtroFechaEl.value || null);
      const tb = document.querySelector('#tablaHistorico tbody'); tb.innerHTML='';

      try{
        cloudHistorico = await fetchHistorico(filtroPaisEl.value, start, end);
      }catch(e){ console.error(e); toast("‚ö†Ô∏è No se pudo leer hist√≥rico: "+(e.code||e.message)); cloudHistorico=[]; }

      cloudHistorico.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${r.hora||''}</td>
          <td>${r.fecha||''}</td>
          <td>${r.pais||''}</td>
          <td>${r.ordersAvail??0}</td>
          <td>${r.totalOrders??0}</td>
          <td>${r.ops||'0 | 0'}</td>
          <td>${r.ultimaActualizacion||''}</td>
        `;
        tb.appendChild(tr);
      });

      renderQuickMetricsFrom(cloudHistorico);
    }

    filtroPaisEl.onchange   = ()=> renderHistoricoTabla();
    presetEl.onchange       = ()=> renderHistoricoTabla();
    filtroFechaEl.onchange  = ()=> renderHistoricoTabla();

    function exportarHistoricoCSV(){
      if(!cloudHistorico.length){ toast("‚ÑπÔ∏è No hay registros para exportar."); return; }
      const encabezados=["Fecha","Hora","Pa√≠s","Orders avail","Total orders","Ops","Ult. act. datos"];
      const filas=cloudHistorico.map(r=>[
        r.fecha||"", r.hora||"", r.pais||"", r.ordersAvail??0, r.totalOrders??0, r.ops||"0 | 0", r.ultimaActualizacion||""
      ]);
      const csv=[encabezados,...filas].map(row=>row.map(v=>`"${String(v??"").replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`psauto_historico_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    /* Inicializaci√≥n */
    document.getElementById('btnExport').disabled = false;
    renderHistoricoTabla(true);

  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gesti√≥n Center ‚Äì New Report CC Per√∫</title>
  <link href="https://fonts.googleapis.com/css2?family=Lexend&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-app:#1c2a45;
      --bg-aside:#152035;
      --txt:#ffffff;
      --txt-muted:#cfd8dc;
      --hover:#1c2a45;

      /* Paleta GC */
      --primary-color:#0d47a1;
      --accent-color:#42a5f5;
      --table-bg:#22314f;
      --table-border:#2f446a;
      --header-bg:#0d47a1;

      /* KPI */
      --green-color:#2e7d32;
      --red-color:#c62828;
      --orange-color:#f57c00;
    }

    body{
      margin:0;
      font-family:'Lexend',sans-serif;
      background:var(--bg-app);
      color:var(--txt);
      display:flex;
      min-height:100vh;
    }
    aside{
      background:var(--bg-aside);
      width:220px;height:100vh;padding:40px 20px;box-sizing:border-box;
      display:flex;flex-direction:column;position:fixed;left:0;top:0;
    }
    .logo{font-size:22px;font-weight:700;margin-bottom:32px;text-align:center;line-height:1.2;}
    nav a{
      color:var(--txt);margin:14px 0;text-decoration:none;font-size:15px;
      padding:10px 12px;border-radius:8px;transition:background-color .25s,transform .05s;
      display:flex;align-items:flex-start;gap:10px;width:100%;box-sizing:border-box;
      white-space:normal;line-height:1.2;overflow-wrap:anywhere;word-break:break-word;
    }
    nav a:hover{background:var(--hover);}
    nav a.active{background:var(--hover);box-shadow:inset 0 0 0 1px rgba(255,255,255,.12);}
    .spacer{flex:1;}

    main{margin-left:220px;padding:28px;width:calc(100% - 220px);box-sizing:border-box;}
    .page-title{display:flex;align-items:center;gap:12px;font-size:24px;font-weight:700;margin:0 0 6px;}
    .subtitle{margin:0 0 16px;color:var(--txt-muted);font-size:14px;}
    .datetime{font-size:14px;font-weight:600;margin:8px 0 14px;opacity:.9;}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 14px;}
    button{
      padding:10px 14px;font-size:14px;cursor:pointer;border:none;border-radius:10px;
      background:var(--primary-color);color:#fff;box-shadow:0 2px 6px rgba(0,0,0,.25);
      transition:background .2s,transform .03s;
    }
    button:hover{background:var(--accent-color);}
    button:active{transform:translateY(1px);}

    textarea{
      width:100%;min-height:150px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      padding:12px;border:1px solid var(--accent-color);background:var(--table-bg);color:var(--txt);
      border-radius:12px;box-sizing:border-box;
    }

    table{
      margin-top:16px;border-collapse:separate;border-spacing:0;width:100%;
      background:var(--table-bg);border:1px solid var(--table-border);
      border-radius:12px;overflow:hidden;box-shadow:0 4px 10px rgba(0,0,0,.18);
    }
    th,td{border-bottom:1px solid var(--table-border);padding:10px;text-align:center;}
    thead th{background:var(--header-bg);color:#fff;cursor:pointer;position:relative;}
    thead th:first-child,tbody td:first-child{text-align:left;}
    .bandera{width:20px;height:14px;margin-right:6px;vertical-align:middle;}
    .bold{font-weight:700;}

    .green{background:var(--green-color);color:#fff;}
    .red{background:var(--red-color);color:#fff;}
    .orange{background:var(--orange-color);color:#fff;}

    /* --- Filtros alineados --- */
    .filters{
      display:flex;align-items:center;gap:22px;flex-wrap:wrap;
      background:rgba(255,255,255,.04);
      border:1px solid var(--table-border);
      border-radius:12px;padding:10px 12px;margin-top:18px;
    }
    .filter-group{ display:flex;align-items:center;gap:10px; }
    .filter-group label{ display:flex;align-items:center;gap:8px;font-weight:700;margin:0; }
    .filter-group select{
      padding:8px 12px;border-radius:10px;border:1px solid var(--primary-color);
      background:var(--table-bg);color:var(--txt);min-width:140px;
      line-height:1;height:38px;
    }

    /* Acciones de hist√≥rico (posici√≥n actual: debajo de tabla principal) */
    .history-actions{
      display:flex;gap:10px;flex-wrap:wrap;margin:14px 0 10px;
      justify-content:flex-start;
    }

    #toast{
      position:fixed;bottom:18px;right:20px;background:#222;color:#fff;
      padding:12px 18px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.35);
      display:none;z-index:1000;
    }

    @media (max-width:960px){
      aside{width:200px;}
      main{margin-left:200px;width:calc(100% - 200px);}
    }
    @media (max-width:760px){
      aside{position:static;width:100%;height:auto;}
      main{margin-left:0;width:100%;}
      .filter-group select{min-width:120px;}
    }
  </style>
</head>
<body>
  <aside>
    <div class="logo">üß≠ Gesti√≥n Center</div>
    <nav>
      <a href="index.html">üè† Inicio</a>
      <a href="plandetrabajo.html">‚úÖ Plan de trabajo</a>
      <a href="distribucion.html">üìã Distribuci√≥n</a>
      <a href="estadisticas.html">üìà Estad√≠sticas</a>
      <a href="cobertura.html">üåé Cobertura</a>
      <a href="camprev.html">üë• Selector de Apoyo Ver 2.0</a>
      <a class="active" href="opo11.html">üß∞ New Report CC Per√∫</a>
      <a href="#contacto">üì¨ Contacto</a>
    </nav>
    <div class="spacer"></div>
  </aside>

  <main>
    <h1 class="page-title">üß∞ New Report CC Per√∫</h1>
    <p class="subtitle">Pega la tabla desde tu Panel y visualiza las m√©tricas por pa√≠s ¬∑ Vista num√©rica, porcentual o mixta ¬∑ Historial por hora + gr√°fico</p>

    <div class="datetime" id="fechaHora"></div>

    <div class="toolbar">
      <button onclick="procesar('numerico')">üì¶ Vista Num√©rica</button>
      <button onclick="procesar('porcentaje')">üìà Vista Porcentual</button>
      <button onclick="procesar('mixto')">üîÅ Vista Mixta</button>
      <button onclick="borrarTodo()">üßπ Borrar</button>
      <button onclick="restablecerOrden()">üß≠ Restablecer Orden</button>
    </div>

    <textarea id="inputData" placeholder="Pega aqu√≠ tu tabla con encabezados (Country, Total, New, Recall, No answer, Call center (approved), Reject, Trash)‚Ä¶"></textarea>

    <!-- Tabla principal -->
    <table id="tablaReporte">
      <thead><tr id="encabezadoTabla"></tr></thead>
      <tbody></tbody>
    </table>

    <!-- üîΩ Botones de hist√≥rico: AHORA debajo de la tabla principal -->
    <div class="history-actions">
      <button onclick="registrarAvance()">üìå Registrar avance ahora</button>
      <button onclick="borrarHistorial()">üóëÔ∏è Borrar historial</button>
    </div>

    <!-- Filtros hist√≥rico, alineados -->
    <div class="filters">
      <div class="filter-group">
        <label for="filtroPais">üåé Filtrar por pa√≠s:</label>
        <select id="filtroPais" onchange="renderTablaHistorico()">
          <option value="todos">üåç Todos</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="filtroFecha">üìÖ Filtrar por d√≠a:</label>
        <select id="filtroFecha" onchange="renderTablaHistorico()">
          <option value="todos">üìÜ Todos</option>
        </select>
      </div>
    </div>

    <h3 class="page-title" style="font-size:18px; margin-top:10px;">üìã Registro hist√≥rico por hora</h3>
    <table id="tablaHistorico">
      <thead>
        <tr>
          <th>Hora</th><th>Pa√≠s</th><th>Leads</th><th>News</th><th>Recall</th>
          <th>No Answer</th><th>Approve</th><th>% Approve</th><th>Reject</th><th>Trash</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <canvas id="graficoAvance" height="220"></canvas>
  </main>

  <div id="toast"></div>

  <script>
    // Fecha y hora (Lima)
    function actualizarFechaHora(){
      const ahora=new Date();
      const fecha=ahora.toLocaleDateString('es-PE',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
      const hora =ahora.toLocaleTimeString('es-PE',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
      document.getElementById('fechaHora').textContent=`üìÖ ${fecha} ‚Äì üïí ${hora}`;
    }
    actualizarFechaHora(); setInterval(actualizarFechaHora,1000);

    // ====== L√ìGICA ======
    let vistaActual='numerico';
    let dataGlobal={};
    let dataOriginal=[];
    let estadoOrdenColumna={};
    let columnaOrdenActual=null;

    const codigos={ "Chile":"cl","Colombia":"co","Costa Rica":"cr","Ecuador":"ec","Mexico":"mx","Paraguay":"py","Peru":"pe","Uruguay":"uy","Venezuela":"ve" };

    function mostrarToast(msg){
      const t=document.getElementById("toast");
      t.textContent=msg; t.style.display="block"; t.style.opacity=1;
      setTimeout(()=>{t.style.transition="opacity .5s"; t.style.opacity=0;},2400);
      setTimeout(()=>{t.style.display="none"; t.style.transition="";},3000);
    }

    function borrarTodo(){
      document.getElementById("inputData").value="";
      document.querySelector("#tablaReporte tbody").innerHTML="";
      document.querySelector("#encabezadoTabla").innerHTML="";
      dataGlobal={}; dataOriginal=[]; estadoOrdenColumna={}; columnaOrdenActual=null;
    }

    function procesar(vista){
      vistaActual=vista; estadoOrdenColumna={}; columnaOrdenActual=null;
      const input=document.getElementById("inputData").value.trim();
      if(!input) return;

      const filas=input.split("\n");
      const headers=filas[0].split("\t");
      const idx=(c)=>headers.indexOf(c);

      dataGlobal={};
      for(let i=1;i<filas.length;i++){
        const f=filas[i].split("\t");
        const pais=f[idx("Country")];
        if(!pais) continue;
        if(!dataGlobal[pais]) dataGlobal[pais]={total:0,news:0,recall:0,noAnswer:0,approved:0,reject:0,trash:0};

        dataGlobal[pais].total    += parseInt(f[idx("Total")]) || 0;
        dataGlobal[pais].news     += parseInt(f[idx("New")]) || 0;
        dataGlobal[pais].recall   += parseInt(f[idx("Recall")]) || 0;
        dataGlobal[pais].noAnswer += parseInt(f[idx("No answer")]) || 0;
        dataGlobal[pais].approved += parseInt(f[idx("Call center (approved)")]) || 0;
        dataGlobal[pais].reject   += parseInt(f[idx("Reject")]) || 0;
        dataGlobal[pais].trash    += parseInt(f[idx("Trash")]) || 0;
      }

      dataOriginal = Object.entries(dataGlobal);
      renderTabla();
      mostrarToast("‚úÖ Datos procesados");
    }

    function renderTabla(){
      const enc=document.getElementById("encabezadoTabla");
      const cuerpo=document.querySelector("#tablaReporte tbody");
      enc.innerHTML=""; cuerpo.innerHTML="";

      let cols=["Pa√≠s","Leads"];
      if(vistaActual==="numerico"){
        cols.push("New","Recall","No Answer","Approve","Reject","Trash");
      }else if(vistaActual==="porcentaje"){
        cols.push("% New","% Recall","% No Answer","% Approve","% Reject","% Trash");
      }else{
        cols.push("New","% New","Recall","% Recall","No Answer","% No Answer","Approve","% Approve","Reject","% Reject","Trash","% Trash");
      }

      // Encabezados SIN iconos de orden (solo sigue siendo clickable)
      cols.forEach((col)=>{
        const th=document.createElement("th"); th.textContent=col;
        if(col!=="Pa√≠s"){ th.style.cursor="pointer"; th.onclick=()=>cambiarOrdenColumna(col); }
        enc.appendChild(th);
      });

      let datos=[...dataOriginal];
      if(columnaOrdenActual){
        const estado=estadoOrdenColumna[columnaOrdenActual]||0;
        datos.sort((a,b)=>{
          const A=getValorOrdenable(a[1],columnaOrdenActual);
          const B=getValorOrdenable(b[1],columnaOrdenActual);
          if(estado===1) return B-A;   // desc
          if(estado===2) return A-B;   // asc
          return 0;
        });
      }

      const flag=(p)=>codigos[p]?`<img class="bandera" src="https://flagcdn.com/w40/${codigos[p]}.png" alt="">`:"";

      for(const [pais,d] of datos){
        const t=d.total||1;
        const tr=document.createElement("tr");
        let html=`<td class="bold">${flag(pais)} ${pais}</td><td>${d.total}</td>`;
        if(vistaActual==="numerico"){
          html+=`<td>${d.news}</td><td>${d.recall}</td><td>${d.noAnswer}</td><td>${d.approved}</td><td>${d.reject}</td><td>${d.trash}</td>`;
        }else if(vistaActual==="porcentaje"){
          html+=`
            <td>${pct(d.news,t)}</td>
            <td>${pct(d.recall,t)}</td>
            <td>${pct(d.noAnswer,t)}</td>
            <td class="${colorPct(d.approved/t*100)}">${pct(d.approved,t)}</td>
            <td>${pct(d.reject,t)}</td>
            <td>${pct(d.trash,t)}</td>`;
        }else{
          html+=`
            <td>${d.news}</td><td>${pct(d.news,t)}</td>
            <td>${d.recall}</td><td>${pct(d.recall,t)}</td>
            <td>${d.noAnswer}</td><td>${pct(d.noAnswer,t)}</td>
            <td>${d.approved}</td><td class="${colorPct(d.approved/t*100)}">${pct(d.approved,t)}</td>
            <td>${d.reject}</td><td>${pct(d.reject,t)}</td>
            <td>${d.trash}</td><td>${pct(d.trash,t)}</td>`;
        }
        tr.innerHTML=html; cuerpo.appendChild(tr);
      }
    }

    function cambiarOrdenColumna(col){
      estadoOrdenColumna[col]=(estadoOrdenColumna[col]||0)+1;
      if(estadoOrdenColumna[col]>2) estadoOrdenColumna[col]=0;
      columnaOrdenActual=estadoOrdenColumna[col]===0?null:col;
      renderTabla();
    }
    function restablecerOrden(){ estadoOrdenColumna={}; columnaOrdenActual=null; renderTabla(); }

    function getValorOrdenable(d,col){
      const t=d.total||1;
      const base={
        "Leads":d.total,
        "New":d.news, "% New":(d.news/t)*100,
        "Recall":d.recall, "% Recall":(d.recall/t)*100,
        "No Answer":d.noAnswer, "% No Answer":(d.noAnswer/t)*100,
        "Approve":d.approved, "% Approve":(d.approved/t)*100,
        "Reject":d.reject, "% Reject":(d.reject/t)*100,
        "Trash":d.trash, "% Trash":(d.trash/t)*100
      };
      return base[col]||0;
    }
    function pct(v,t){ return ((v/t)*100).toFixed(1)+"%"; }
    function colorPct(p){ return p<=25?"red":p>=30?"green":"orange"; }

    // ====== HIST√ìRICO & CHART ======
    let historico=JSON.parse(localStorage.getItem('historicoAvance'))||[];

    function borrarHistorial(){
      if(confirm("¬øBorrar todo el historial guardado?")){
        localStorage.removeItem('historicoAvance'); historico=[];
        renderTablaHistorico(); renderGrafico(); mostrarToast("üóëÔ∏è Historial borrado.");
      }
    }
    function registrarAvance(){
      if(!Object.keys(dataGlobal).length){ mostrarToast("‚ÑπÔ∏è Procesa datos antes de registrar."); return; }
      const now=new Date();
      const hora=now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
      const fecha=now.toLocaleDateString('es-PE');
      for(const [pais,d] of Object.entries(dataGlobal)){
        const total=d.total||1;
        historico.push({
          fecha,hora,pais,leads:d.total,news:d.news,recall:d.recall,noAnswer:d.noAnswer,
          approve:d.approved,pctApprove:((d.approved/total)*100).toFixed(1),
          reject:d.reject,trash:d.trash
        });
      }
      localStorage.setItem('historicoAvance',JSON.stringify(historico));
      renderTablaHistorico(); renderGrafico(); mostrarToast("‚úÖ Avance registrado.");
    }

    function renderTablaHistorico(){
      const fp=document.getElementById("filtroPais").value;
      const ff=document.getElementById("filtroFecha").value;
      const tbody=document.querySelector("#tablaHistorico tbody");
      tbody.innerHTML="";

      const paises=[...new Set(historico.map(r=>r.pais))];
      const sp=document.getElementById("filtroPais");
      if(sp.options.length===1){ paises.forEach(p=>{const o=document.createElement("option");o.value=p;o.textContent=p;sp.appendChild(o);}); }

      const fechas=[...new Set(historico.map(r=>r.fecha))];
      const sf=document.getElementById("filtroFecha");
      if(sf.options.length===1){ fechas.forEach(f=>{const o=document.createElement("option");o.value=f;o.textContent=f;sf.appendChild(o);}); }

      historico.forEach(r=>{
        if((fp!=="todos"&&r.pais!==fp)||(ff!=="todos"&&r.fecha!==ff)) return;
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${r.hora}</td><td>${r.pais}</td><td>${r.leads}</td><td>${r.news}</td><td>${r.recall}</td><td>${r.noAnswer}</td><td>${r.approve}</td><td>${Number(r.pctApprove).toFixed(1)}%</td><td>${r.reject}</td><td>${r.trash}</td>`;
        tbody.appendChild(tr);
      });
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    function renderGrafico(){
      const ctx=document.getElementById('graficoAvance').getContext('2d');
      const agrupado={};
      historico.forEach(r=>{
        if(!agrupado[r.pais]) agrupado[r.pais]=[];
        agrupado[r.pais].push({hora:r.hora,pct:r.pctApprove});
      });
      const datasets=Object.keys(agrupado).map(pais=>({
        label:pais,
        data:agrupado[pais].map(p=>({x:p.hora,y:p.pct})),
        fill:false,
        tension:.2
      }));
      if(window.graficoAvance) window.graficoAvance.destroy();
      window.graficoAvance=new Chart(ctx,{
        type:'line',
        data:{datasets},
        options:{
          responsive:true,
          plugins:{legend:{position:'top'}},
          scales:{
            x:{title:{display:true,text:'Hora'},type:'category'},
            y:{title:{display:true,text:'% Approve'},beginAtZero:true,max:100}
          }
        }
      });
    }
    renderTablaHistorico(); renderGrafico();
  </script>
</body>
</html>

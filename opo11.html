<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gesti√≥n Center ‚Äì New Report CC Per√∫</title>
  <link href="https://fonts.googleapis.com/css2?family=Lexend&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-app:#1c2a45; --bg-aside:#152035; --txt:#ffffff; --txt-muted:#cfd8dc; --hover:#1c2a45;
      --primary-color:#0d47a1; --accent-color:#42a5f5; --table-bg:#22314f; --table-border:#2f446a; --header-bg:#0d47a1;
      --green-color:#2e7d32; --red-color:#c62828; --orange-color:#f57c00;
    }
    body{ margin:0; font-family:'Lexend',sans-serif; background:var(--bg-app); color:var(--txt); display:flex; min-height:100vh; }
    aside{ background:var(--bg-aside); width:220px; height:100vh; padding:40px 20px; box-sizing:border-box; display:flex; flex-direction:column; position:fixed; left:0; top:0; }
    .logo{ font-size:22px; font-weight:700; margin-bottom:32px; text-align:center; line-height:1.2; }
    nav a{ color:var(--txt); margin:14px 0; text-decoration:none; font-size:15px; padding:10px 12px; border-radius:8px; transition:background-color .25s,transform .05s; display:flex; align-items:flex-start; gap:10px; width:100%; box-sizing:border-box; white-space:normal; line-height:1.2; overflow-wrap:anywhere; word-break:break-word; }
    nav a:hover{ background:var(--hover); }
    nav a.active{ background:var(--hover); box-shadow:inset 0 0 0 1px rgba(255,255,255,.12); }
    .spacer{ flex:1; }

    main{ margin-left:220px; padding:28px; width:calc(100% - 220px); box-sizing:border-box; }
    .page-title{ display:flex; align-items:center; gap:12px; font-size:24px; font-weight:700; margin:0 0 4px; }
    .subtitle{ margin:0 0 8px; color:var(--txt-muted); font-size:14px; display:flex; align-items:center; gap:10px; }
    .badge{ font-size:12px; padding:4px 8px; border-radius:999px; background:#334766; border:1px solid #2a3d5e; }
    .badge.ok{ background:#1b5e20; border-color:#1b5e20; }
    .badge.warn{ background:#8d2a2a; border-color:#8d2a2a; }

    .datetime{ font-size:14px; font-weight:600; margin:8px 0 14px; opacity:.9; }

    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 14px; }
    button{ padding:10px 14px; font-size:14px; cursor:pointer; border:none; border-radius:10px; background:var(--primary-color); color:#fff; box-shadow:0 2px 6px rgba(0,0,0,.25); transition:background .2s,transform .03s; }
    button:hover{ background:var(--accent-color); }
    button:active{ transform:translateY(1px); }
    button[disabled]{ opacity:.55; cursor:not-allowed; }

    textarea{ width:100%; min-height:150px; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; padding:12px; border:1px solid var(--accent-color); background:var(--table-bg); color:var(--txt); border-radius:12px; box-sizing:border-box; }

    table{ margin-top:16px; border-collapse:separate; border-spacing:0; width:100%; background:var(--table-bg); border:1px solid var(--table-border); border-radius:12px; overflow:hidden; box-shadow:0 4px 10px rgba(0,0,0,.18); }
    th,td{ border-bottom:1px solid var(--table-border); padding:10px; text-align:center; }
    thead th{ background:var(--header-bg); color:#fff; cursor:pointer; position:relative; }
    thead th:first-child, tbody td:first-child{ text-align:left; }
    .bandera{ width:20px; height:14px; margin-right:6px; vertical-align:middle; }
    .bold{ font-weight:700; }

    .green{ background:var(--green-color); color:#fff; }
    .red{ background:var(--red-color); color:#fff; }
    .orange{ background:var(--orange-color); color:#fff; }

    tfoot td{ font-weight:800; background:rgba(66,165,245,.16); border-top:2px solid var(--table-border); }

    .filters{ display:flex; align-items:center; gap:22px; flex-wrap:wrap; background:rgba(255,255,255,.04); border:1px solid var(--table-border); border-radius:12px; padding:10px 12px; margin-top:18px; }
    .filter-group{ display:flex; align-items:center; gap:10px; }
    .filter-group label{ display:flex; align-items:center; gap:8px; font-weight:700; margin:0; }
    .filter-group select, .filter-group input[type="date"]{ padding:8px 12px; border-radius:10px; border:1px solid var(--primary-color); background:var(--table-bg); color:var(--txt); min-width:140px; line-height:1; height:38px; }
    .filter-group .clear-btn{ background:#344768; border:1px solid var(--table-border); }
    .filter-group .clear-btn:hover{ background:#3e577f; }

    .history-actions{ display:flex; gap:10px; flex-wrap:wrap; margin:14px 0 10px; justify-content:flex-start; }

    /* M√©tricas r√°pidas */
    .quick-metrics{ display:flex; gap:10px; flex-wrap:wrap; margin:12px 0; }
    .metric{ background:rgba(255,255,255,.05); border:1px solid var(--table-border); padding:10px 12px; border-radius:10px; min-width:150px; }
    .metric .title{ font-size:12px; color:var(--txt-muted); margin-bottom:4px; }
    .metric .value{ font-size:18px; font-weight:800; }
    .metric .delta.up{ color:#76ff7a; }
    .metric .delta.down{ color:#ff9e9e; }

    #toast{ position:fixed; bottom:18px; right:20px; background:#222; color:#fff; padding:12px 18px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,.35); display:none; z-index:1000; }
  </style>
</head>
<body>
  <aside>
    <div class="logo">üß≠ Gesti√≥n Center</div>
    <nav>
      <a href="index.html">üè† Inicio</a>
      <a href="plandetrabajo.html">‚úÖ Plan de trabajo</a>
      <a href="distribucion.html">üìã Distribuci√≥n</a>
      <a href="estadisticas.html">üìà Estad√≠sticas</a>
      <a href="cobertura.html">üåé Cobertura</a>
      <a href="camprev.html">üë• Selector de Apoyo Ver 2.0</a>
      <a class="active" href="opo11.html">üß∞ New Report CC Per√∫</a>
      <a href="#contacto">üì¨ Contacto</a>
    </nav>
    <div class="spacer"></div>
  </aside>

  <main>
    <div class="page-title">üß∞ New Report CC Per√∫</div>
    <p class="subtitle">
      Pega la tabla desde tu Panel y visualiza las m√©tricas ¬∑ Historial por hora compartido
      <span id="fbBadge" class="badge">Conectando‚Ä¶</span>
    </p>

    <div class="datetime" id="fechaHora"></div>

    <div class="toolbar">
      <button onclick="procesar('numerico')">üì¶ Vista Num√©rica</button>
      <button onclick="procesar('porcentaje')">üìà Vista Porcentual</button>
      <button onclick="procesar('mixto')">üîÅ Vista Mixta</button>
      <button onclick="borrarTodo()">üßπ Borrar</button>
      <button onclick="restablecerOrden()">üß≠ Restablecer Orden</button>
    </div>

    <textarea id="inputData" placeholder="Pega aqu√≠ tu tabla con encabezados (Country, Total, New, Recall, No answer, Approved, Reject, Trash)‚Ä¶"></textarea>

    <table id="tablaReporte">
      <thead><tr id="encabezadoTabla"></tr></thead>
      <tbody></tbody>
      <tfoot><tr id="filaTotales"></tr></tfoot>
    </table>

    <div class="history-actions">
      <button id="btnRegistrar" onclick="registrarAvance()" disabled>üìå Registrar avance ahora</button>
      <button onclick="borrarHistorial()">üóëÔ∏è Borrar historial</button>
      <button onclick="exportarHistoricoCSV()">‚¨áÔ∏è Exportar hist√≥rico (CSV)</button>
    </div>

    <!-- Filtros -->
    <div class="filters">
      <div class="filter-group">
        <label for="filtroPais">üåé Pa√≠s:</label>
        <select id="filtroPais" onchange="onFiltroChange()">
          <option value="todos">üåç Todos</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="presetRango">üóìÔ∏è Rango:</label>
        <select id="presetRango" onchange="onPresetChange()">
          <option value="dia">D√≠a espec√≠fico</option>
          <option value="hoy">Hoy</option>
          <option value="ayer">Ayer</option>
          <option value="7d">√öltimos 7 d√≠as</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="filtroFecha">üìÖ Fecha:</label>
        <input type="date" id="filtroFecha" onchange="onFiltroChange()"/>
        <button class="clear-btn" onclick="limpiarFecha()">Todos</button>
      </div>
    </div>

    <!-- M√©tricas r√°pidas -->
    <div id="quickMetrics" class="quick-metrics" style="display:none;">
      <div class="metric">
        <div class="title">Min % Approve</div>
        <div id="mMin" class="value">‚Äì</div>
      </div>
      <div class="metric">
        <div class="title">Mediana % Approve</div>
        <div id="mMed" class="value">‚Äì</div>
      </div>
      <div class="metric">
        <div class="title">Max % Approve</div>
        <div id="mMax" class="value">‚Äì</div>
      </div>
      <div class="metric">
        <div class="title">Œî vs hora previa</div>
        <div id="mDelta" class="value">‚Äì</div>
      </div>
    </div>

    <h3 class="page-title" style="font-size:18px; margin-top:6px;">üìã Registro hist√≥rico por hora</h3>
    <table id="tablaHistorico">
      <thead>
        <tr>
          <th>Hora</th>
          <th>Fecha</th>
          <th>Pa√≠s</th>
          <th>Leads</th>
          <th>News</th>
          <th>Recall</th>
          <th>No Answer</th>
          <th>Approve</th>
          <th>% Approve</th>
          <th>Reject</th>
          <th>Trash</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <canvas id="graficoAvance" height="220"></canvas>
  </main>

  <div id="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="module">
    /* ===== Firebase v12 ===== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCHBsq9AdVZEMVryQWReX7oaPparo9lK8M",
      authDomain: "gestioncenterdata.firebaseapp.com",
      projectId: "gestioncenterdata",
      storageBucket: "gestioncenterdata.firebasestorage.app",
      messagingSenderId: "628401314464",
      appId: "1:628401314464:web:0671233dfd801ee43587c5",
      measurementId: "G-NBFZYTN094"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const fbBadge = document.getElementById('fbBadge');
    function setBadge(txt, cls=''){ fbBadge.textContent = txt; fbBadge.className = 'badge ' + cls; }

    (async ()=>{
      try{ await signInAnonymously(auth); }
      catch(e){ console.error('Auth error', e); setBadge('Solo lectura (auth fall√≥)','warn'); mostrarToast('‚ö†Ô∏è Autenticaci√≥n: ' + (e.code||e.message)); }
    })();
    onAuthStateChanged(auth, (u)=>{
      if(u){ document.getElementById('btnRegistrar')?.removeAttribute('disabled'); setBadge('Conectado ‚úì','ok'); }
      else setBadge('Solo lectura','');
    });

    /* ===== Utils ===== */
    const PREF_VISTA='gc_vista', PREF_ORDEN='gc_orden', PREF_FPAIS='gc_filtro_pais',
          PREF_FFECHA='gc_filtro_fecha_iso', PREF_PRESET='gc_preset_rango';
    const savePref=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
    const readPref=(k,d=null)=>{ try{const v=JSON.parse(localStorage.getItem(k)); return v??d;}catch{ return d;} };

    const pad2=n=>String(n).padStart(2,'0');
    const formatDDMMYYYY=d=>`${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
    const formatISO=d=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;

    function ddmmyyyyToISO(s){ if(!s) return ""; if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      const m=/^\s*(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})\s*$/.exec(s); if(!m) return ""; return `${m[3]}-${pad2(+m[2])}-${pad2(+m[1])}`; }

    function toHora24(str){
      if(!str) return "";
      let s=str.toString().trim().toLowerCase().replace(/\s+/g,'').replace(/[\.]/g,'');
      const m24=s.match(/^(\d{1,2}):(\d{2})$/); if(m24) return `${pad2(+m24[1])}:${pad2(+m24[2])}`;
      const m12=s.match(/^(\d{1,2}):(\d{2})(am|pm)$/);
      if(m12){ let h=+m12[1]%12, min=+m12[2]; if(m12[3]==='pm') h+=12; return `${pad2(h)}:${pad2(min)}`; }
      return str;
    }

    function actualizarFechaHora(){
      const ahora=new Date();
      const fecha=ahora.toLocaleDateString('es-PE',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
      const hora =ahora.toLocaleTimeString('es-PE',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
      document.getElementById('fechaHora').textContent=`üìÖ ${fecha} ‚Äì üïí ${hora}`;
    }
    actualizarFechaHora(); setInterval(actualizarFechaHora,1000);

    let vistaActual=readPref(PREF_VISTA,'numerico'), dataGlobal={}, dataOriginal=[], estadoOrdenColumna=readPref(PREF_ORDEN,{}), columnaOrdenActual=null;

    const codigos={ "Chile":"cl","Colombia":"co","Costa Rica":"cr","Ecuador":"ec","Mexico":"mx","Paraguay":"py","Peru":"pe","Uruguay":"uy","Venezuela":"ve","Bolivia":"bo" };
    function mostrarToast(msg){ const t=document.getElementById("toast"); t.textContent=msg; t.style.display="block"; t.style.opacity=1; setTimeout(()=>{t.style.transition="opacity .5s"; t.style.opacity=0;},2600); setTimeout(()=>{t.style.display="none"; t.style.transition="";},3200); }

    const COLMAP={ country:["Country"], total:["Total"], news:["New"], recall:["Recall"], noAnswer:["No answer","No Answer"], approved:["Approved","Call center (approved)","Call center approved"], reject:["Reject"], trash:["Trash"] };

    function borrarTodo(){ document.getElementById("inputData").value=""; document.querySelector("#tablaReporte tbody").innerHTML=""; document.querySelector("#encabezadoTabla").innerHTML=""; document.querySelector("#filaTotales").innerHTML=""; dataGlobal={}; dataOriginal=[]; estadoOrdenColumna={}; columnaOrdenActual=null; savePref(PREF_ORDEN,{}); }

    function procesar(vista){
      vistaActual=vista; savePref(PREF_VISTA,vista); estadoOrdenColumna={}; savePref(PREF_ORDEN,{}); columnaOrdenActual=null;
      const input=document.getElementById("inputData").value.trim(); if(!input){ mostrarToast("Pega la tabla del panel para procesar."); return; }
      const filas=input.split("\n"), headersRaw=filas[0].split("\t").map(h=>h.trim()), headersLC=headersRaw.map(h=>h.toLowerCase());
      const idx=(names)=> (Array.isArray(names)?names:[names]).reduce((r,n)=> r>=0?r:(headersRaw.indexOf(n)>=0?headersRaw.indexOf(n):headersLC.indexOf(n.toLowerCase())), -1);
      const IDX={ country:idx(COLMAP.country), total:idx(COLMAP.total), news:idx(COLMAP.news), recall:idx(COLMAP.recall), noAnswer:idx(COLMAP.noAnswer), approved:idx(COLMAP.approved), reject:idx(COLMAP.reject), trash:idx(COLMAP.trash) };
      if(IDX.country===-1||IDX.total===-1){ mostrarToast("‚ö†Ô∏è Falta Country/Total."); return; }
      if(IDX.approved===-1){ mostrarToast("‚ÑπÔ∏è No encuentro ‚ÄòApproved‚Äô; usar√© 0."); }
      dataGlobal={};
      for(let i=1;i<filas.length;i++){
        const f=filas[i].split("\t"), pais=(f[IDX.country]||"").trim(); if(!pais) continue;
        if(!dataGlobal[pais]) dataGlobal[pais]={total:0,news:0,recall:0,noAnswer:0,approved:0,reject:0,trash:0};
        const val=j=> j===-1?0:(parseInt(f[j])||0);
        dataGlobal[pais].total+=val(IDX.total); dataGlobal[pais].news+=val(IDX.news); dataGlobal[pais].recall+=val(IDX.recall); dataGlobal[pais].noAnswer+=val(IDX.noAnswer); dataGlobal[pais].approved+=val(IDX.approved); dataGlobal[pais].reject+=val(IDX.reject); dataGlobal[pais].trash+=val(IDX.trash);
      }
      dataOriginal=Object.entries(dataGlobal);
      renderTabla(); mostrarToast("‚úÖ Datos procesados");
    }

    function renderTabla(){
      const enc=document.getElementById("encabezadoTabla"), cuerpo=document.querySelector("#tablaReporte tbody"), tfoot=document.getElementById("filaTotales");
      enc.innerHTML=""; cuerpo.innerHTML=""; tfoot.innerHTML="";
      let cols=["Pa√≠s","Leads"];
      if(vistaActual==="numerico"){ cols.push("New","Recall","No Answer","Approve","Reject","Trash");
      }else if(vistaActual==="porcentaje"){ cols.push("% New","% Recall","% No Answer","% Approve","% Reject","% Trash");
      }else{ cols.push("New","% New","Recall","% Recall","No Answer","% No Answer","Approve","% Approve","Reject","% Reject","Trash","% Trash"); }
      cols.forEach(col=>{ const th=document.createElement("th"); th.textContent=col; if(col!=="Pa√≠s"){ th.onclick=()=>cambiarOrdenColumna(col);} enc.appendChild(th); });
      let datos=[...dataOriginal];
      if(columnaOrdenActual){ const e=estadoOrdenColumna[columnaOrdenActual]||0; datos.sort((a,b)=>{ const A=getValorOrdenable(a[1],columnaOrdenActual), B=getValorOrdenable(b[1],columnaOrdenActual); return e===1?B-A:e===2?A-B:0; }); }
      const flag=p=>codigos[p]?`<img class="bandera" src="https://flagcdn.com/w40/${codigos[p]}.png" alt="">`:"";
      for(const [pais,d] of datos){
        const t=d.total||1;
        const tr=document.createElement("tr");
        let html=`<td class="bold">${flag(pais)} ${pais}</td><td>${d.total}</td>`;
        if(vistaActual==="numerico"){ html+=`<td>${d.news}</td><td>${d.recall}</td><td>${d.noAnswer}</td><td>${d.approved}</td><td>${d.reject}</td><td>${d.trash}</td>`;
        }else if(vistaActual==="porcentaje"){ html+=`<td>${pct(d.news,t)}</td><td>${pct(d.recall,t)}</td><td>${pct(d.noAnswer,t)}</td><td class="${colorPct(d.approved/t*100)}">${pct(d.approved,t)}</td><td>${pct(d.reject,t)}</td><td>${pct(d.trash,t)}</td>`;
        }else{ html+=`<td>${d.news}</td><td>${pct(d.news,t)}</td><td>${d.recall}</td><td>${pct(d.recall,t)}</td><td>${d.noAnswer}</td><td>${pct(d.noAnswer,t)}</td><td>${d.approved}</td><td class="${colorPct(d.approved/t*100)}">${pct(d.approved,t)}</td><td>${d.reject}</td><td>${pct(d.reject,t)}</td><td>${d.trash}</td><td>${pct(d.trash,t)}</td>`; }
        tr.innerHTML=html; cuerpo.appendChild(tr);
      }
      const tot=Object.values(dataGlobal).reduce((a,d)=>{ a.total+=d.total; a.news+=d.news; a.recall+=d.recall; a.noAnswer+=d.noAnswer; a.approved+=d.approved; a.reject+=d.reject; a.trash+=d.trash; return a; },{total:0,news:0,recall:0,noAnswer:0,approved:0,reject:0,trash:0});
      if(Object.keys(dataGlobal).length){
        let foot=`<td class="bold">TOTAL</td><td>${tot.total}</td>`; const t=tot.total||1;
        if(vistaActual==="numerico"){ foot+=`<td>${tot.news}</td><td>${tot.recall}</td><td>${tot.noAnswer}</td><td>${tot.approved}</td><td>${tot.reject}</td><td>${tot.trash}</td>`;
        }else if(vistaActual==="porcentaje"){ foot+=`<td>${pct(tot.news,t)}</td><td>${pct(tot.recall,t)}</td><td>${pct(tot.noAnswer,t)}</td><td class="${colorPct(tot.approved/t*100)}">${pct(tot.approved,t)}</td><td>${pct(tot.reject,t)}</td><td>${pct(tot.trash,t)}</td>`;
        }else{ foot+=`<td>${tot.news}</td><td>${pct(tot.news,t)}</td><td>${tot.recall}</td><td>${pct(tot.recall,t)}</td><td>${tot.noAnswer}</td><td>${pct(tot.noAnswer,t)}</td><td>${tot.approved}</td><td class="${colorPct(tot.approved/t*100)}">${pct(tot.approved,t)}</td><td>${tot.reject}</td><td>${pct(tot.reject,t)}</td><td>${tot.trash}</td><td>${pct(tot.trash,t)}</td>`; }
        tfoot.innerHTML=foot;
      }
    }
    function cambiarOrdenColumna(col){ estadoOrdenColumna[col]=(estadoOrdenColumna[col]||0)+1; if(estadoOrdenColumna[col]>2) estadoOrdenColumna[col]=0; columnaOrdenActual=estadoOrdenColumna[col]===0?null:col; savePref(PREF_ORDEN,estadoOrdenColumna); renderTabla(); }
    function restablecerOrden(){ estadoOrdenColumna={}; columnaOrdenActual=null; savePref(PREF_ORDEN,{}); renderTabla(); }
    function getValorOrdenable(d,col){ const t=d.total||1; const base={"Leads":d.total,"New":d.news,"% New":(d.news/t)*100,"Recall":d.recall,"% Recall":(d.recall/t)*100,"No Answer":d.noAnswer,"% No Answer":(d.noAnswer/t)*100,"Approve":d.approved,"% Approve":(d.approved/t)*100,"Reject":d.reject,"% Reject":(d.reject/t)*100,"Trash":d.trash,"% Trash":(d.trash/t)*100}; return base[col]||0; }
    const pct=(v,t)=>((v/t)*100).toFixed(1)+"%";
    const colorPct=p=>p<=25?"red":p>=30?"green":"orange";

    /* ===== Cloud hist√≥rico con FALLBACK ===== */
    let cloudHistorico=[];
    const filtroPaisEl=document.getElementById("filtroPais");
    const filtroFechaEl=document.getElementById("filtroFecha");
    const presetEl=document.getElementById("presetRango");

    function rangeFromPreset(preset, dateISO){
      const now=new Date();
      const todayISO = `${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}`;
      const startOf=(iso)=> new Date(`${iso}T00:00:00`).getTime();
      const addDays=(iso,days)=>{ const d=new Date(`${iso}T00:00:00`); d.setDate(d.getDate()+days); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; };

      if(preset==='hoy'){
        const s=startOf(todayISO), e=startOf(addDays(todayISO,1)); return {start:s, end:e};
      }else if(preset==='ayer'){
        const y=addDays(todayISO,-1); return {start:startOf(y), end:startOf(todayISO)};
      }else if(preset==='7d'){
        const s=addDays(todayISO,-6); return {start:startOf(s), end:startOf(addDays(todayISO,1))};
      }else if(preset==='dia' && dateISO){
        return {start:startOf(dateISO), end:startOf(addDays(dateISO,1))};
      }
      return {start:null, end:null};
    }

    function normalizeRows(rows){
      rows.forEach(r=>{
        const iso  = r.fechaISO || ddmmyyyyToISO(r.fecha);
        const hhmm = r.hora24 || toHora24(r.hora);
        if(!r.ts && iso && hhmm){
          r.ts = new Date(`${iso}T${hhmm}:00`).getTime();
        }
        r.hora = hhmm || r.hora;
      });
      // Orden horario: temprano ‚Üí tarde
      rows.sort((a,b)=>(a.ts||0)-(b.ts||0));
      return rows;
    }

    // ‚Üê ESTA FUNCI√ìN incluye fallback si falta el √≠ndice compuesto
    async function fetchHistoricoCloud(fp, startTs, endTs){
      const base = collection(db,'historico');
      try {
        // consulta √≥ptima (puede requerir √≠ndice)
        let qy;
        if(fp !== 'todos' && startTs != null && endTs != null){
          qy = query(base,
            where('pais','==',fp),
            where('ts','>=',startTs),
            where('ts','<', endTs)
          );
        } else if(startTs != null && endTs != null){
          qy = query(base, where('ts','>=',startTs), where('ts','<', endTs));
        } else if(fp !== 'todos'){
          qy = query(base, where('pais','==',fp));
        } else {
          qy = base;
        }
        const snap = await getDocs(qy);
        const rows = []; snap.forEach(d=>rows.push(d.data()));
        return normalizeRows(rows);

      } catch (e) {
        if (e.code === 'failed-precondition') {
          // fallback: consultar por rango y filtrar pa√≠s en cliente
          let q2 = base;
          if (startTs != null && endTs != null){
            q2 = query(base, where('ts','>=',startTs), where('ts','<', endTs));
          }
          const snap = await getDocs(q2);
          let rows = []; snap.forEach(d=>rows.push(d.data()));
          if (fp !== 'todos') rows = rows.filter(r => r.pais === fp);
          return normalizeRows(rows);
        }
        throw e;
      }
    }

    async function registrarAvance(){
      if(!Object.keys(dataGlobal).length){ mostrarToast("‚ÑπÔ∏è Procesa datos antes de registrar."); return; }
      if(!auth.currentUser){ mostrarToast("‚ö†Ô∏è Sin autenticaci√≥n (solo lectura)."); return; }

      const now=new Date();
      const hora24=`${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
      const fecha=formatDDMMYYYY(now), fechaISO=formatISO(now), ts=now.getTime();

      const colRef=collection(db,'historico');
      const writes=[];
      for(const [pais,d] of Object.entries(dataGlobal)){
        const total=d.total||1;
        writes.push(addDoc(colRef,{
          fecha, fechaISO, hora:hora24, hora24:hora24, ts, pais,
          leads:d.total, news:d.news, recall:d.recall, noAnswer:d.noAnswer,
          approve:d.approved, pctApprove:((d.approved/total)*100).toFixed(1),
          reject:d.reject, trash:d.trash
        }));
      }
      try{
        await Promise.all(writes);
        mostrarToast("‚úÖ Avance registrado en la nube.");
        await renderTablaHistorico(true);
        renderGrafico();
      }catch(e){
        console.error('Firestore write error:', e);
        mostrarToast("‚ö†Ô∏è Error guardando en la nube: " + (e.code || e.message));
      }
    }

    async function borrarHistorial(){
      if(!confirm("¬øBorrar TODO el historial de la nube?")) return;
      try{
        const snap=await getDocs(collection(db,'historico'));
        const ops=[]; snap.forEach(d=>ops.push(deleteDoc(doc(db,'historico',d.id))));
        await Promise.all(ops); mostrarToast("üóëÔ∏è Historial borrado."); await renderTablaHistorico(true); renderGrafico();
      }catch(e){ console.error(e); mostrarToast("‚ùå No se pudo borrar: " + (e.code||e.message)); }
    }

    async function ensurePaisesOptions(){
      if(filtroPaisEl.options.length>1) return;
      try{
        const snap=await getDocs(collection(db,'historico'));
        const set=new Set(); snap.forEach(d=>set.add(d.data().pais||""));
        [...set].filter(Boolean).forEach(p=>{ const o=document.createElement("option");o.value=p;o.textContent=p;filtroPaisEl.appendChild(o); });
      }catch{}
    }

    function calcMedian(arr){
      if(!arr.length) return 0;
      const v=[...arr].sort((a,b)=>a-b);
      const m=Math.floor(v.length/2);
      return v.length%2?v[m]:(v[m-1]+v[m])/2;
    }

    function renderQuickMetrics(){
      const box=document.getElementById('quickMetrics');
      if(!cloudHistorico.length){ box.style.display='none'; return; }
      const vals=cloudHistorico.map(r=>parseFloat(r.pctApprove||0)).filter(n=>!isNaN(n));
      if(!vals.length){ box.style.display='none'; return; }
      const min=Math.min(...vals).toFixed(1);
      const med=calcMedian(vals).toFixed(1);
      const max=Math.max(...vals).toFixed(1);

      document.getElementById('mMin').textContent=`${min}%`;
      document.getElementById('mMed').textContent=`${med}%`;
      document.getElementById('mMax').textContent=`${max}%`;

      let deltaTxt='‚Äì', cls='';
      if(vals.length>=2){
        const last=vals[vals.length-1], prev=vals[vals.length-2];
        const d=(last-prev).toFixed(1);
        const arrow = (d>=0? '‚Üë':'‚Üì');
        cls = d>=0? 'delta up':'delta down';
        deltaTxt = `${arrow} ${Math.abs(d)} pp`;
      }
      const mDelta=document.getElementById('mDelta');
      mDelta.className='value ' + cls;
      mDelta.textContent=deltaTxt;

      box.style.display='flex';
    }

    async function renderTablaHistorico(){
      await ensurePaisesOptions();
      // Restaurar preferencias
      const prefPais=readPref(PREF_FPAIS,'todos');
      const prefFecha=readPref(PREF_FFECHA,'');
      const prefPreset=readPref(PREF_PRESET,'dia');
      if([...filtroPaisEl.options].some(o=>o.value===prefPais)) filtroPaisEl.value=prefPais;
      presetEl.value = prefPreset;
      if(prefFecha) filtroFechaEl.value = prefFecha;

      // Calcular rango a consultar
      const preset = presetEl.value;
      const dateISO = filtroFechaEl.value || '';
      const {start, end} = rangeFromPreset(preset, dateISO);

      const tbody=document.querySelector("#tablaHistorico tbody"); tbody.innerHTML="";
      try{
        cloudHistorico=await fetchHistoricoCloud(filtroPaisEl.value, start, end);
      }catch(e){
        console.error('Fetch error:', e); mostrarToast("‚ö†Ô∏è No se pudo leer la nube: " + (e.code||e.message)); cloudHistorico=[];
      }

      cloudHistorico.forEach(r=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${r.hora||""}</td><td>${r.fecha||""}</td><td>${r.pais||""}</td><td>${r.leads||0}</td><td>${r.news||0}</td><td>${r.recall||0}</td><td>${r.noAnswer||0}</td><td>${r.approve||0}</td><td>${Number(r.pctApprove||0).toFixed(1)}%</td><td>${r.reject||0}</td><td>${r.trash||0}</td>`;
        tbody.appendChild(tr);
      });

      renderQuickMetrics();
      renderGrafico();
    }

    function onFiltroChange(){
      savePref(PREF_FPAIS, filtroPaisEl.value);
      savePref(PREF_FFECHA, filtroFechaEl.value || '');
      renderTablaHistorico();
    }
    function onPresetChange(){
      const preset=presetEl.value;
      savePref(PREF_PRESET, preset);
      // Habilitar/deshabilitar el datepicker seg√∫n preset
      filtroFechaEl.disabled = (preset !== 'dia');
      renderTablaHistorico();
    }
    function limpiarFecha(){ filtroFechaEl.value=""; savePref(PREF_FFECHA,''); presetEl.value='dia'; savePref(PREF_PRESET,'dia'); filtroFechaEl.disabled=false; renderTablaHistorico(); }

    function exportarHistoricoCSV(){
      if(!cloudHistorico.length){ mostrarToast("‚ÑπÔ∏è No hay registros para exportar."); return; }
      const encabezados=["Fecha","Hora","Pa√≠s","Leads","News","Recall","No Answer","Approve","% Approve","Reject","Trash"];
      const filas=cloudHistorico.map(r=>[ r.fecha||"", r.hora||"", r.pais||"", r.leads||0, r.news||0, r.recall||0, r.noAnswer||0, r.approve||0, r.pctApprove||0, r.reject||0, r.trash||0 ]);
      const csv=[encabezados,...filas].map(row=>row.map(v=>`"${String(v??"").replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`historico_gc_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    function renderGrafico(){
      const ctx=document.getElementById('graficoAvance').getContext('2d');
      const agr={}; cloudHistorico.forEach(r=>{ if(!agr[r.pais]) agr[r.pais]=[]; agr[r.pais].push({x:r.hora,y:r.pctApprove}); });
      const datasets=Object.keys(agr).map(k=>({label:k,data:agr[k],fill:false,tension:.2}));
      if(window.graficoAvance) window.graficoAvance.destroy();
      window.graficoAvance=new Chart(ctx,{type:'line',data:{datasets},options:{responsive:true,plugins:{legend:{position:'top'}},scales:{x:{title:{display:true,text:'Hora'},type:'category'},y:{title:{display:true,text:'% Approve'},beginAtZero:true,max:100}}}});
    }

    // Exponer
    window.procesar=procesar; window.borrarTodo=borrarTodo; window.restablecerOrden=restablecerOrden;
    window.registrarAvance=registrarAvance; window.borrarHistorial=borrarHistorial;
    window.exportarHistoricoCSV=exportarHistoricoCSV; window.onFiltroChange=onFiltroChange; window.onPresetChange=onPresetChange; window.limpiarFecha=limpiarFecha;

    document.addEventListener('DOMContentLoaded', ()=>{
      const prefPreset=readPref(PREF_PRESET,'dia');
      presetEl.value=prefPreset;
      filtroFechaEl.disabled = (prefPreset!=='dia');
      const prefFecha=readPref(PREF_FFECHA,''); if(prefFecha) filtroFechaEl.value=prefFecha;
      renderTablaHistorico();
    });
  </script>
</body>
</html>

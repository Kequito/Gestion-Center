<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gesti√≥n Center ‚Äì New Report CC Per√∫</title>
  <link href="https://fonts.googleapis.com/css2?family=Lexend&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-app:#1c2a45; --bg-aside:#152035; --txt:#ffffff; --txt-muted:#cfd8dc; --hover:#1c2a45;
      --primary-color:#0d47a1; --accent-color:#42a5f5; --table-bg:#22314f; --table-border:#2f446a; --header-bg:#0d47a1;
      --green-color:#2e7d32; --red-color:#c62828; --orange-color:#f57c00;
    }
    body{ margin:0; font-family:'Lexend',sans-serif; background:var(--bg-app); color:var(--txt); display:flex; min-height:100vh; }
    aside{ background:var(--bg-aside); width:220px; height:100vh; padding:40px 20px; box-sizing:border-box; display:flex; flex-direction:column; position:fixed; left:0; top:0; }
    .logo{ font-size:22px; font-weight:700; margin-bottom:32px; text-align:center; line-height:1.2; }
    nav a{ color:var(--txt); margin:14px 0; text-decoration:none; font-size:15px; padding:10px 12px; border-radius:8px; transition:background-color .25s,transform .05s; display:flex; align-items:flex-start; gap:10px; width:100%; box-sizing:border-box; white-space:normal; line-height:1.2; overflow-wrap:anywhere; word-break:break-word; }
    nav a:hover{ background:var(--hover); }
    nav a.active{ background:var(--hover); box-shadow:inset 0 0 0 1px rgba(255,255,255,.12); }
    .spacer{ flex:1; }

    main{ margin-left:220px; padding:28px; width:calc(100% - 220px); box-sizing:border-box; }
    .page-title{ display:flex; align-items:center; gap:12px; font-size:24px; font-weight:700; margin:0 0 6px; }
    .subtitle{ margin:0 0 16px; color:var(--txt-muted); font-size:14px; }
    .datetime{ font-size:14px; font-weight:600; margin:8px 0 14px; opacity:.9; }

    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 14px; }
    button{ padding:10px 14px; font-size:14px; cursor:pointer; border:none; border-radius:10px; background:var(--primary-color); color:#fff; box-shadow:0 2px 6px rgba(0,0,0,.25); transition:background .2s,transform .03s; }
    button:hover{ background:var(--accent-color); }
    button:active{ transform:translateY(1px); }

    textarea{ width:100%; min-height:150px; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; padding:12px; border:1px solid var(--accent-color); background:var(--table-bg); color:var(--txt); border-radius:12px; box-sizing:border-box; }

    table{ margin-top:16px; border-collapse:separate; border-spacing:0; width:100%; background:var(--table-bg); border:1px solid var(--table-border); border-radius:12px; overflow:hidden; box-shadow:0 4px 10px rgba(0,0,0,.18); }
    th,td{ border-bottom:1px solid var(--table-border); padding:10px; text-align:center; }
    thead th{ background:var(--header-bg); color:#fff; cursor:pointer; position:relative; }
    thead th:first-child, tbody td:first-child{ text-align:left; }
    .bandera{ width:20px; height:14px; margin-right:6px; vertical-align:middle; }
    .bold{ font-weight:700; }

    .green{ background:var(--green-color); color:#fff; }
    .red{ background:var(--red-color); color:#fff; }
    .orange{ background:var(--orange-color); color:#fff; }

    tfoot td{ font-weight:800; background:rgba(66,165,245,.16); border-top:2px solid var(--table-border); }

    .filters{ display:flex; align-items:center; gap:22px; flex-wrap:wrap; background:rgba(255,255,255,.04); border:1px solid var(--table-border); border-radius:12px; padding:10px 12px; margin-top:18px; }
    .filter-group{ display:flex; align-items:center; gap:10px; }
    .filter-group label{ display:flex; align-items:center; gap:8px; font-weight:700; margin:0; }
    .filter-group select, .filter-group input[type="date"]{ padding:8px 12px; border-radius:10px; border:1px solid var(--primary-color); background:var(--table-bg); color:var(--txt); min-width:140px; line-height:1; height:38px; }
    .filter-group .clear-btn{ background:#344768; border:1px solid var(--table-border); }
    .filter-group .clear-btn:hover{ background:#3e577f; }

    .history-actions{ display:flex; gap:10px; flex-wrap:wrap; margin:14px 0 10px; justify-content:flex-start; }

    #toast{ position:fixed; bottom:18px; right:20px; background:#222; color:#fff; padding:12px 18px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,.35); display:none; z-index:1000; }

    @media (max-width:960px){ aside{width:200px;} main{margin-left:200px; width:calc(100% - 200px);} }
    @media (max-width:760px){ aside{position:static;width:100%;height:auto;} main{margin-left:0;width:100%;} .filter-group select,.filter-group input[type="date"]{min-width:120px;} }
  </style>
</head>
<body>
  <aside>
    <div class="logo">üß≠ Gesti√≥n Center</div>
    <nav>
      <a href="index.html">üè† Inicio</a>
      <a href="plandetrabajo.html">‚úÖ Plan de trabajo</a>
      <a href="distribucion.html">üìã Distribuci√≥n</a>
      <a href="estadisticas.html">üìà Estad√≠sticas</a>
      <a href="cobertura.html">üåé Cobertura</a>
      <a href="camprev.html">üë• Selector de Apoyo Ver 2.0</a>
      <a class="active" href="opo11.html">üß∞ New Report CC Per√∫</a>
      <a href="#contacto">üì¨ Contacto</a>
    </nav>
    <div class="spacer"></div>
  </aside>

  <main>
    <h1 class="page-title">üß∞ New Report CC Per√∫</h1>
    <p class="subtitle">Pega la tabla desde tu Panel y visualiza las m√©tricas por pa√≠s ¬∑ Vista num√©rica, porcentual o mixta ¬∑ Historial por hora + gr√°fico (compartido)</p>

    <div class="datetime" id="fechaHora"></div>

    <div class="toolbar">
      <button onclick="procesar('numerico')">üì¶ Vista Num√©rica</button>
      <button onclick="procesar('porcentaje')">üìà Vista Porcentual</button>
      <button onclick="procesar('mixto')">üîÅ Vista Mixta</button>
      <button onclick="borrarTodo()">üßπ Borrar</button>
      <button onclick="restablecerOrden()">üß≠ Restablecer Orden</button>
    </div>

    <textarea id="inputData" placeholder="Pega aqu√≠ tu tabla con encabezados (Country, Total, New, Recall, No answer, Approved, Reject, Trash)‚Ä¶"></textarea>

    <!-- Tabla principal -->
    <table id="tablaReporte">
      <thead><tr id="encabezadoTabla"></tr></thead>
      <tbody></tbody>
      <tfoot><tr id="filaTotales"></tr></tfoot>
    </table>

    <!-- Acciones de hist√≥rico -->
    <div class="history-actions">
      <button onclick="registrarAvance()">üìå Registrar avance ahora</button>
      <button onclick="borrarHistorial()">üóëÔ∏è Borrar historial</button>
      <button onclick="exportarHistoricoCSV()">‚¨áÔ∏è Exportar hist√≥rico (CSV)</button>
    </div>

    <!-- Filtros hist√≥rico -->
    <div class="filters">
      <div class="filter-group">
        <label for="filtroPais">üåé Filtrar por pa√≠s:</label>
        <select id="filtroPais" onchange="onFiltroChange()">
          <option value="todos">üåç Todos</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="filtroFecha">üìÖ Filtrar por d√≠a:</label>
        <input type="date" id="filtroFecha" onchange="onFiltroChange()"/>
        <button class="clear-btn" onclick="limpiarFecha()">Todos</button>
      </div>
    </div>

    <h3 class="page-title" style="font-size:18px; margin-top:10px;">üìã Registro hist√≥rico por hora</h3>
    <table id="tablaHistorico">
      <thead>
        <tr>
          <th>Hora</th>
          <th>Fecha</th>
          <th>Pa√≠s</th>
          <th>Leads</th>
          <th>News</th>
          <th>Recall</th>
          <th>No Answer</th>
          <th>Approve</th>
          <th>% Approve</th>
          <th>Reject</th>
          <th>Trash</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <canvas id="graficoAvance" height="220"></canvas>
  </main>

  <div id="toast"></div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Toda la l√≥gica + Firebase en m√≥dulo -->
  <script type="module">
    /* =========================
       Firebase v12 (ESM CDN)
       ========================= */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCHBsq9AdVZEMVryQWReX7oaPparo9lK8M",
      authDomain: "gestioncenterdata.firebaseapp.com",
      projectId: "gestioncenterdata",
      storageBucket: "gestioncenterdata.firebasestorage.app",
      messagingSenderId: "628401314464",
      appId: "1:628401314464:web:0671233dfd801ee43587c5",
      measurementId: "G-NBFZYTN094"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    signInAnonymously(auth).catch(console.error);
    const db   = getFirestore(app);

    /* =========================
       Utilidades UI / estado
       ========================= */
    const PREF_VISTA  = 'gc_vista';
    const PREF_ORDEN  = 'gc_orden';
    const PREF_FPAIS  = 'gc_filtro_pais';
    const PREF_FFECHA = 'gc_filtro_fecha_iso'; // yyyy-mm-dd

    const savePref = (k,v)=>localStorage.setItem(k, JSON.stringify(v));
    const readPref = (k,def=null)=>{ try{ const v=JSON.parse(localStorage.getItem(k)); return (v===undefined||v===null)?def:v; }catch{ return def; } };

    // Fechas helpers
    const pad2 = n => String(n).padStart(2,'0');
    function formatDDMMYYYY(d){ return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`; }
    function formatISO(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
    function ddmmyyyyToISO(s){
      if(!s) return "";
      if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s; // ya ISO
      const m = /^\s*(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})\s*$/.exec(s);
      if(!m) return "";
      const d = pad2(+m[1]), mo = pad2(+m[2]), y = m[3];
      return `${y}-${mo}-${d}`;
    }

    // Fecha/hora en t√≠tulo
    function actualizarFechaHora(){
      const ahora=new Date();
      const fecha=ahora.toLocaleDateString('es-PE',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
      const hora =ahora.toLocaleTimeString('es-PE',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
      document.getElementById('fechaHora').textContent=`üìÖ ${fecha} ‚Äì üïí ${hora}`;
    }
    actualizarFechaHora(); setInterval(actualizarFechaHora,1000);

    // Estado de tablas
    let vistaActual = readPref(PREF_VISTA, 'numerico');
    let dataGlobal={};
    let dataOriginal=[];
    let estadoOrdenColumna=readPref(PREF_ORDEN, {});
    let columnaOrdenActual=null;

    // Banderas
    const codigos={
      "Chile":"cl","Colombia":"co","Costa Rica":"cr","Ecuador":"ec",
      "Mexico":"mx","Paraguay":"py","Peru":"pe","Uruguay":"uy",
      "Venezuela":"ve","Bolivia":"bo"
    };

    function mostrarToast(msg){
      const t=document.getElementById("toast");
      t.textContent=msg; t.style.display="block"; t.style.opacity=1;
      setTimeout(()=>{t.style.transition="opacity .5s"; t.style.opacity=0;},2400);
      setTimeout(()=>{t.style.display="none"; t.style.transition="";},3000);
    }

    /* =========================
       Parser tolerante (Approved)
       ========================= */
    const COLMAP = {
      country:  ["Country"],
      total:    ["Total"],
      news:     ["New"],
      recall:   ["Recall"],
      noAnswer: ["No answer","No Answer"],
      approved: ["Approved","Call center (approved)","Call center approved"],
      reject:   ["Reject"],
      trash:    ["Trash"]
    };

    function borrarTodo(){
      document.getElementById("inputData").value="";
      document.querySelector("#tablaReporte tbody").innerHTML="";
      document.querySelector("#encabezadoTabla").innerHTML="";
      document.querySelector("#filaTotales").innerHTML="";
      dataGlobal={}; dataOriginal=[]; estadoOrdenColumna={}; columnaOrdenActual=null;
      savePref(PREF_ORDEN, {});
    }

    function procesar(vista){
      vistaActual=vista; savePref(PREF_VISTA, vista);
      estadoOrdenColumna={}; savePref(PREF_ORDEN, {}); columnaOrdenActual=null;

      const input=document.getElementById("inputData").value.

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gesti√≥n Center ‚Äì Tablas Colaborativas</title>
  <link href="https://fonts.googleapis.com/css2?family=Lexend&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ===== Tema base (mismo que Estad√≠sticas) ===== */
    :root{
      --bg-app:#1c2a45; --bg-aside:#152035; --txt:#ffffff; --txt-muted:#cfd8dc; --hover:#1c2a45;
      --primary-color:#0D47A1; --accent-color:#42a5f5; --table-bg:#22314f; --table-border:#2f446a; --header-bg:#0d47a1;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:'Lexend',sans-serif; background:var(--bg-app); color:var(--txt); display:flex; min-height:100vh; }
    /* ===== Sidebar (id√©ntico) ===== */
    aside{ background:var(--bg-aside); width:220px; height:100vh; padding:40px 20px; display:flex; flex-direction:column; position:fixed; left:0; top:0; }
    .logo{ font-size:22px; font-weight:700; margin-bottom:32px; text-align:center; line-height:1.2; }
    nav a{ color:var(--txt); margin:14px 0; text-decoration:none; font-size:15px; padding:10px 12px; border-radius:8px; transition:background-color .25s,transform .05s; display:flex; align-items:flex-start; gap:10px; width:100%; white-space:normal; line-height:1.2; overflow-wrap:anywhere; word-break:break-word; }
    nav a:hover{ background:var(--hover); }
    nav a.active{ background:var(--hover); box-shadow:inset 0 0 0 1px rgba(255,255,255,.12); }
    .spacer{ flex:1; }
    /* ===== Main ===== */
    main{ margin-left:220px; padding:28px; width:calc(100% - 220px); }
    .page-title{ display:flex; align-items:center; gap:12px; font-size:24px; font-weight:700; margin:0 0 4px; }
    .subtitle{ margin:0 0 10px; color:var(--txt-muted); font-size:14px; display:flex; align-items:center; gap:10px; }
    /* Componentes base */
    .pill{ background:rgba(33,150,243,.15); border:1px solid rgba(33,150,243,.35); color:#cfe8ff; }
    .btn{ padding:10px 14px; border-radius:10px; background:var(--primary-color); color:#fff; border:none; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.25); }
    .btn:hover{ background:var(--accent-color); }
    .btn-outline{ background:#22314f; border:1px solid var(--table-border); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .input,.select{ width:100%; background:#22314f; color:#fff; border:1px solid var(--table-border); padding:.5rem .75rem; border-radius:.75rem; outline:none; }
    table.gc{ width:100%; border-collapse:separate; border-spacing:0; background:var(--table-bg); border:1px solid var(--table-border); border-radius:12px; overflow:hidden; box-shadow:0 4px 10px rgba(0,0,0,.18); }
    table.gc thead th{ background:var(--header-bg); color:#fff; padding:10px; text-align:left; position:sticky; top:0; z-index:2; user-select:none; }
    table.gc tbody td{ padding:10px; border-top:1px solid var(--table-border); }
    .tag{ font-size:10px; padding:2px 6px; background:#334766; border:1px solid #2a3d5e; border-radius:999px; }
    .card{ background:var(--bg-aside); border:1px solid var(--table-border); border-radius:12px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,.15); }
    .icon-btn{ padding:8px 10px; border-radius:8px; background:#22314f; border:1px solid var(--table-border); }
    .small{ font-size:12px; color:var(--txt-muted); }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside>
    <div class="logo">üß≠ Gesti√≥n Center</div>
    <nav>
      <a href="index.html">üè† Inicio</a>
      <a href="plandetrabajo.html">‚úÖ Plan de trabajo</a>
      <a href="distribucion.html">üìã Distribuci√≥n</a>
      <a class="active" href="#">üß© Tablas</a>
      <a href="estadisticas.html">üìà Estad√≠sticas</a>
      <a href="cobertura.html">üåé Cobertura</a>
      <a href="camprev.html">üë• Selector de Apoyo Ver 2.0</a>
    </nav>
    <div class="spacer"></div>
  </aside>

  <!-- Contenido -->
  <main>
    <h1 class="page-title">üìã Tablas Colaborativas <span id="modePill" class="pill px-2 py-1 rounded-full text-xs">Modo Vista</span></h1>
    <p class="subtitle">Crear, visualizar y editar tablas personalizadas con importaci√≥n/exportaci√≥n CSV</p>

    <!-- Toolbar global -->
    <div class="flex items-center gap-2 flex-wrap mb-3">
      <button id="btnCreate" class="btn">‚ûï Crear tabla</button>
      <button id="btnImport" class="btn btn-outline" disabled>üì• Importar CSV</button>
      <button id="btnExport" class="btn btn-outline" disabled>üì§ Exportar CSV</button>
    </div>

    <!-- Listado de tablas -->
    <section id="tablesGrid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6"></section>

    <!-- Editor/Visor -->
    <section id="editorSection" class="hidden">
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-2">
          <h2 id="editorTitle" class="text-lg font-semibold"></h2>
          <span id="metaCols" class="tag"></span>
          <span id="metaRows" class="tag"></span>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnToggleEdit" class="btn">Entrar a edici√≥n</button>
          <button id="btnBack" class="btn btn-outline">‚üµ Volver</button>
        </div>
      </div>

      <!-- Acciones de edici√≥n -->
      <div id="editToolbar" class="flex items-center gap-2 mb-2 hidden">
        <button id="btnAddRow" class="btn">‚ûï Fila</button>
        <button id="btnAddCol" class="btn btn-outline">‚ûï Columna</button>
        <span class="small">Sugerencia: haz clic en el nombre de una columna para renombrarla. Usa ‚ùå para eliminarla.</span>
      </div>

      <div class="overflow-auto rounded-2xl border border-[var(--table-border)]">
        <table class="gc" id="dataTable">
          <thead><tr id="theadRow"></tr></thead>
          <tbody id="tbodyRows"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Modal Crear Tabla -->
  <div id="modalCreate" class="hidden fixed inset-0 bg-black/60 items-center justify-center z-50">
    <div class="card w-full max-w-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Crear nueva tabla</h3>
        <button data-close class="icon-btn">‚úñ</button>
      </div>
      <div class="space-y-3">
        <input id="tblName" class="input" placeholder="Nombre de la tabla"/>
        <div id="colsEditor" class="space-y-2"></div>
        <button id="btnAddNewCol" class="btn btn-outline">‚ûï A√±adir columna</button>
        <div class="flex justify-end gap-2 mt-2">
          <button data-close class="btn btn-outline">Cancelar</button>
          <button id="btnConfirmCreate" class="btn">Crear</button>
        </div>
      </div>
    </div>
  </div>

  <input id="fileCsv" type="file" accept=".csv" class="hidden" />

  <!-- ===================== Script ===================== -->
  <script>
    // ===== Estado =====
    const state = {
      tables: [], // {id,name,columns:[{id,name}], rows:[{id, cells:[]}]}
      activeId: null,
      editMode: false,
    };

    // ===== Helpers =====
    const uid = (p='id') => p + '_' + Math.random().toString(36).slice(2,9);
    const now = () => Date.now();

    // ===== Refs DOM =====
    const tablesGrid = document.getElementById('tablesGrid');
    const btnCreate = document.getElementById('btnCreate');
    const btnImport = document.getElementById('btnImport');
    const btnExport = document.getElementById('btnExport');
    const editorSection = document.getElementById('editorSection');
    const editorTitle = document.getElementById('editorTitle');
    const metaCols = document.getElementById('metaCols');
    const metaRows = document.getElementById('metaRows');
    const btnToggleEdit = document.getElementById('btnToggleEdit');
    const btnBack = document.getElementById('btnBack');
    const theadRow = document.getElementById('theadRow');
    const tbodyRows = document.getElementById('tbodyRows');
    const editToolbar = document.getElementById('editToolbar');
    const btnAddRow = document.getElementById('btnAddRow');
    const btnAddCol = document.getElementById('btnAddCol');
    const modePill = document.getElementById('modePill');
    const modalCreate = document.getElementById('modalCreate');
    const tblName = document.getElementById('tblName');
    const colsEditor = document.getElementById('colsEditor');
    const btnAddNewCol = document.getElementById('btnAddNewCol');
    const btnConfirmCreate = document.getElementById('btnConfirmCreate');
    const fileCsv = document.getElementById('fileCsv');

    // ===== Demo =====
    function ensureDemo() {
      if (state.tables.length) return;
      const t = { id: 'demo', name: 'Ejemplo ‚Äì Turnos OPs', columns: [
        { id:'op', name:'Operador' }, { id:'perop', name:'PEROP1AM' }, { id:'turno', name:'Turno' }, { id:'desc', name:'Descanso' }, { id:'tl', name:'Team Leader' }, { id:'camp', name:'Campa√±a' }, { id:'activo', name:'Activo' }
      ], rows: [
        { id:uid('row'), cells:['Jennifer','PEROP1AM-40588','AM (07-16)','3:00 (15m)','Kevin','M√©xico','true'] },
        { id:uid('row'), cells:['Manuel','PEROP1AM-40453','AM (07-16)','4:00 (15m)','Kevin','M√©xico','true'] },
      ], createdAt: now(), updatedAt: now() };
      state.tables.push(t);
    }

    // ===== Listado de tablas =====
    function renderTables() {
      tablesGrid.innerHTML = '';
      state.tables.filter(t=>!t.deletedAt).forEach(t => {
        const rowsCount = t.rows.filter(r=>!r.deletedAt).length;
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="flex items-start justify-between">
            <div>
              <div class="font-semibold">${t.name}</div>
              <div class="small mt-1">${t.columns.length} cols ¬∑ ${rowsCount} filas</div>
            </div>
            <div class="flex items-center gap-2">
              <button class="icon-btn" data-edit="${t.id}">‚úèÔ∏è Editar</button>
              <button class="icon-btn" data-open="${t.id}">üëÅÔ∏è Abrir</button>
              <button class="icon-btn" data-del="${t.id}">üóë</button>
            </div>
          </div>`;
        tablesGrid.appendChild(card);
        card.querySelector('[data-open]').onclick = () => openTable(t.id,false);
        card.querySelector('[data-edit]').onclick = () => openTable(t.id,true);
        card.querySelector('[data-del]').onclick = () => { t.deletedAt = now(); updateUI(); };
      });
    }

    function openTable(id, edit=false){
      state.activeId = id; state.editMode = !!edit;
      editorSection.classList.remove('hidden');
      btnImport.disabled = false; btnExport.disabled = false;
      renderEditor();
    }

    // ===== Editor/Visor =====
    function renderEditor(){
      const t = state.tables.find(x=>x.id===state.activeId); if(!t){ editorSection.classList.add('hidden'); return; }
      editorTitle.textContent = t.name;
      metaCols.textContent = `${t.columns.length} cols`;
      metaRows.textContent = `${t.rows.filter(r=>!r.deletedAt).length} filas`;
      btnToggleEdit.textContent = state.editMode ? 'Salir de edici√≥n' : 'Entrar a edici√≥n';
      modePill.textContent = state.editMode ? 'Modo Edici√≥n' : 'Modo Vista';
      editToolbar.classList.toggle('hidden', !state.editMode);

      // Cabecera
      theadRow.innerHTML = '';
      t.columns.forEach((c, idx)=>{
        const th = document.createElement('th');
        th.innerHTML = state.editMode
          ? `<span class="cursor-pointer underline decoration-dotted" data-rename="${idx}">${c.name}</span> <button class="ml-2 text-red-200" data-delcol="${idx}">‚ùå</button>`
          : c.name;
        theadRow.appendChild(th);
      });
      const thAcc = document.createElement('th'); thAcc.textContent = 'Acciones'; theadRow.appendChild(thAcc);

      // Filas
      tbodyRows.innerHTML = '';
      t.rows.filter(r=>!r.deletedAt).forEach((r)=>{
        const tr = document.createElement('tr'); tr.className='odd:bg-[#1c2a45] even:bg-[#18263f]';
        t.columns.forEach((c, idx)=>{
          const td = document.createElement('td');
          if(!state.editMode){
            const span = document.createElement('span'); span.textContent = r.cells[idx] ?? ''; td.appendChild(span);
          }else{
            const input = document.createElement('input'); input.className='input'; input.value = r.cells[idx] ?? '';
            input.oninput = (e)=>{ r.cells[idx] = e.target.value; t.updatedAt = now(); };
            td.appendChild(input);
          }
          tr.appendChild(td);
        });
        const tdAcc = document.createElement('td');
        if(!state.editMode){ tdAcc.textContent = '‚Äî'; }
        else {
          const btnTrash = document.createElement('button'); btnTrash.className='icon-btn'; btnTrash.textContent='üóë';
          btnTrash.onclick = ()=>{ r.deletedAt = now(); updateUI(); };
          tdAcc.appendChild(btnTrash);
        }
        tr.appendChild(tdAcc);
        tbodyRows.appendChild(tr);
      });

      // Eventos cabecera (renombrar/eliminar columna)
      theadRow.querySelectorAll('[data-rename]').forEach(el=>{
        el.onclick = ()=>{
          const idx = +el.getAttribute('data-rename');
          const cur = t.columns[idx].name;
          const name = prompt('Nuevo nombre de columna', cur);
          if(!name) return; t.columns[idx].name = name; t.updatedAt = now(); renderEditor(); renderTables();
        };
      });
      theadRow.querySelectorAll('[data-delcol]').forEach(el=>{
        el.onclick = ()=>{
          const idx = +el.getAttribute('data-delcol');
          if(!confirm('¬øEliminar esta columna?')) return;
          t.columns.splice(idx,1);
          t.rows.forEach(r=>{ r.cells.splice(idx,1); });
          t.updatedAt = now(); renderEditor(); renderTables();
        };
      });
    }

    // ===== Crear tabla =====
    function openCreate(){
      tblName.value='';
      const seed=[ {id:uid('col'),name:'Columna A'}, {id:uid('col'),name:'Columna B'} ];
      colsEditor.dataset.cols = JSON.stringify(seed);
      renderColsEditor(seed, colsEditor);
      modalCreate.classList.remove('hidden'); modalCreate.classList.add('flex');
    }
    function closeCreate(){ modalCreate.classList.add('hidden'); modalCreate.classList.remove('flex'); }

    function renderColsEditor(cols, container){
      container.innerHTML='';
      cols.forEach((c, idx)=>{
        const row = document.createElement('div'); row.className='grid grid-cols-12 gap-3 items-center bg-[var(--table-bg)] border border-[var(--table-border)] rounded-xl p-3';
        const n = document.createElement('div'); n.className='col-span-8';
        const inp = document.createElement('input'); inp.className='input'; inp.placeholder='Nombre de la columna'; inp.value=c.name||''; inp.oninput=e=>c.name=e.target.value; n.appendChild(inp);
        const actions = document.createElement('div'); actions.className='col-span-4 flex items-center gap-2 justify-end';
        const del = document.createElement('button'); del.className='icon-btn'; del.textContent='üóë'; del.onclick=()=>{ cols.splice(idx,1); renderColsEditor(cols,container); };
        actions.appendChild(del);
        row.append(n, actions); container.appendChild(row);
      });
    }

    // ===== Import/Export =====
    function toCSV(t){
      const headers = t.columns.map(c=>c.name);
      const lines = [headers.join(',')];
      t.rows.filter(r=>!r.deletedAt).forEach(r=>{
        const vals = r.cells.map(v => '"'+String(v??'').replace(/"/g,'""')+'"');
        lines.push(vals.join(','));
      });
      return lines.join('\n');
    }
    async function parseCSV(file){
      const text = await file.text();
      return text.split(/\r?\n/).filter(l=>l.trim().length>0).map(l=> l.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(cell=> cell.replace(/^"|"$/g,'').replace(/""/g,'"')) );
    }

    // ===== Eventos =====
    btnCreate.onclick = openCreate;
    modalCreate.querySelectorAll('[data-close]').forEach(b=> b.onclick = closeCreate);
    btnAddNewCol.onclick = ()=>{
      const cols = JSON.parse(colsEditor.dataset.cols||'[]');
      cols.push({id:uid('col'),name:'Nueva columna'});
      colsEditor.dataset.cols = JSON.stringify(cols);
      renderColsEditor(cols, colsEditor);
    };
    btnConfirmCreate.onclick = ()=>{
      const name = (tblName.value||'').trim(); if(!name){ alert('Ponle un nombre a la tabla'); return; }
      const cols = JSON.parse(colsEditor.dataset.cols||'[]');
      const t = { id:uid('tbl'), name, columns: cols.map(c=>({id:c.id,name:c.name||'Columna'})), rows: [], createdAt: now(), updatedAt: now() };
      state.tables.unshift(t); closeCreate(); updateUI(); openTable(t.id,true);
    };

    btnBack.onclick = ()=>{ state.activeId=null; editorSection.classList.add('hidden'); btnImport.disabled=true; btnExport.disabled=true; };
    btnToggleEdit.onclick = ()=>{ state.editMode=!state.editMode; renderEditor(); };
    btnAddRow.onclick = ()=>{ const t = state.tables.find(x=>x.id===state.activeId); if(!t) return; t.rows.unshift({id:uid('row'),cells:t.columns.map(()=> '')}); t.updatedAt=now(); renderEditor(); renderTables(); };
    btnAddCol.onclick = ()=>{ const t = state.tables.find(x=>x.id===state.activeId); if(!t) return; const name = prompt('Nombre de la nueva columna'); if(!name) return; t.columns.push({id:uid('col'),name}); t.rows.forEach(r=> r.cells.push('')); t.updatedAt=now(); renderEditor(); renderTables(); };

    btnImport.onclick = ()=> fileCsv.click();
    fileCsv.onchange = async ()=>{
      const t = state.tables.find(x=>x.id===state.activeId); if(!t) return; const f = fileCsv.files && fileCsv.files[0]; if(!f) return;
      const rowsCSV = await parseCSV(f); if(!rowsCSV.length) return;
      const headers = rowsCSV[0];
      // mapear por nombre exacto
      const map = headers.map(h=> t.columns.findIndex(c=> c.name.toLowerCase().trim() === h.toLowerCase().trim()));
      for(let i=1;i<rowsCSV.length;i++){
        const arr = rowsCSV[i]; const cells = t.columns.map(()=> '');
        arr.forEach((val,idx)=>{ const at = map[idx]; if(at>=0) cells[at] = val; });
        t.rows.push({id:uid('row'),cells});
      }
      t.updatedAt = now(); renderEditor(); renderTables();
    };

    btnExport.onclick = ()=>{
      const t = state.tables.find(x=>x.id===state.activeId); if(!t) return;
      const csv = toCSV(t); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=t.name.replace(/\s+/g,'_')+'.csv'; a.click(); URL.revokeObjectURL(url);
    };

    function updateUI(){ renderTables(); if(state.activeId) renderEditor(); }

    // Init
    ensureDemo(); updateUI();

    // ===== Firebase (opcional; actualmente DESACTIVADO) =====
    // Si quieres conectarlo YA MISMO sin React/Build Tools:
    // 1) Descomenta los 2 <script> de Firebase y este bloque.
    // 2) Pega tu config en firebaseConfig.
    // 3) Llama a loadFromFirestore() en lugar de ensureDemo().
    //
    // </script>
    // <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
    // <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
    // <script>
    // const firebaseConfig = { /* TU CONFIG */ };
    // firebase.initializeApp(firebaseConfig);
    // const db = firebase.firestore();
    //
    // async function loadFromFirestore(){
    //   const snap = await db.collection('tables').get();
    //   state.tables = snap.docs.map(d => d.data());
    //   updateUI();
    // }
    // async function saveTable(t){ await db.collection('tables').doc(t.id).set(t); }
    // async function saveRow(tableId, row){ await db.collection('tables').doc(tableId).collection('rows').doc(row.id).set(row); }
    //
    // // Ejemplo: al crear tabla, adem√°s de state.tables.unshift(t) -> await saveTable(t)
    // // Ejemplo: al editar/a√±adir fila -> await saveRow(t.id, fila)
  </script>
</body>
</html>

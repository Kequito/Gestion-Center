<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gesti√≥n Center ‚Äì Tablas Colaborativas</title>
  <link href="https://fonts.googleapis.com/css2?family=Lexend&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg-app:#1c2a45; --bg-aside:#152035; --txt:#ffffff; --txt-muted:#cfd8dc; --hover:#1c2a45;
      --primary:#0D47A1; --primary-h:#0b3b86; --panel:#152035; --panel-2:#22314f; --border:#2f446a; --thead:#0d47a1;
    }
    body{ font-family:'Lexend',sans-serif; background:var(--bg-app); color:#fff; }
    .btn{ padding:10px 14px; border-radius:10px; background:var(--primary); color:#fff; border:none; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.25); }
    .btn:hover{ background:var(--primary-h); }
    .btn-sec{ background:var(--panel-2); border:1px solid var(--border); }
    .pill{ background:rgba(33,150,243,.15); border:1px solid rgba(33,150,243,.35); color:#cfe8ff; }
    .input,.select{ width:100%; background:var(--panel-2); color:#fff; border:1px solid var(--border); padding:.5rem .75rem; border-radius:.75rem; outline:none; }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,.15); }
    table.gc{ width:100%; border-collapse:separate; border-spacing:0; background:var(--panel-2); border:1px solid var(--border); border-radius:12px; overflow:hidden; box-shadow:0 4px 10px rgba(0,0,0,.18); }
    table.gc thead th{ background:var(--thead); color:#fff; padding:10px; text-align:left; position:sticky; top:0; z-index:2; }
    table.gc tbody td{ padding:10px; border-top:1px solid var(--border); }
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal{ width:100%; max-width:56rem; background:var(--panel); border:1px solid var(--border); border-radius:1rem; padding:1rem; }
  </style>
</head>
<body>
  <div class="min-h-screen grid grid-cols-[220px_1fr]">
    <!-- Sidebar -->
    <aside class="h-screen sticky top-0 bg-[var(--bg-aside)] border-r border-[var(--border)] p-5 flex flex-col">
      <div class="text-xl font-semibold text-center mb-6">üß≠ Gesti√≥n Center</div>
      <nav class="flex flex-col gap-1 text-slate-200">
        <a class="px-3 py-2 rounded-xl hover:bg-[var(--hover)]" href="index.html">üè† Inicio</a>
        <a class="px-3 py-2 rounded-xl hover:bg-[var(--hover)]" href="plandetrabajo.html">‚úÖ Plan de trabajo</a>
        <a class="px-3 py-2 rounded-xl hover:bg-[var(--hover)]" href="distribucion.html">üìã Distribuci√≥n</a>
        <a class="px-3 py-2 rounded-xl hover:bg-[var(--hover)]" href="estadisticas.html">üìà Estad√≠sticas</a>
        <a class="px-3 py-2 rounded-xl hover:bg-[var(--hover)]" href="cobertura.html">üåé Cobertura</a>
        <a class="px-3 py-2 rounded-xl hover:bg-[var(--hover)]" href="camprev.html">üë• Selector de Apoyo Ver 2.0</a>
        <a class="px-3 py-2 rounded-xl bg-[var(--hover)]" href="#">üß© Tablas</a>
      </nav>
      <div class="flex-1"></div>
    </aside>

    <!-- Contenido principal -->
    <main class="max-w-7xl mx-auto p-6 space-y-6 w-full">
      <!-- Encabezado -->
      <header class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span>üìã</span>
          <h1 class="text-xl font-semibold">Tablas Colaborativas</h1>
          <span id="mode-pill" class="px-2 py-1 text-xs rounded-full pill">Modo Vista</span>
        </div>
        <div>
          <button id="toggle-mode" class="btn">Entrar a edici√≥n</button>
        </div>
      </header>

      <!-- Toolbar (Import/Export removidos) -->
      <div class="flex items-center gap-3">
        <button id="create-table" class="btn">‚ûï Crear tabla</button>
      </div>

      <!-- Listado de Tablas -->
      <section id="tables-list" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></section>

      <!-- Editor de filas -->
      <section id="table-editor" class="space-y-3 hidden">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <h2 id="table-title" class="text-lg font-semibold"></h2>
            <span id="meta-cols" class="px-2 py-1 text-xs rounded-full pill"></span>
            <span id="meta-rows" class="px-2 py-1 text-xs rounded-full pill"></span>
          </div>
          <div class="flex items-center gap-2">
            <button id="add-row" class="btn hidden">‚ûï Fila</button>
            <button id="add-col" class="btn-sec hidden">‚ûï Columna</button>
            <button id="back-list" class="btn-sec">‚üµ Volver</button>
          </div>
        </div>
        <div id="data-grid" class="overflow-auto rounded-2xl border border-[var(--border)]"></div>
      </section>
    </main>
  </div>

  <!-- Modal Crear Tabla -->
  <div id="create-modal" class="modal-backdrop">
    <div class="modal">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Crear nueva tabla</h3>
        <button data-close-create class="btn-sec">‚úñ</button>
      </div>
      <div class="space-y-3">
        <input id="new-table-name" class="input" placeholder="Nombre de la tabla"/>
        <div id="new-cols-editor" class="space-y-2"></div>
        <button id="add-new-col" class="btn-sec">‚ûï A√±adir columna</button>
        <div class="flex justify-end gap-2">
          <button data-close-create class="btn-sec">Cancelar</button>
          <button id="confirm-create" class="btn">Crear</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal A√±adir Columna (modo edici√≥n) -->
  <div id="addcol-modal" class="modal-backdrop">
    <div class="modal max-w-lg">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">A√±adir columna</h3>
        <button data-close-addcol class="btn-sec">‚úñ</button>
      </div>
      <div class="space-y-3">
        <input id="addcol-name" class="input" placeholder="Nombre de la columna"/>
        <select id="addcol-type" class="select">
          <option value="text">text</option>
          <option value="number">number</option>
          <option value="date">date</option>
          <option value="checkbox">checkbox</option>
          <option value="email">email</option>
          <option value="link">link</option>
          <option value="select">select</option>
        </select>
        <input id="addcol-options" class="input hidden" placeholder="Opciones para 'select' (coma)"/>
        <div class="flex justify-end gap-2">
          <button data-close-addcol class="btn-sec">Cancelar</button>
          <button id="confirm-addcol" class="btn">A√±adir</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =================== Estado ===================
    let tables = []; // {id,name,columns:[{id,name,type,options?}], rows:[{id, cells:[]}]}
    let activeTable = null;
    let editMode = false;

    // draft de columnas para el modal de creaci√≥n (no se pierden al a√±adir)
    let draftCols = [];

    // =================== Refs ===================
    const tablesList = document.getElementById('tables-list');
    const tableEditor = document.getElementById('table-editor');
    const tableTitle = document.getElementById('table-title');
    const dataGrid = document.getElementById('data-grid');
    const modePill = document.getElementById('mode-pill');
    const toggleModeBtn = document.getElementById('toggle-mode');
    const metaCols = document.getElementById('meta-cols');
    const metaRows = document.getElementById('meta-rows');
    const addRowBtn = document.getElementById('add-row');
    const addColBtn = document.getElementById('add-col');
    const backListBtn = document.getElementById('back-list');

    // Crear modal
    const createModal = document.getElementById('create-modal');
    const newTableName = document.getElementById('new-table-name');
    const newColsEditor = document.getElementById('new-cols-editor');
    const addNewColBtn = document.getElementById('add-new-col');
    const confirmCreateBtn = document.getElementById('confirm-create');

    // Add-col modal (edici√≥n)
    const addColModal = document.getElementById('addcol-modal');
    const addColName = document.getElementById('addcol-name');
    const addColType = document.getElementById('addcol-type');
    const addColOptions = document.getElementById('addcol-options');
    const confirmAddCol = document.getElementById('confirm-addcol');

    // =================== Utilidades ===================
    const uid = (p='id') => p + '_' + Math.random().toString(36).slice(2,9);
    const now = () => Date.now();
    const open = el => el.style.display = 'flex';
    const close = el => el.style.display = 'none';

    function formatLinkDisplay(urlStr){
      if(!urlStr) return '‚Äî';
      try{ const u = new URL(urlStr); return u.hostname.replace(/^www\./,''); }catch{ return 'Abrir'; }
    }

    // =================== Render listado ===================
    function renderTables(){
      tablesList.innerHTML = '';
      tables.filter(t=>!t.deletedAt).forEach((t)=>{
        const rowsCount = t.rows.filter(r=>!r.deletedAt).length;
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="flex items-start justify-between">
            <div>
              <h3 class="font-semibold">${t.name}</h3>
              <div class="text-slate-300 text-sm mt-1">${t.columns.length} cols ¬∑ ${rowsCount} filas</div>
            </div>
            <div class="flex items-center gap-2">
              <button class="btn-sec" data-open>üëÅÔ∏è Abrir</button>
              <button class="btn-sec" data-edit>‚úèÔ∏è Editar</button>
            </div>
          </div>`;
        card.querySelector('[data-open]').onclick = () => openTable(t,false);
        card.querySelector('[data-edit]').onclick = () => openTable(t,true);
        tablesList.appendChild(card);
      });
    }

    function openTable(t, goEdit=false){
      activeTable = t; editMode = !!goEdit;
      tableEditor.classList.remove('hidden');
      renderEditor();
    }

    // =================== Render editor ===================
    function renderEditor(){
      if(!activeTable){ tableEditor.classList.add('hidden'); return; }
      tableTitle.textContent = activeTable.name;
      metaCols.textContent = `${activeTable.columns.length} cols`;
      metaRows.textContent = `${activeTable.rows.filter(r=>!r.deletedAt).length} filas`;
      modePill.textContent = editMode ? 'Modo Edici√≥n' : 'Modo Vista';
      toggleModeBtn.textContent = editMode ? 'Salir de edici√≥n' : 'Entrar a edici√≥n';
      addRowBtn.classList.toggle('hidden', !editMode);
      addColBtn.classList.toggle('hidden', !editMode);

      // Construir tabla
      let html = '<table class="gc"><thead><tr>';
      activeTable.columns.forEach(c=>{ html += `<th>${c.name}</th>`; });
      html += '</tr></thead><tbody>';

      const rows = activeTable.rows.filter(r=>!r.deletedAt);
      rows.forEach((r)=>{
        html += '<tr class="odd:bg-[#1c2a45] even:bg-[#18263f]">';
        activeTable.columns.forEach((c, idx)=>{
          const val = r.cells[idx] ?? '';
          if(!editMode){
            if(c.type==='link'){
              const label = formatLinkDisplay(val);
              html += `<td><a href="${val || '#'}" target="_blank" rel="noopener" class="text-blue-300 underline">${label}</a></td>`;
            } else {
              html += `<td>${val}</td>`;
            }
          }else{
            // inputs por tipo
            if(c.type==='checkbox'){
              const checked = String(val)==='true' || val===true;
              html += `<td><input type="checkbox" ${checked?'checked':''} data-cell="${r.id}|${idx}"/></td>`;
            } else if(c.type==='date'){
              html += `<td><input class="input" type="date" value="${val}" data-cell="${r.id}|${idx}"/></td>`;
            } else if(c.type==='number'){
              html += `<td><input class="input" type="number" value="${val}" data-cell="${r.id}|${idx}"/></td>`;
            } else if(c.type==='email'){
              html += `<td><input class="input" type="email" value="${val}" data-cell="${r.id}|${idx}"/></td>`;
            } else if(c.type==='link'){
              html += `<td><input class="input" type="url" placeholder="https://" value="${val}" data-cell="${r.id}|${idx}"/></td>`;
            } else if(c.type==='select'){
              const opts = c.options||[];
              html += `<td><select class="select" data-cell="${r.id}|${idx}"><option value=""></option>${opts.map(o=>`<option ${o===val?'selected':''}>${o}</option>`).join('')}</select></td>`;
            } else {
              html += `<td><input class="input" value="${val}" data-cell="${r.id}|${idx}"/></td>`;
            }
          }
        });
        html += '</tr>';
      });
      html += '</tbody></table>';
      dataGrid.innerHTML = html;

      if(editMode){
        // bind inputs
        dataGrid.querySelectorAll('[data-cell]').forEach(el=>{
          const [rowId, idxStr] = el.getAttribute('data-cell').split('|');
          const idx = +idxStr;
          const row = activeTable.rows.find(rr=>rr.id===rowId);
          if(!row) return;
          if(el.type==='checkbox'){
            el.onchange = ()=>{ row.cells[idx] = el.checked; activeTable.updatedAt = now(); };
          } else {
            el.oninput = ()=>{ row.cells[idx] = el.value; activeTable.updatedAt = now(); };
          }
        });
      }
    }

    // =================== Crear tabla (modal con tipos) ===================
    function openCreate(){
      newTableName.value = '';
      draftCols = [
        { id: uid('col'), name: 'Columna A', type:'text' },
        { id: uid('col'), name: 'Columna B', type:'text' },
      ];
      renderCreateCols();
      open(createModal);
    }
    function closeCreate(){ close(createModal); }

    function renderCreateCols(){
      newColsEditor.innerHTML = '';
      draftCols.forEach((c, i)=>{
        const row = document.createElement('div');
        row.className = 'grid grid-cols-12 gap-3 items-center bg-[var(--panel-2)] border border-[var(--border)] rounded-xl p-3';

        const nameWrap = document.createElement('div'); nameWrap.className='col-span-5';
        const name = document.createElement('input'); name.className='input'; name.placeholder='Nombre de la columna'; name.value=c.name||'';
        name.oninput = (e)=>{ c.name = e.target.value; };
        nameWrap.appendChild(name);

        const typeWrap = document.createElement('div'); typeWrap.className='col-span-3';
        const type = document.createElement('select'); type.className='select';
        ['text','number','date','checkbox','email','link','select'].forEach(tt=>{
          const o = document.createElement('option'); o.value=tt; o.textContent=tt; type.appendChild(o);
        });
        type.value = c.type||'text';
        type.onchange = (e)=>{ c.type = e.target.value; renderCreateCols(); };
        typeWrap.appendChild(type);

        const optWrap = document.createElement('div'); optWrap.className='col-span-3';
        if(c.type==='select'){
          const opt = document.createElement('input'); opt.className='input'; opt.placeholder="Opciones (coma)"; opt.value=(c.options||[]).join(',');
          opt.oninput = (e)=>{ c.options = e.target.value.split(',').map(x=>x.trim()).filter(Boolean); };
          optWrap.appendChild(opt);
        } else if(c.type==='link') {
          const hint = document.createElement('div'); hint.className='text-xs text-slate-300'; hint.textContent='Se mostrar√° solo el dominio (p. ej. ejemplo.com)';
          optWrap.appendChild(hint);
        }

        const actions = document.createElement('div'); actions.className='col-span-1 flex justify-end';
        const del = document.createElement('button'); del.className='btn-sec'; del.textContent='üóë';
        del.onclick = ()=>{ draftCols.splice(i,1); renderCreateCols(); };
        actions.appendChild(del);

        row.append(nameWrap, typeWrap, optWrap, actions);
        newColsEditor.appendChild(row);
      });
    }

    // =================== Eventos ===================
    document.getElementById('create-table').addEventListener('click', openCreate);
    document.querySelectorAll('[data-close-create]').forEach(b=> b.addEventListener('click', closeCreate));
    document.getElementById('add-new-col').addEventListener('click', ()=>{
      draftCols.push({ id: uid('col'), name: '', type:'text' });
      renderCreateCols(); // ‚Üê no perder lo escrito
    });
    document.getElementById('confirm-create').addEventListener('click', ()=>{
      const name = (newTableName.value||'').trim(); if(!name){ alert('Ponle un nombre a la tabla'); return; }
      if(!draftCols.length){ alert('A√±ade al menos una columna'); return; }
      const t = { id: uid('tbl'), name, columns: draftCols.map(c=>({ id:c.id, name:c.name||'Columna', type:c.type||'text', options:c.options||[] })), rows: [], createdAt: now(), updatedAt: now() };
      tables.unshift(t); closeCreate(); renderTables(); openTable(t,true);
    });

    // Editor
    toggleModeBtn.addEventListener('click', ()=>{ editMode = !editMode; renderEditor(); });
    backListBtn.addEventListener('click', ()=>{ activeTable=null; tableEditor.classList.add('hidden'); });
    addRowBtn.addEventListener('click', ()=>{
      if(!activeTable) return;
      const cells = activeTable.columns.map(()=> '');
      activeTable.rows.unshift({ id: uid('row'), cells, createdAt: now(), updatedAt: now() });
      renderEditor(); renderTables();
    });
    addColBtn.addEventListener('click', ()=>{
      if(!activeTable) return; addColName.value=''; addColType.value='text'; addColOptions.value=''; addColOptions.classList.add('hidden'); open(addColModal);
    });
    addColType.addEventListener('change', ()=>{
      addColOptions.classList.toggle('hidden', addColType.value!=='select');
    });
    document.querySelectorAll('[data-close-addcol]').forEach(b=> b.addEventListener('click', ()=> close(addColModal)));
    confirmAddCol.addEventListener('click', ()=>{
      const name = (addColName.value||'').trim(); if(!name){ alert('Nombre de columna'); return; }
      const type = addColType.value; const options = type==='select' ? addColOptions.value.split(',').map(x=>x.trim()).filter(Boolean) : [];
      const col = { id: uid('col'), name, type, options };
      activeTable.columns.push(col);
      activeTable.rows.forEach(r=> r.cells.push(''));
      activeTable.updatedAt = now();
      close(addColModal); renderEditor(); renderTables();
    });

    // =================== Demo inicial ===================
    (function ensureDemo(){
      if(tables.length) return;
      const t = { id:'demo', name:'Ejemplo ‚Äì Turnos OPs', columns:[
        {id:'op', name:'Operador', type:'text'},
        {id:'perop', name:'PEROP1AM', type:'text'},
        {id:'turno', name:'Turno', type:'select', options:['AM (07-16)','PM (13-22)']},
        {id:'desc', name:'Descanso', type:'select', options:['3:00 (15m)','4:00 (15m)','5:00 (45m)','6:00 (45m)']},
        {id:'tl', name:'Team Leader', type:'text'},
        {id:'camp', name:'Campa√±a', type:'text'},
        {id:'ficha', name:'Ficha', type:'link'}
      ], rows:[
        { id: uid('row'), cells:['Jennifer','PEROP1AM-40588','AM (07-16)','3:00 (15m)','Kevin','M√©xico','https://bi.ejemplo.com/reporte/123'] },
        { id: uid('row'), cells:['Manuel','PEROP1AM-40453','AM (07-16)','4:00 (15m)','Kevin','M√©xico','https://bi.ejemplo.com/reporte/999'] }
      ], createdAt: now(), updatedAt: now() };
      tables.push(t);
    })();

    renderTables();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gestión Center — v2.0 · Selector de Apoyo 2.0</title>

    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=Lexend:wght@300;400;600;700&display=swap" rel="stylesheet"/>

    <!-- 🔒 Ocultar hasta validar sesión -->
    <style>html{visibility:hidden}</style>
    <script type="module" src="../assets/guard.js"></script>

    <style>
      :root{
        --radius:16px; --radius-sm:12px; --radius-xs:10px;
        --font-title:'Outfit',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
        --font-body:'Lexend',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
        --t-fast:.15s; --t-med:.22s; --t-slow:.6s; --curve:cubic-bezier(.2,.7,.2,1);
        --elev-1:0 6px 20px rgba(0,0,0,.25); --elev-2:0 12px 34px rgba(0,0,0,.35);
        --hover-delay:80ms;
        --sidebar-w:280px;         /* ancho expandido */
        --sidebar-w-compact:72px;  /* ancho compacto  */
      }
      [data-theme="dark"]{
        --bg-app:#070b1a; --bg-aside:#0c1228;
        --bg-card:linear-gradient(160deg, rgba(17,24,49,.88), rgba(17,24,49,.7));
        --txt:#e9f1ff; --txt-muted:#b8c6de; --stroke:rgba(255,255,255,.10);
        --primary:#5b8bff; --accent:#7ae3ff;
        --table-bg:rgba(17,24,49,.65);
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0; font-family:var(--font-body); color:var(--txt);
        background:var(--bg-app);
        overflow-x:hidden;
      }

      /* ===== Fondo fijo (luces decorativas) ===== */
      #bg-fx{
        position:fixed; inset:0; z-index:-2; pointer-events:none;
        background:
          radial-gradient(1100px 1100px at 10% -10%, color-mix(in oklab, var(--primary) 30%, transparent), transparent 60%),
          radial-gradient(900px 900px at 90% 0%, color-mix(in oklab, var(--accent) 35%, transparent), transparent 55%);
        background-repeat:no-repeat; background-attachment:fixed;
      }
      /* ===== Sidebar (idéntica al Index) ===== */
      aside{
        position:fixed; inset:0 auto 0 0; width:var(--sidebar-w); z-index:25;
        backdrop-filter:saturate(120%) blur(8px);
        background:color-mix(in oklab, var(--bg-aside) 96%, transparent);
        border-right:1px solid var(--stroke);
        display:flex; flex-direction:column; padding:14px 12px; gap:12px; overflow:auto;
        contain: content;
        --pad-x: 10px;
      }
      aside::before, aside::after{
        content:""; position:sticky; display:block; height:14px; pointer-events:none; z-index:5;
      }
      aside::before{ top:0; background:linear-gradient(#0000, rgba(0,0,0,.25)) }
      aside::after{ bottom:0; background:linear-gradient(rgba(0,0,0,.25), #0000) }

      .brand{
        display:flex; align-items:center; justify-content:center;
        padding:12px; border-radius:var(--radius);
        border:1px solid var(--stroke);
        background:linear-gradient(132deg, color-mix(in oklab, var(--primary) 18%, transparent), color-mix(in oklab, var(--accent) 12%, transparent));
        transition: transform var(--t-fast) var(--curve), box-shadow var(--t-fast) ease;
        will-change: transform;
        text-decoration:none;
      }
      .brand:hover{ transform:scale(1.01) }
      .brand picture{ display:block; }
      .brand img{ width:160px; height:auto; object-fit:contain; filter:drop-shadow(0 6px 14px rgba(0,0,0,.35)); }

      .sidebar-toggle{
        display:flex; align-items:center; justify-content:center;
        gap:8px; width:100%; border:1px solid var(--stroke);
        padding:10px; border-radius:12px; background:rgba(255,255,255,.04);
        color:var(--txt); cursor:pointer; font-weight:700;
        transition:filter var(--t-med) ease, transform var(--t-fast) ease;
      }
      .sidebar-toggle:hover{ filter:brightness(1.05) }
      .sidebar-toggle:active{ transform:translateY(1px) }
      .sidebar-toggle .lbl{ font-size:13px }
      .sidebar-toggle[aria-pressed="true"] .lbl::after{ content:" (compacto)"; opacity:.8; font-weight:600 }

      nav{ position:relative; display:flex; flex-direction:column; gap:10px; }
      .nav-group{
        border:1px solid var(--stroke); border-radius:14px; overflow:hidden;
        background:color-mix(in oklab, var(--bg-aside) 92%, transparent)
      }
      .nav-head{
        width:100%; text-align:left; padding:10px 12px; border:0; background:transparent; color:var(--txt);
        font:700 13px/1 var(--font-title); letter-spacing:.3px; cursor:pointer; display:flex; align-items:center; gap:8px;
      }
      .nav-head .chev{ transition:transform var(--t-med) var(--curve) }
      .nav-group.is-collapsed .nav-head .chev{ transform:rotate(-90deg) }
      .nav-body{ overflow:hidden; transition:grid-template-rows .35s var(--curve), opacity .25s ease; display:grid; grid-template-rows:1fr; opacity:1 }
      .nav-group.is-collapsed .nav-body{ grid-template-rows:0fr; opacity:.0 }
      .nav-body-inner{ min-height:0; padding:6px; display:flex; flex-direction:column; gap:8px }

      .nav-item{
        display:flex; align-items:center; gap:10px; padding:12px var(--pad-x);
        border-radius:10px; text-decoration:none; color:var(--txt); font-size:15px;
        border:1px solid transparent;
        transition: background var(--t-med) ease var(--hover-delay),
                    transform var(--t-fast) ease var(--hover-delay);
        min-height:40px;
      }
      .nav-item:hover{ background:color-mix(in oklab, var(--bg-aside) 80%, transparent); transform:translateX(2px) }
      .nav-item .label{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100% }
      .nav-item.active{
        background:linear-gradient(90deg, color-mix(in oklab, var(--primary) 20%, transparent), color-mix(in oklab, var(--accent) 14%, transparent));
        border-color:var(--stroke)
      }
      .nav-indicator{
        position:absolute; left:6px; width:4px; height:40px; border-radius:0 3px 3px 0;
        background:linear-gradient(180deg, var(--primary), var(--accent));
        box-shadow:0 0 16px color-mix(in oklab, var(--accent) 65%, transparent);
        transition:transform 220ms var(--curve), height 220ms ease;
        will-change: transform, height;
        pointer-events:none;
      }

      .spacer{flex:1}
      .role-card{
        display:flex; align-items:center; gap:10px; padding:10px 12px;
        border-radius:14px; border:1px solid var(--stroke);
        background:color-mix(in oklab, var(--bg-aside) 92%, transparent);
      }
      .role-dot{ width:14px; height:14px; border-radius:50%; box-shadow:0 0 0 3px rgba(255,255,255,.06) inset, 0 0 14px rgba(0,0,0,.25) }
      .role-text small{ color:var(--txt-muted) }
      .role-badge{ font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--stroke); background:rgba(255,255,255,.06) }
      .logout{
        width:100%; border:1px solid var(--stroke);
        background:linear-gradient(180deg, #ef4444, #d62c2c); color:#fff;
        padding:12px; border-radius:12px; cursor:pointer; font-weight:700;
        transition:transform var(--t-fast) ease, filter var(--t-med) ease;
      }
      .logout:hover{filter:brightness(1.05)} .logout:active{transform:translateY(1px)}

      /* ===== Main ===== */
      main{ margin-left:var(--sidebar-w); padding:24px 22px 40px; transition:margin-left var(--t-med) var(--curve) }
      body.sidebar-compact aside{ width:var(--sidebar-w-compact) }
      body.sidebar-compact main{ margin-left:var(--sidebar-w-compact) }
      body.sidebar-compact .brand img{ width:42px }
      body.sidebar-compact .nav-head .txt, body.sidebar-compact .nav-item .label, body.sidebar-compact .sidebar-toggle .lbl, body.sidebar-compact .role-text{ display:none }
      body.sidebar-compact .nav-head{ justify-content:center }
      body.sidebar-compact .nav-group{ gap:0 }
      body.sidebar-compact .nav-item{ justify-content:center; padding-inline:0 }
      body.sidebar-compact .role-card{ justify-content:center; padding:10px }
      .hero{
        position:relative; border-radius:var(--radius); padding:18px 18px 18px 20px;
        background:linear-gradient(135deg, color-mix(in oklab, var(--primary) 14%, transparent), color-mix(in oklab, var(--accent) 12%, transparent));
        border:1px solid var(--stroke); overflow:hidden;
      }
      .hero h1{margin:0 0 6px; font:700 22px/1.2 var(--font-title)}
      .hero p{margin:0; color:var(--txt-muted); font-size:14px}

      /* ===== Contenido CampRev ===== */
      .filters{
        display:flex; gap:10px; flex-wrap:wrap; margin:14px 0 10px;
        background:rgba(255,255,255,.05); border:1px solid var(--stroke);
        padding:10px; border-radius:12px;
      }
      .filters select, .filters input{
        padding:8px 10px; border-radius:10px; border:1px solid var(--stroke);
        background:var(--table-bg); color:var(--txt); min-width:140px; height:38px;
      }
      .filters .search{ min-width:220px }
      table{
        width:100%; border-collapse:separate; border-spacing:0; margin-top:10px;
        background:var(--table-bg); border:1px solid var(--stroke); border-radius:12px; overflow:hidden;
        box-shadow:var(--elev-1);
      }
      thead th, td{ padding:10px; border-bottom:1px solid var(--stroke); text-align:center }
      thead th:first-child, tbody td:first-child{ text-align:left }
      thead th{
        position:relative; cursor:pointer;
        background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
        font:700 13px/1 var(--font-title);
      }
      .bandera{ width:20px; height:14px; margin-right:6px; vertical-align:middle }
      .money::before{ content:"$" }
      .actions{ display:flex; gap:8px; justify-content:center }
      .btn{
        padding:8px 12px; border:1px solid var(--stroke); border-radius:10px;
        background:rgba(255,255,255,.06); color:var(--txt); cursor:pointer;
      }
      .btn:active{ transform:translateY(1px) }
      .right{ display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:8px }
      .muted{ color:var(--txt-muted); font-size:13px }

      /* Responsive tabla */
      @media (max-width:1000px){
        .filters{ gap:8px }
        table{ font-size:13px }
        thead th, td{ padding:8px }
      }
    </style>
  </head>
  <body>
    <!-- 🔵 Fondo fijo (luces) -->
    <div id="bg-fx" aria-hidden="true"></div>

    <!-- ===== SIDEBAR (idéntica al Index) ===== -->
    <aside class="reveal" id="gc-aside">
      <a class="brand" href="../index.html" id="brandLink" aria-label="Inicio" title="Inicio">
        <picture>
          <source srcset="../images/logogestioncenter.webp" type="image/webp"/>
          <img id="brandLogo" src="../images/logogestioncenter.png" alt="Gestión Center" loading="lazy" decoding="async"/>
        </picture>
      </a>

      <button class="sidebar-toggle" id="btnSidebarToggle" aria-pressed="false" title="Compactar / Expandir">
        <span class="icon">⇆</span><span class="lbl">Cambiar ancho</span>
      </button>

      <nav id="gc-nav" role="navigation" aria-label="Navegación principal">
        <div class="nav-indicator" aria-hidden="true"></div>

        <a href="../index.html" class="nav-item" title="Inicio">
          🏠 <span class="label">Inicio</span>
        </a>

        <!-- REPORTES -->
        <section class="nav-group" data-key="grp-reportes">
          <button class="nav-head" title="Reportes">
            <span class="chev">▾</span> <span class="txt">📊 Reportes</span>
          </button>
          <div class="nav-body"><div class="nav-body-inner">
            <a href="../reports/newreport.html" class="nav-item" title="New Report">🧰 <span class="label">New Report</span></a>
            <a href="../reports/psreport.html" class="nav-item" title="Post-Sale Report">🚚 <span class="label">Post-Sale Report</span></a>
          </div></div>
        </section>

        <!-- OPERACIONES -->
        <section class="nav-group" data-key="grp-operaciones">
          <button class="nav-head" title="Operaciones">
            <span class="chev">▾</span> <span class="txt">🛠️ Operaciones</span>
          </button>
          <div class="nav-body"><div class="nav-body-inner">
            <a href="../operations/distribucion.html" class="nav-item" title="Distribución">📋 <span class="label">Distribución</span></a>
            <a href="../operations/biops.html" class="nav-item" title="BI de OPs + Links">🔗 <span class="label">BI de OPs + Links</span></a>
          </div></div>
        </section>

        <!-- COBERTURA -->
        <section class="nav-group" data-key="grp-cobertura">
          <button class="nav-head" title="Cobertura">
            <span class="chev">▾</span> <span class="txt">🌎 Cobertura</span>
          </button>
          <div class="nav-body"><div class="nav-body-inner">
            <a href="../cobertura.html" class="nav-item" title="Mapa de cobertura">🗺️ <span class="label">Mapa de cobertura</span></a>
            <a href="../newcobertura.html" class="nav-item" title="New Cobertura 1.1">🧭 <span class="label">New Cobertura 1.1</span></a>
          </div></div>
        </section>

        <!-- UTILIDADES -->
        <section class="nav-group" data-key="grp-utils">
          <button class="nav-head" title="Utilidades">
            <span class="chev">▾</span> <span class="txt">🧩 Utilidades</span>
          </button>
          <div class="nav-body"><div class="nav-body-inner">
            <a href="../utilities/camprev.html" class="nav-item" title="Selector de Apoyo 2.0">👥 <span class="label">Selector de Apoyo 2.0</span></a>
          </div></div>
        </section>
      </nav>

      <div class="spacer"></div>

      <div class="role-card" id="roleCard" title="Rango del usuario">
        <div class="role-dot" id="roleDot"></div>
        <div class="role-text">
          <strong id="roleName">Invitado</strong>
          <span class="role-badge" id="roleBadge" style="margin-left:6px">⭐ Invitado</span><br/>
          <small id="roleDesc">Acceso limitado</small>
        </div>
      </div>

      <button class="logout" onclick="gcLogout()">Salir</button>
    </aside>

    <!-- ===== CONTENIDO ===== -->
    <main>
      <section class="hero reveal">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap">
          <div>
            <h1>👥 Selector de Apoyo 2.0</h1>
            <p>Cruce dinámico de <b>datadistribucion.json</b> + <b>camprev.json</b> con filtros combinables.</p>
          </div>
          <div class="right">
            <button class="btn" id="btnReload">↻ Recargar</button>
            <button class="btn" id="btnReset">🧭 Restablecer</button>
          </div>
        </div>
      </section>

      <section class="filters">
        <select id="fPais" title="Filtrar por país">
          <option value="todos">🌍 Todos</option>
          <option>Chile</option><option>Colombia</option><option>Costa Rica</option>
          <option>Ecuador</option><option>Mexico</option><option>Paraguay</option>
          <option>Peru</option><option>Uruguay</option><option>Venezuela</option>
        </select>
        <select id="fTurno" title="Filtrar por turno">
          <option value="todos">⏰ Todos los turnos</option>
          <option>07:00 - 16:00</option>
          <option>08:00 - 17:00</option>
          <option>09:00 - 18:00</option>
          <option>10:00 - 19:00</option>
          <option>11:00 - 20:00</option>
          <option>12:00 - 21:00</option>
          <option>13:00 - 22:00</option>
          <option>14:00 - 23:00</option>
          <option>15:00 - 00:00</option>
          <option>22:00 - 07:00</option>
        </select>
        <select id="fTL" title="Filtrar por Team Leader">
          <option value="todos">⭐ Todos los TL</option>
        </select>
        <input id="fSearch" class="search" placeholder="🔎 Buscar por nombre, PEROP1AM, campaña…" />
      </section>

      <table id="tabla">
        <thead>
          <tr id="theadRow">
            <th data-k="idx">#</th>
            <th data-k="op">Operador</th>
            <th data-k="perop">PEROP1AM</th>
            <th data-k="pais">País</th>
            <th data-k="turno">Turno</th>
            <th data-k="campana">Campaña</th>
            <th data-k="tl">TL</th>
            <th data-k="avg">Avg Check</th>
            <th data-k="status">Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="right">
        <span class="muted" id="resume">—</span>
      </div>
    </main>

    <script type="module">
      // ========= Indicador activo + auto-scroll =========
      const items=[...document.querySelectorAll('nav .nav-item')];
      const indicator=document.querySelector('.nav-indicator');
      const navEl=document.getElementById('gc-nav');

      function setActive(){
        const current=(location.pathname.split('/').pop()||'index.html').toLowerCase();
        let active=items[0];
        items.forEach(a=>{
          const href=(a.getAttribute('href')||'').split('#')[0].split('/').pop().toLowerCase();
          if(href && href===current) active=a;
          a.classList.toggle('active', a===active);
          a.toggleAttribute('aria-current', a===active ? 'page':false);
        });
        if(active){
          const pr=navEl.getBoundingClientRect();
          const r=active.getBoundingClientRect();
          const y=r.top - pr.top + navEl.scrollTop;
          indicator.style.height=r.height+'px';
          indicator.style.transform=`translateY(${y}px)`;
          const margin=16;
          const topNeeded = y - margin;
          const bottomNeeded = y + r.height + margin - navEl.clientHeight;
          if (topNeeded < navEl.scrollTop) navEl.scrollTo({top: topNeeded, behavior:'smooth'});
          else if (bottomNeeded > navEl.scrollTop) navEl.scrollTo({top: bottomNeeded, behavior:'smooth'});
        }
      }
      setActive();
      navEl.addEventListener('scroll', setActive);
      window.addEventListener('resize', setActive);

      // ========= Grupos colapsables con memoria =========
      document.querySelectorAll('.nav-group').forEach(g=>{
        const key=g.dataset.key, head=g.querySelector('.nav-head');
        const saved=localStorage.getItem(key);
        if(saved==='0') g.classList.add('is-collapsed');
        head.addEventListener('click', ()=>{
          g.classList.toggle('is-collapsed');
          localStorage.setItem(key, g.classList.contains('is-collapsed')?'0':'1');
          setActive();
        });
      });

      // ========= Compact/Expand =========
      const btnToggle=document.getElementById('btnSidebarToggle');
      const compactKey='gc-sidebar-compact';
      function setCompactState(on){
        document.body.classList.toggle('sidebar-compact', !!on);
        btnToggle.setAttribute('aria-pressed', on ? 'true' : 'false');
        localStorage.setItem(compactKey, on ? '1' : '0');
      }
      btnToggle.addEventListener('click', ()=> setCompactState(!document.body.classList.contains('sidebar-compact')));
      setCompactState(localStorage.getItem(compactKey)==='1');

      // ========= Role UI (mismo sistema) =========
      const ROLE_STYLE={
        'owner':{name:'Owner',desc:'Control total',badge:'👑 Owner',color:'#f59e0b',gradient:'linear-gradient(135deg,#f59e0b,#8b5cf6,#06b6d4)'},
        'admin':{name:'Admin',desc:'Administración',badge:'🛡️ Admin',color:'#f59e0b',gradient:'linear-gradient(135deg,#f59e0b,#8b5cf6,#06b6d4)'},
        'supervisor':{name:'Supervisor',desc:'Lidera TLs',badge:'⭐ Supervisor',color:'#5b8bff',gradient:'linear-gradient(135deg,#5b8bff,#60a5fa)'},
        'team leader':{name:'Team Leader',desc:'Lidera equipo',badge:'⭐ TL',color:'#a78bfa',gradient:'linear-gradient(135deg,#a78bfa,#7c3aed)'},
        'analista':{name:'Analista',desc:'Calidad / Datos',badge:'📊 Analista',color:'#22d3ee',gradient:'linear-gradient(135deg,#22d3ee,#06b6d4)'},
        'calidad':{name:'Calidad',desc:'Auditoría',badge:'🧪 Calidad',color:'#22d3ee',gradient:'linear-gradient(135deg,#22d3ee,#06b6d4)'},
        'operador':{name:'Operador',desc:'Ventas / Gestión',badge:'⚙️ Operador',color:'#22c55e',gradient:'linear-gradient(135deg,#22c55e,#16a34a)'},
        'invitado':{name:'Invitado',desc:'Acceso limitado',badge:'⭐ Invitado',color:'#94a3b8',gradient:'linear-gradient(135deg,#94a3b8,#64748b)'}
      };
      function getRole(){
        const qp=new URLSearchParams(location.search).get('role');
        const w=(window.gcRole||'').toString().trim();
        const ls=(localStorage.getItem('gc-role')||'').trim();
        return (qp||w||ls||'Invitado');
      }
      (function applyRoleUI(roleRaw){
        const roleDot=document.getElementById('roleDot');
        const roleName=document.getElementById('roleName');
        const roleDesc=document.getElementById('roleDesc');
        const roleBadge=document.getElementById('roleBadge');
        const r=roleRaw.toLowerCase();
        const key=Object.keys(ROLE_STYLE).find(k=>r.includes(k))||'invitado';
        const cfg=ROLE_STYLE[key];
        roleDot.style.background=cfg.gradient;
        roleDot.style.boxShadow=`0 0 0 3px rgba(255,255,255,.06) inset, 0 0 18px ${cfg.color}55`;
        roleName.textContent=cfg.name; roleDesc.textContent=cfg.desc; roleBadge.textContent=cfg.badge;
        const card=document.getElementById('roleCard');
        card.style.filter = (key==='invitado') ? 'saturate(0.8) brightness(0.95)' : 'none';
        localStorage.setItem('gc-role', cfg.name);
      })(getRole());

      // ========= Normalizador rutas (GitHub Pages / dominio propio) =========
      (function(){
        const isGhProject = location.hostname.endsWith('github.io');
        const PROJECT_SLUG = 'Gestion-Center';
        const base = isGhProject ? `/${PROJECT_SLUG}/` : '/';
        document.querySelectorAll('nav a.nav-item[href], .brand[href]').forEach(a=>{
          const href=a.getAttribute('href'); if(!href || href.startsWith('#') || /^https?:\/\//i.test(href)) return;
          const clean=href.replace(/^\.?\//,''); a.setAttribute('href', base + clean);
        });
        const logo=document.querySelector('#brandLink img');
        if(logo){ let src=logo.getAttribute('src')||'../images/logogestioncenter.png';
          if(!/^https?:\/\//i.test(src)){ src=src.replace(/^\.?\//,''); logo.setAttribute('src', base + src); }
          const source=document.querySelector('#brandLink source');
          if(source){ let s=source.getAttribute('srcset')||'../images/logogestioncenter.webp';
            s=s.replace(/^\.?\//,''); source.setAttribute('srcset', base + s); }
        }
      })();

      // ========= CampRev: datos + UI =========
      const codigos={ "Chile":"cl","Colombia":"co","Costa Rica":"cr","Ecuador":"ec","Mexico":"mx","Paraguay":"py","Peru":"pe","Uruguay":"uy","Venezuela":"ve","Bolivia":"bo" };
      const flag=p=>codigos[p]?`<img class="bandera" src="https://flagcdn.com/w40/${codigos[p]}.png" alt="">`:"";

      const $ = sel => document.querySelector(sel);
      const fPais = $('#fPais');
      const fTurno = $('#fTurno');
      const fTL = $('#fTL');
      const fSearch = $('#fSearch');
      const tbody = document.querySelector('#tabla tbody');
      const resume = $('#resume');

      let baseDistrib = [];   // datadistribucion.json
      let baseCampRev = [];   // camprev.json
      let rows = [];          // combinado
      let sortState = {};     // estado de orden por columna (0 none, 1 desc, 2 asc)

      async function loadJSON(path){
        const res = await fetch(path, {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        return res.json();
      }

      async function loadData(){
        // Rutas relativas desde /utilities/camprev.html
        const distrib = await loadJSON('../data/datadistribucion.json');
        const camp = await loadJSON('../data/camprev.json');
        baseDistrib = Array.isArray(distrib) ? distrib : (distrib.data || []);
        baseCampRev = Array.isArray(camp) ? camp : (camp.data || []);
      }

      function merge(){
        const byPerop = new Map(baseDistrib.map(d => [String(d.PEROP1AM||d.perop||'').trim(), d]));
        const merged = [];
        for(const c of baseCampRev){
          const key = String(c.PEROP1AM || c.perop || '').trim();
          const d = byPerop.get(key);
          if(!d) continue; // 👈 omitir si no existe en datadistribucion
          merged.push({
            idx: 0,
            op: d.Nombre || d.name || '',
            perop: key,
            pais: d.Pais || d.pais || '',
            turno: d.Turno || d.turno || '',
            campana: c.Campana || c.campana || d.Campaña || d.campana || '',
            tl: d.TL || d.tl || '',
            avg: Number(c.AvgCheck || c.avg || 0),
            status: d.Status || d.status || 'Presente'
          });
        }
        // Index visible 1..N
        merged.forEach((r,i)=> r.idx=i+1);
        rows = merged;
        // Poblar TL únicos
        const tls = [...new Set(rows.map(r=>r.tl).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
        fTL.innerHTML = `<option value="todos">⭐ Todos los TL</option>` + tls.map(t=>`<option>${t}</option>`).join('');
      }

      function applyFilters(){
        const q = (fSearch.value||'').toLowerCase().trim();
        const p = fPais.value;
        const t = fTurno.value;
        const tl= fTL.value;

        let out = rows.filter(r=>{
          if(p!=='todos' && r.pais!==p) return false;
          if(t!=='todos' && r.turno!==t) return false;
          if(tl!=='todos' && r.tl!==tl) return false;
          if(q){
            const hay = (r.op||'').toLowerCase().includes(q)
                    || (r.perop||'').toLowerCase().includes(q)
                    || (r.campana||'').toLowerCase().includes(q)
                    || (r.tl||'').toLowerCase().includes(q);
            if(!hay) return false;
          }
          return true;
        });

        // Orden si hay alguna columna activa
        const activeCol = Object.keys(sortState).find(k=>sortState[k]>0);
        if(activeCol){
          const st = sortState[activeCol]; // 1 desc, 2 asc
          out.sort((a,b)=>{
            const A = a[activeCol]; const B = b[activeCol];
            const num = (v)=> (typeof v==='number' || /^\d+(\.\d+)?$/.test(String(v))) ? Number(v) : null;
            const nA=num(A), nB=num(B);
            let cmp=0;
            if(nA!=null && nB!=null) cmp = nA - nB;
            else cmp = String(A||'').localeCompare(String(B||''), 'es', {numeric:true});
            return st===1 ? -cmp : cmp;
          });
        }

        renderTable(out);
      }

      function renderTable(data){
        const html = data.map(r=>`
          <tr>
            <td>${r.idx}</td>
            <td>${r.op}</td>
            <td>${r.perop}</td>
            <td>${flag(r.pais)} ${r.pais}</td>
            <td>${r.turno}</td>
            <td>${r.campana}</td>
            <td>${r.tl}</td>
            <td class="money">${r.avg.toFixed(2)}</td>
            <td>${r.status}</td>
          </tr>
        `).join('');
        tbody.innerHTML = html || `<tr><td colspan="9" class="muted">Sin resultados con los filtros actuales.</td></tr>`;
        resume.textContent = `Mostrando ${data.length} de ${rows.length} registros`;
      }

      // Orden tri-estado para todas las columnas
      document.querySelectorAll('#theadRow th').forEach(th=>{
        th.addEventListener('click', ()=>{
          const k = th.dataset.k;
          if(!k) return;
          sortState = {}; // reset otros
          sortState[k] = ((sortState[k]||0)+1) % 3; // 0->1 desc, 1->2 asc, 2->0 none
          applyFilters();
        });
      });

      // Eventos filtros
      [fPais,fTurno,fTL].forEach(el=> el.addEventListener('change', applyFilters));
      fSearch.addEventListener('input', applyFilters);
      document.getElementById('btnReload').addEventListener('click', async ()=>{
        try{
          document.getElementById('btnReload').disabled = true;
          await loadData(); merge(); applyFilters();
        } finally {
          document.getElementById('btnReload').disabled = false;
        }
      });
      document.getElementById('btnReset').addEventListener('click', ()=>{
        fPais.value='todos'; fTurno.value='todos'; fTL.value='todos'; fSearch.value='';
        sortState={}; applyFilters();
      });

      // Boot
      (async function init(){
        try{
          await loadData();
          merge();
          applyFilters();
          // Activa reveal simple
          document.querySelectorAll('.reveal').forEach(el=>el.classList.add('show'));
        }catch(e){
          tbody.innerHTML = `<tr><td colspan="9">⚠️ Error cargando datos: ${e.message}</td></tr>`;
        }
      })();
    </script>
  </body>
</html>

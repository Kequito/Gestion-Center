<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>New Report — Gestión Center</title>

  <!-- Carga robusta de bw.css y shell -->
  <script type="module">
    const isGh  = location.hostname.endsWith('github.io');
    const parts = location.pathname.split('/').filter(Boolean);
    const repo  = isGh ? (parts[0] || '') : '';
    const base  = isGh ? `/${repo}/` : '/';
    const abs   = (p) => new URL(p.replace(/^\//, ''), location.origin + base).href;

    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = abs('assets/bw/bw.css');
    document.head.appendChild(link);

    import(abs('assets/bw/shell.js')).catch(e => {
      console.error('[newreport] No se pudo cargar shell.js:', e);
      document.head.insertAdjacentHTML('beforeend', `
        <style>
          :root{--gray-100:#f5f5f5;--gray-200:#e5e5e5;--gray-300:#d4d4d4;--gray-700:#3f3f3f;--gray-900:#111;--white:#fff;--black:#0a0a0a}
          body{font-family:'Lexend',system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
        </style>`);
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Ajustes locales -->
  <style>
    /* Título y estado Firebase */
    #nr .page-title{ display:flex; align-items:center; gap:10px; font-weight:800; font-size:20px; margin:0 0 8px }
    #nr .gc-chip.ok{ background:var(--gray-200); border-color:var(--gray-300) }
    #nr .datetime{ font-size:14px; color:var(--gray-700); margin:6px 0 10px }

    /* Área de pegado */
    #nr textarea{
      width:100%; min-height:150px; resize:vertical;
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      padding:12px; border:1px solid var(--gray-300); border-radius:12px;
      background:var(--white); color:var(--gray-900);
    }

    /* Tablas con bw.css + pequeños ajustes */
    .gc-table th, .gc-table td{ text-align:center }
    .gc-table thead th:first-child, .gc-table tbody td:first-child{ text-align:left }

    /* Semáforo % Approve */
    :root{
      --ok-bg:#eaf7ee; --ok-fg:#166534; --ok-br:#22c55e;
      --mid-bg:#fffbeb; --mid-fg:#92400e; --mid-br:#f59e0b;
      --bad-bg:#fef2f2; --bad-fg:#991b1b; --bad-br:#ef4444;
    }
    td.green{ background:var(--ok-bg); color:var(--ok-fg); font-weight:800; border-left:3px solid var(--ok-br) }
    td.orange{ background:var(--mid-bg); color:var(--mid-fg); font-weight:800; border-left:3px solid var(--mid-br) }
    td.red{ background:var(--bad-bg); color:var(--bad-fg); font-weight:800; border-left:3px solid var(--bad-br) }

    /* Botón eliminar histórico compacto */
    #tablaHistorico .gc-btn.gc-btn--sm{ padding:6px 10px; font-size:12px }

    /* ---- Campos nativos estilizados (para evitar issues de .gc-btn en selects/inputs) ---- */
    .gc-select, .gc-date{
      padding:8px 12px; border-radius:12px; border:1px solid var(--gray-300);
      background:var(--white); color:var(--gray-900); font-weight:700; line-height:1;
    }
    .gc-select{ appearance:auto; -webkit-appearance:auto }
    .gc-date{ appearance:auto; -webkit-appearance:auto }
    .gc-field-wrap{ display:flex; align-items:center; gap:8px }
  </style>
</head>
<body>
  <!-- Hero vacío (título propio abajo) -->
  <gc-shell hero-title="" hero-subtitle="">
    <section id="nr" class="gc-panel">
      <div class="page-title">🧰 New Report CC Perú</div>
      <div class="gc-chipset" style="margin-bottom:8px">
        <span id="fbBadge" class="gc-chip">Conectando…</span>
      </div>

      <div class="datetime" id="fechaHora"></div>

      <!-- Toolbar -->
      <div class="gc-toolbar" style="margin:10px 0 12px">
        <button class="gc-btn" onclick="procesar('numerico')">📦 Vista Numérica</button>
        <button class="gc-btn" onclick="procesar('porcentaje')">📈 Vista Porcentual</button>
        <button class="gc-btn" onclick="procesar('mixto')">🔁 Vista Mixta</button>
        <button class="gc-btn gc-btn--danger" onclick="borrarTodo()">🧹 Borrar</button>
        <button class="gc-btn" onclick="restablecerOrden()">🧭 Restablecer Orden</button>
        <a class="gc-btn u-right" href="https://panel.2wcall.com/stats/queue/index?QueueSearch%5Bcountries%5D=&QueueSearch%5Bdate_type%5D=partner_created_at&QueueSearch%5Bdate_range%5D=20%2F09%2F2025+0%3A00+-+20%2F09%2F2025+23%3A59&QueueSearch%5Bpartner_id%5D=1" target="_blank" rel="noopener">🔗 Fuente (Panel)</a>
      </div>

      <textarea id="inputData" placeholder="Pega aquí tu tabla con encabezados (Country, Total, New, Recall, No answer, Approved, Reject, Trash)…"></textarea>

      <table id="tablaReporte" class="gc-table gc-table--sticky" style="margin-top:12px">
        <thead><tr id="encabezadoTabla"></tr></thead>
        <tbody></tbody>
        <tfoot><tr id="filaTotales"></tr></tfoot>
      </table>

      <!-- Acciones histórico -->
      <div class="gc-toolbar" style="margin:12px 0 10px">
        <button id="btnRegistrar" class="gc-btn gc-btn--primary" onclick="registrarAvance()" disabled>📌 Registrar avance ahora</button>
        <button class="gc-btn gc-btn--danger" onclick="borrarHistorial()">🗑️ Borrar historial</button>
        <!-- (CSV eliminado) -->
      </div>

      <!-- Filtros -->
      <div class="gc-panel" style="margin-top:12px">
        <div class="gc-toolbar">
          <div class="gc-field-wrap">
            <span class="gc-chip">🌎 País</span>
            <select id="filtroPais" class="gc-select" onchange="onFiltroChange()">
              <option value="todos">🌍 Todos</option>
            </select>
          </div>

          <div class="gc-field-wrap">
            <span class="gc-chip">🗓️ Rango</span>
            <select id="presetRango" class="gc-select" onchange="onPresetChange()">
              <option value="dia">Día específico</option>
              <option value="hoy">Hoy</option>
              <option value="ayer">Ayer</option>
              <option value="7d">Últimos 7 días</option>
            </select>
          </div>

          <div class="gc-field-wrap">
            <span class="gc-chip">📅 Fecha</span>
            <input type="date" id="filtroFecha" class="gc-date" onchange="onFiltroChange()"/>
            <button class="gc-btn gc-btn--ghost" onclick="limpiarFecha()">Todos</button>
          </div>
        </div>
      </div>

      <!-- Métricas rápidas -->
      <div id="quickMetrics" class="gc-toolbar" style="display:none; margin:12px 0">
        <span class="gc-chip"><strong>Min % Approve</strong> <span id="mMin">–</span></span>
        <span class="gc-chip"><strong>Mediana % Approve</strong> <span id="mMed">–</span></span>
        <span class="gc-chip"><strong>Max % Approve</strong> <span id="mMax">–</span></span>
        <span class="gc-chip"><strong>Δ vs hora previa</strong> <span id="mDelta">–</span></span>
      </div>

      <h3 style="font-size:16px; margin:6px 0 8px">📋 Registro histórico por hora</h3>
      <table id="tablaHistorico" class="gc-table gc-table--sticky gc-table--compact">
        <thead>
          <tr>
            <th>Hora</th><th>Fecha</th><th>País</th>
            <th>Leads</th><th>News</th><th>Recall</th><th>No Answer</th>
            <th>Approve</th><th>% Approve</th><th>Reject</th><th>Trash</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="gc-panel" style="margin-top:12px">
        <canvas id="graficoAvance" height="220"></canvas>
      </div>
    </section>

    <div id="toast" class="gc-panel" style="position:fixed; bottom:18px; right:20px; display:none; z-index:1000"></div>
  </gc-shell>

  <!-- Lógica -->
  <script type="module">
    async function waitForEl(sel, timeout=8000){
      const t0=performance.now();
      while(performance.now()-t0 < timeout){
        const el=document.querySelector(sel);
        if(el) return el;
        await new Promise(r=>setTimeout(r, 40));
      }
      throw new Error("Timeout esperando " + sel);
    }
    await customElements.whenDefined('gc-shell');
    await waitForEl('#encabezadoTabla');

    /* ===== Firebase ===== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCHBsq9AdVZEMVryQWReX7oaPparo9lK8M",
      authDomain: "gestioncenterdata.firebaseapp.com",
      projectId: "gestioncenterdata",
      storageBucket: "gestioncenterdata.appspot.com",
      messagingSenderId: "628401314464",
      appId: "1:628401314464:web:0671233dfd801ee43587c5",
      measurementId: "G-NBFZYTN094"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const fbBadge = document.getElementById('fbBadge');
    function setBadge(txt, cls=''){ fbBadge.textContent = txt; fbBadge.className = 'gc-chip ' + (cls || ''); }

    let authSettled = false;
    const authWatchdog = setTimeout(()=>{
      if (!authSettled) {
        console.warn('[GC] Auth watchdog timeout → habilitado sin auth (temporal)');
        document.getElementById('btnRegistrar')?.removeAttribute('disabled');
        setBadge('Conectado ✓','ok');
        renderTablaHistorico();
      }
    }, 6000);

    /* ===== Utils ===== */
    const PREF_VISTA='gc_vista', PREF_ORDEN='gc_orden', PREF_FPAIS='gc_filtro_pais',
          PREF_FFECHA='gc_filtro_fecha_iso', PREF_PRESET='gc_preset_rango';
    const savePref=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
    const readPref=(k,d=null)=>{ try{const v=JSON.parse(localStorage.getItem(k)); return v??d;}catch{ return d;} };

    const pad2=n=>String(n).padStart(2,'0');
    const formatDDMMYYYY=d=>`${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
    const formatISO=d=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;

    function ddmmyyyyToISO(s){ if(!s) return ""; if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      const m=/^\s*(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})\s*$/.exec(s); if(!m) return ""; return `${m[3]}-${pad2(+m[2])}-${pad2(+m[1])}`; }

    function toHora24(str){
      if(!str) return "";
      let s=str.toString().trim().toLowerCase().replace(/\s+/g,'').replace(/[\.]/g,'');
      const m24=s.match(/^(\d{1,2}):(\d{2})$/); if(m24) return `${pad2(+m24[1])}:${pad2(+m24[2])}`;
      const m12=s.match(/^(\d{1,2}):(\d{2})(am|pm)$/);
      if(m12){ let h=+m12[1]%12, min=+m12[2]; if(m12[3]==='pm') h+=12; return `${pad2(h)}:${pad2(min)}`; }
      return str;
    }

    function actualizarFechaHora(){
      const ahora=new Date();
      const fecha=ahora.toLocaleDateString('es-PE',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
      const hora =ahora.toLocaleTimeString('es-PE',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
      document.getElementById('fechaHora').textContent=`📅 ${fecha} – 🕒 ${hora}`;
    }
    actualizarFechaHora(); setInterval(actualizarFechaHora,1000);

    let vistaActual=readPref(PREF_VISTA,'numerico'), dataGlobal={}, dataOriginal=[], estadoOrdenColumna=readPref(PREF_ORDEN,{}), columnaOrdenActual=null;

    const codigos={ "Chile":"cl","Colombia":"co","Costa Rica":"cr","Ecuador":"ec","Mexico":"mx","México":"mx","Paraguay":"py","Peru":"pe","Perú":"pe","Uruguay":"uy","Venezuela":"ve","Bolivia":"bo" };

    function mostrarToast(msg){
      const t=document.getElementById("toast");
      t.textContent=msg; t.style.display="block"; t.style.opacity=1;
      setTimeout(()=>{t.style.transition="opacity .5s"; t.style.opacity=0;},2600);
      setTimeout(()=>{t.style.display="none"; t.style.transition="";},3200);
    }

    const COLMAP={ country:["Country"], total:["Total"], news:["New"], recall:["Recall"], noAnswer:["No answer","No Answer"], approved:["Approved","Call center (approved)","Call center approved"], reject:["Reject"], trash:["Trash"] };

    function borrarTodo(){
      document.getElementById("inputData").value="";
      document.querySelector("#tablaReporte tbody").innerHTML="";
      document.querySelector("#encabezadoTabla").innerHTML="";
      document.querySelector("#filaTotales").innerHTML="";
      dataGlobal={}; dataOriginal=[]; estadoOrdenColumna={}; columnaOrdenActual=null; savePref(PREF_ORDEN,{});
    }

    function procesar(vista){
      vistaActual=vista; savePref(PREF_VISTA,vista); estadoOrdenColumna={}; savePref(PREF_ORDEN,{}); columnaOrdenActual=null;
      const input=document.getElementById("inputData").value.trim(); if(!input){ mostrarToast("Pega la tabla del panel para procesar."); return; }
      const filas=input.split("\n"), headersRaw=filas[0].split("\t").map(h=>h.trim()), headersLC=headersRaw.map(h=>h.toLowerCase());
      const idx=(names)=> (Array.isArray(names)?names:[names]).reduce((r,n)=> r>=0?r:(headersRaw.indexOf(n)>=0?headersRaw.indexOf(n):headersLC.indexOf(n.toLowerCase())), -1);
      const IDX={ country:idx(COLMAP.country), total:idx(COLMAP.total), news:idx(COLMAP.news), recall:idx(COLMAP.recall), noAnswer:idx(COLMAP.noAnswer), approved:idx(COLMAP.approved), reject:idx(COLMAP.reject), trash:idx(COLMAP.trash) };
      if(IDX.country===-1||IDX.total===-1){ mostrarToast("⚠️ Falta Country/Total."); return; }
      if(IDX.approved===-1){ mostrarToast("ℹ️ No encuentro ‘Approved’; usaré 0."); }
      dataGlobal={};
      for(let i=1;i<filas.length;i++){
        const f=filas[i].split("\t"), pais=(f[IDX.country]||"").trim(); if(!pais) continue;
        if(!dataGlobal[pais]) dataGlobal[pais]={total:0,news:0,recall:0,noAnswer:0,approved:0,reject:0,trash:0};
        const val=j=> j===-1?0:(parseInt(f[j])||0);
        dataGlobal[pais].total+=val(IDX.total); dataGlobal[pais].news+=val(IDX.news); dataGlobal[pais].recall+=val(IDX.recall); dataGlobal[pais].noAnswer+=val(IDX.noAnswer); dataGlobal[pais].approved+=val(IDX.approved); dataGlobal[pais].reject+=val(IDX.reject); dataGlobal[pais].trash+=val(IDX.trash);
      }
      dataOriginal=Object.entries(dataGlobal);
      renderTabla(); mostrarToast("✅ Datos procesados");
    }

    function pctSafe(v,t){ if(!t) return "0.0%"; return ((v/t)*100).toFixed(1)+"%"; }
    const colorPct=p=> p<=25?"red": p>=30?"green":"orange";

    function renderTabla(){
      const enc=document.getElementById("encabezadoTabla"), cuerpo=document.querySelector("#tablaReporte tbody"), tfoot=document.getElementById("filaTotales");
      enc.innerHTML=""; cuerpo.innerHTML=""; tfoot.innerHTML="";
      let cols=["País","Leads"];
      if(vistaActual==="numerico"){ cols.push("New","Recall","No Answer","Approve","Reject","Trash");
      }else if(vistaActual==="porcentaje"){ cols.push("% New","% Recall","% No Answer","% Approve","% Reject","% Trash");
      }else{ cols.push("New","% New","Recall","% Recall","No Answer","% No Answer","Approve","% Approve","Reject","% Reject","Trash","% Trash"); }
      cols.forEach(col=>{ const th=document.createElement("th"); th.textContent=col; if(col!=="País"){ th.style.cursor='pointer'; th.onclick=()=>cambiarOrdenColumna(col);} enc.appendChild(th); });

      let datos=[...dataOriginal];
      if(columnaOrdenActual){
        const e=estadoOrdenColumna[columnaOrdenActual]||0;
        datos.sort((a,b)=>{ const A=getValorOrdenable(a[1],columnaOrdenActual), B=getValorOrdenable(b[1],columnaOrdenActual);
          return e===1?B-A:e===2?A-B:0; });
      }
      const flag=p=>codigos[p]?`<img style="width:20px;height:14px;vertical-align:middle;margin-right:6px" src="https://flagcdn.com/w40/${codigos[p]}.png" alt="">`:"";

      for(const [pais,d] of datos){
        const t=d.total||0;
        const tr=document.createElement("tr");
        let html=`<td><strong>${flag(pais)} ${pais}</strong></td><td>${d.total}</td>`;
        if(vistaActual==="numerico"){
          html+=`<td>${d.news}</td><td>${d.recall}</td><td>${d.noAnswer}</td><td>${d.approved}</td><td>${d.reject}</td><td>${d.trash}</td>`;
        }else if(vistaActual==="porcentaje"){
          const cls = colorPct(t?d.approved/t*100:0);
          html+=`<td>${pctSafe(d.news,t)}</td><td>${pctSafe(d.recall,t)}</td><td>${pctSafe(d.noAnswer,t)}</td><td class="${cls}">${pctSafe(d.approved,t)}</td><td>${pctSafe(d.reject,t)}</td><td>${pctSafe(d.trash,t)}</td>`;
        }else{
          const cls = colorPct(t?d.approved/t*100:0);
          html+=`<td>${d.news}</td><td>${pctSafe(d.news,t)}</td><td>${d.recall}</td><td>${pctSafe(d.recall,t)}</td><td>${d.noAnswer}</td><td>${pctSafe(d.noAnswer,t)}</td><td>${d.approved}</td><td class="${cls}">${pctSafe(d.approved,t)}</td><td>${d.reject}</td><td>${pctSafe(d.reject,t)}</td><td>${d.trash}</td><td>${pctSafe(d.trash,t)}</td>`;
        }
        tr.innerHTML=html; cuerpo.appendChild(tr);
      }

      const tot=Object.values(dataGlobal).reduce((a,d)=>{ a.total+=d.total; a.news+=d.news; a.recall+=d.recall; a.noAnswer+=d.noAnswer; a.approved+=d.approved; a.trash+=d.trash; a.reject+=d.reject; return a; },{total:0,news:0,recall:0,noAnswer:0,approved:0,trash:0,reject:0});
      if(Object.keys(dataGlobal).length){
        let foot=`<td><strong>TOTAL</strong></td><td>${tot.total}</td>`; const t=tot.total||0;
        const clsTot = colorPct(t?tot.approved/t*100:0);
        if(vistaActual==="numerico"){
          foot+=`<td>${tot.news}</td><td>${tot.recall}</td><td>${tot.noAnswer}</td><td>${tot.approved}</td><td>${tot.reject}</td><td>${tot.trash}</td>`;
        }else if(vistaActual==="porcentaje"){
          foot+=`<td>${pctSafe(tot.news,t)}</td><td>${pctSafe(tot.recall,t)}</td><td>${pctSafe(tot.noAnswer,t)}</td><td class="${clsTot}">${pctSafe(tot.approved,t)}</td><td>${pctSafe(tot.reject,t)}</td><td>${pctSafe(tot.trash,t)}</td>`;
        }else{
          foot+=`<td>${tot.news}</td><td>${pctSafe(tot.news,t)}</td><td>${tot.recall}</td><td>${pctSafe(tot.recall,t)}</td><td>${tot.noAnswer}</td><td>${pctSafe(tot.noAnswer,t)}</td><td>${tot.approved}</td><td class="${clsTot}">${pctSafe(tot.approved,t)}</td><td>${tot.reject}</td><td>${pctSafe(tot.reject,t)}</td><td>${tot.trash}</td><td>${pctSafe(tot.trash,t)}</td>`;
        }
        tfoot.innerHTML=foot;
      }
    }

    function cambiarOrdenColumna(col){ estadoOrdenColumna[col]=(estadoOrdenColumna[col]||0)+1; if(estadoOrdenColumna[col]>2) estadoOrdenColumna[col]=0; columnaOrdenActual=estadoOrdenColumna[col]===0?null:col; savePref(PREF_ORDEN,estadoOrdenColumna); renderTabla(); }
    function restablecerOrden(){ estadoOrdenColumna={}; columnaOrdenActual=null; savePref(PREF_ORDEN,{}); renderTabla(); }
    function getValorOrdenable(d,col){ const t=d.total||0; const base={"Leads":d.total,"New":d.news,"% New":t?(d.news/t)*100:0,"Recall":d.recall,"% Recall":t?(d.recall/t)*100:0,"No Answer":d.noAnswer,"% No Answer":t?(d.noAnswer/t)*100:0,"Approve":d.approved,"% Approve":t?(d.approved/t)*100:0,"Reject":d.reject,"% Reject":t?(d.reject/t)*100:0,"Trash":d.trash,"% Trash":t?(d.trash/t)*100:0}; return base[col]||0; }

    /* ===== Cloud histórico ===== */
    let cloudHistorico=[];
    const filtroPaisEl=document.getElementById("filtroPais");
    const filtroFechaEl=document.getElementById("filtroFecha");
    const presetEl=document.getElementById("presetRango");

    function rangeFromPreset(preset, dateISO){
      const now=new Date();
      const todayISO = `${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}`;
      const startOf=(iso)=> new Date(`${iso}T00:00:00`).getTime();
      const addDays=(iso,days)=>{ const d=new Date(`${iso}T00:00:00`); d.setDate(d.getDate()+days); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; };
      if(preset==='hoy'){ const s=startOf(todayISO), e=startOf(addDays(todayISO,1)); return {start:s, end:e}; }
      if(preset==='ayer'){ const y=addDays(todayISO,-1); return {start:startOf(y), end:startOf(todayISO)}; }
      if(preset==='7d'){ const s=addDays(todayISO,-6); return {start:startOf(s), end:startOf(addDays(todayISO,1))}; }
      if(preset==='dia' && dateISO){ return {start:startOf(dateISO), end:startOf(addDays(dateISO,1))}; }
      return {start:null, end:null};
    }

    function normalizeRows(rows){
      rows.forEach(r=>{
        const iso  = r.fechaISO || ddmmyyyyToISO(r.fecha);
        const hhmm = r.hora24 || toHora24(r.hora);
        if(!r.ts && iso && hhmm){ r.ts = new Date(`${iso}T${hhmm}:00`).getTime(); }
        r.hora = hhmm || r.hora;
      });
      rows.sort((a,b)=>(a.ts||0)-(b.ts||0));
      return rows;
    }

    async function fetchHistoricoCloud(fp, startTs, endTs){
      const base = collection(db,'historico');
      try {
        let qy;
        if(fp !== 'todos' && startTs != null && endTs != null){
          qy = query(base, where('pais','==',fp), where('ts','>=',startTs), where('ts','<', endTs));
        } else if(startTs != null && endTs != null){
          qy = query(base, where('ts','>=',startTs), where('ts','<', endTs));
        } else if(fp !== 'todos'){
          qy = query(base, where('pais','==',fp));
        } else {
          qy = base;
        }
        const snap = await getDocs(qy);
        const rows = [];
        snap.forEach(d=>rows.push({ ...d.data(), _id: d.id }));
        return normalizeRows(rows);
      } catch (e) {
        console.warn('[GC] fetchHistoricoCloud fallback:', e);
        if (e.code === 'failed-precondition') {
          let q2 = base;
          if (startTs != null && endTs != null){
            q2 = query(base, where('ts','>=',startTs), where('ts','<', endTs));
          }
          const snap = await getDocs(q2);
          let rows = [];
          snap.forEach(d=>rows.push({ ...d.data(), _id: d.id }));
          if (fp !== 'todos') rows = rows.filter(r => r.pais === fp);
          return normalizeRows(rows);
        }
        throw e;
      }
    }

    // (temporal) habilitar botón siempre
    document.addEventListener('DOMContentLoaded', ()=>{ document.getElementById('btnRegistrar')?.removeAttribute('disabled'); });

    async function registrarAvance(){
      if(!Object.keys(dataGlobal).length){ mostrarToast("ℹ️ Procesa datos antes de registrar."); return; }
      const now=new Date();
      const hora24=`${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
      const fecha=formatDDMMYYYY(now), fechaISO=formatISO(now), ts=now.getTime();

      const colRef=collection(db,'historico');
      const writes=[];
      for(const [pais,d] of Object.entries(dataGlobal)){
        const total=d.total||0;
        writes.push(addDoc(colRef,{
          fecha, fechaISO, hora:hora24, hora24:hora24, ts, pais,
          leads:d.total, news:d.news, recall:d.recall, noAnswer:d.noAnswer,
          approve:d.approved, pctApprove: total?((d.approved/total)*100).toFixed(1):"0.0",
          reject:d.reject, trash:d.trash
        }));
      }
      try{
        await Promise.all(writes);
        mostrarToast("✅ Avance registrado en la nube.");
        await renderTablaHistorico();
        renderGrafico();
      }catch(e){
        console.error('[GC] Firestore write error:', e);
        mostrarToast("⚠️ Error guardando en la nube: " + (e.code || e.message));
      }
    }

    async function borrarHistorial(){
      if(!confirm("¿Borrar TODO el historial de la nube?")) return;
      try{
        const snap=await getDocs(collection(db,'historico'));
        const ops=[]; snap.forEach(d=>ops.push(deleteDoc(doc(db,'historico',d.id))));
        await Promise.all(ops); mostrarToast("🗑️ Historial borrado."); await renderTablaHistorico(); renderGrafico();
      }catch(e){ console.error(e); mostrarToast("❌ No se pudo borrar: " + (e.code||e.message)); }
    }

    async function eliminarRegistro(id){
      if(!id){ mostrarToast("⚠️ No se encontró el ID del registro."); return; }
      const ok = confirm("¿Seguro que deseas eliminar este registro?");
      if(!ok) return;
      try{
        await deleteDoc(doc(db, 'historico', id));
        mostrarToast("🗑️ Registro eliminado.");
        await renderTablaHistorico();
        renderGrafico();
      }catch(e){
        console.error(e);
        mostrarToast("❌ No se pudo eliminar: " + (e.code || e.message));
      }
    }

    async function ensurePaisesOptions(){
      if(filtroPaisEl.options.length>1) return;
      try{
        const snap=await getDocs(collection(db,'historico'));
        const set=new Set(); snap.forEach(d=>set.add(d.data().pais||""));
        [...set].filter(Boolean).forEach(p=>{ const o=document.createElement("option");o.value=p;o.textContent=p;filtroPaisEl.appendChild(o); });
      }catch(e){ console.warn('[GC] ensurePaisesOptions:', e); }
    }

    function calcMedian(arr){
      if(!arr.length) return 0;
      const v=[...arr].sort((a,b)=>a-b);
      const m=Math.floor(v.length/2);
      return v.length%2?v[m]:(v[m-1]+v[m])/2;
    }

    function renderQuickMetrics(){
      const box=document.getElementById('quickMetrics');
      if(!cloudHistorico.length){ box.style.display='none'; return; }
      const vals=cloudHistorico.map(r=>parseFloat(r.pctApprove||0)).filter(n=>!isNaN(n));
      if(!vals.length){ box.style.display='none'; return; }
      const min=Math.min(...vals).toFixed(1);
      const med=calcMedian(vals).toFixed(1);
      const max=Math.max(...vals).toFixed(1);

      document.getElementById('mMin').textContent=`${min}%`;
      document.getElementById('mMed').textContent=`${med}%`;
      document.getElementById('mMax').textContent=`${max}%`;

      let deltaTxt='–';
      if(vals.length>=2){
        const last=vals[vals.length-1], prev=vals[vals.length-2];
        const d=(last-prev).toFixed(1);
        const arrow = (d>=0? '↑':'↓');
        deltaTxt = `${arrow} ${Math.abs(d)} pp`;
      }
      document.getElementById('mDelta').textContent=deltaTxt;
      box.style.display='flex';
    }

    async function renderTablaHistorico(){
      await ensurePaisesOptions();
      const tbody=document.querySelector("#tablaHistorico tbody"); tbody.innerHTML="";

      // Forzar predeterminado "hoy" SIEMPRE al entrar
      const firstLoad = !sessionStorage.getItem('nr-init');
      if(firstLoad){
        presetEl.value = 'hoy';
        filtroFechaEl.value = '';
        filtroFechaEl.disabled = true;
        savePref(PREF_PRESET,'hoy');
        savePref(PREF_FFECHA,'');
        sessionStorage.setItem('nr-init','1');
      }else{
        // restaurar desde prefs para navegación interna
        const prefPais=readPref(PREF_FPAIS,'todos');
        const prefFecha=readPref(PREF_FFECHA,'');
        const prefPreset=readPref(PREF_PRESET,'hoy');
        if([...filtroPaisEl.options].some(o=>o.value===prefPais)) filtroPaisEl.value=prefPais;
        presetEl.value = prefPreset;
        if(prefFecha) filtroFechaEl.value = prefFecha;
        filtroFechaEl.disabled = (presetEl.value !== 'dia');
      }

      const {start, end} = rangeFromPreset(presetEl.value, (filtroFechaEl.value||''));

      try{
        cloudHistorico=await fetchHistoricoCloud(filtroPaisEl.value, start, end);
      }catch(e){
        console.error('[GC] Fetch histórico:', e);
        mostrarToast("⚠️ No se pudo leer la nube: " + (e.code||e.message));
        cloudHistorico=[];
      }

      cloudHistorico.forEach(r=>{
        const pct = Number(r.pctApprove||0);
        const cls = colorPct(pct);
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${r.hora||""}</td>
          <td>${r.fecha||""}</td>
          <td>${r.pais||""}</td>
          <td>${r.leads||0}</td>
          <td>${r.news||0}</td>
          <td>${r.recall||0}</td>
          <td>${r.noAnswer||0}</td>
          <td>${r.approve||0}</td>
          <td class="${cls}">${pct.toFixed(1)}%</td>
          <td>${r.reject||0}</td>
          <td>${r.trash||0}</td>
          <td>
            <button class="gc-btn gc-btn--sm gc-btn--danger" ${r._id ? '' : 'disabled'}
              onclick="eliminarRegistro('${r._id||''}')" title="Eliminar este registro">
              🗑️ Eliminar
            </button>
          </td>`;
        tbody.appendChild(tr);
      });

      renderQuickMetrics();
      renderGrafico();
    }

    function onFiltroChange(){
      savePref(PREF_FPAIS, filtroPaisEl.value);
      savePref(PREF_FFECHA, filtroFechaEl.value || '');
      renderTablaHistorico();
    }
    function onPresetChange(){
      const preset=presetEl.value;
      savePref(PREF_PRESET, preset);
      filtroFechaEl.disabled = (preset !== 'dia');
      if(preset!=='dia'){ filtroFechaEl.value=''; savePref(PREF_FFECHA,''); }
      renderTablaHistorico();
    }
    function limpiarFecha(){
      filtroFechaEl.value="";
      savePref(PREF_FFECHA,'');
      presetEl.value='dia';
      savePref(PREF_PRESET,'dia');
      filtroFechaEl.disabled=false;
      renderTablaHistorico();
    }

    function renderGrafico(){
      const ctx=document.getElementById('graficoAvance').getContext('2d');
      const agr={}; cloudHistorico.forEach(r=>{ if(!agr[r.pais]) agr[r.pais]=[]; agr[r.pais].push({x:r.hora,y:r.pctApprove}); });
      const grayPal=['#111','#333','#555','#777','#999','#bbb'];
      const datasets=Object.keys(agr).map((k,i)=>({
        label:k, data:agr[k], fill:false, tension:.2,
        borderColor: grayPal[i % grayPal.length],
        backgroundColor: grayPal[i % grayPal.length],
        pointRadius: 2
      }));
      if(window.graficoAvance) window.graficoAvance.destroy();
      window.graficoAvance=new Chart(ctx,{type:'line',data:{datasets},options:{responsive:true,plugins:{legend:{position:'top'}},scales:{x:{title:{display:true,text:'Hora'},type:'category'},y:{title:{display:true,text:'% Approve'},beginAtZero:true,max:100}}}});
    }

    // Exponer
    window.procesar=procesar; window.borrarTodo=borrarTodo; window.restablecerOrden=restablecerOrden;
    window.registrarAvance=registrarAvance; window.borrarHistorial=borrarHistorial;
    window.onFiltroChange=onFiltroChange; window.onPresetChange=onPresetChange; window.limpiarFecha=limpiarFecha;
    window.eliminarRegistro=eliminarRegistro;

    // Auth
    onAuthStateChanged(auth, ()=>{
      authSettled = true;
      clearTimeout(authWatchdog);
      document.getElementById('btnRegistrar')?.removeAttribute('disabled');
      setBadge('Conectado ✓','ok');
      renderTablaHistorico();
    });
    signInAnonymously(auth).catch(e=>{ console.error('[GC] signInAnonymously error:', e); });

    // Init (fija 'hoy' en primer ingreso de la sesión)
    document.addEventListener('DOMContentLoaded', ()=>{
      presetEl.value='hoy';
      filtroFechaEl.disabled=true;
      savePref(PREF_PRESET,'hoy');
      savePref(PREF_FFECHA,'');
    });
  </script>
</body>
</html>

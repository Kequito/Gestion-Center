<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>New Report ‚Äî Gesti√≥n Center</title>

  <!-- Carga el shell con BASE robusto -->
  <script type="module">
  const isGh  = location.hostname.endsWith('github.io');
  const parts = location.pathname.split('/').filter(Boolean);
  const repo  = isGh ? (parts[0] || '') : '';
  const base  = isGh ? `/${repo}/` : '/';
  const abs   = (p) => new URL(p.replace(/^\//, ''), location.origin + base).href;

  import(abs('assets/bw/shell.js')).catch(e => {
    console.error('[newreport] No se pudo cargar shell.js:', e);
    document.head.insertAdjacentHTML('beforeend', `
      <style>:root{--gray-100:#f5f5f5;--gray-200:#e5e5e5;--gray-300:#d4d4d4;
      --gray-700:#3f3f3f;--gray-900:#111;--white:#fff;--black:#0a0a0a;
      font-family: Lexend,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}</style>`);
  });
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    #nr .page-title{ display:flex; align-items:center; gap:12px; font-weight:700; font-size:22px; margin:0 0 6px }
    #nr .subtitle{ margin:0 0 10px; color:var(--gray-700); font-size:14px; display:flex; align-items:center; gap:10px }

    #nr .badge{ font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--gray-300); background:var(--gray-100); color:var(--gray-900) }
    #nr .badge.ok{ background:var(--gray-200) }  #nr .badge.warn{ background:var(--gray-300) }

    #nr .datetime{ font-size:14px; font-weight:600; margin:8px 0 14px; color:var(--gray-700) }

    #nr .toolbar{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 14px; align-items:center }
    #nr .toolbar button, #nr .toolbar a.button, #nr .history-actions button{
      padding:10px 14px; font-size:14px; cursor:pointer; border:1px solid var(--gray-300); border-radius:10px;
      background:var(--white); color:var(--gray-900); transition:background .15s ease, transform .03s ease, filter .15s ease;
      text-decoration:none; display:inline-flex; align-items:center; gap:8px;
    }
    #nr .toolbar button:hover, #nr .toolbar a.button:hover, #nr .history-actions button:hover{ background:var(--gray-100) }
    #nr .toolbar button:active, #nr .toolbar a.button:active, #nr .history-actions button:active{ transform:translateY(1px) }
    #nr .toolbar button[disabled], #nr .history-actions button[disabled]{ opacity:.55; cursor:not-allowed }

    #nr .toolbar .btn-danger, #nr .history-actions .btn-danger{ background:#fef2f2; border-color:#fecaca; color:#991b1b; }
    #nr .toolbar .btn-danger:hover, #nr .history-actions .btn-danger:hover{ background:#fee2e2; filter:brightness(1.02); }

    /* Toggle de vista (un solo bot√≥n ‚Äúdeslizable‚Äù que cicla modos) */
    #viewToggle{ position:relative; }
    #viewToggle .mode{ font-weight:700 }
    #viewToggle[data-mode="numerico"] .mode{ color:#111 }
    #viewToggle[data-mode="porcentaje"] .mode{ color:#111 }
    #viewToggle[data-mode="mixto"] .mode{ color:#111 }

    #nr textarea{
      width:100%; min-height:150px; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      padding:12px; border:1px solid var(--gray-300); background:var(--white); color:var(--gray-900); border-radius:12px; box-sizing:border-box
    }
    #nr textarea[readonly]{ background:#fafafa; color:#555; }

    #nr table{ margin-top:16px; border-collapse:separate; border-spacing:0; width:100%;
      background:var(--white); border:1px solid var(--gray-300); border-radius:12px; overflow:hidden }
    #nr th,#nr td{ border-bottom:1px solid var(--gray-200); padding:10px; text-align:center }
    #nr thead th{ cursor:pointer; position:relative; font-weight:700 }
    #nr thead th:first-child, #nr tbody td:first-child{ text-align:left }
    #nr .bandera{ width:20px; height:14px; margin-right:6px; vertical-align:middle }
    #nr .bold{ font-weight:700 }

    :root{
      --ok-bg:#eaf7ee; --ok-fg:#166534; --ok-br:#22c55e;
      --mid-bg:#fffbeb; --mid-fg:#92400e; --mid-br:#f59e0b;
      --bad-bg:#fef2f2; --bad-fg:#991b1b; --bad-br:#ef4444;
    }
    #nr td.green{ background:var(--ok-bg); color:var(--ok-fg); font-weight:800; border-left:3px solid var(--ok-br) }
    #nr td.orange{ background:var(--mid-bg); color:var(--mid-fg); font-weight:800; border-left:3px solid var(--mid-br) }
    #nr td.red{ background:var(--bad-bg); color:var(--bad-fg); font-weight:800; border-left:3px solid var(--bad-br) }

    #nr tfoot td{ font-weight:800; background:var(--gray-100); border-top:2px solid var(--gray-300) }

    #nr .filters{ display:flex; align-items:center; gap:22px; flex-wrap:wrap; background:var(--white);
      border:1px solid var(--gray-300); border-radius:12px; padding:10px 12px; margin-top:18px }
    #nr .filter-group{ display:flex; align-items:center; gap:10px }
    #nr .filter-group label{ display:flex; align-items:center; gap:8px; font-weight:700; margin:0 }
    #nr .filter-group select, #nr .filter-group input[type="date"]{
      padding:8px 12px; border-radius:10px; border:1px solid var(--gray-300); background:var(--white); color:var(--gray-900);
      min-width:140px; line-height:1; height:38px
    }
    #nr .filter-group .clear-btn{ background:var(--gray-100); border:1px solid var(--gray-300); padding:8px 12px; border-radius:10px; cursor:pointer }
    #nr .filter-group .clear-btn:hover{ background:var(--gray-200) }

    #nr .quick-metrics{ display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 }
    #nr .metric{ background:var(--white); border:1px solid var(--gray-300); padding:10px 12px; border-radius:10px; min-width:150px }
    #nr .metric .title{ font-size:12px; color:var(--gray-700); margin-bottom:4px }
    #nr .metric .value{ font-size:18px; font-weight:800 }
    #nr .metric .delta.up{ color:#16a34a }   /* verde */
    #nr .metric .delta.down{ color:#dc2626 } /* rojo */

    #tablaHistorico .btn-danger{
      padding:6px 10px; font-size:12px; border-radius:8px; border:1px solid #fecaca;
      background:#fef2f2; color:#991b1b; cursor:pointer;
    }
    #tablaHistorico .btn-danger:hover{ background:#fee2e2 }

    #toast{ position:fixed; bottom:18px; right:20px; background:var(--black); color:#fff;
      padding:12px 18px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,.35); display:none; z-index:1000 }

    #lockInfo{ display:flex; align-items:center; gap:8px; font-size:12px; }
  </style>
</head>
<body>
  <gc-shell hero-title="" hero-subtitle="">
    <section id="nr">
      <div class="page-title">üß∞ New Report CC Per√∫</div>
      <p class="subtitle">
        <span id="fbBadge" class="badge">Conectando‚Ä¶</span>
        <span id="lockInfo" class="badge warn" style="display:none;"></span>
      </p>

      <div class="datetime" id="fechaHora"></div>

      <div class="toolbar">
        <!-- √öNICO BOT√ìN DESLIZABLE DE VISTA -->
        <button id="viewToggle" data-mode="numerico" title="Cambiar vista (clic para rotar)">
          <span class="icon" id="viewIcon">üì¶</span>
          <span class="mode" id="viewLabel">Vista Num√©rica</span>
        </button>

        <!-- Edici√≥n compartida -->
        <button id="btnTakeLock"     title="Tomar control de edici√≥n">üîí Tomar control</button>
        <button id="btnReleaseLock"  title="Liberar control" disabled>üîì Liberar</button>
        <button id="btnPushData"     title="Guardar/compartir datos pegados" disabled>‚¨ÜÔ∏è Compartir datos</button>

        <!-- Otros -->
        <button class="btn-danger" id="btnBorrarTodo">üßπ Borrar</button>
        <button id="btnRestOrden">üß≠ Restablecer Orden</button>

        <a class="button" href="https://panel.2wcall.com/stats/queue/index?QueueSearch%5Bcountries%5D=&QueueSearch%5Bdate_type%5D=partner_created_at&QueueSearch%5Bdate_range%5D=20%2F09%2F2025+0%3A00+-+20%2F09%2F2025+23%3A59&QueueSearch%5Bpartner_id%5D=1" target="_blank" rel="noopener">üîó Fuente (Panel)</a>
      </div>

      <textarea id="inputData" placeholder="Pega aqu√≠ tu tabla‚Ä¶" readonly></textarea>

      <table id="tablaReporte">
        <thead><tr id="encabezadoTabla"></tr></thead>
        <tbody></tbody>
        <tfoot><tr id="filaTotales"></tr></tfoot>
      </table>

      <div class="history-actions" style="display:flex; gap:10px; flex-wrap:wrap; margin:14px 0 10px;">
        <button id="btnRegistrar" disabled>üìå Registrar avance ahora</button>
        <button class="btn-danger" id="btnBorrarHist">üóëÔ∏è Borrar historial</button>
      </div>

      <div class="filters">
        <div class="filter-group">
          <label for="filtroPais">üåé Pa√≠s:</label>
          <select id="filtroPais">
            <option value="todos">üåç Todos</option>
          </select>
          <button class="clear-btn" id="btnAllCountries">Todos</button>
        </div>

        <div class="filter-group">
          <label for="presetRango">üóìÔ∏è Rango:</label>
          <select id="presetRango">
            <option value="dia">D√≠a espec√≠fico</option>
            <option value="hoy">Hoy</option>
            <option value="ayer">Ayer</option>
            <option value="7d">√öltimos 7 d√≠as</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="filtroFecha">üìÖ Fecha:</label>
          <input type="date" id="filtroFecha"/>
          <button class="clear-btn" id="btnClearFecha">Todos</button>
        </div>
      </div>

      <div id="quickMetrics" class="quick-metrics" style="display:none;">
        <div class="metric"><div class="title">Min % Approve</div><div id="mMin" class="value">‚Äì</div></div>
        <div class="metric"><div class="title">Mediana % Approve</div><div id="mMed" class="value">‚Äì</div></div>
        <div class="metric"><div class="title">Max % Approve</div><div id="mMax" class="value">‚Äì</div></div>
        <div class="metric"><div class="title">Œî vs hora previa</div><div id="mDelta" class="value">‚Äì</div></div>
      </div>

      <h3 class="page-title" style="font-size:18px; margin-top:6px;">üìã Registro hist√≥rico por hora</h3>
      <table id="tablaHistorico">
        <thead>
          <tr>
            <th>Hora</th><th>Fecha</th><th>Pa√≠s</th>
            <th>Leads</th><th>News</th><th>Recall</th><th>No Answer</th>
            <th>Approve</th><th>% Approve</th><th>Reject</th><th>Trash</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <canvas id="graficoAvance" height="220"></canvas>
    </section>

    <div id="toast"></div>
  </gc-shell>

  <script type="module">
    // Espera util
    async function waitForEl(sel, timeout=8000){
      const t0=performance.now();
      while(performance.now()-t0 < timeout){
        const el=document.querySelector(sel);
        if(el) return el;
        await new Promise(r=>setTimeout(r, 40));
      }
      throw new Error("Timeout esperando " + sel);
    }
    await customElements.whenDefined('gc-shell');
    await waitForEl('#encabezadoTabla');

    // Firebase v10.12.2 (mismo stack del guard)
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc, onSnapshot, runTransaction, serverTimestamp, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const auth = getAuth();
    const db   = getFirestore();

    const fbBadge   = document.getElementById('fbBadge');
    const lockInfoEl= document.getElementById('lockInfo');
    const setBadge = (txt, cls='') => { fbBadge.textContent = txt; fbBadge.className = 'badge ' + cls; };

    // Prefs
    const PREF_VISTA='gc_vista', PREF_ORDEN='gc_orden', PREF_FPAIS='gc_filtro_pais',
          PREF_FFECHA='gc_filtro_fecha_iso', PREF_PRESET='gc_preset_rango';
    const savePref=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
    const readPref=(k,d=null)=>{ try{const v=JSON.parse(localStorage.getItem(k)); return v??d;}catch{ return d;} };

    // Tiempo
    const pad2=n=>String(n).padStart(2,'0');
    const formatDDMMYYYY=d=>`${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
    const formatISO=d=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const ddmmyyyyToISO=(s)=>{ if(!s) return ""; if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s; const m=/^\s*(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})\s*$/.exec(s); if(!m) return ""; return `${m[3]}-${pad2(+m[2])}-${pad2(+m[1])}`; };
    function toHora24(str){
      if(!str) return "";
      let s=str.toString().trim().toLowerCase().replace(/\s+/g,'').replace(/[\.]/g,'');
      const m24=s.match(/^(\d{1,2}):(\d{2})$/); if(m24) return `${pad2(+m24[1])}:${pad2(+m24[2])}`;
      const m12=s.match(/^(\d{1,2}):(\d{2})(am|pm)$/);
      if(m12){ let h=+m12[1]%12, min=+m12[2]; if(m12[3]==='pm') h+=12; return `${pad2(h)}:${pad2(min)}`; }
      return str;
    }
    function actualizarFechaHora(){
      const ahora=new Date();
      const fecha=ahora.toLocaleDateString('es-PE',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
      const hora =ahora.toLocaleTimeString('es-PE',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
      document.getElementById('fechaHora').textContent=`üìÖ ${fecha} ‚Äì üïí ${hora}`;
    }
    actualizarFechaHora(); setInterval(actualizarFechaHora,1000);

    // UI refs
    const inputEl       = document.getElementById('inputData');
    const viewToggleBtn = document.getElementById('viewToggle');
    const viewIcon      = document.getElementById('viewIcon');
    const viewLabel     = document.getElementById('viewLabel');

    const btnTakeLock   = document.getElementById('btnTakeLock');
    const btnRelease    = document.getElementById('btnReleaseLock');
    const btnPushData   = document.getElementById('btnPushData');

    const btnRegistrar  = document.getElementById('btnRegistrar');
    const btnBorrarHist = document.getElementById('btnBorrarHist');
    const btnBorrarTodo = document.getElementById('btnBorrarTodo');
    const btnRestOrden  = document.getElementById('btnRestOrden');

    const filtroPaisEl  = document.getElementById("filtroPais");
    const filtroFechaEl = document.getElementById("filtroFecha");
    const presetEl      = document.getElementById("presetRango");
    const btnAllCountries = document.getElementById("btnAllCountries");
    const btnClearFecha   = document.getElementById("btnClearFecha");

    // Estado compartido
    const nrDocRef = doc(db,'nr_state','global');
    const LOCK_TTL_SEC = 120;
    let heartbeatTimer = null;
    let holdLock = false;
    let myRank = 'invitado';
    let canEdit = false;
    let canDelete = false;
    let lastSnapshotDataRaw = '';
    let vistaActual = readPref(PREF_VISTA,'numerico');

    const ALLOWED_EDIT_ROLES   = new Set(['supervisor','admin']);
    const ALLOWED_DELETE_ROLES = new Set(['supervisor','admin']);

    async function getRank(){
      const u = auth.currentUser;
      if(!u) return 'invitado';
      const t = await u.getIdTokenResult(true);
      return String(t.claims?.rank || 'invitado').toLowerCase();
    }

    function setViewButton(mode){
      viewToggleBtn.dataset.mode = mode;
      if(mode==='numerico'){ viewIcon.textContent='üì¶'; viewLabel.textContent='Vista Num√©rica'; }
      else if(mode==='porcentaje'){ viewIcon.textContent='üìà'; viewLabel.textContent='Vista Porcentual'; }
      else { viewIcon.textContent='üîÅ'; viewLabel.textContent='Vista Mixta'; }
    }
    setViewButton(vistaActual);

    function applyRoleUI(){
      // vista (toggle)
      viewToggleBtn.disabled = !canEdit;

      // edici√≥n compartida
      btnTakeLock.disabled = !canEdit || holdLock;
      btnRelease.disabled  = !holdLock;
      btnPushData.disabled = !holdLock;
      inputEl.readOnly     = !holdLock;

      // hist√≥rico
      btnRegistrar.disabled  = !canEdit;
      btnBorrarHist.disabled = !canDelete;
      btnBorrarTodo.disabled = !canDelete;
    }

    function showToast(msg){
      const t=document.getElementById("toast");
      t.textContent=msg; t.style.display="block"; t.style.opacity=1;
      setTimeout(()=>{t.style.transition="opacity .5s"; t.style.opacity=0;},2600);
      setTimeout(()=>{t.style.display="none"; t.style.transition="";},3200);
    }

    function setLockInfo(lock){
      if(!lock){ lockInfoEl.style.display='none'; return; }
      const { holderEmail, since } = lock;
      const at  = (since && since.toDate ? since.toDate() : null);
      const hhmm = at ? `${pad2(at.getHours())}:${pad2(at.getMinutes())}` : '‚Äî';
      lockInfoEl.textContent = holderEmail
        ? `üîí En edici√≥n por ${holderEmail} desde ${hhmm}`
        : 'üîí En edici√≥n';
      lockInfoEl.style.display='inline-flex';
    }

    async function acquireLock(){
      if(!canEdit){ showToast("No tienes permisos para editar."); return; }
      const u = auth.currentUser; if(!u){ showToast("Sesi√≥n inv√°lida."); return; }
      try{
        await runTransaction(db, async (tx)=>{
          const snap = await tx.get(nrDocRef);
          const now = Date.now();
          let data = snap.exists() ? snap.data() : {};
          const lock = data.lock;
          let canTake = false;
          if(!lock) canTake = true;
          else {
            const sinceMs = lock.since?.toMillis ? lock.since.toMillis() : 0;
            const ttl = (lock.ttlSec || LOCK_TTL_SEC) * 1000;
            if (now - sinceMs > ttl) canTake = true;
            if (lock.holderUid === u.uid) canTake = true;
          }
          if(!canTake) throw new Error("Otro usuario est√° editando actualmente.");
          const newLock = {
            holderUid: u.uid,
            holderEmail: u.email || '(sin email)',
            since: serverTimestamp(),
            ttlSec: LOCK_TTL_SEC
          };
          tx.set(nrDocRef, { lock: newLock }, { merge:true });
        });
        holdLock = true;
        applyRoleUI();
        startHeartbeat();
        showToast("Control de edici√≥n adquirido ‚úÖ");
      }catch(e){
        console.warn(e); showToast(e.message || "No se pudo tomar el control.");
      }
    }
    async function releaseLock(){
      if(!holdLock) return;
      const u = auth.currentUser; if(!u) return;
      try{
        await runTransaction(db, async (tx)=>{
          const snap = await tx.get(nrDocRef);
          if(!snap.exists()) return;
          const data = snap.data() || {};
          const lock = data.lock;
          if(lock?.holderUid === u.uid){
            tx.update(nrDocRef, { lock: null });
          }
        });
      }catch(e){ console.warn(e); }
      finally{
        holdLock = false; stopHeartbeat(); applyRoleUI(); showToast("Control liberado.");
      }
    }
    function startHeartbeat(){
      stopHeartbeat();
      heartbeatTimer = setInterval(async ()=>{
        try{
          const u = auth.currentUser;
          if(!u || !holdLock) return;
          const snap = await getDoc(nrDocRef);
          const lock = snap.exists() ? (snap.data().lock || null) : null;
          if(lock?.holderUid !== u.uid){
            holdLock=false; applyRoleUI(); stopHeartbeat(); return;
          }
          await updateDoc(nrDocRef, { 'lock.since': serverTimestamp() });
        }catch(e){ console.warn('[heartbeat]', e); }
      }, 30000);
    }
    function stopHeartbeat(){ if(heartbeatTimer){ clearInterval(heartbeatTimer); heartbeatTimer=null; } }

    async function pushSharedData(){
      if(!holdLock){ showToast("Toma el control para compartir datos."); return; }
      const raw = inputEl.value || '';
      const u = auth.currentUser;
      try{
        await updateDoc(nrDocRef, {
          dataRaw: raw, updatedAt: serverTimestamp(),
          updatedBy: { uid: u.uid, email: u.email || '(sin email)', displayName: u.displayName || '' }
        });
        lastSnapshotDataRaw = raw;
        showToast("Datos compartidos ‚úÖ");
      }catch(e){ console.warn(e); showToast("No se pudo actualizar el estado compartido."); }
    }

    async function setSharedView(mode){
      if(!canEdit){ showToast("No tienes permisos para cambiar la vista."); return; }
      try{
        await updateDoc(nrDocRef, { viewMode: mode, updatedAt: serverTimestamp() });
        savePref(PREF_VISTA, mode);
      }catch(e){ console.warn(e); showToast("No se pudo cambiar la vista compartida."); }
    }

    // Toggle c√≠clico de vistas en un solo bot√≥n
    const MODES = ['numerico','porcentaje','mixto'];
    viewToggleBtn.addEventListener('click', async ()=>{
      const curr = viewToggleBtn.dataset.mode || 'numerico';
      const idx  = MODES.indexOf(curr);
      const next = MODES[(idx+1) % MODES.length];
      setViewButton(next);
      await setSharedView(next);
      // si hay datos, re-procesa local
      if((inputEl.value||'').trim()){ vistaActual = next; procesar(vistaActual); }
    });

    // ====== Render (tu l√≥gica) ======
    let dataGlobal={}, dataOriginal=[], estadoOrdenColumna=readPref(PREF_ORDEN,{}), columnaOrdenActual=null;
    const codigos={ "Chile":"cl","Colombia":"co","Costa Rica":"cr","Ecuador":"ec","Mexico":"mx","M√©xico":"mx","Paraguay":"py","Peru":"pe","Per√∫":"pe","Uruguay":"uy","Venezuela":"ve","Bolivia":"bo" };
    function mostrarToast(msg){ showToast(msg); }
    function borrarTodo(){
      inputEl.value="";
      document.querySelector("#tablaReporte tbody").innerHTML="";
      document.querySelector("#encabezadoTabla").innerHTML="";
      document.querySelector("#filaTotales").innerHTML="";
      dataGlobal={}; dataOriginal=[]; estadoOrdenColumna={}; columnaOrdenActual=null; savePref(PREF_ORDEN,{});
    }
    function pctSafe(v,t){ if(!t) return "0.0%"; return ((v/t)*100).toFixed(1)+"%"; }
    const colorPct=p=> p<=25?"red": p>=30?"green":"orange";

    function procesar(vista){
      vistaActual=vista; savePref(PREF_VISTA,vista);
      estadoOrdenColumna={}; savePref(PREF_ORDEN,{}); columnaOrdenActual=null;

      const input=(inputEl.value||"").trim(); if(!input){ mostrarToast("Pega la tabla del panel para procesar."); return; }
      const filas=input.split("\n"), headersRaw=filas[0].split("\t").map(h=>h.trim()), headersLC=headersRaw.map(h=>h.toLowerCase());
      const COLMAP={ country:["Country"], total:["Total"], news:["New"], recall:["Recall"], noAnswer:["No answer","No Answer"], approved:["Approved","Call center (approved)","Call center approved"], reject:["Reject"], trash:["Trash"] };
      const idx=(names)=> (Array.isArray(names)?names:[names]).reduce((r,n)=> r>=0?r:(headersRaw.indexOf(n)>=0?headersRaw.indexOf(n):headersLC.indexOf(n.toLowerCase())), -1);
      const IDX={ country:idx(COLMAP.country), total:idx(COLMAP.total), news:idx(COLMAP.news), recall:idx(COLMAP.recall), noAnswer:idx(COLMAP.noAnswer), approved:idx(COLMAP.approved), reject:idx(COLMAP.reject), trash:idx(COLMAP.trash) };
      if(IDX.country===-1||IDX.total===-1){ mostrarToast("‚ö†Ô∏è Falta Country/Total."); return; }
      if(IDX.approved===-1){ mostrarToast("‚ÑπÔ∏è No encuentro ‚ÄòApproved‚Äô; usar√© 0."); }
      dataGlobal={};
      for(let i=1;i<filas.length;i++){
        const f=filas[i].split("\t"), pais=(f[IDX.country]||"").trim(); if(!pais) continue;
        if(!dataGlobal[pais]) dataGlobal[pais]={total:0,news:0,recall:0,noAnswer:0,approved:0,reject:0,trash:0};
        const val=j=> j===-1?0:(parseInt(f[j])||0);
        dataGlobal[pais].total+=val(IDX.total); dataGlobal[pais].news+=val(IDX.news); dataGlobal[pais].recall+=val(IDX.recall); dataGlobal[pais].noAnswer+=val(IDX.noAnswer); dataGlobal[pais].approved+=val(IDX.approved); dataGlobal[pais].reject+=val(IDX.reject); dataGlobal[pais].trash+=val(IDX.trash);
      }
      dataOriginal=Object.entries(dataGlobal);
      renderTabla();
      mostrarToast("‚úÖ Datos procesados");
    }

    function renderTabla(){
      const enc=document.getElementById("encabezadoTabla"), cuerpo=document.querySelector("#tablaReporte tbody"), tfoot=document.getElementById("filaTotales");
      enc.innerHTML=""; cuerpo.innerHTML=""; tfoot.innerHTML="";
      let cols=["Pa√≠s","Leads"];
      if(vistaActual==="numerico"){ cols.push("New","Recall","No Answer","Approve","Reject","Trash");
      }else if(vistaActual==="porcentaje"){ cols.push("% New","% Recall","% No Answer","% Approve","% Reject","% Trash");
      }else{ cols.push("New","% New","Recall","% Recall","No Answer","% No Answer","Approve","% Approve","Reject","% Reject","Trash","% Trash"); }
      cols.forEach(col=>{ const th=document.createElement("th"); th.textContent=col; if(col!=="Pa√≠s"){ th.onclick=()=>cambiarOrdenColumna(col);} enc.appendChild(th); });

      let datos=[...dataOriginal];
      if(columnaOrdenActual){
        const e=estadoOrdenColumna[columnaOrdenActual]||0;
        datos.sort((a,b)=>{ const A=getValorOrdenable(a[1],columnaOrdenActual), B=getValorOrdenable(b[1],columnaOrdenActual);
          return e===1?B-A:e===2?A-B:0; });
      }
      const flag=p=>codigos[p]?`<img class="bandera" src="https://flagcdn.com/w40/${codigos[p]}.png" alt="">`:"";

      for(const [pais,d] of datos){
        const t=d.total||0;
        const tr=document.createElement("tr");
        let html=`<td class="bold">${flag(pais)} ${pais}</td><td>${d.total}</td>`;
        if(vistaActual==="numerico"){
          html+=`<td>${d.news}</td><td>${d.recall}</td><td>${d.noAnswer}</td><td>${d.approved}</td><td>${d.reject}</td><td>${d.trash}</td>`;
        }else if(vistaActual==="porcentaje"){
          const cls = colorPct(t?d.approved/t*100:0);
          html+=`<td>${pctSafe(d.news,t)}</td><td>${pctSafe(d.recall,t)}</td><td>${pctSafe(d.noAnswer,t)}</td><td class="${cls}">${pctSafe(d.approved,t)}</td><td>${pctSafe(d.reject,t)}</td><td>${pctSafe(d.trash,t)}</td>`;
        }else{
          const cls = colorPct(t?d.approved/t*100:0);
          html+=`<td>${d.news}</td><td>${pctSafe(d.news,t)}</td><td>${d.recall}</td><td>${pctSafe(d.recall,t)}</td><td>${d.noAnswer}</td><td>${pctSafe(d.noAnswer,t)}</td><td>${d.approved}</td><td class="${cls}">${pctSafe(d.approved,t)}</td><td>${d.reject}</td><td>${pctSafe(d.reject,t)}</td><td>${d.trash}</td><td>${pctSafe(d.trash,t)}</td>`;
        }
        tr.innerHTML=html; cuerpo.appendChild(tr);
      }

      const tot=Object.values(dataGlobal).reduce((a,d)=>{ a.total+=d.total; a.news+=d.news; a.recall+=d.recall; a.noAnswer+=d.noAnswer; a.approved+=d.approved; a.trash+=d.trash; a.reject+=d.reject; return a; },{total:0,news:0,recall:0,noAnswer:0,approved:0,trash:0,reject:0});
      if(Object.keys(dataGlobal).length){
        let foot=`<td class="bold">TOTAL</td><td>${tot.total}</td>`; const t=tot.total||0; const clsTot = colorPct(t?tot.approved/t*100:0);
        if(vistaActual==="numerico"){
          foot+=`<td>${tot.news}</td><td>${tot.recall}</td><td>${tot.noAnswer}</td><td>${tot.approved}</td><td>${tot.reject}</td><td>${tot.trash}</td>`;
        }else if(vistaActual==="porcentaje"){
          foot+=`<td>${pctSafe(tot.news,t)}</td><td>${pctSafe(tot.recall,t)}</td><td>${pctSafe(tot.noAnswer,t)}</td><td class="${clsTot}">${pctSafe(tot.approved,t)}</td><td>${pctSafe(tot.reject,t)}</td><td>${pctSafe(tot.trash,t)}</td>`;
        }else{
          foot+=`<td>${tot.news}</td><td>${pctSafe(tot.news,t)}</td><td>${tot.recall}</td><td>${pctSafe(tot.recall,t)}</td><td>${tot.noAnswer}</td><td>${pctSafe(tot.noAnswer,t)}</td><td>${tot.approved}</td><td class="${clsTot}">${pctSafe(tot.approved,t)}</td><td>${tot.reject}</td><td>${pctSafe(tot.reject,t)}</td><td>${tot.trash}</td><td>${pctSafe(tot.trash,t)}</td>`;
        }
        tfoot.innerHTML=foot;
      }
    }
    function cambiarOrdenColumna(col){ estadoOrdenColumna[col]=(estadoOrdenColumna[col]||0)+1; if(estadoOrdenColumna[col]>2) estadoOrdenColumna[col]=0; columnaOrdenActual=estadoOrdenColumna[col]===0?null:col; savePref(PREF_ORDEN,estadoOrdenColumna); renderTabla(); }
    function restablecerOrden(){ estadoOrdenColumna={}; columnaOrdenActual=null; savePref(PREF_ORDEN,{}); renderTabla(); }
    function getValorOrdenable(d,col){ const t=d.total||0; const base={"Leads":d.total,"New":d.news,"% New":t?(d.news/t)*100:0,"Recall":d.recall,"% Recall":t?(d.recall/t)*100:0,"No Answer":d.noAnswer,"% No Answer":t?(d.noAnswer/t)*100:0,"Approve":d.approved,"% Approve":t?(d.approved/t)*100:0,"Reject":d.reject,"% Reject":t?(d.reject/t)*100:0,"Trash":d.trash,"% Trash":t?(d.trash/t)*100:0}; return base[col]||0; }

    /* ===== Cloud hist√≥rico (ahora popula pa√≠ses desde el resultado) ===== */
    let cloudHistorico=[];
    function rangeFromPreset(preset, dateISO){
      const now=new Date(); const todayISO = `${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}`;
      const startOf=(iso)=> new Date(`${iso}T00:00:00`).getTime();
      const addDays=(iso,days)=>{ const d=new Date(`${iso}T00:00:00`); d.setDate(d.getDate()+days); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; };
      if(preset==='hoy'){ const s=startOf(todayISO), e=startOf(addDays(todayISO,1)); return {start:s, end:e}; }
      if(preset==='ayer'){ const y=addDays(todayISO,-1); return {start:startOf(y), end:startOf(todayISO)}; }
      if(preset==='7d'){ const s=addDays(todayISO,-6); return {start:startOf(s), end:startOf(addDays(todayISO,1))}; }
      if(preset==='dia' && dateISO){ return {start:startOf(dateISO), end:startOf(addDays(dateISO,1))}; }
      return {start:null, end:null};
    }
    function normalizeRows(rows){
      rows.forEach(r=>{
        const iso  = r.fechaISO || ddmmyyyyToISO(r.fecha);
        const hhmm = r.hora24 || toHora24(r.hora);
        if(!r.ts && iso && hhmm){ r.ts = new Date(`${iso}T${hhmm}:00`).getTime(); }
        r.hora = hhmm || r.hora;
      });
      rows.sort((a,b)=>(a.ts||0)-(b.ts||0));
      return rows;
    }
    async function fetchHistoricoCloud(fp, startTs, endTs){
      const base = collection(db,'historico');
      try {
        let qy;
        if(fp !== 'todos' && startTs != null && endTs != null){
          qy = query(base, where('pais','==',fp), where('ts','>=',startTs), where('ts','<', endTs));
        } else if(startTs != null && endTs != null){
          qy = query(base, where('ts','>=',startTs), where('ts','<', endTs));
        } else if(fp !== 'todos'){
          qy = query(base, where('pais','==',fp));
        } else {
          qy = base;
        }
        const snap = await getDocs(qy);
        const rows = [];
        snap.forEach(d=>rows.push({ ...d.data(), _id: d.id }));
        return normalizeRows(rows);
      } catch (e) {
        console.warn('[GC] fetchHistoricoCloud fallback:', e);
        const snap = await getDocs(base);
        let rows = [];
        snap.forEach(d=>rows.push({ ...d.data(), _id: d.id }));
        if (fp !== 'todos') rows = rows.filter(r => r.pais === fp);
        return normalizeRows(rows);
      }
    }

    async function renderTablaHistorico(){
      const prefPais = readPref(PREF_FPAIS,'todos');
      const prefFecha= readPref(PREF_FFECHA,'');
      const prefPreset=readPref(PREF_PRESET,'hoy');
      presetEl.value = prefPreset;
      if(prefFecha) filtroFechaEl.value = prefFecha;
      filtroFechaEl.disabled = (presetEl.value !== 'dia');

      const {start, end} = rangeFromPreset(presetEl.value, filtroFechaEl.value || '');
      try{
        const fp = (prefPais==='todos' ? 'todos' : prefPais);
        cloudHistorico=await fetchHistoricoCloud(fp, start, end);
      }catch(e){
        console.error('[GC] Fetch hist√≥rico:', e);
        showToast("‚ö†Ô∏è No se pudo leer la nube: " + (e.code||e.message));
        cloudHistorico=[];
      }

      // Relleno select pa√≠ses a partir del resultado (r√°pido)
      const seen = new Set(['todos']);
      const current = filtroPaisEl.value || prefPais || 'todos';
      filtroPaisEl.innerHTML = '';
      const optAll = document.createElement('option');
      optAll.value='todos'; optAll.textContent='üåç Todos'; filtroPaisEl.appendChild(optAll);
      cloudHistorico.forEach(r=>{ const p=r.pais||''; if(p && !seen.has(p)){ seen.add(p); const o=document.createElement('option'); o.value=p; o.textContent=p; filtroPaisEl.appendChild(o);} });
      // restaurar selecci√≥n si existe
      if([...filtroPaisEl.options].some(o=>o.value===current)) filtroPaisEl.value=current; else filtroPaisEl.value='todos';
      savePref(PREF_FPAIS, filtroPaisEl.value);

      const tbody=document.querySelector("#tablaHistorico tbody"); tbody.innerHTML="";
      cloudHistorico.forEach(r=>{
        const pct = Number(r.pctApprove||0);
        const cls = colorPct(pct);
        const disabled = (!canDelete || !r._id) ? 'disabled' : '';
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${r.hora||""}</td>
          <td>${r.fecha||""}</td>
          <td>${r.pais||""}</td>
          <td>${r.leads||0}</td>
          <td>${r.news||0}</td>
          <td>${r.recall||0}</td>
          <td>${r.noAnswer||0}</td>
          <td>${r.approve||0}</td>
          <td class="${cls}">${pct.toFixed(1)}%</td>
          <td>${r.reject||0}</td>
          <td>${r.trash||0}</td>
          <td><button class="btn-danger" ${disabled}
            onclick="eliminarRegistro('${r._id||''}')">üóëÔ∏è Eliminar</button></td>`;
        tbody.appendChild(tr);
      });

      renderQuickMetrics();
      renderGrafico();
    }

    const calcMedian=(arr)=>{ if(!arr.length) return 0; const v=[...arr].sort((a,b)=>a-b); const m=Math.floor(v.length/2); return v.length%2?v[m]:(v[m-1]+v[m])/2; };
    function renderQuickMetrics(){
      const box=document.getElementById('quickMetrics');
      if(!cloudHistorico.length){ box.style.display='none'; return; }
      const vals=cloudHistorico.map(r=>parseFloat(r.pctApprove||0)).filter(n=>!isNaN(n));
      if(!vals.length){ box.style.display='none'; return; }
      document.getElementById('mMin').textContent=`${Math.min(...vals).toFixed(1)}%`;
      document.getElementById('mMed').textContent=`${calcMedian(vals).toFixed(1)}%`;
      document.getElementById('mMax').textContent=`${Math.max(...vals).toFixed(1)}%`;
      let deltaTxt='‚Äì', cls='';
      if(vals.length>=2){
        const last=vals[vals.length-1], prev=vals[vals.length-2];
        const d=(last-prev).toFixed(1);
        const arrow = (d>=0? '‚Üë':'‚Üì');
        cls = d>=0? 'delta up':'delta down';
        deltaTxt = `${arrow} ${Math.abs(d)} pp`;
      }
      const mDelta=document.getElementById('mDelta');
      mDelta.className='value ' + cls;
      mDelta.textContent=deltaTxt;
      box.style.display='flex';
    }
    function renderGrafico(){
      const ctx=document.getElementById('graficoAvance').getContext('2d');
      const agr={}; cloudHistorico.forEach(r=>{ if(!agr[r.pais]) agr[r.pais]=[]; agr[r.pais].push({x:r.hora,y:r.pctApprove}); });
      const grayPal=['#111','#333','#555','#777','#999','#bbb'];
      const datasets=Object.keys(agr).map((k,i)=>({
        label:k, data:agr[k], fill:false, tension:.2,
        borderColor: grayPal[i % grayPal.length],
        backgroundColor: grayPal[i % grayPal.length],
        pointRadius: 2
      }));
      if(window.graficoAvance) window.graficoAvance.destroy();
      window.graficoAvance=new Chart(ctx,{type:'line',data:{datasets},options:{responsive:true,plugins:{legend:{position:'top'}},scales:{x:{title:{display:true,text:'Hora'},type:'category'},y:{title:{display:true,text:'% Approve'},beginAtZero:true,max:100}}}});
    }

    // Acciones hist√≥rico (con permisos)
    async function registrarAvance(){
      if(!canEdit){ showToast("No tienes permisos para registrar avance."); return; }
      if(!Object.keys(dataGlobal).length){ showToast("‚ÑπÔ∏è Procesa/pega datos antes de registrar."); return; }
      const now=new Date();
      const hora24=`${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
      const fecha=formatDDMMYYYY(now), fechaISO=formatISO(now), ts=now.getTime();

      const colRef=collection(db,'historico');
      const writes=[];
      for(const [pais,d] of Object.entries(dataGlobal)){
        const total=d.total||0;
        writes.push(addDoc(colRef,{
          fecha, fechaISO, hora:hora24, hora24:hora24, ts, pais,
          leads:d.total, news:d.news, recall:d.recall, noAnswer:d.noAnswer,
          approve:d.approved, pctApprove: total?((d.approved/total)*100).toFixed(1):"0.0",
          reject:d.reject, trash:d.trash
        }));
      }
      try{
        await Promise.all(writes);
        showToast("‚úÖ Avance registrado en la nube.");
        await renderTablaHistorico();
        renderGrafico();
      }catch(e){
        console.error('[GC] Firestore write error:', e);
        showToast("‚ö†Ô∏è Error guardando en la nube: " + (e.code || e.message));
      }
    }
    async function borrarHistorial(){
      if(!canDelete){ showToast("No tienes permisos para borrar el historial."); return; }
      if(!confirm("¬øBorrar TODO el historial de la nube?")) return;
      try{
        const snap=await getDocs(collection(db,'historico'));
        const ops=[]; snap.forEach(d=>ops.push(deleteDoc(doc(db,'historico',d.id))));
        await Promise.all(ops); showToast("üóëÔ∏è Historial borrado."); await renderTablaHistorico(); renderGrafico();
      }catch(e){ console.error(e); showToast("‚ùå No se pudo borrar: " + (e.code||e.message)); }
    }
    async function eliminarRegistro(id){
      if(!canDelete){ showToast("No tienes permisos para eliminar registros."); return; }
      if(!id){ showToast("‚ö†Ô∏è No se encontr√≥ el ID del registro."); return; }
      const ok = confirm("¬øSeguro que deseas eliminar este registro?");
      if(!ok) return;
      try{
        await deleteDoc(doc(db, 'historico', id));
        showToast("üóëÔ∏è Registro eliminado.");
        await renderTablaHistorico();
        renderGrafico();
      }catch(e){
        console.error(e);
        showToast("‚ùå No se pudo eliminar: " + (e.code || e.message));
      }
    }
    window.eliminarRegistro = eliminarRegistro;

    // Filtros
    filtroPaisEl.addEventListener('change', ()=>{ savePref(PREF_FPAIS, filtroPaisEl.value); renderTablaHistorico(); });
    presetEl.addEventListener('change', ()=>{ const p=presetEl.value; savePref(PREF_PRESET,p); filtroFechaEl.disabled=(p!=='dia'); renderTablaHistorico(); });
    filtroFechaEl.addEventListener('change', ()=>{ savePref(PREF_FFECHA, filtroFechaEl.value || ''); renderTablaHistorico(); });
    btnAllCountries.addEventListener('click', ()=>{ filtroPaisEl.value='todos'; savePref(PREF_FPAIS,'todos'); renderTablaHistorico(); });
    btnClearFecha.addEventListener('click', ()=>{ filtroFechaEl.value=''; savePref(PREF_FFECHA,''); presetEl.value='dia'; savePref(PREF_PRESET,'dia'); filtroFechaEl.disabled=false; renderTablaHistorico(); });

    btnBorrarTodo.addEventListener('click', borrarTodo);
    btnRestOrden.addEventListener('click', restablecerOrden);
    btnRegistrar.addEventListener('click', registrarAvance);
    btnBorrarHist.addEventListener('click', borrarHistorial);

    // ===== Suscripci√≥n al estado compartido (creaci√≥n perezosa del doc si falta) =====
    async function ensureStateDocIfNeeded(){
      try{
        const snap = await getDoc(nrDocRef);
        if(!snap.exists() && canEdit){
          // crea el doc base (una vez)
          await updateDoc(nrDocRef, { viewMode: 'numerico' }).catch(async()=>{
            // si falla updateDoc porque no existe, usa set con merge
            const { setDoc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
            await setDoc(nrDocRef, { viewMode:'numerico', dataRaw:'' }, { merge:true });
          });
        }
      }catch(e){
        // si reglas proh√≠ben, no pasa nada; el onSnapshot abajo mostrar√° error
      }
    }

    onSnapshot(nrDocRef, (snap)=>{
      const data = snap.exists() ? snap.data() : {};
      const { dataRaw = '', viewMode = 'numerico', lock = null } = data;
      setLockInfo(lock);

      // textarea desde la nube si no estoy editando
      if(!holdLock){
        inputEl.value = dataRaw;
        lastSnapshotDataRaw = dataRaw;
      }
      vistaActual = viewMode || 'numerico';
      setViewButton(vistaActual);
      savePref(PREF_VISTA, vistaActual);

      if((inputEl.value||'').trim()){
        try{ procesar(vistaActual); }catch{}
      }
      setBadge('Conectado ‚úì','ok');
    }, (err)=>{
      console.warn('[nr_state] onSnapshot:', err);
      setBadge('Sin acceso a nr_state/global','warn');
    });

    // ===== Sesi√≥n / roles
    auth.onAuthStateChanged(async (user)=>{
      if(!user){ setBadge('Sin sesi√≥n','warn'); return; }
      myRank   = await getRank();
      canEdit  = ALLOWED_EDIT_ROLES.has(myRank);
      canDelete= ALLOWED_DELETE_ROLES.has(myRank);
      applyRoleUI();
      setBadge('Conectado ‚úì','ok');

      // crea doc base si falta (solo editores), evita ‚ÄúConectando‚Ä¶‚Äù eterno
      await ensureStateDocIfNeeded();

      // Prefs iniciales filtros
      const prefPreset=readPref(PREF_PRESET,'hoy');
      presetEl.value=prefPreset;
      filtroFechaEl.disabled=(prefPreset!=='dia');
      const prefFecha=readPref(PREF_FFECHA,''); if(prefFecha) filtroFechaEl.value=prefFecha;

      await renderTablaHistorico();
    });
  </script>
</body>
</html>

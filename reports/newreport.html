<!DOCTYPE html>
<html lang="es" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gesti√≥n Center ‚Äî v2.0 ¬∑ New Report CC Per√∫</title>

    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=Lexend:wght@300;400;600;700&display=swap" rel="stylesheet"/>

    <!-- üîí Ocultar hasta validar sesi√≥n -->
    <style>html{visibility:hidden}</style>
    <!-- ‚ö†Ô∏è desde /reports/ subimos un nivel -->
    <script type="module" src="../assets/guard.js"></script>

    <!-- ======== Estilos del ecosistema (id√©nticos al index v2.0) ======== -->
    <style>
      :root{
        --radius:16px; --radius-sm:12px; --radius-xs:10px;
        --font-title:'Outfit',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
        --font-body:'Lexend',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
        --t-fast:.15s; --t-med:.22s; --t-slow:.6s; --curve:cubic-bezier(.2,.7,.2,1);
        --elev-1:0 6px 20px rgba(0,0,0,.25); --elev-2:0 12px 34px rgba(0,0,0,.35);
        --hover-delay:80ms;
        --sidebar-w:280px; --sidebar-w-compact:72px;
      }
      [data-theme="dark"]{
        --bg-app:#070b1a; --bg-aside:#0c1228;
        --bg-card:linear-gradient(160deg, rgba(17,24,49,.88), rgba(17,24,49,.7));
        --txt:#e9f1ff; --txt-muted:#b8c6de; --stroke:rgba(255,255,255,.10);
        --primary:#5b8bff; --accent:#7ae3ff;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0; font-family:var(--font-body); color:var(--txt);
        background:var(--bg-app); overflow-x:hidden;
      }

      /* Fondo decorativo */
      #bg-fx{
        position:fixed; inset:0; z-index:-2; pointer-events:none;
        background:
          radial-gradient(1100px 1100px at 10% -10%, color-mix(in oklab, var(--primary) 30%, transparent), transparent 60%),
          radial-gradient(900px 900px at 90% 0%, color-mix(in oklab, var(--accent) 35%, transparent), transparent 55%);
        background-repeat:no-repeat; background-attachment:fixed;
      }
      #bg-grid{
        position:fixed; inset:0; z-index:-1; opacity:.07; pointer-events:none;
        background:
          linear-gradient(color-mix(in oklab, var(--txt) 9%, transparent) 1px, transparent 1px) 0 0 / 28px 28px,
          linear-gradient(90deg, color-mix(in oklab, var(--txt) 9%, transparent) 1px, transparent 1px) 0 0 / 28px 28px;
      }

      /* Reveal */
      @media (prefers-reduced-motion:no-preference){
        .reveal{opacity:0; transform:translateY(8px); will-change:transform,opacity; transition:opacity var(--t-slow) ease, transform var(--t-slow) ease}
        .reveal.show{opacity:1; transform:none}
      }

      /* ===== Sidebar (id√©ntico) ===== */
      aside{
        position:fixed; inset:0 auto 0 0; width:var(--sidebar-w); z-index:25;
        backdrop-filter:saturate(120%) blur(8px);
        background:color-mix(in oklab, var(--bg-aside) 96%, transparent);
        border-right:1px solid var(--stroke);
        display:flex; flex-direction:column; padding:14px 12px; gap:12px; overflow:auto;
        contain:content; --pad-x:10px;
      }
      aside::before, aside::after{
        content:""; position:sticky; display:block; height:14px; pointer-events:none; z-index:5;
      }
      aside::before{ top:0; background:linear-gradient(#0000, rgba(0,0,0,.25)) }
      aside::after{ bottom:0; background:linear-gradient(rgba(0,0,0,.25), #0000) }

      .brand{
        display:flex; align-items:center; justify-content:center;
        padding:12px; border-radius:16px; border:1px solid var(--stroke);
        background:linear-gradient(132deg, color-mix(in oklab, var(--primary) 18%, transparent), color-mix(in oklab, var(--accent) 12%, transparent));
        transition:transform var(--t-fast) cubic-bezier(.2,.7,.2,1);
        text-decoration:none;
      }
      .brand:hover{ transform:scale(1.01) }
      .brand img{ width:160px; height:auto; object-fit:contain; filter:drop-shadow(0 6px 14px rgba(0,0,0,.35)); }

      .sidebar-toggle{
        display:flex; align-items:center; justify-content:center; gap:8px; width:100%;
        border:1px solid var(--stroke); padding:10px; border-radius:12px; background:rgba(255,255,255,.04);
        color:var(--txt); cursor:pointer; font-weight:700; transition:filter var(--t-med) ease, transform var(--t-fast) ease;
      }
      .sidebar-toggle:hover{ filter:brightness(1.05) } .sidebar-toggle:active{ transform:translateY(1px) }
      .sidebar-toggle .lbl{ font-size:13px }

      nav{ position:relative; display:flex; flex-direction:column; gap:10px; }
      .nav-group{ border:1px solid var(--stroke); border-radius:14px; overflow:hidden; background:color-mix(in oklab, var(--bg-aside) 92%, transparent) }
      .nav-head{
        width:100%; text-align:left; padding:10px 12px; border:0; background:transparent; color:var(--txt);
        font:700 13px/1 var(--font-title); letter-spacing:.3px; cursor:pointer; display:flex; align-items:center; gap:8px;
      }
      .nav-head .chev{ transition:transform var(--t-med) cubic-bezier(.2,.7,.2,1) }
      .nav-group.is-collapsed .nav-head .chev{ transform:rotate(-90deg) }
      .nav-body{ overflow:hidden; transition:grid-template-rows .35s cubic-bezier(.2,.7,.2,1), opacity .25s ease; display:grid; grid-template-rows:1fr; opacity:1 }
      .nav-group.is-collapsed .nav-body{ grid-template-rows:0fr; opacity:.0 }
      .nav-body-inner{ min-height:0; padding:6px; display:flex; flex-direction:column; gap:8px }

      .nav-item{
        display:flex; align-items:center; gap:10px; padding:12px var(--pad-x);
        border-radius:10px; text-decoration:none; color:var(--txt); font-size:15px;
        border:1px solid transparent;
        transition: background var(--t-med) ease var(--hover-delay), transform var(--t-fast) ease var(--hover-delay);
        min-height:40px;
      }
      .nav-item:hover{ background:color-mix(in oklab, var(--bg-aside) 80%, transparent); transform:translateX(2px) }
      .nav-item .label{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100% }
      .nav-item.active{
        background:linear-gradient(90deg, color-mix(in oklab, var(--primary) 20%, transparent), color-mix(in oklab, var(--accent) 14%, transparent));
        border-color:var(--stroke)
      }
      .nav-indicator{
        position:absolute; left:6px; width:4px; height:40px; border-radius:0 3px 3px 0;
        background:linear-gradient(180deg, var(--primary), var(--accent));
        box-shadow:0 0 16px color-mix(in oklab, var(--accent) 65%, transparent);
        transition:transform 220ms cubic-bezier(.2,.7,.2,1), height 220ms ease;
        pointer-events:none;
      }

      .spacer{flex:1}
      .role-card{
        display:flex; align-items:center; gap:10px; padding:10px 12px;
        border-radius:14px; border:1px solid var(--stroke);
        background:color-mix(in oklab, var(--bg-aside) 92%, transparent);
      }
      .role-dot{ width:14px; height:14px; border-radius:50%; box-shadow:0 0 0 3px rgba(255,255,255,.06) inset, 0 0 14px rgba(0,0,0,.25) }
      .role-text small{ color:var(--txt-muted) }
      .role-badge{ font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--stroke); background:rgba(255,255,255,.06) }
      .logout{
        width:100%; border:1px solid var(--stroke);
        background:linear-gradient(180deg, #ef4444, #d62c2c); color:#fff;
        padding:12px; border-radius:12px; cursor:pointer; font-weight:700;
        transition:transform var(--t-fast) ease, filter var(--t-med) ease;
      }
      .logout:hover{filter:brightness(1.05)} .logout:active{transform:translateY(1px)}

      /* Main del ecosistema */
      main{ margin-left:var(--sidebar-w); padding:24px 22px 40px; transition:margin-left var(--t-med) cubic-bezier(.2,.7,.2,1) }

      /* Sidebar compacto */
      body.sidebar-compact aside{ width:var(--sidebar-w-compact) }
      body.sidebar-compact main{ margin-left:var(--sidebar-w-compact) }
      body.sidebar-compact .brand img{ width:42px }
      body.sidebar-compact .nav-head .txt, body.sidebar-compact .nav-item .label, body.sidebar-compact .sidebar-toggle .lbl, body.sidebar-compact .role-text{ display:none }
      body.sidebar-compact .nav-head{ justify-content:center }
      body.sidebar-compact .nav-item{ justify-content:center; padding-inline:0 }
      body.sidebar-compact .role-card{ justify-content:center; padding:10px }

      /* Responsive */
      @media (max-width:1080px){
        main{margin-left:0; padding:16px}
        aside{position:sticky; width:auto; inset:auto; border-right:none; border-bottom:1px solid var(--stroke)}
        body.sidebar-compact aside{ width:auto }
        body.sidebar-compact main{ margin-left:0 }
      }
    </style>

    <!-- ======== Estilos ESPEC√çFICOS de New Report (scope #nr) ======== -->
    <style>
      #nr{
        --bg-app:#1c2a45; --bg-aside:#152035; --txt:#ffffff; --txt-muted:#cfd8dc; --hover:#1c2a45;
        --primary-color:#0d47a1; --accent-color:#42a5f5; --table-bg:#22314f; --table-border:#2f446a; --header-bg:#0d47a1;
        --green-color:#2e7d32; --red-color:#c62828; --orange-color:#f57c00;
      }
      #nr .page-title{ display:flex; align-items:center; gap:12px; font:700 24px/1.1 var(--font-title); margin:0 0 4px }
      #nr .subtitle{ margin:0 0 8px; color:var(--txt-muted); font-size:14px; display:flex; align-items:center; gap:10px }
      #nr .badge{ font-size:12px; padding:4px 8px; border-radius:999px; background:#334766; border:1px solid #2a3d5e }
      #nr .badge.ok{ background:#1b5e20; border-color:#1b5e20 }  #nr .badge.warn{ background:#8d2a2a; border-color:#8d2a2a }
      #nr .datetime{ font-size:14px; font-weight:600; margin:8px 0 14px; opacity:.9 }

      #nr .toolbar{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 14px }
      #nr button{ padding:10px 14px; font-size:14px; cursor:pointer; border:none; border-radius:10px; background:var(--primary-color); color:#fff; box-shadow:0 2px 6px rgba(0,0,0,.25); transition:background .2s, transform .03s }
      #nr button:hover{ background:var(--accent-color) } #nr button:active{ transform:translateY(1px) } #nr button[disabled]{ opacity:.55; cursor:not-allowed }
      #nr .btn-danger{ background:#8d2a2a; border:1px solid #6f2020 } #nr .btn-danger:hover{ background:#a93333 }

      #nr textarea{ width:100%; min-height:150px; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; padding:12px; border:1px solid var(--accent-color); background:var(--table-bg); color:#fff; border-radius:12px; box-sizing:border-box }

      #nr table{ margin-top:16px; border-collapse:separate; border-spacing:0; width:100%; background:var(--table-bg); border:1px solid var(--table-border); border-radius:12px; overflow:hidden; box-shadow:0 4px 10px rgba(0,0,0,.18) }
      #nr th,#nr td{ border-bottom:1px solid var(--table-border); padding:10px; text-align:center }
      #nr thead th{ background:var(--header-bg); color:#fff; cursor:pointer; position:relative }
      #nr thead th:first-child, #nr tbody td:first-child{ text-align:left }
      #nr .bandera{ width:20px; height:14px; margin-right:6px; vertical-align:middle }
      #nr .bold{ font-weight:700 }
      #nr .green{ background:var(--green-color); color:#fff } #nr .red{ background:var(--red-color); color:#fff } #nr .orange{ background:var(--orange-color); color:#fff }
      #nr tfoot td{ font-weight:800; background:rgba(66,165,245,.16); border-top:2px solid var(--table-border) }

      #nr .filters{ display:flex; align-items:center; gap:22px; flex-wrap:wrap; background:rgba(255,255,255,.04); border:1px solid var(--table-border); border-radius:12px; padding:10px 12px; margin-top:18px }
      #nr .filter-group{ display:flex; align-items:center; gap:10px }
      #nr .filter-group label{ display:flex; align-items:center; gap:8px; font-weight:700; margin:0 }
      #nr .filter-group select, #nr .filter-group input[type="date"]{ padding:8px 12px; border-radius:10px; border:1px solid var(--primary-color); background:var(--table-bg); color:#fff; min-width:140px; line-height:1; height:38px }
      #nr .filter-group .clear-btn{ background:#344768; border:1px solid var(--table-border) }
      #nr .filter-group .clear-btn:hover{ background:#3e577f }

      #nr .history-actions{ display:flex; gap:10px; flex-wrap:wrap; margin:14px 0 10px; justify-content:flex-start }
      #nr .quick-metrics{ display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 }
      #nr .metric{ background:rgba(255,255,255,.05); border:1px solid var(--table-border); padding:10px 12px; border-radius:10px; min-width:150px }
      #nr .metric .title{ font-size:12px; color:var(--txt-muted); margin-bottom:4px }
      #nr .metric .value{ font-size:18px; font-weight:800 }
      #nr .metric .delta.up{ color:#76ff7a } #nr .metric .delta.down{ color:#ff9e9e }

      #toast{ position:fixed; bottom:18px; right:20px; background:#222; color:#fff; padding:12px 18px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,.35); display:none; z-index:1000 }

      /* Bot√≥n Eliminar compacto solo en la tabla del hist√≥rico */
      #tablaHistorico .btn-danger{ padding:6px 10px; font-size:12px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,.25) }
      #tablaHistorico .btn-danger:hover{ background:#a93333 }
    </style>
  </head>
  <body>
    <!-- Fondo decorativo -->
    <div id="bg-fx" aria-hidden="true"></div>
    <div id="bg-grid" aria-hidden="true"></div>

    <!-- ===== SIDEBAR (id√©ntico al index v2.0) ===== -->
    <aside class="reveal" id="gc-aside">
      <a class="brand" href="../index.html" id="brandLink" aria-label="Inicio" title="Inicio">
        <picture>
          <source srcset="../images/logogestioncenter.webp" type="image/webp"/>
          <img id="brandLogo" src="../images/logogestioncenter.png" alt="Gesti√≥n Center" loading="lazy" decoding="async"/>
        </picture>
      </a>

      <button class="sidebar-toggle" id="btnSidebarToggle" aria-pressed="false" title="Compactar / Expandir">
        <span class="icon">‚áÜ</span><span class="lbl">Cambiar ancho</span>
      </button>

      <nav id="gc-nav" role="navigation" aria-label="Navegaci√≥n principal">
        <div class="nav-indicator" aria-hidden="true"></div>

        <a href="../index.html" class="nav-item" title="Inicio">üè† <span class="label">Inicio</span></a>

        <section class="nav-group" data-key="grp-reportes">
          <button class="nav-head" title="Reportes"><span class="chev">‚ñæ</span> <span class="txt">üìä Reportes</span></button>
          <div class="nav-body"><div class="nav-body-inner">
            <!-- Esta p√°gina -->
            <a href="newreport.html" class="nav-item" title="New Report">üß∞ <span class="label">New Report</span></a>
            <a href="psreport.html" class="nav-item" title="Post-Sale Report">üöö <span class="label">Post-Sale Report</span></a>
          </div></div>
        </section>

        <section class="nav-group" data-key="grp-operaciones">
          <button class="nav-head" title="Operaciones"><span class="chev">‚ñæ</span> <span class="txt">üõ†Ô∏è Operaciones</span></button>
          <div class="nav-body"><div class="nav-body-inner">
            <a href="../operations/distribucion.html" class="nav-item" title="Distribuci√≥n">üìã <span class="label">Distribuci√≥n</span></a>
            <a href="../operations/biops.html" class="nav-item" title="BI de OPs + Links">üîó <span class="label">BI de OPs + Links</span></a>
          </div></div>
        </section>

        <section class="nav-group" data-key="grp-cobertura">
          <button class="nav-head" title="Cobertura"><span class="chev">‚ñæ</span> <span class="txt">üåé Cobertura</span></button>
          <div class="nav-body"><div class="nav-body-inner">
            <a href="../cobertura.html" class="nav-item" title="Mapa de cobertura">üó∫Ô∏è <span class="label">Mapa de cobertura</span></a>
            <a href="../newcobertura.html" class="nav-item" title="New Cobertura 1.1">üß≠ <span class="label">New Cobertura 1.1</span></a>
          </div></div>
        </section>

        <section class="nav-group" data-key="grp-utils">
          <button class="nav-head" title="Utilidades"><span class="chev">‚ñæ</span> <span class="txt">üß© Utilidades</span></button>
          <div class="nav-body"><div class="nav-body-inner">
            <a href="../utilities/camprev.html" class="nav-item" title="Selector de Apoyo 2.0">üë• <span class="label">Selector de Apoyo 2.0</span></a>
          </div></div>
        </section>
      </nav>

      <div class="spacer"></div>

      <div class="role-card" id="roleCard" title="Rango del usuario">
        <div class="role-dot" id="roleDot"></div>
        <div class="role-text">
          <strong id="roleName">Invitado</strong>
          <span class="role-badge" id="roleBadge" style="margin-left:6px">‚≠ê Invitado</span><br/>
          <small id="roleDesc">Acceso limitado</small>
        </div>
      </div>

      <button class="logout" onclick="gcLogout()">Salir</button>
    </aside>

    <!-- ===== CONTENIDO New Report (scope #nr) ===== -->
    <main>
      <section id="nr" class="reveal">
        <div class="page-title">üß∞ New Report CC Per√∫</div>
        <p class="subtitle">
          Pega la tabla desde tu Panel y visualiza las m√©tricas ¬∑ Historial por hora compartido
          <span id="fbBadge" class="badge">Conectando‚Ä¶</span>
        </p>

        <div class="datetime" id="fechaHora"></div>

        <div class="toolbar">
          <button onclick="procesar('numerico')">üì¶ Vista Num√©rica</button>
          <button onclick="procesar('porcentaje')">üìà Vista Porcentual</button>
          <button onclick="procesar('mixto')">üîÅ Vista Mixta</button>
          <button onclick="borrarTodo()">üßπ Borrar</button>
          <button onclick="restablecerOrden()">üß≠ Restablecer Orden</button>
        </div>

        <textarea id="inputData" placeholder="Pega aqu√≠ tu tabla con encabezados (Country, Total, New, Recall, No answer, Approved, Reject, Trash)‚Ä¶"></textarea>

        <table id="tablaReporte">
          <thead><tr id="encabezadoTabla"></tr></thead>
          <tbody></tbody>
          <tfoot><tr id="filaTotales"></tr></tfoot>
        </table>

        <div class="history-actions">
          <button id="btnRegistrar" onclick="registrarAvance()" disabled>üìå Registrar avance ahora</button>
          <button onclick="borrarHistorial()">üóëÔ∏è Borrar historial</button>
          <button onclick="exportarHistoricoCSV()">‚¨áÔ∏è Exportar hist√≥rico (CSV)</button>
        </div>

        <!-- Filtros -->
        <div class="filters">
          <div class="filter-group">
            <label for="filtroPais">üåé Pa√≠s:</label>
            <select id="filtroPais" onchange="onFiltroChange()">
              <option value="todos">üåç Todos</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="presetRango">üóìÔ∏è Rango:</label>
            <select id="presetRango" onchange="onPresetChange()">
              <option value="dia">D√≠a espec√≠fico</option>
              <option value="hoy">Hoy</option>
              <option value="ayer">Ayer</option>
              <option value="7d">√öltimos 7 d√≠as</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="filtroFecha">üìÖ Fecha:</label>
            <input type="date" id="filtroFecha" onchange="onFiltroChange()"/>
            <button class="clear-btn" onclick="limpiarFecha()">Todos</button>
          </div>
        </div>

        <!-- M√©tricas r√°pidas -->
        <div id="quickMetrics" class="quick-metrics" style="display:none;">
          <div class="metric">
            <div class="title">Min % Approve</div>
            <div id="mMin" class="value">‚Äì</div>
          </div>
          <div class="metric">
            <div class="title">Mediana % Approve</div>
            <div id="mMed" class="value">‚Äì</div>
          </div>
          <div class="metric">
            <div class="title">Max % Approve</div>
            <div id="mMax" class="value">‚Äì</div>
          </div>
          <div class="metric">
            <div class="title">Œî vs hora previa</div>
            <div id="mDelta" class="value">‚Äì</div>
          </div>
        </div>

        <h3 class="page-title" style="font-size:18px; margin-top:6px;">üìã Registro hist√≥rico por hora</h3>
        <table id="tablaHistorico">
          <thead>
            <tr>
              <th>Hora</th>
              <th>Fecha</th>
              <th>Pa√≠s</th>
              <th>Leads</th>
              <th>News</th>
              <th>Recall</th>
              <th>No Answer</th>
              <th>Approve</th>
              <th>% Approve</th>
              <th>Reject</th>
              <th>Trash</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <canvas id="graficoAvance" height="220"></canvas>
      </section>
    </main>

    <div id="toast"></div>

    <!-- ===== Scripts del ecosistema (activo nav, colapsables, rol, parallax, compacto) ===== -->
    <script type="module">
      // Indicador activo + auto-scroll
      const items=[...document.querySelectorAll('nav .nav-item')];
      const indicator=document.querySelector('.nav-indicator');
      const navEl=document.getElementById('gc-nav');
      function setActive(){
        const current=(location.pathname.split('/').pop()||'index.html').toLowerCase();
        let active=items[0];
        items.forEach(a=>{
          const href=(a.getAttribute('href')||'').split('#')[0].split('/').pop().toLowerCase();
          if(href && href===current) active=a;
          a.classList.toggle('active', a===active);
          a.toggleAttribute('aria-current', a===active ? 'page':false);
        });
        if(active){
          const pr=navEl.getBoundingClientRect();
          const r=active.getBoundingClientRect();
          const y=r.top - pr.top + navEl.scrollTop;
          indicator.style.height=r.height+'px';
          indicator.style.transform=`translateY(${y}px)`;
          const margin=16;
          const topNeeded = y - margin;
          const bottomNeeded = y + r.height + margin - navEl.clientHeight;
          if (topNeeded < navEl.scrollTop) navEl.scrollTo({top: topNeeded, behavior:'smooth'});
          else if (bottomNeeded > navEl.scrollTop) navEl.scrollTo({top: bottomNeeded, behavior:'smooth'});
        }
      }
      setActive();
      navEl.addEventListener('scroll', setActive);
      window.addEventListener('resize', setActive);

      // Grupos colapsables con memoria
      document.querySelectorAll('.nav-group').forEach(g=>{
        const key=g.dataset.key, head=g.querySelector('.nav-head');
        const saved=localStorage.getItem(key);
        if(saved==='0') g.classList.add('is-collapsed');
        head.addEventListener('click', ()=>{
          g.classList.toggle('is-collapsed');
          localStorage.setItem(key, g.classList.contains('is-collapsed')?'0':'1');
          setActive();
        });
      });

      // Reveal
      const reduced=window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if(!reduced && 'IntersectionObserver' in window){
        const io=new IntersectionObserver((entries)=>{
          for(const e of entries){ if(e.isIntersecting){ e.target.classList.add('show'); io.unobserve(e.target); } }
        }, {threshold:.12, rootMargin:'0px 0px -10% 0px'});
        document.querySelectorAll('.reveal').forEach(el=>{
          const delay=el.style.getPropertyValue('--delay')||'0s';
          el.style.transitionDelay=delay; io.observe(el);
        });
      } else { document.querySelectorAll('.reveal').forEach(el=>el.classList.add('show')); }

      // Parallax fondo
      const bg=document.getElementById('bg-grid'); let rafId=null;
      function parallax(e){
        const x=(e.clientX/window.innerWidth - .5)*6;
        const y=(e.clientY/window.innerHeight - .5)*6;
        if(rafId) cancelAnimationFrame(rafId);
        rafId=requestAnimationFrame(()=>{ bg.style.transform=`translate(${x}px, ${y}px)`; });
      }
      if(!reduced) window.addEventListener('mousemove', parallax);

      // Role UI
      const ROLE_STYLE={
        'owner':{name:'Owner',desc:'Control total',badge:'üëë Owner',color:'#f59e0b',gradient:'linear-gradient(135deg,#f59e0b,#8b5cf6,#06b6d4)'},
        'admin':{name:'Admin',desc:'Administraci√≥n',badge:'üõ°Ô∏è Admin',color:'#f59e0b',gradient:'linear-gradient(135deg,#f59e0b,#8b5cf6,#06b6d4)'},
        'supervisor':{name:'Supervisor',desc:'Lidera TLs',badge:'‚≠ê Supervisor',color:'#5b8bff',gradient:'linear-gradient(135deg,#5b8bff,#60a5fa)'},
        'team leader':{name:'Team Leader',desc:'Lidera equipo',badge:'‚≠ê TL',color:'#a78bfa',gradient:'linear-gradient(135deg,#a78bfa,#7c3aed)'},
        'analista':{name:'Analista',desc:'Calidad / Datos',badge:'üìä Analista',color:'#22d3ee',gradient:'linear-gradient(135deg,#22d3ee,#06b6d4)'},
        'calidad':{name:'Calidad',desc:'Auditor√≠a',badge:'üß™ Calidad',color:'#22d3ee',gradient:'linear-gradient(135deg,#22d3ee,#06b6d4)'},
        'operador':{name:'Operador',desc:'Ventas / Gesti√≥n',badge:'‚öôÔ∏è Operador',color:'#22c55e',gradient:'linear-gradient(135deg,#22c55e,#16a34a)'},
        'invitado':{name:'Invitado',desc:'Acceso limitado',badge:'‚≠ê Invitado',color:'#94a3b8',gradient:'linear-gradient(135deg,#94a3b8,#64748b)'}
      };
      function getRole(){
        const qp=new URLSearchParams(location.search).get('role');
        const w=(window.gcRole||'').toString().trim();
        const ls=(localStorage.getItem('gc-role')||'').trim();
        return (qp||w||ls||'Invitado');
      }
      function applyRoleUI(roleRaw){
        const roleDot=document.getElementById('roleDot');
        const roleName=document.getElementById('roleName');
        const roleDesc=document.getElementById('roleDesc');
        const roleBadge=document.getElementById('roleBadge');
        const r=roleRaw.toLowerCase();
        const key=Object.keys(ROLE_STYLE).find(k=>r.includes(k))||'invitado';
        const cfg=ROLE_STYLE[key];
        roleDot.style.background=cfg.gradient;
        roleDot.style.boxShadow=`0 0 0 3px rgba(255,255,255,.06) inset, 0 0 18px ${cfg.color}55`;
        roleName.textContent=cfg.name; roleDesc.textContent=cfg.desc; roleBadge.textContent=cfg.badge;
        const card=document.getElementById('roleCard'); card.style.filter = (key==='invitado') ? 'saturate(0.8) brightness(0.95)' : 'none';
        localStorage.setItem('gc-role', cfg.name);
      }
      applyRoleUI(getRole());

      // Compact/Expand preferencia
      const btnToggle=document.getElementById('btnSidebarToggle');
      const compactKey='gc-sidebar-compact';
      function setCompactState(on){
        document.body.classList.toggle('sidebar-compact', !!on);
        btnToggle.setAttribute('aria-pressed', on ? 'true' : 'false');
        localStorage.setItem(compactKey, on ? '1' : '0');
      }
      btnToggle.addEventListener('click', ()=> setCompactState(!document.body.classList.contains('sidebar-compact')));
      setCompactState(localStorage.getItem(compactKey)==='1');
    </script>

    <!-- Normalizador de rutas para GitHub Pages / dominio -->
    <script>
    (() => {
      const isGhProject = location.hostname.endsWith('github.io');
      const PROJECT_SLUG = 'Gestion-Center';
      const base = isGhProject ? `/${PROJECT_SLUG}/` : '/';

      document.querySelectorAll('nav a.nav-item[href], .brand[href]').forEach(a => {
        const href = a.getAttribute('href');
        if (!href || href.startsWith('#') || /^https?:\/\//i.test(href)) return;
        const clean = href.replace(/^\.?\//, '');
        // Como estamos en /reports/, mantener rutas relativas correctas
        a.setAttribute('href', isGhProject ? base + clean : (href.startsWith('../') ? href : clean));
      });

      const logo = document.querySelector('#brandLink img');
      if (logo) {
        let src = logo.getAttribute('src') || '../images/logogestioncenter.png';
        if (!/^https?:\/\//i.test(src)) {
          src = src.replace(/^\.?\//, '');
          logo.setAttribute('src', isGhProject ? base + src : '../' + src);
        }
        const source = document.querySelector('#brandLink source');
        if (source) {
          let s = source.getAttribute('srcset') || '../images/logogestioncenter.webp';
          s = s.replace(/^\.?\//, '');
          source.setAttribute('srcset', isGhProject ? base + s : '../' + s);
        }
      }
    })();
    </script>

    <!-- ====== Librer√≠as del reporte ====== -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- ========= Script del REPORTE (id√©ntico, solo rutas ajustadas y scope #nr) ========= -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
      import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
      import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCHBsq9AdVZEMVryQWReX7oaPparo9lK8M",
        authDomain: "gestioncenterdata.firebaseapp.com",
        projectId: "gestioncenterdata",
        storageBucket: "gestioncenterdata.appspot.com",
        messagingSenderId: "628401314464",
        appId: "1:628401314464:web:0671233dfd801ee43587c5",
        measurementId: "G-NBFZYTN094"
      };

      const app  = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db   = getFirestore(app);

      const fbBadge = document.getElementById('fbBadge');
      function setBadge(txt, cls=''){ fbBadge.textContent = txt; fbBadge.className = 'badge ' + cls; }

      // Watchdog anti ‚ÄúConectando‚Ä¶‚Äù infinito
      let authSettled = false;
      const authWatchdog = setTimeout(()=>{
        if (!authSettled) {
          console.warn('[GC] Auth watchdog timeout ‚Üí Solo lectura');
          setBadge('Solo lectura','warn');
          renderTablaHistorico();
        }
      }, 6000);

      /* ===== Utilidades ===== */
      const PREF_VISTA='gc_vista', PREF_ORDEN='gc_orden', PREF_FPAIS='gc_filtro_pais',
            PREF_FFECHA='gc_filtro_fecha_iso', PREF_PRESET='gc_preset_rango';
      const savePref=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
      const readPref=(k,d=null)=>{ try{const v=JSON.parse(localStorage.getItem(k)); return v??d;}catch{ return d;} };

      const pad2=n=>String(n).padStart(2,'0');
      const formatDDMMYYYY=d=>`${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
      const formatISO=d=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;

      function ddmmyyyyToISO(s){ if(!s) return ""; if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
        const m=/^\s*(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})\s*$/.exec(s); if(!m) return ""; return `${m[3]}-${pad2(+m[2])}-${pad2(+m[1])}`; }

      function toHora24(str){
        if(!str) return "";
        let s=str.toString().trim().toLowerCase().replace(/\s+/g,'').replace(/[\.]/g,'');
        const m24=s.match(/^(\d{1,2}):(\d{2})$/); if(m24) return `${pad2(+m24[1])}:${pad2(+m24[2])}`;
        const m12=s.match(/^(\d{1,2}):(\d{2})(am|pm)$/);
        if(m12){ let h=+m12[1]%12, min=+m12[2]; if(m12[3]==='pm') h+=12; return `${pad2(h)}:${pad2(min)}`; }
        return str;
      }

      function actualizarFechaHora(){
        const ahora=new Date();
        const fecha=ahora.toLocaleDateString('es-PE',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
        const hora =ahora.toLocaleTimeString('es-PE',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
        document.getElementById('fechaHora').textContent=`üìÖ ${fecha} ‚Äì üïí ${hora}`;
      }
      actualizarFechaHora(); setInterval(actualizarFechaHora,1000);

      let vistaActual=readPref(PREF_VISTA,'numerico'), dataGlobal={}, dataOriginal=[], estadoOrdenColumna=readPref(PREF_ORDEN,{}), columnaOrdenActual=null;

      // Banderas (alias b√°sicos; si luego quieres normalizar acentos lo vemos)
      const codigos={ "Chile":"cl","Colombia":"co","Costa Rica":"cr","Ecuador":"ec","Mexico":"mx","M√©xico":"mx","Paraguay":"py","Peru":"pe","Per√∫":"pe","Uruguay":"uy","Venezuela":"ve","Bolivia":"bo" };

      function mostrarToast(msg){
        const t=document.getElementById("toast");
        t.textContent=msg; t.style.display="block"; t.style.opacity=1;
        setTimeout(()=>{t.style.transition="opacity .5s"; t.style.opacity=0;},2600);
        setTimeout(()=>{t.style.display="none"; t.style.transition="";},3200);
      }

      const COLMAP={ country:["Country"], total:["Total"], news:["New"], recall:["Recall"], noAnswer:["No answer","No Answer"], approved:["Approved","Call center (approved)","Call center approved"], reject:["Reject"], trash:["Trash"] };

      function borrarTodo(){
        document.getElementById("inputData").value="";
        document.querySelector("#tablaReporte tbody").innerHTML="";
        document.querySelector("#encabezadoTabla").innerHTML="";
        document.querySelector("#filaTotales").innerHTML="";
        dataGlobal={}; dataOriginal=[]; estadoOrdenColumna={}; columnaOrdenActual=null; savePref(PREF_ORDEN,{});
      }

      function procesar(vista){
        vistaActual=vista; savePref(PREF_VISTA,vista); estadoOrdenColumna={}; savePref(PREF_ORDEN,{}); columnaOrdenActual=null;
        const input=document.getElementById("inputData").value.trim(); if(!input){ mostrarToast("Pega la tabla del panel para procesar."); return; }
        const filas=input.split("\n"), headersRaw=filas[0].split("\t").map(h=>h.trim()), headersLC=headersRaw.map(h=>h.toLowerCase());
        const idx=(names)=> (Array.isArray(names)?names:[names]).reduce((r,n)=> r>=0?r:(headersRaw.indexOf(n)>=0?headersRaw.indexOf(n):headersLC.indexOf(n.toLowerCase())), -1);
        const IDX={ country:idx(COLMAP.country), total:idx(COLMAP.total), news:idx(COLMAP.news), recall:idx(COLMAP.recall), noAnswer:idx(COLMAP.noAnswer), approved:idx(COLMAP.approved), reject:idx(COLMAP.reject), trash:idx(COLMAP.trash) };
        if(IDX.country===-1||IDX.total===-1){ mostrarToast("‚ö†Ô∏è Falta Country/Total."); return; }
        if(IDX.approved===-1){ mostrarToast("‚ÑπÔ∏è No encuentro ‚ÄòApproved‚Äô; usar√© 0."); }
        dataGlobal={};
        for(let i=1;i<filas.length;i++){
          const f=filas[i].split("\t"), pais=(f[IDX.country]||"").trim(); if(!pais) continue;
          if(!dataGlobal[pais]) dataGlobal[pais]={total:0,news:0,recall:0,noAnswer:0,approved:0,reject:0,trash:0};
          const val=j=> j===-1?0:(parseInt(f[j])||0);
          dataGlobal[pais].total+=val(IDX.total); dataGlobal[pais].news+=val(IDX.news); dataGlobal[pais].recall+=val(IDX.recall); dataGlobal[pais].noAnswer+=val(IDX.noAnswer); dataGlobal[pais].approved+=val(IDX.approved); dataGlobal[pais].reject+=val(IDX.reject); dataGlobal[pais].trash+=val(IDX.trash);
        }
        dataOriginal=Object.entries(dataGlobal);
        renderTabla(); mostrarToast("‚úÖ Datos procesados");
      }

      function pctSafe(v,t){ if(!t) return "0.0%"; return ((v/t)*100).toFixed(1)+"%"; }
      function renderTabla(){
        const enc=document.getElementById("encabezadoTabla"), cuerpo=document.querySelector("#tablaReporte tbody"), tfoot=document.getElementById("filaTotales");
        enc.innerHTML=""; cuerpo.innerHTML=""; tfoot.innerHTML="";
        let cols=["Pa√≠s","Leads"];
        if(vistaActual==="numerico"){ cols.push("New","Recall","No Answer","Approve","Reject","Trash");
        }else if(vistaActual==="porcentaje"){ cols.push("% New","% Recall","% No Answer","% Approve","% Reject","% Trash");
        }else{ cols.push("New","% New","Recall","% Recall","No Answer","% No Answer","Approve","% Approve","Reject","% Reject","Trash","% Trash"); }
        cols.forEach(col=>{ const th=document.createElement("th"); th.textContent=col; if(col!=="Pa√≠s"){ th.onclick=()=>cambiarOrdenColumna(col);} enc.appendChild(th); });
        let datos=[...dataOriginal];
        if(columnaOrdenActual){ const e=estadoOrdenColumna[columnaOrdenActual]||0; datos.sort((a,b)=>{ const A=getValorOrdenable(a[1],columnaOrdenActual), B=getValorOrdenable(b[1],columnaOrdenActual); return e===1?B-A:e===2?A-B:0; }); }
        const flag=p=>codigos[p]?`<img class="bandera" src="https://flagcdn.com/w40/${codigos[p]}.png" alt="">`:"";
        for(const [pais,d] of datos){
          const t=d.total||0;
          const tr=document.createElement("tr");
          let html=`<td class="bold">${flag(pais)} ${pais}</td><td>${d.total}</td>`;
          if(vistaActual==="numerico"){
            html+=`<td>${d.news}</td><td>${d.recall}</td><td>${d.noAnswer}</td><td>${d.approved}</td><td>${d.reject}</td><td>${d.trash}</td>`;
          }else if(vistaActual==="porcentaje"){
            html+=`<td>${pctSafe(d.news,t)}</td><td>${pctSafe(d.recall,t)}</td><td>${pctSafe(d.noAnswer,t)}</td><td class="${colorPct(t?d.approved/t*100:0)}">${pctSafe(d.approved,t)}</td><td>${pctSafe(d.reject,t)}</td><td>${pctSafe(d.trash,t)}</td>`;
          }else{
            html+=`<td>${d.news}</td><td>${pctSafe(d.news,t)}</td><td>${d.recall}</td><td>${pctSafe(d.recall,t)}</td><td>${d.noAnswer}</td><td>${pctSafe(d.noAnswer,t)}</td><td>${d.approved}</td><td class="${colorPct(t?d.approved/t*100:0)}">${pctSafe(d.approved,t)}</td><td>${d.reject}</td><td>${pctSafe(d.reject,t)}</td><td>${d.trash}</td><td>${pctSafe(d.trash,t)}</td>`;
          }
          tr.innerHTML=html; cuerpo.appendChild(tr);
        }
        const tot=Object.values(dataGlobal).reduce((a,d)=>{ a.total+=d.total; a.news+=d.news; a.recall+=d.recall; a.noAnswer+=d.noAnswer; a.approved+=d.approved; a.trash+=d.trash; a.reject+=d.reject; return a; },{total:0,news:0,recall:0,noAnswer:0,approved:0,trash:0,reject:0});
        if(Object.keys(dataGlobal).length){
          let foot=`<td class="bold">TOTAL</td><td>${tot.total}</td>`; const t=tot.total||0;
          if(vistaActual==="numerico"){
            foot+=`<td>${tot.news}</td><td>${tot.recall}</td><td>${tot.noAnswer}</td><td>${tot.approved}</td><td>${tot.reject}</td><td>${tot.trash}</td>`;
          }else if(vistaActual==="porcentaje"){
            foot+=`<td>${pctSafe(tot.news,t)}</td><td>${pctSafe(tot.recall,t)}</td><td>${pctSafe(tot.noAnswer,t)}</td><td class="${colorPct(t?tot.approved/t*100:0)}">${pctSafe(tot.approved,t)}</td><td>${pctSafe(tot.reject,t)}</td><td>${pctSafe(tot.trash,t)}</td>`;
          }else{
            foot+=`<td>${tot.news}</td><td>${pctSafe(tot.news,t)}</td><td>${tot.recall}</td><td>${pctSafe(tot.recall,t)}</td><td>${tot.noAnswer}</td><td>${pctSafe(tot.noAnswer,t)}</td><td>${tot.approved}</td><td class="${colorPct(t?tot.approved/t*100:0)}">${pctSafe(tot.approved,t)}</td><td>${tot.reject}</td><td>${pctSafe(tot.reject,t)}</td><td>${tot.trash}</td><td>${pctSafe(tot.trash,t)}</td>`;
          }
          tfoot.innerHTML=foot;
        }
      }
      function cambiarOrdenColumna(col){ estadoOrdenColumna[col]=(estadoOrdenColumna[col]||0)+1; if(estadoOrdenColumna[col]>2) estadoOrdenColumna[col]=0; columnaOrdenActual=estadoOrdenColumna[col]===0?null:col; savePref(PREF_ORDEN,estadoOrdenColumna); renderTabla(); }
      function restablecerOrden(){ estadoOrdenColumna={}; columnaOrdenActual=null; savePref(PREF_ORDEN,{}); renderTabla(); }
      function getValorOrdenable(d,col){ const t=d.total||0; const base={"Leads":d.total,"New":d.news,"% New":t?(d.news/t)*100:0,"Recall":d.recall,"% Recall":t?(d.recall/t)*100:0,"No Answer":d.noAnswer,"% No Answer":t?(d.noAnswer/t)*100:0,"Approve":d.approved,"% Approve":t?(d.approved/t)*100:0,"Reject":d.reject,"% Reject":t?(d.reject/t)*100:0,"Trash":d.trash,"% Trash":t?(d.trash/t)*100:0}; return base[col]||0; }
      const colorPct=p=>p<=25?"red":p>=30?"green":"orange";

      /* ===== Cloud hist√≥rico con FALLBACK ===== */
      let cloudHistorico=[];
      const filtroPaisEl=document.getElementById("filtroPais");
      const filtroFechaEl=document.getElementById("filtroFecha");
      const presetEl=document.getElementById("presetRango");

      function rangeFromPreset(preset, dateISO){
        const now=new Date();
        const todayISO = `${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}`;
        const startOf=(iso)=> new Date(`${iso}T00:00:00`).getTime();
        const addDays=(iso,days)=>{ const d=new Date(`${iso}T00:00:00`); d.setDate(d.getDate()+days); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; };
        if(preset==='hoy'){ const s=startOf(todayISO), e=startOf(addDays(todayISO,1)); return {start:s, end:e}; }
        if(preset==='ayer'){ const y=addDays(todayISO,-1); return {start:startOf(y), end:startOf(todayISO)}; }
        if(preset==='7d'){ const s=addDays(todayISO,-6); return {start:startOf(s), end:startOf(addDays(todayISO,1))}; }
        if(preset==='dia' && dateISO){ return {start:startOf(dateISO), end:startOf(addDays(dateISO,1))}; }
        return {start:null, end:null};
      }

      function normalizeRows(rows){
        rows.forEach(r=>{
          const iso  = r.fechaISO || ddmmyyyyToISO(r.fecha);
          const hhmm = r.hora24 || toHora24(r.hora);
          if(!r.ts && iso && hhmm){
            r.ts = new Date(`${iso}T${hhmm}:00`).getTime();
          }
          r.hora = hhmm || r.hora;
        });
        rows.sort((a,b)=>(a.ts||0)-(b.ts||0));
        return rows;
      }

      async function fetchHistoricoCloud(fp, startTs, endTs){
        const base = collection(db,'historico');
        try {
          let qy;
          if(fp !== 'todos' && startTs != null && endTs != null){
            qy = query(base, where('pais','==',fp), where('ts','>=',startTs), where('ts','<', endTs));
          } else if(startTs != null && endTs != null){
            qy = query(base, where('ts','>=',startTs), where('ts','<', endTs));
          } else if(fp !== 'todos'){
            qy = query(base, where('pais','==',fp));
          } else {
            qy = base;
          }
          const snap = await getDocs(qy);
          const rows = [];
          snap.forEach(d=>rows.push({ ...d.data(), _id: d.id })); // conservar id
          return normalizeRows(rows);
        } catch (e) {
          console.warn('[GC] fetchHistoricoCloud fallback:', e);
          if (e.code === 'failed-precondition') {
            let q2 = base;
            if (startTs != null && endTs != null){
              q2 = query(base, where('ts','>=',startTs), where('ts','<', endTs));
            }
            const snap = await getDocs(q2);
            let rows = [];
            snap.forEach(d=>rows.push({ ...d.data(), _id: d.id }));
            if (fp !== 'todos') rows = rows.filter(r => r.pais === fp);
            return normalizeRows(rows);
          }
          throw e;
        }
      }

      async function registrarAvance(){
        if(!Object.keys(dataGlobal).length){ mostrarToast("‚ÑπÔ∏è Procesa datos antes de registrar."); return; }
        if(!auth.currentUser){ mostrarToast("‚ö†Ô∏è Sin autenticaci√≥n (solo lectura)."); return; }

        const now=new Date();
        const hora24=`${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
        const fecha=formatDDMMYYYY(now), fechaISO=formatISO(now), ts=now.getTime();

        const colRef=collection(db,'historico');
        const writes=[];
        for(const [pais,d] of Object.entries(dataGlobal)){
          const total=d.total||0;
          writes.push(addDoc(colRef,{
            fecha, fechaISO, hora:hora24, hora24:hora24, ts, pais,
            leads:d.total, news:d.news, recall:d.recall, noAnswer:d.noAnswer,
            approve:d.approved, pctApprove: total?((d.approved/total)*100).toFixed(1):"0.0",
            reject:d.reject, trash:d.trash
          }));
        }
        try{
          await Promise.all(writes);
          mostrarToast("‚úÖ Avance registrado en la nube.");
          await renderTablaHistorico();
          renderGrafico();
        }catch(e){
          console.error('[GC] Firestore write error:', e);
          mostrarToast("‚ö†Ô∏è Error guardando en la nube: " + (e.code || e.message));
        }
      }

      async function borrarHistorial(){
        if(!confirm("¬øBorrar TODO el historial de la nube?")) return;
        try{
          const snap=await getDocs(collection(db,'historico'));
          const ops=[]; snap.forEach(d=>ops.push(deleteDoc(doc(db,'historico',d.id))));
          await Promise.all(ops); mostrarToast("üóëÔ∏è Historial borrado."); await renderTablaHistorico(); renderGrafico();
        }catch(e){ console.error(e); mostrarToast("‚ùå No se pudo borrar: " + (e.code||e.message)); }
      }

      // üóëÔ∏è Eliminar registro individual
      async function eliminarRegistro(id){
        if(!id){ mostrarToast("‚ö†Ô∏è No se encontr√≥ el ID del registro."); return; }
        if(!auth.currentUser){ mostrarToast("‚ö†Ô∏è No autenticado: no puedes eliminar."); return; }
        const ok = confirm("¬øSeguro que deseas eliminar este registro?");
        if(!ok) return;
        try{
          await deleteDoc(doc(db, 'historico', id));
          mostrarToast("üóëÔ∏è Registro eliminado.");
          await renderTablaHistorico();
          renderGrafico();
        }catch(e){
          console.error(e);
          mostrarToast("‚ùå No se pudo eliminar: " + (e.code || e.message));
        }
      }

      async function ensurePaisesOptions(){
        if(filtroPaisEl.options.length>1) return;
        try{
          const snap=await getDocs(collection(db,'historico'));
          const set=new Set(); snap.forEach(d=>set.add(d.data().pais||""));
          [...set].filter(Boolean).forEach(p=>{ const o=document.createElement("option");o.value=p;o.textContent=p;filtroPaisEl.appendChild(o); });
        }catch(e){ console.warn('[GC] ensurePaisesOptions:', e); }
      }

      function calcMedian(arr){
        if(!arr.length) return 0;
        const v=[...arr].sort((a,b)=>a-b);
        const m=Math.floor(v.length/2);
        return v.length%2?v[m]:(v[m-1]+v[m])/2;
      }

      function renderQuickMetrics(){
        const box=document.getElementById('quickMetrics');
        if(!cloudHistorico.length){ box.style.display='none'; return; }
        const vals=cloudHistorico.map(r=>parseFloat(r.pctApprove||0)).filter(n=>!isNaN(n));
        if(!vals.length){ box.style.display='none'; return; }
        const min=Math.min(...vals).toFixed(1);
        const med=calcMedian(vals).toFixed(1);
        const max=Math.max(...vals).toFixed(1);

        document.getElementById('mMin').textContent=`${min}%`;
        document.getElementById('mMed').textContent=`${med}%`;
        document.getElementById('mMax').textContent=`${max}%`;

        let deltaTxt='‚Äì', cls='';
        if(vals.length>=2){
          const last=vals[vals.length-1], prev=vals[vals.length-2];
          const d=(last-prev).toFixed(1);
          const arrow = (d>=0? '‚Üë':'‚Üì');
          cls = d>=0? 'delta up':'delta down';
          deltaTxt = `${arrow} ${Math.abs(d)} pp`;
        }
        const mDelta=document.getElementById('mDelta');
        mDelta.className='value ' + cls;
        mDelta.textContent=deltaTxt;

        box.style.display='flex';
      }

      async function renderTablaHistorico(){
        await ensurePaisesOptions();
        const tbody=document.querySelector("#tablaHistorico tbody"); tbody.innerHTML="";

        // Preferencias
        const prefPais=readPref(PREF_FPAIS,'todos');
        const prefFecha=readPref(PREF_FFECHA,'');
        const prefPreset=readPref(PREF_PRESET,'dia');
        if([...filtroPaisEl.options].some(o=>o.value===prefPais)) filtroPaisEl.value=prefPais;
        presetEl.value = prefPreset;
        if(prefFecha) filtroFechaEl.value = prefFecha;

        const preset = presetEl.value;
        const dateISO = filtroFechaEl.value || '';
        const {start, end} = rangeFromPreset(preset, dateISO);

        try{
          cloudHistorico=await fetchHistoricoCloud(filtroPaisEl.value, start, end);
        }catch(e){
          console.error('[GC] Fetch hist√≥rico:', e);
          mostrarToast("‚ö†Ô∏è No se pudo leer la nube: " + (e.code||e.message));
          cloudHistorico=[];
        }

        cloudHistorico.forEach(r=>{
          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td>${r.hora||""}</td>
            <td>${r.fecha||""}</td>
            <td>${r.pais||""}</td>
            <td>${r.leads||0}</td>
            <td>${r.news||0}</td>
            <td>${r.recall||0}</td>
            <td>${r.noAnswer||0}</td>
            <td>${r.approve||0}</td>
            <td>${Number(r.pctApprove||0).toFixed(1)}%</td>
            <td>${r.reject||0}</td>
            <td>${r.trash||0}</td>
            <td>
              <button class="btn-danger" ${r._id ? '' : 'disabled'}
                onclick="eliminarRegistro('${r._id||''}')" title="Eliminar este registro">
                üóëÔ∏è Eliminar
              </button>
            </td>`;
          tbody.appendChild(tr);
        });

        renderQuickMetrics();
        renderGrafico();
      }

      function onFiltroChange(){ savePref(PREF_FPAIS, filtroPaisEl.value); savePref(PREF_FFECHA, filtroFechaEl.value || ''); renderTablaHistorico(); }
      function onPresetChange(){ const preset=presetEl.value; savePref(PREF_PRESET, preset); filtroFechaEl.disabled = (preset !== 'dia'); renderTablaHistorico(); }
      function limpiarFecha(){ filtroFechaEl.value=""; savePref(PREF_FFECHA,''); presetEl.value='dia'; savePref(PREF_PRESET,'dia'); filtroFechaEl.disabled=false; renderTablaHistorico(); }

      function exportarHistoricoCSV(){
        if(!cloudHistorico.length){ mostrarToast("‚ÑπÔ∏è No hay registros para exportar."); return; }
        const encabezados=["Fecha","Hora","Pa√≠s","Leads","News","Recall","No Answer","Approve","% Approve","Reject","Trash"];
        const filas=cloudHistorico.map(r=>[ r.fecha||"", r.hora||"", r.pais||"", r.leads||0, r.news||0, r.recall||0, r.noAnswer||0, r.approve||0, r.pctApprove||0, r.reject||0, r.trash||0 ]);
        const csv=[encabezados,...filas].map(row=>row.map(v=>`"${String(v??"").replace(/"/g,'""')}"`).join(",")).join("\n");
        const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`historico_gc_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
      }

      function renderGrafico(){
        const ctx=document.getElementById('graficoAvance').getContext('2d');
        const agr={}; cloudHistorico.forEach(r=>{ if(!agr[r.pais]) agr[r.pais]=[]; agr[r.pais].push({x:r.hora,y:r.pctApprove}); });
        const datasets=Object.keys(agr).map(k=>({label:k,data:agr[k],fill:false,tension:.2}));
        if(window.graficoAvance) window.graficoAvance.destroy();
        window.graficoAvance=new Chart(ctx,{type:'line',data:{datasets},options:{responsive:true,plugins:{legend:{position:'top'}},scales:{x:{title:{display:true,text:'Hora'},type:'category'},y:{title:{display:true,text:'% Approve'},beginAtZero:true,max:100}}}});
      }

      // Exponer a window (mismos nombres)
      window.procesar=procesar; window.borrarTodo=borrarTodo; window.restablecerOrden=restablecerOrden;
      window.registrarAvance=registrarAvance; window.borrarHistorial=borrarHistorial;
      window.exportarHistoricoCSV=exportarHistoricoCSV; window.onFiltroChange=onFiltroChange; window.onPresetChange=onPresetChange; window.limpiarFecha=limpiarFecha;
      window.eliminarRegistro=eliminarRegistro;

      // Auth
      onAuthStateChanged(auth, (u)=>{
        authSettled = true;
        clearTimeout(authWatchdog);
        if(u){
          document.getElementById('btnRegistrar')?.removeAttribute('disabled');
          setBadge('Conectado ‚úì','ok');
        }else{
          setBadge('Solo lectura','warn');
        }
        renderTablaHistorico();
      });

      signInAnonymously(auth).catch(e=>{
        console.error('[GC] signInAnonymously error:', e);
      });

      document.addEventListener('DOMContentLoaded', ()=>{
        const prefPreset=readPref(PREF_PRESET,'dia');
        document.getElementById('presetRango').value=prefPreset;
        document.getElementById('filtroFecha').disabled = (prefPreset!=='dia');
        const prefFecha=readPref(PREF_FFECHA,''); if(prefFecha) document.getElementById('filtroFecha').value=prefFecha;
      });
    </script>
  </body>
</html>

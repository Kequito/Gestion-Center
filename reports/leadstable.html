<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leads Table | Gestión Center</title>

  <!-- Opcional:
  <meta name="gc-base" content="/Gestion-Center/">
  -->
</head>

<body>
  <gc-shell hero-title="Leads Table" hero-subtitle="Pega la data del panel y genera la tabla agrupada por país (estilo Gestión Center).">

    <section class="gc-panel">
      <div class="gc-toolbar" style="gap:12px">
        <button class="gc-btn gc-btn--primary" id="btnRender">Generar Tabla</button>
        <button class="gc-btn gc-btn--ghost" id="btnClear">Limpiar</button>

        <div class="gc-chipset u-right" style="margin-left:auto">
          <span class="gc-chip" id="metaRows">Filas: —</span>
          <span class="gc-chip" id="metaCountries">Países: —</span>
          <span class="gc-chip gc-chip--dark" id="metaUpdated">Último render: —</span>
        </div>
      </div>

      <div style="margin-top:12px">
        <textarea id="pasteInput" class="gc-input" placeholder="Pega aquí la tabla completa (incluye encabezados)."></textarea>
        <div class="gc-help" style="margin-top:8px">
          ✅ Mapeo: <b>Queues = Name</b> · <b>Operators = derecha (X|Y)</b> · <b>Orders available = min de Capacity</b> · <b>Total orders = primer valor de Orders</b>
        </div>
      </div>
    </section>

    <section class="gc-panel" style="margin-top:12px">
      <div class="gc-table-wrap">
        <table class="gc-table gc-table--compact" id="leadsTable">
          <thead>
            <tr>
              <th style="width:150px;text-align:center">Country</th>
              <th>Queues</th>
              <th style="width:140px;text-align:center">Number<br/>of operators</th>
              <th style="width:140px;text-align:center">Orders<br/>available</th>
              <th style="width:120px;text-align:center">Total<br/>orders</th>
              <th style="width:120px;text-align:center">Full Total</th>
            </tr>
          </thead>
          <tbody id="leadsTbody"></tbody>
        </table>
      </div>
    </section>

    <style>
      .gc-input{
        width:100%;
        min-height:170px;
        resize:vertical;
        border:1px solid var(--gray-300);
        border-radius:12px;
        padding:12px 14px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size:13px;
        line-height:1.35;
        outline:none;
      }
      .gc-input:focus{ box-shadow:0 0 0 3px rgba(0,0,0,.08); }

      .gc-help{ font-size:12px; color:var(--gray-700); }

      .gc-table-wrap{ overflow:auto; border-radius:12px; }

      #leadsTable td:nth-child(3),
      #leadsTable td:nth-child(4),
      #leadsTable td:nth-child(5),
      #leadsTable td:nth-child(6){
        text-align:center;
        font-weight:800;
      }

      td.country-cell{
        text-transform:uppercase;
        font-weight:900;
        letter-spacing:.6px;
        text-align:center;
        color:#000;
        white-space:nowrap;
      }

      td.queue-cell{
        text-align:left;
        font-weight:800;
        white-space:nowrap;
      }

      td.fulltotal{
        font-weight:900;
        background: var(--gray-100);
      }

      .heat-red   { background:#ff6b6b !important; }
      .heat-pink  { background:#f6b2b2 !important; }
      .heat-beige { background:#e8ddc6 !important; }
      .heat-green { background:#9ad39a !important; }

      .cc-chile     { background:#9fc6e6 !important; }
      .cc-colombia  { background:#f3de8a !important; }
      .cc-costarica { background:#b675a7 !important; }
      .cc-ecuador   { background:#f1b782 !important; }
      .cc-mexico    { background:#cfe8c7 !important; }
      .cc-paraguay  { background:#e6c7d6 !important; }
      .cc-peru      { background:#e39a9a !important; }
      .cc-uruguay   { background:#9fc0c3 !important; }
      .cc-venezuela { background:#c9c9c9 !important; }
      .cc-default   { background:#bdbdbd !important; }
    </style>

  </gc-shell>

  <script type="module" src="../assets/bw/shell.js"></script>

  <script>
    // =====================================
    // Helpers de parse
    // =====================================
    function toIntSafe(v){
      const n = parseInt(String(v || "").replace(/[^\d-]/g, ""), 10);
      return Number.isFinite(n) ? n : 0;
    }
    function parseRightPipe(value){
      const parts = String(value || "").split("|").map(s => s.trim());
      if (parts.length >= 2) return toIntSafe(parts[1]); // ✅ derecha
      return toIntSafe(value);
    }
    function parseLeftPipe(value){
      const parts = String(value || "").split("|").map(s => s.trim());
      return toIntSafe(parts[0]); // ✅ izquierda
    }
    function parseCapacityMin(value){
      const parts = String(value || "").split("->").map(s => s.trim());
      return toIntSafe(parts[0]); // ✅ min
    }
    function extractCountryName(raw){
      const s = String(raw || "").trim();
      const m = s.match(/^\d+\.\s*(.+)$/); // "3. Mexico" => "Mexico"
      return (m ? m[1] : s).trim();
    }
    function countryClass(countryUpper){
      const key = countryUpper.toLowerCase();
      if (key.includes("chile")) return "cc-chile";
      if (key.includes("colombia")) return "cc-colombia";
      if (key.includes("costa rica") || key.includes("costarica")) return "cc-costarica";
      if (key.includes("ecuador")) return "cc-ecuador";
      if (key.includes("mexico")) return "cc-mexico";
      if (key.includes("paraguay")) return "cc-paraguay";
      if (key.includes("peru")) return "cc-peru";
      if (key.includes("uruguay")) return "cc-uruguay";
      if (key.includes("venezuela")) return "cc-venezuela";
      return "cc-default";
    }
    function heatClass(val){
      const n = Number(val);
      if (n === 0) return "heat-red";
      if (n <= 5) return "heat-pink";
      if (n <= 20) return "heat-beige";
      return "heat-green";
    }

    // =====================================
    // ✅ Parser correcto (TAB-based)
    // =====================================
    function splitRow(line){
      // Preferimos tabs porque así viene desde el panel
      if (line.includes("\t")){
        const arr = line.replace(/\r/g,"").split("\t").map(s => (s ?? "").trim());
        // Header suele venir con un tab inicial => primera celda vacía
        if (arr.length && arr[0] === "") arr.shift();
        return arr;
      }
      // Fallback: si alguna vez lo copian sin tabs
      return line.replace(/\r/g,"").trim().split(/\s{2,}/g).map(s => s.trim());
    }

    function normHeaderKey(s){
      return String(s || "")
        .trim()
        .toLowerCase()
        .replace(/\s+/g," ")
        .replace(/\u00a0/g," "); // NBSP
    }

    function findHeaderIndex(lines){
      for (let i=0;i<lines.length;i++){
        const low = lines[i].toLowerCase();
        // Match fuerte
        if (low.includes("country") && low.includes("name") && low.includes("number of operators") && low.includes("capacity") && low.includes("orders")){
          return i;
        }
      }
      return -1;
    }

    function parsePastedData(text){
      const rawLines = String(text || "")
        .split("\n")
        .map(l => (l || "").replace(/\r/g,"").trim())
        .filter(Boolean);

      // Quitar líneas “☰” o “≡”
      const lines = rawLines.filter(l => !/^(☰|≡)+$/.test(l));

      if (!lines.length) return { rows: [], groups: [] };

      const headerIndex = findHeaderIndex(lines);
      if (headerIndex === -1){
        return { rows: [], groups: [], error: "No se detectó encabezado. Pega incluyendo la fila de headers." };
      }

      const headerCells = splitRow(lines[headerIndex]).map(normHeaderKey);

      // Mapear índices
      const colIndex = {};
      headerCells.forEach((h, idx) => { colIndex[h] = idx; });

      // Nombres EXACTOS (como viene en tu export)
      const KEY_COUNTRY   = "country";
      const KEY_NAME      = "name";
      const KEY_OPERATORS = "number of operators";
      const KEY_CAPACITY  = "capacity";
      const KEY_ORDERS    = "orders";

      const required = [KEY_COUNTRY, KEY_NAME, KEY_OPERATORS, KEY_CAPACITY, KEY_ORDERS];
      for (const k of required){
        if (!(k in colIndex)){
          return { rows: [], groups: [], error: `Falta la columna "${k}" en el header detectado.` };
        }
      }

      const rows = [];
      const dataLines = lines.slice(headerIndex + 1);

      for (const line of dataLines){
        if (!line || /^(☰|≡)+$/.test(line)) continue;

        const cells = splitRow(line);
        const get = (key) => {
          const idx = colIndex[key];
          return (idx != null && idx < cells.length) ? (cells[idx] ?? "") : "";
        };

        const rawCountry   = get(KEY_COUNTRY);
        const rawName      = get(KEY_NAME);
        const rawOperators = get(KEY_OPERATORS);
        const rawCapacity  = get(KEY_CAPACITY);
        const rawOrders    = get(KEY_ORDERS);

        // Country/Name son obligatorios
        if (!rawCountry || !rawName) continue;

        rows.push({
          country: extractCountryName(rawCountry),
          queue: rawName.trim(),
          operators: parseRightPipe(rawOperators),
          ordersAvailable: parseCapacityMin(rawCapacity),
          totalOrders: parseLeftPipe(rawOrders),
        });
      }

      // Agrupar por país (orden de aparición)
      const groupsMap = new Map();
      for (const r of rows){
        if (!groupsMap.has(r.country)){
          groupsMap.set(r.country, { country: r.country, items: [], sumAvail: 0, sumTotal: 0 });
        }
        const g = groupsMap.get(r.country);
        g.items.push(r);
        g.sumAvail += r.ordersAvailable;
        g.sumTotal += r.totalOrders;
      }

      return { rows, groups: Array.from(groupsMap.values()) };
    }

    // =====================================
    // Render
    // =====================================
    function renderTable(groups){
      const tbody = document.getElementById("leadsTbody");
      tbody.innerHTML = "";

      for (const g of groups){
        const rowspan = g.items.length;
        const cUpper = String(g.country || "").toUpperCase();
        const cClass = countryClass(cUpper);

        g.items.forEach((item, idx) => {
          const tr = document.createElement("tr");

          // Country merged
          if (idx === 0){
            const tdCountry = document.createElement("td");
            tdCountry.className = `country-cell ${cClass}`;
            tdCountry.rowSpan = rowspan;
            tdCountry.textContent = cUpper;
            tr.appendChild(tdCountry);
          }

          // Queues
          const tdQueue = document.createElement("td");
          tdQueue.className = "queue-cell";
          tdQueue.textContent = item.queue;
          tr.appendChild(tdQueue);

          // Operators
          const tdOps = document.createElement("td");
          tdOps.textContent = item.operators;
          tr.appendChild(tdOps);

          // Orders available
          const tdAvail = document.createElement("td");
          tdAvail.className = heatClass(item.ordersAvailable);
          tdAvail.textContent = item.ordersAvailable;
          tr.appendChild(tdAvail);

          // Total orders
          const tdTotal = document.createElement("td");
          tdTotal.className = heatClass(item.totalOrders);
          tdTotal.textContent = item.totalOrders;
          tr.appendChild(tdTotal);

          // Full Total (1ra fila sumAvail, 2da fila sumTotal)
          const tdFull = document.createElement("td");
          tdFull.className = "fulltotal";
          if (idx === 0) tdFull.textContent = g.sumAvail;
          else if (idx === 1) tdFull.textContent = g.sumTotal;
          else tdFull.textContent = "";
          tr.appendChild(tdFull);

          tbody.appendChild(tr);
        });
      }
    }

    function setMeta(rowsCount, countriesCount){
      document.getElementById("metaRows").textContent = `Filas: ${rowsCount}`;
      document.getElementById("metaCountries").textContent = `Países: ${countriesCount}`;
      document.getElementById("metaUpdated").textContent = `Último render: ${new Date().toLocaleString()}`;
    }

    // =====================================
    // Init seguro con shell ready
    // =====================================
    function initLeadsTable(){
      const btnRender = document.getElementById("btnRender");
      const btnClear  = document.getElementById("btnClear");
      const input     = document.getElementById("pasteInput");

      if (!btnRender || !btnClear || !input) return;

      btnRender.addEventListener("click", () => {
        const parsed = parsePastedData(input.value);

        if (parsed.error){
          alert(parsed.error);
          return;
        }

        renderTable(parsed.groups);
        setMeta(parsed.rows.length, parsed.groups.length);
      });

      btnClear.addEventListener("click", () => {
        input.value = "";
        document.getElementById("leadsTbody").innerHTML = "";
        document.getElementById("metaRows").textContent = "Filas: —";
        document.getElementById("metaCountries").textContent = "Países: —";
        document.getElementById("metaUpdated").textContent = "Último render: —";
      });
    }

    function whenShellReady(fn){
      if (window.__GC_READY__ === true) return fn();
      window.addEventListener("gc:shell-ready", fn, { once:true });
    }
    whenShellReady(initLeadsTable);
  </script>
</body>
</html>

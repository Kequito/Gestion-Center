<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="gc-base" content="/Gestion-Center/">
  <title>Delta Report 2 ¬∑ Gesti√≥n Center</title>

  <style>
    /* Heatmaps */
    td[data-h]{background:linear-gradient(90deg, rgba(56,142,60,.18) var(--h,0%), transparent 0)}
    td.badmap[data-h]{background:linear-gradient(90deg, rgba(183,28,28,.25) var(--h,0%), transparent 0)}
    .muted{color:var(--gray-700)}
    .u-gap{height:10px}

    /* Tarjetas por pa√≠s */
    .country-card{margin:10px 0; padding:0; overflow:hidden}
    .country-head{
      width:100%; display:flex; align-items:center; gap:10px;
      background:#0a0a0a; color:#fff; border:0; padding:12px 14px; cursor:pointer;
    }
    .country-head .title{font-weight:800}
    .country-head .meta{display:flex; gap:6px; flex-wrap:wrap}
    .country-head .chev{margin-left:auto; transition:transform .22s var(--ease)}
    .country-card.is-collapsed .chev{transform:rotate(-90deg)}
    .country-body{padding:10px}
    .country-card.is-collapsed .country-body{display:none}
  </style>
</head>
<body>
  <gc-shell>
    <h1 class="page-title">Delta Report 2</h1>

    <div class="gc-panel" style="margin-top:14px;">
      <div class="gc-toolbar">
        <input id="search" class="gc-btn gc-btn--ghost" placeholder="üîé Buscar pa√≠s o cola‚Ä¶" style="width:280px; text-align:left;" />
        <button id="btnProcess" class="gc-btn gc-btn--primary">
          <span class="gc-icon">‚öôÔ∏è</span> Procesar texto
        </button>
        <button id="btnClear" class="gc-btn">
          <span class="gc-icon">üßπ</span> Limpiar
        </button>
        <a class="gc-btn gc-btn--ghost" target="_blank" rel="noopener"
           href="https://panel.2wcall.com/queue/control/index?QueueSearch%5Bid%5D=&QueueSearch%5Bname%5D=&QueueSearch%5Bpartner_id%5D=&QueueSearch%5Bcountry_id%5D%5B0%5D=26&QueueSearch%5Bcountry_id%5D%5B1%5D=28&QueueSearch%5Bcountry_id%5D%5B2%5D=67&QueueSearch%5Bcountry_id%5D%5B3%5D=88&QueueSearch%5Bcountry_id%5D%5B4%5D=3&QueueSearch%5Bcountry_id%5D%5B5%5D=84&QueueSearch%5Bcountry_id%5D%5B6%5D=39&QueueSearch%5Bcountry_id%5D%5B7%5D=96&QueueSearch%5Bcountry_id%5D%5B8%5D=103&QueueSearch%5Bpriorities%5D=&QueueSearch%5Btype_primary%5D=&QueueSearch%5Bis_primary%5D=0&per-page=500">
          üîó Fuente (Panel)
        </a>
        <div class="u-right gc-chipset">
          <span class="gc-chip">Se ignoran PS / Post-sale / PS-Auto</span>
          <span class="gc-chip">Solo 1-1, 2-2, 3-3, 4-4, 5-2, 5-5</span>
        </div>
      </div>
      <div class="u-gap"></div>
      <textarea id="raw" class="gc-panel" placeholder="Pega aqu√≠ el texto con encabezados (#, Country, Name, ‚Ä¶). Acepta TABs o espacios; usa '‚ò∞' como separador de filas."
                style="width:100%; min-height:220px; white-space:pre; border:1px solid var(--gray-300);"></textarea>
    </div>

    <div id="out" class="gc-panel" style="margin-top:14px; display:none;">
      <div style="display:flex; align-items:center; gap:10px; justify-content:space-between; margin-bottom:8px;">
        <h3 style="margin:0;">Resultados <span id="resume" class="muted"></span></h3>
        <div class="gc-chipset">
          <span class="gc-chip gc-chip--dark">verde = mayor</span>
          <span class="gc-chip">rojo = menor</span>
          <span class="gc-chip">click en cabeceras para ordenar</span>
        </div>
      </div>

      <!-- Contenedor de tarjetas por pa√≠s -->
      <div id="countries"></div>
    </div>
  </gc-shell>

  <script type="module" src="../assets/bw/shell.js"></script>

  <script>
    const $  = (s,p=document)=>p.querySelector(s);
    const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));

    const queueAllow = /(?:^|\s)(?:1-1|2-2|3-3|4-4|5-2|5-5)(?:\s|$)/;
    const isPS       = /(\bPS\b|Post-sale|Post-sale_Auto|-PS\b)/i;

    const fmt = n => Number(n||0).toLocaleString('en-US');
    const cleanCountry = s => String(s||'').replace(/^\d+\.\s*/,'').trim();

    const secondNum = s => { const m = String(s||'').match(/(\d+)\s*\|\s*(\d+)/); return m ? parseInt(m[2],10) : 0; };
    const firstNum  = s => { const m = String(s||'').match(/(\d+)\s*\|\s*(\d+)/); return m ? parseInt(m[1],10) : 0; };
    const firstArrow= s => { const m = String(s||'').match(/(\d+)\s*->\s*\d+/);  return m ? parseInt(m[1],10) : null; };

    // Split robusto por fila
    function robustSplit(line, expectedCount){
      let cols = line.split('\t');
      if (cols.length < expectedCount){
        const normalized = line.replace(/\s{2,}/g, '\t');
        cols = normalized.split('\t');
      }
      if (cols.length < expectedCount){
        cols = line.trim().split(/\s+/);
      }
      return cols.map(c=>c.trim());
    }

    function findHeaderAndChunks(lines){
      const headIdx = lines.findIndex(l=>{
        const low = l.toLowerCase();
        return low.includes('country') && low.includes('name')
            && low.includes('number of operators') && low.includes('orders');
      });
      if (headIdx === -1) return { headers:[], chunks:[] };

      // headers
      const tmpCols = lines[headIdx].includes('\t')
        ? lines[headIdx].split('\t').map(c=>c.trim())
        : lines[headIdx].trim().split(/\s{2,}/).map(c=>c.trim());

      const headers = tmpCols;

      // bloques por '‚ò∞'
      const rest = lines.slice(headIdx+1);
      const chunks = [];
      let buf = [];
      for(const ln of rest){
        const t = ln.trim();
        if (t === '‚ò∞'){
          if (buf.length) { chunks.push(buf.join(' ')); buf = []; }
          continue;
        }
        if (t) buf.push(ln);
      }
      if (buf.length) chunks.push(buf.join(' '));

      return { headers, chunks };
    }

    function parseRows(){
      const rawEl = $('#raw');
      const text = (rawEl?.value || '').replace(/\r/g,'').trim();
      if(!text) return [];

      const all   = text.split(/\n/).map(l=>l.replace(/\s+$/,''));
      const lines = all.filter(l=>l.trim() || l.trim()==='‚ò∞');

      const { headers, chunks } = findHeaderAndChunks(lines);
      if (!headers.length || !chunks.length) return [];

      const idx = (name) => headers.findIndex(h => h.toLowerCase() === name.toLowerCase());

      const iCountry = idx('Country');
      const iName    = idx('Name');
      const iOps     = idx('Number of operators');
      const iOrders  = idx('Orders');
      const iCap     = idx('Capacity');
      const iPri     = idx('Priority');

      if ([iCountry,iName,iOps,iOrders,iCap].some(v => v === -1)) return [];

      const expectedCount = headers.length;
      const rows = [];

      for(const ch of chunks){
        const cols = robustSplit(ch, expectedCount);

        const name = (cols[iName] || '').trim();
        if (!name) continue;
        if (isPS.test(name)) continue;
        if (!queueAllow.test(name)) continue;

        const country = cleanCountry(cols[iCountry] || '');
        const ops     = secondNum(cols[iOps] || '');
        // avail: capacity a->b, si no existe probar en priority
        let avail  = firstArrow(cols[iCap]) ?? firstArrow(cols[iPri]) ?? 0;
        const total = firstNum (cols[iOrders] || '');

        rows.push({ country, queue:name, ops, avail, total });
      }
      return rows;
    }

    function groupByCountry(rows){
      const map = new Map();
      for (const r of rows){
        if (!map.has(r.country)) map.set(r.country, {
          country:r.country, rows:[], fullAvail:0, fullOrders:0, sumOps:0
        });
        const g = map.get(r.country);
        g.rows.push(r);
        g.fullAvail  += r.avail;
        g.fullOrders += r.total;
        g.sumOps     += r.ops;
      }
      // ordenar pa√≠ses por Full Orders desc
      return Array.from(map.values()).sort((a,b)=>b.fullOrders-a.fullOrders);
    }

    function render(rows){
      const out  = $('#out');
      const wrap = $('#countries');
      const resume = $('#resume');
      if (!out || !wrap || !resume) return;

      const groups = groupByCountry(rows);

      // para heatmaps globales
      const allOps  = rows.map(r=>r.ops);
      const allAvail= rows.map(r=>r.avail);
      const allTotal= rows.map(r=>r.total);
      const mm=a=>({min:Math.min(...a,0),max:Math.max(...a,1)});
      const mmOps=mm(allOps), mmAvail=mm(allAvail), mmTotal=mm(allTotal);
      const scale=(v,{min,max})=> max===min?0:Math.round(((v-min)/(max-min))*100);

      wrap.innerHTML = '';

      for(const g of groups){
        // tarjeta del pa√≠s
        const card = document.createElement('section');
        card.className = 'gc-panel country-card';

        // header del pa√≠s
        card.innerHTML = `
          <button class="country-head" data-country="${g.country}">
            <span class="title">${g.country}</span>
            <span class="meta">
              <span class="gc-chip">Queues: ${g.rows.length}</span>
              <span class="gc-chip">Ops: ${fmt(g.sumOps)}</span>
              <span class="gc-chip gc-chip--dark">Full Total (Avail): ${fmt(g.fullAvail)}</span>
              <span class="gc-chip">Full Total (Orders): ${fmt(g.fullOrders)}</span>
            </span>
            <span class="chev">‚ñæ</span>
          </button>
          <div class="country-body">
            <table class="gc-table gc-table--compact">
              <thead>
                <tr>
                  <th>Queue</th>
                  <th style="text-align:center;">Operators (Y)</th>
                  <th style="text-align:center;">Orders available</th>
                  <th style="text-align:center;">Total orders</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <td><strong>Totales pa√≠s</strong></td>
                  <td style="text-align:center;"><strong>${fmt(g.sumOps)}</strong></td>
                  <td style="text-align:center;"><strong>${fmt(g.fullAvail)}</strong></td>
                  <td style="text-align:center;"><strong>${fmt(g.fullOrders)}</strong></td>
                </tr>
              </tfoot>
            </table>
          </div>
        `;

        const tbody = $('tbody', card);

        // ordenar colas por total desc
        g.rows.sort((a,b)=>b.total-a.total);

        for(const r of g.rows){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.queue}</td>
            <td data-h style="text-align:center; --h:${scale(r.ops,mmOps)}%">${fmt(r.ops)}</td>
            <td class="badmap" data-h style="text-align:center; --h:${scale(r.avail,mmAvail)}%">${fmt(r.avail)}</td>
            <td data-h style="text-align:center; --h:${scale(r.total,mmTotal)}%">${fmt(r.total)}</td>
          `;
          tbody.appendChild(tr);
        }

        wrap.appendChild(card);
      }

      out.style.display = '';
      resume.textContent = `‚Äî ${rows.length} filas ¬∑ ${new Set(rows.map(r=>r.country)).size} pa√≠ses`;
    }

    // Delegaci√≥n de eventos UI
    document.addEventListener('click', (e)=>{
      if (e.target.closest('#btnProcess')) render(parseRows());
      if (e.target.closest('#btnClear')) {
        const raw = $('#raw'); const search = $('#search'); const out = $('#out');
        if (raw) raw.value=''; if (search) search.value=''; if (out) out.style.display='none';
      }
      // colapsar/expandir tarjeta pa√≠s
      const head = e.target.closest('.country-head');
      if (head){
        const card = head.closest('.country-card');
        if (card) card.classList.toggle('is-collapsed');
      }
    });

    // B√∫squeda (filtra y re-renderiza)
    document.addEventListener('input', (e)=>{
      if (e.target && e.target.id === 'search') {
        const q = e.target.value.toLowerCase().trim();
        const rows = parseRows().filter(r =>
          r.country.toLowerCase().includes(q) || r.queue.toLowerCase().includes(q)
        );
        render(rows);
      }
    });

    // Atajo: Ctrl/Cmd + Enter
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) render(parseRows());
    });
  </script>
</body>
</html>

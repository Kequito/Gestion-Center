<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="gc-base" content="/Gestion-Center/"/>
  <title>Delta Report 2</title>
  <script defer src="../assets/bw/shell.js"></script>
  <style>
    /* ---- Ajustes propios de la p√°gina ---- */
    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:10px 0 12px }
    .toolbar .grow{ flex:1 1 320px }
    .gc-panel h3{ margin:0 0 8px }

    textarea#raw{ width:100%; min-height:220px; resize:vertical; font-family:ui-monospace,Menlo,Consolas,monospace }

    /* Chips info */
    .legend{ display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 }
    .legend .gc-chip--ok{ background:#10b981; border-color:#10b981; color:#fff }

    /* Barras en celdas */
    .bar-wrap{ position:relative; height:22px; background:#f3f4f6; border-radius:6px; overflow:hidden }
    .bar{ position:absolute; inset:0 0 0 0; transform-origin:left center; background:#ef4444; opacity:.25 }
    .bar.green{ background:#10b981; opacity:.25 }

    /* ===== Vista "Por pa√≠s" (cards) ===== */
    .country-card{ border:1px solid var(--gray-300); border-radius:12px; overflow:hidden; margin-bottom:14px; background:var(--white) }
    .country-hd{
      background:#000; color:#fff; padding:8px 12px; display:flex; align-items:center; gap:10px; flex-wrap:wrap
    }
    .flag{ width:20px; height:14px; object-fit:cover; border-radius:2px; border:1px solid rgba(255,255,255,.25) }
    .country-hd .name{ font-weight:800; text-transform:capitalize; display:flex; align-items:center; gap:8px }
    .country-hd .pill{ background:#111; border:1px solid #222; border-radius:999px; padding:4px 8px; font-weight:700 }
    .country-table{ width:100%; border-collapse:separate; border-spacing:0 }
    .country-table th, .country-table td{ padding:10px 12px; border-bottom:1px solid var(--gray-200) }
    .country-table thead th{ background:#000; color:#fff; text-align:left }
    .country-table tfoot td{ font-weight:800; background:var(--gray-100) }

    /* ===== Vista global 3 columnas ===== */
    .global-grid{
      display:grid; gap:14px;
      grid-template-columns:repeat(3, minmax(360px, 1fr));
    }
    @media (max-width:1500px){ .global-grid{ grid-template-columns:repeat(2, minmax(360px,1fr)) } }
    @media (max-width:1080px){ .global-grid{ grid-template-columns:1fr } }

    .gcard{ border:1px solid var(--gray-300); border-radius:12px; overflow:hidden; background:var(--white); display:flex; flex-direction:column }
    .ghead{
      display:grid; grid-template-columns:110px 1fr; align-items:stretch; min-height:48px;
    }
    .ghead .tag{
      display:flex; align-items:center; justify-content:center;
      font-weight:900; font-size:13px; color:#111; text-transform:uppercase;
      background:linear-gradient(180deg,#e5e7eb,#cbd5e1);
      border-right:1px solid var(--gray-300);
      gap:8px;
    }
    .ghead .title{
      background:#000; color:#fff; padding:8px 12px; font-weight:800;
      display:flex; align-items:center; justify-content:space-between;
    }
    .gsmall{ font-size:12px; opacity:.8 }

    .gtable{ width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed }
    .gtable th,.gtable td{ padding:8px 10px; border-bottom:1px solid var(--gray-200) }
    .gtable thead th{ background:#000; color:#fff; font-size:12px }
    .gtable tfoot td{ background:var(--gray-100); font-weight:800 }
    .gtable td:first-child, .gtable th:first-child{ width:42% } /* para nombres largos */
    .gtable td:nth-child(2), .gtable th:nth-child(2){ width:18%; text-align:center }
    .gtable td:nth-child(3), .gtable th:nth-child(3){ width:20% }
    .gtable td:nth-child(4), .gtable th:nth-child(4){ width:20% }
    .truncate{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis }

    /* Bot√≥n activo negro (no ‚Äúse vuelve blanco‚Äù) heredando GC */
    .gc-btn--primary[aria-pressed="true"]{
      filter:brightness(1.05); outline:2px solid var(--black)
    }
  </style>
</head>
<body>
<gc-shell hero-title="Delta Report 2" hero-subtitle="Deltas en formato GC ‚Äî ignora PS y PS-Auto">
  <section class="gc-panel">
    <div class="toolbar">
      <input id="q" class="grow gc-btn gc-btn--ghost" placeholder="üîé Buscar pa√≠s o cola‚Ä¶ (ej: Peru, 3-3)"/>
      <button id="btnProcess" class="gc-btn gc-btn--primary">‚öôÔ∏è Procesar texto</button>
      <button id="btnClear" class="gc-btn">üßπ Limpiar</button>
      <a class="gc-btn gc-btn--ghost" target="_blank" rel="noopener"
         href="https://panel.2wcall.com/queue/control/index?QueueSearch%5Bid%5D=&QueueSearch%5Bname%5D=&QueueSearch%5Bpartner_id%5D=&QueueSearch%5Bcountry_id%5D%5B0%5D=26&QueueSearch%5Bcountry_id%5D%5B1%5D=28&QueueSearch%5Bcountry_id%5D%5B2%5D=67&QueueSearch%5Bcountry_id%5D%5B3%5D=88&QueueSearch%5Bcountry_id%5D%5B4%5D=3&QueueSearch%5Bcountry_id%5D%5B5%5D=84&QueueSearch%5Bcountry_id%5D%5B6%5D=39&QueueSearch%5Bcountry_id%5D%5B7%5D=96&QueueSearch%5Bcountry_id%5D%5B8%5D=103&QueueSearch%5Bpriorities%5D=&QueueSearch%5Btype_primary%5D=&QueueSearch%5Bis_primary%5D=0&per-page=500">üîó Fuente (Panel)</a>
      <span class="u-right"></span>
      <button id="viewCountry" class="gc-btn gc-btn--primary" aria-pressed="true">Vista por pa√≠s</button>
      <button id="viewGlobal"  class="gc-btn">Vista global (3 columnas)</button>
    </div>

    <div class="legend">
      <span class="gc-chip gc-chip--dark">verde = mayor</span>
      <span class="gc-chip">rojo = menor</span>
      <span class="gc-chip">click en cabeceras para ordenar</span>
      <span class="gc-chip gc-chip--ok" id="chipAvail">Full Total (Avail): 0</span>
      <span class="gc-chip gc-chip--ok" id="chipOrders">Full Total (Orders): 0</span>
    </div>

    <div class="gc-panel">
      <h3>Entrada</h3>
      <textarea id="raw" placeholder="Pega aqu√≠ el bloque con encabezados (tabulado). Se ignoran PS y PS-Auto."></textarea>
    </div>

    <div class="gc-panel" id="out">
      <h3 id="resume">Resultados ‚Äî 0 filas ¬∑ 0 pa√≠ses</h3>
      <div id="result"></div>
    </div>
  </section>
</gc-shell>

<script>
/* ============ Config banderas ============ */
const FLAG_BY_COUNTRY = {
  "mexico":"images/flags/mx.svg",
  "colombia":"images/flags/co.svg",
  "chile":"images/flags/cl.svg",
  "peru":"images/flags/pe.svg",
  "costa rica":"images/flags/cr.svg",
  "paraguay":"images/flags/py.svg",
  "ecuador":"images/flags/ec.svg",
  "uruguay":"images/flags/uy.svg",
  "venezuela":"images/flags/ve.svg",
};

/* ================== Utils ================== */
const orderMap = {"1-1":0, "2-2":1, "3-3":2, "4-4":3, "5-2":4, "5-5":5};
function queueOrderKey(q){
  const m = /(\d)\s*-\s*(\d)/.exec(q || "");
  if (!m) return 999;
  const key = `${m[1]}-${m[2]}`;
  if (key in orderMap) return orderMap[key];
  return 500 + (+m[1])*10 + (+m[2]);
}
function clean(s){ return String(s||"").trim(); }
function numFirstInt(s){
  if (s == null) return 0;
  const m = String(s).match(/-?\d+/);
  return m ? parseInt(m[0],10) : 0;
}
function splitPipePair(s){ // "53 | 15" -> [53,15]
  const parts = String(s||"").split("|");
  const a = numFirstInt(parts[0]);
  const b = numFirstInt(parts[1]);
  return [a,b];
}
function leftOfArrow(s){ // "0 -> 11" -> 0
  return numFirstInt(s);
}
function barHTML(value, max, green=false){
  const pct = max > 0 ? Math.min(1, value/max) : 0;
  return `
    <div class="bar-wrap" title="${value}">
      <div class="bar ${green?'green':''}" style="transform:scaleX(${pct})"></div>
      <div style="position:relative;z-index:1;padding:0 6px;font-weight:700">${value}</div>
    </div>`;
}

/* ================== Parser ================== */
const COL_ALIASES = {
  country: ["country"],
  name: ["name","description"],
  ops: ["number of operators", "operators", "agents"],
  capacity: ["capacity"],
  orders: ["orders"],
  orderType: ["order type","type"]
};
function findIndexByAliases(headers, aliases){
  const lc = headers.map(h => h.toLowerCase().replace(/\s+/g," ").trim());
  for (let i=0;i<lc.length;i++){
    for (const a of aliases){
      const an = a.toLowerCase();
      if (lc[i] === an) return i;
      if (lc[i].includes(an)) return i; // relajado
    }
  }
  return -1;
}
function parseInput(txt){
  if (!txt) return [];
  const lines = txt.split(/\r?\n/).filter(l => l.trim().length);

  // detectar fila de encabezado por tener varias tabs y palabra "Country"
  let headerIdx = lines.findIndex(l => l.includes("\t") && /Country/i.test(l));
  if (headerIdx === -1) headerIdx = 0;

  const headers = lines[headerIdx].split("\t");

  const idx = {
    country : findIndexByAliases(headers, COL_ALIASES.country),
    name    : findIndexByAliases(headers, COL_ALIASES.name),
    ops     : findIndexByAliases(headers, COL_ALIASES.ops),
    capacity: findIndexByAliases(headers, COL_ALIASES.capacity),
    orders  : findIndexByAliases(headers, COL_ALIASES.orders),
    type    : findIndexByAliases(headers, COL_ALIASES.orderType),
  };

  const rows = [];
  for (let i = headerIdx + 1; i < lines.length; i++){
    const raw = lines[i];
    if (!raw.includes("\t")) continue;
    if (/^[‚ò∞=]+$/.test(raw.trim())) continue;

    const cells = raw.split("\t");

    const orderType = clean(cells[idx.type] || "");
    const name = clean(cells[idx.name] || "");

    // Ignorar PS / PS-Auto por nombre o tipo
    if (/post[- ]?sale/i.test(orderType) || /post[- ]?sale/i.test(name) || /ps[- ]?auto/i.test(name)) continue;

    // Country sin prefijo "NN. "
    const country = clean((cells[idx.country]||"").replace(/^\d+\.\s*/,""));

    const queue   = clean(name);
    const [, opsY] = splitPipePair(cells[idx.ops] || "");             // segunda parte
    const avail   = leftOfArrow(cells[idx.capacity] || "");           // izquierda de Capacity
    const total   = splitPipePair(cells[idx.orders] || "")[0];        // primera de Orders

    rows.push({ country, queue, opsY, avail, orders: total });
  }
  return rows;
}

/* ============== Transformaciones ============== */
function groupByCountry(rows){
  const map = new Map();
  for (const r of rows){
    if (!map.has(r.country)) map.set(r.country, []);
    map.get(r.country).push(r);
  }
  // ordenar colas seg√∫n key
  for (const arr of map.values()){
    arr.sort((a,b)=>{
      const ka = queueOrderKey(a.queue);
      const kb = queueOrderKey(b.queue);
      if (ka !== kb) return ka - kb;
      return a.queue.localeCompare(b.queue);
    });
  }
  return map;
}

/* ============== Render: Pa√≠s (cards) ============== */
function flagHTML(country){
  const src = FLAG_BY_COUNTRY[country.toLowerCase()];
  return src ? `<img class="flag" src="${src}" alt="${country}" onerror="this.remove()">` : "";
}
function renderCountryCards(rows){
  const root = document.getElementById("result");
  root.innerHTML = "";
  const g = groupByCountry(rows);
  const countries = [...g.keys()].sort((a,b)=> a.localeCompare(b));
  let fullAvail = 0, fullOrders = 0;

  countries.forEach(country=>{
    const items = g.get(country);
    const sumAvail = items.reduce((s,x)=> s + x.avail, 0);
    const sumOrders = items.reduce((s,x)=> s + x.orders, 0);
    fullAvail += sumAvail; fullOrders += sumOrders;

    // m√°ximos locales para barras
    const mAvail = Math.max(1, ...items.map(x=>x.avail));
    const mOrders = Math.max(1, ...items.map(x=>x.orders));

    const table = `
      <table class="country-table gc-table--compact" role="grid">
        <thead>
          <tr>
            <th>Queue</th>
            <th style="width:170px">Number of operators</th>
            <th style="width:220px">Orders available</th>
            <th style="width:220px">Total orders</th>
          </tr>
        </thead>
        <tbody>
          ${items.map(x=>`
            <tr>
              <td class="truncate" title="${x.queue}">${x.queue}</td>
              <td style="text-align:center;"><strong>${x.opsY}</strong></td>
              <td>${barHTML(x.avail,  mAvail,  false)}</td>
              <td>${barHTML(x.orders, mOrders, true)}</td>
            </tr>`).join("")}
        </tbody>
        <tfoot>
          <tr>
            <td><strong>Totales pa√≠s</strong></td>
            <td><!-- sin suma de ops --></td>
            <td>${sumAvail}</td>
            <td>${sumOrders}</td>
          </tr>
        </tfoot>
      </table>`;

    const card = document.createElement("section");
    card.className = "country-card";
    card.innerHTML = `
      <div class="country-hd">
        <span class="name">${flagHTML(country)}<span>${country}</span></span>
        <span class="pill">Queues: ${items.length}</span>
        <span class="pill">Full Total (Avail): ${sumAvail}</span>
        <span class="pill">Full Total (Orders): ${sumOrders}</span>
      </div>
      ${table}
    `;
    root.appendChild(card);
  });

  document.getElementById("chipAvail").textContent  = `Full Total (Avail): ${fullAvail}`;
  document.getElementById("chipOrders").textContent = `Full Total (Orders): ${fullOrders}`;
  document.getElementById("resume").textContent = `Resultados ‚Äî ${rows.length} filas ¬∑ ${countries.length} pa√≠ses`;
}

/* ============== Render: Global 3 columnas ============== */
function renderGlobalThreeCol(rows){
  const root = document.getElementById("result");
  root.innerHTML = "";
  const g = groupByCountry(rows);
  const countries = [...g.keys()].sort((a,b)=> a.localeCompare(b));

  const grid = document.createElement("div");
  grid.className = "global-grid";

  // m√°ximos globales para barras (para comparar entre pa√≠ses)
  const maxAvailGlobal  = Math.max(1, ...rows.map(x=>x.avail));
  const maxOrdersGlobal = Math.max(1, ...rows.map(x=>x.orders));

  let fullAvail = 0, fullOrders = 0;

  countries.forEach(country=>{
    const items = g.get(country);
    const sumAvail = items.reduce((s,x)=> s + x.avail, 0);
    const sumOrders = items.reduce((s,x)=> s + x.orders, 0);
    fullAvail += sumAvail; fullOrders += sumOrders;

    const card = document.createElement("section");
    card.className = "gcard";
    card.innerHTML = `
      <div class="ghead">
        <div class="tag">${flagHTML(country)}<span>${country.toUpperCase()}</span></div>
        <div class="title">
          <span>Queues: ${items.length}</span>
          <span class="gsmall">Avail: ${sumAvail} ¬∑ Orders: ${sumOrders}</span>
        </div>
      </div>
      <table class="gtable" role="grid">
        <thead>
          <tr>
            <th class="truncate">Queues</th>
            <th>Number of operators</th>
            <th>Orders available</th>
            <th>Total orders</th>
          </tr>
        </thead>
        <tbody>
          ${items.map(x=>`
            <tr>
              <td class="truncate" title="${x.queue}">${x.queue}</td>
              <td style="text-align:center">${x.opsY}</td>
              <td>${barHTML(x.avail,  maxAvailGlobal,  false)}</td>
              <td>${barHTML(x.orders, maxOrdersGlobal, true)}</td>
            </tr>
          `).join("")}
        </tbody>
        <tfoot>
          <tr>
            <td><strong>Totales pa√≠s</strong></td>
            <td><!-- sin suma de ops --></td>
            <td>${sumAvail}</td>
            <td>${sumOrders}</td>
          </tr>
        </tfoot>
      </table>
    `;
    grid.appendChild(card);
  });

  root.appendChild(grid);
  document.getElementById("chipAvail").textContent  = `Full Total (Avail): ${fullAvail}`;
  document.getElementById("chipOrders").textContent = `Full Total (Orders): ${fullOrders}`;
  document.getElementById("resume").textContent = `Resultados ‚Äî ${rows.length} filas ¬∑ ${countries.length} pa√≠ses`;
}

/* ============== Control / Estado ============== */
let CURRENT_ROWS = [];
let CURRENT_VIEW = "country"; // "country" | "global3"

function applyFilterAndRender(){
  const term = document.getElementById("q").value.trim().toLowerCase();
  const rows = term
    ? CURRENT_ROWS.filter(r =>
        r.country.toLowerCase().includes(term) ||
        r.queue.toLowerCase().includes(term))
    : CURRENT_ROWS.slice();

  if (CURRENT_VIEW === "country") renderCountryCards(rows);
  else renderGlobalThreeCol(rows);
}

/* ============== Bind con hook del shell ============== */
function bindUI(){
  const $ = (id)=>document.getElementById(id);

  $("btnProcess").addEventListener("click", ()=>{
    const txt = $("raw").value;
    CURRENT_ROWS = parseInput(txt);
    applyFilterAndRender();
  });
  $("btnClear").addEventListener("click", ()=>{
    $("raw").value = "";
    CURRENT_ROWS = [];
    applyFilterAndRender();
  });
  $("q").addEventListener("input", applyFilterAndRender);

  $("viewCountry").addEventListener("click", ()=>{
    CURRENT_VIEW = "country";
    $("viewCountry").setAttribute("aria-pressed","true");
    $("viewGlobal").setAttribute("aria-pressed","false");
    applyFilterAndRender();
  });
  $("viewGlobal").addEventListener("click", ()=>{
    CURRENT_VIEW = "global3";
    $("viewCountry").setAttribute("aria-pressed","false");
    $("viewGlobal").setAttribute("aria-pressed","true");
    applyFilterAndRender();
  });
}

// Importante: nos enganchamos a gcOnReady para no perder listeners
gcOnReady(bindUI);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="gc-base" content="/Gestion-Center/"><!-- el shell calcula BASE y fuerza HOME -->
  <title>Delta Report 2 ¬∑ Gesti√≥n Center</title>
  <!-- bw.css lo inyecta el shell si falta; igual cargar√° tipograf√≠as y guard -->
  <style>
    /* Solo reforzamos el heatmap de celdas num√©ricas (no tocamos la est√©tica BW) */
    td[data-h]{background:linear-gradient(90deg, rgba(56,142,60,.18) var(--h,0%), transparent 0)}
    td.badmap[data-h]{background:linear-gradient(90deg, rgba(183,28,28,.25) var(--h,0%), transparent 0)}
    .muted{color:var(--gray-700)}
    .u-gap{height:10px}
  </style>
</head>
<body>
  <!-- üåü Shell GC: sidebar + header + hero -->
  <gc-shell>
    <!-- Hero AUTO lee este t√≠tulo y oculta este h1 para evitar duplicado -->
    <h1 class="page-title">Delta Report 2</h1>

    <!-- Toolbar superior (GC) -->
    <div class="gc-panel" style="margin-top:14px;">
      <div class="gc-toolbar">
        <input id="search" class="gc-btn gc-btn--ghost" placeholder="üîé Buscar pa√≠s o cola‚Ä¶" style="width:280px; text-align:left;" />
        <button id="btnProcess" class="gc-btn gc-btn--primary">
          <span class="gc-icon">‚öôÔ∏è</span> Procesar texto
        </button>
        <button id="btnClear" class="gc-btn">
          <span class="gc-icon">üßπ</span> Limpiar
        </button>
        <div class="u-right gc-chipset">
          <span class="gc-chip">Se ignoran PS / Post-sale / PS-Auto</span>
          <span class="gc-chip">Solo 1-1, 2-2, 3-3, 4-4, 5-2, 5-5</span>
        </div>
      </div>
      <div class="u-gap"></div>
      <textarea id="raw" class="gc-panel" placeholder="Pega aqu√≠ el texto con encabezados (#, Country, Name, ‚Ä¶). Acepta TABs o espacios; separadores '‚ò∞' entre filas."
                style="width:100%; min-height:220px; white-space:pre; border:1px solid var(--gray-300);"></textarea>
    </div>

    <!-- Resultados -->
    <div id="out" class="gc-panel" style="margin-top:14px; display:none;">
      <div style="display:flex; align-items:center; gap:10px; justify-content:space-between; margin-bottom:8px;">
        <h3 style="margin:0;">Resultados <span id="resume" class="muted"></span></h3>
        <div class="gc-chipset">
          <span class="gc-chip gc-chip--dark">verde = mayor</span>
          <span class="gc-chip">rojo = menor</span>
          <span class="gc-chip">click en cabeceras para ordenar</span>
        </div>
      </div>

      <div class="gc-panel" style="padding:0;">
        <table id="tbl" class="gc-table gc-table--sticky">
          <thead>
            <tr>
              <th class="sort" data-sort="country">Country</th>
              <th class="sort" data-sort="queue">Queues</th>
              <th class="sort center" data-sort="ops"   style="text-align:center;">Number of operators</th>
              <th class="sort center" data-sort="avail" style="text-align:center;">Orders available</th>
              <th class="sort center" data-sort="total" style="text-align:center;">Total orders</th>
              <th class="sort center" data-sort="fullAvail"  style="text-align:center;">Full Total (Avail)</th>
              <th class="sort center" data-sort="fullOrders" style="text-align:center;">Full Total (Orders)</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </gc-shell>

  <!-- Shell BW (sidebar, head, guard, nav) -->
  <script type="module" src="../assets/bw/shell.js"></script>

  <!-- L√≥gica espec√≠fica de Delta Report 2 -->
  <script>
    const $  = (s,p=document)=>p.querySelector(s);
    const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));

    const rawEl   = $('#raw');
    const out     = $('#out');
    const tbody   = $('#tbody');
    const resume  = $('#resume');

    // Reglas de filtro
    const queueAllow = /(?:^|\\s)(?:1-1|2-2|3-3|4-4|5-2|5-5)(?:\\s|$)/;
    const isPS = /(\\bPS\\b|Post-sale|Post-sale_Auto|\\-PS\\b)/i;

    // Helpers
    const fmt = n => Number(n||0).toLocaleString('en-US');
    const cleanCountry = s => String(s||'').replace(/^\\d+\\.\\s*/,'').trim();
    const secondNum = s => { const m = String(s||'').match(/(\\d+)\\s*\\|\\s*(\\d+)/); return m ? parseInt(m[2],10) : 0; };
    const firstNum  = s => { const m = String(s||'').match(/(\\d+)\\s*\\|\\s*(\\d+)/); return m ? parseInt(m[1],10) : 0; };
    const firstArrow= s => { const m = String(s||'').match(/(\\d+)\\s*->\\s*\\d+/);  return m ? parseInt(m[1],10) : 0; };

    // Split flexible: TABs o 2+ espacios
    function smartSplit(line){
      return line.includes('\\t') ? line.split('\\t') : line.trim().split(/\\s{2,}/);
    }

    // Detectar header y cortar en chunks "‚ò∞"
    function findHeaderAndChunks(lines){
      const headIdx = lines.findIndex(l=>{
        const low = l.toLowerCase();
        return low.includes('country') && low.includes('name')
            && low.includes('number of operators') && low.includes('orders');
      });
      if (headIdx === -1) return { headers:[], chunks:[] };

      const headers = smartSplit(lines[headIdx]).map(h=>h.trim());

      const rest = lines.slice(headIdx+1);
      const chunks = [];
      let buf = [];
      for(const ln of rest){
        const t = ln.trim();
        if (t === '‚ò∞'){
          if (buf.length) { chunks.push(buf.join(' ')); buf = []; }
          continue;
        }
        if (t) buf.push(t);
      }
      if (buf.length) chunks.push(buf.join(' '));

      return { headers, chunks };
    }

    function parseRows(){
      const text = rawEl.value.replace(/\\r/g,'').trim();
      if(!text) return [];

      const all   = text.split(/\\n/).map(l=>l.replace(/\\s+$/,''));
      const lines = all.filter(l=>l.trim() || l.trim()==='‚ò∞');

      const { headers, chunks } = findHeaderAndChunks(lines);
      if (!headers.length || !chunks.length) return [];

      const idx = (name) => headers.findIndex(h => h.toLowerCase() === name.toLowerCase());

      const iCountry = idx('Country');
      const iName    = idx('Name');
      const iOps     = idx('Number of operators');
      const iOrders  = idx('Orders');
      const iCap     = idx('Capacity');

      if ([iCountry,iName,iOps,iOrders,iCap].some(v => v === -1)) return [];

      const rows = [];
      for(const ch of chunks){
        const cols = smartSplit(ch);

        const name = (cols[iName] || '').trim();
        if (!name) continue;
        if (isPS.test(name)) continue;
        if (!queueAllow.test(name)) continue;

        const country = cleanCountry(cols[iCountry] || '');
        const ops     = secondNum(cols[iOps] || '');     // 2¬∫ de "X | Y"
        const avail   = firstArrow(cols[iCap] || '');    // 1¬∫ de "a -> b" (Capacity)
        const total   = firstNum (cols[iOrders] || '');  // 1¬∫ de "A | B" (Orders)

        rows.push({ country, queue:name, ops, avail, total });
      }
      return rows;
    }

    function groupByCountry(rows){
      const map = new Map();
      for (const r of rows){
        if (!map.has(r.country)) map.set(r.country, {country:r.country, rows:[], fullAvail:0, fullOrders:0});
        const g = map.get(r.country);
        g.rows.push(r);
        g.fullAvail  += r.avail;
        g.fullOrders += r.total;
      }
      // Orden default: por Full Orders desc
      return Array.from(map.values()).sort((a,b)=>b.fullOrders-a.fullOrders);
    }

    function render(rows){
      const groups = groupByCountry(rows);
      const allOps  = rows.map(r=>r.ops);
      const allAvail= rows.map(r=>r.avail);
      const allTotal= rows.map(r=>r.total);
      const mm=a=>({min:Math.min(...a,0),max:Math.max(...a,1)});
      const mmOps=mm(allOps), mmAvail=mm(allAvail), mmTotal=mm(allTotal);
      const scale=(v,{min,max})=> max===min?0:Math.round(((v-min)/(max-min))*100);

      tbody.innerHTML='';
      for (const g of groups){
        for(const r of g.rows){
          const tr=document.createElement('tr');
          tr.innerHTML = `
            <td>${g.country}</td>
            <td>${r.queue}</td>
            <td style="text-align:center" data-h style="--h:${scale(r.ops,mmOps)}%">${fmt(r.ops)}</td>
            <td class="badmap" style="text-align:center" data-h style="--h:${scale(r.avail,mmAvail)}%">${fmt(r.avail)}</td>
            <td style="text-align:center" data-h style="--h:${scale(r.total,mmTotal)}%">${fmt(r.total)}</td>
            <td style="text-align:center" class="muted">${fmt(g.fullAvail)}</td>
            <td style="text-align:center" class="muted">${fmt(g.fullOrders)}</td>`;
          tbody.appendChild(tr);
        }
      }
      out.style.display='';
      resume.textContent = `‚Äî ${rows.length} filas ¬∑ ${new Set(rows.map(r=>r.country)).size} pa√≠ses`;
    }

    // Ordenamiento + b√∫squeda
    let sortKey=null, sortDir=1;
    $$('#tbl thead th.sort').forEach(th=>{
      th.addEventListener('click', ()=>{
        const key = th.dataset.sort;
        sortDir = (sortKey===key) ? -sortDir : 1; sortKey=key;
        const rows = parseRows();

        // Columnas agregadas por pa√≠s
        if (key==='fullAvail' || key==='fullOrders'){
          const groups = groupByCountry(rows);
          groups.sort((a,b)=> ((key==='fullAvail'? (a.fullAvail-b.fullAvail) : (a.fullOrders-b.fullOrders)) * sortDir));
          const ordered = [];
          for(const g of groups) ordered.push(...g.rows);
          render(ordered);
          return;
        }

        // Columnas de fila
        rows.sort((a,b)=>{
          const A = key==='country'? a.country.localeCompare(b.country)
                  : key==='queue' ? a.queue.localeCompare(b.queue)
                  : key==='ops'   ? a.ops
                  : key==='avail' ? a.avail
                  : key==='total' ? a.total : 0;
          const B = key==='country'? b.country.localeCompare(a.country)
                  : key==='queue' ? b.queue.localeCompare(a.queue)
                  : key==='ops'   ? b.ops
                  : key==='avail' ? b.avail
                  : key==='total' ? b.total : 0;
          return (A-B)*sortDir;
        });
        render(rows);
      });
    });

    $('#search').addEventListener('input', e=>{
      const q = e.target.value.toLowerCase().trim();
      const rows = parseRows().filter(r =>
        r.country.toLowerCase().includes(q) || r.queue.toLowerCase().includes(q)
      );
      render(rows);
    });

    $('#btnProcess').addEventListener('click', ()=> render(parseRows()));
    $('#btnClear').addEventListener('click', ()=>{
      rawEl.value=''; out.style.display='none'; $('#search').value='';
    });
  </script>
</body>
</html>

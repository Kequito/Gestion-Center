<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Delta Report 2</title>
  <!-- El shell inyecta bw.css y tipograf√≠as -->
  <meta name="gc-base" content="/Gestion-Center/"/>
  <style>
    /* ======= Estilos locales del reporte ======= */
    .gc-toolbar{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:10px }
    .gc-input{
      display:flex; align-items:center; gap:8px; border:1px solid var(--gray-300);
      border-radius:12px; padding:10px 12px; min-width:320px; background:var(--white)
    }
    .gc-input input{ border:0; outline:0; width:100%; font:inherit }
    .gc-chipset{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px }
    .gc-chip{ border:1px solid var(--gray-300); border-radius:999px; padding:6px 10px; font-weight:700; background:var(--white) }
    .gc-chip--dark{ background:#000; color:#fff; border-color:#000 }
    .gc-btn{ appearance:none; border:1px solid var(--gray-300); background:#fff; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer }
    .gc-btn--primary{ background:#000; color:#fff; border-color:#000 }
    .gc-btn[aria-pressed="true"]{ background:#000; color:#fff; border-color:#000 }
    .gc-btn:active{ transform:translateY(1px) }

    textarea.textmono{
      width:100%; min-height:220px; resize:vertical;
      border:1px solid var(--gray-300); border-radius:12px; padding:12px;
      background:#fff; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      line-height:1.25; white-space:pre; overflow:auto;
    }

    /* Barras */
    .bar-wrap{
      position:relative; height:28px; border:1px solid var(--gray-200);
      border-radius:10px; overflow:hidden; background:#fff; display:flex; align-items:center;
    }
    .bar{
      position:absolute; inset:0 auto 0 0; width:100%;
      background:#f3b3b3; transform-origin:left center; transform:scaleX(0);
    }
    .bar.green{ background:#cfe9cf }

    /* Cards por Pa√≠s */
    .country-card{ border:1px solid var(--gray-300); border-radius:12px; background:#fff; margin:12px 0 }
    .country-hd{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      padding:10px 12px; border-bottom:1px solid var(--gray-200); background:var(--gray-100);
      border-top-left-radius:12px; border-top-right-radius:12px;
    }
    .country-hd .name{ font-weight:900 }
    .pill{ border:1px solid var(--gray-300); border-radius:999px; padding:4px 10px; font-size:12px; background:#fff; font-weight:700 }
    .country-table{ width:100%; border-collapse:separate; border-spacing:0 }
    .country-table thead th{
      background:#000; color:#fff; padding:10px 12px; text-align:left;
    }
    .country-table td{ border-bottom:1px solid var(--gray-200); padding:10px 12px }
    .country-table tfoot td{ background:var(--gray-100); font-weight:800; }

    /* Vista global 2 columnas */
    .global-grid{
      display:grid; grid-template-columns:repeat(2, minmax(420px,1fr)); gap:14px;
    }
    @media (max-width:1200px){ .global-grid{ grid-template-columns:1fr } }
    .gcard{ border:1px solid var(--gray-300); border-radius:12px; background:#fff; overflow:hidden }
    .ghead{ display:flex; gap:12px; align-items:center; padding:10px; background:var(--gray-100) }
    .ghead .tag{
      min-width:140px; padding:10px; border-radius:10px; text-align:center; font-weight:900; background:#e5e7eb;
    }
    .ghead .title{ display:flex; flex-direction:column; gap:4px; font-weight:800 }
    .ghead .gsmall{ font-weight:700; color:var(--gray-700); font-size:12px }
    .gtable{ width:100%; border-collapse:separate; border-spacing:0 }
    .gtable thead th{ background:#000; color:#fff; padding:8px 10px; text-align:left }
    .gtable td{ padding:8px 10px; border-bottom:1px solid var(--gray-200) }
    .gtable tfoot td{ background:var(--gray-100); font-weight:800 }
  </style>
</head>
<body>
  <gc-shell hero-title="Delta Report 2" hero-subtitle="Datos en formato GC ‚Äî ignora PS y PS-Auto">
    <section class="gc-panel" style="margin-top:14px">
      <!-- Toolbar -->
      <div class="gc-toolbar">
        <label class="gc-input" title="Buscar">
          <span>üîé</span>
          <input id="q" type="search" placeholder="Buscar pa√≠s o cola... (ej: Peru, 3-3)"/>
        </label>

        <button id="btnProcess" class="gc-btn gc-btn--primary">‚ñ∂Ô∏è Procesar texto</button>
        <button id="btnClear" class="gc-btn">üßπ Limpiar</button>

        <a id="btnSource" class="gc-btn" target="_blank" rel="noopener"
           href="https://panel.2wcall.com/queue/control/index?QueueSearch%5Bid%5D=&QueueSearch%5Bname%5D=&QueueSearch%5Bpartner_id%5D=&QueueSearch%5Bcountry_id%5D%5B0%5D=26&QueueSearch%5Bcountry_id%5D%5B1%5D=28&QueueSearch%5Bcountry_id%5D%5B2%5D=67&QueueSearch%5Bcountry_id%5D%5B3%5D=88&QueueSearch%5Bcountry_id%5D%5B4%5D=3&QueueSearch%5Bcountry_id%5D%5B5%5D=84&QueueSearch%5Bcountry_id%5D%5B6%5D=39&QueueSearch%5Bcountry_id%5D%5B7%5D=96&QueueSearch%5Bcountry_id%5D%5B8%5D=103&QueueSearch%5Bpriorities%5D=&QueueSearch%5Btype_primary%5D=&QueueSearch%5Bis_primary%5D=0&per-page=500">üîó Fuente (Panel)</a>

        <button id="viewCountry" class="gc-btn" aria-pressed="true">Vista por pa√≠s</button>
        <button id="viewGlobal"  class="gc-btn">Vista global (2 columnas)</button>

        <span class="u-right"></span>
      </div>

      <!-- Chips -->
      <div class="gc-chipset">
        <span class="gc-chip gc-chip--dark">verde = mayor</span>
        <span class="gc-chip">rojo = menor</span>
        <span class="gc-chip">click en cabeceras para ordenar</span>
        <span id="chipAvail" class="gc-chip">Full Total (Avail): 0</span>
        <span id="chipOrders" class="gc-chip">Full Total (Orders): 0</span>
      </div>

      <!-- Entrada -->
      <h3 style="margin:8px 0">Entrada</h3>
      <textarea id="raw" class="textmono" spellcheck="false"
        placeholder="Pega el bloque tal como lo copia el sistema (con encabezados). Se ignoran PS y PS-Auto."></textarea>

      <!-- Resultados -->
      <h3 id="resume" style="margin:16px 0 8px">Resultados ‚Äî 0 filas ¬∑ 0 pa√≠ses</h3>
      <div id="result"></div>
    </section>
  </gc-shell>

  <script>
  /* ================== Utils ================== */
  const orderMap = {"1-1":0, "2-2":1, "3-3":2, "4-4":3, "5-2":4, "5-5":5};
  function queueOrderKey(q){
    const m = /(\d)\s*-\s*(\d)/.exec(q || "");
    if (!m) return 999;
    const key = `${m[1]}-${m[2]}`;
    if (key in orderMap) return orderMap[key];
    return 500 + (+m[1])*10 + (+m[2]);
  }
  function clean(s){ return String(s||"").trim(); }
  function num(s){ const m = String(s??"").match(/-?\d+/g); return m ? parseInt(m[0],10) : 0; }
  function splitPair(s){ const p=String(s||"").split("|"); return [num(p[0]), num(p[1])]; }
  function leftOfArrow(s){ const m = String(s||"").match(/-?\d+/); return m?parseInt(m[0],10):0; }
  function barHTML(value,max,green=false){
    const pct = max>0 ? Math.min(1, value/max) : 0;
    return `<div class="bar-wrap" title="${value}">
      <div class="bar ${green?'green':''}" style="transform:scaleX(${pct})"></div>
      <div style="position:relative;z-index:1;padding:0 6px;font-weight:700">${value}</div>
    </div>`;
  }

  /* ================== Parser ================== */
  function parseInput(txt){
    if (!txt) return [];
    const lines = txt.split(/\r?\n/).filter(l => l.trim().length);
    let headerIdx = lines.findIndex(l => l.includes("\t") && /Country/i.test(l));
    if (headerIdx === -1) headerIdx = 0;
    const headers = lines[headerIdx].split("\t").map(h => h.trim());
    const out = [];

    for (let i = headerIdx + 1; i < lines.length; i++){
      const line = lines[i];
      if (!line || !line.includes("\t")) continue;
      if (/^[‚ò∞=]+$/.test(line.trim())) continue;

      const cells = line.split("\t");
      const m = Object.create(null);
      headers.forEach((h,idx)=> m[h] = cells[idx]);

      // Excluir Post-sale y PS-Auto
      const name = clean(m["Name"] || m["Description"] || "");
      if (/post[- ]?sale/i.test(m["Order type"] || "") || /post[- ]?sale/i.test(name) || /PS[- ]?Auto/i.test(name)) continue;

      const country = clean((m["Country"] || "").replace(/^\d+\.\s*/,""));
      const queue   = clean(name);
      const [, opsY] = splitPair(m["Number of operators"] || "");
      const avail   = leftOfArrow(m["Capacity"] || "");
      const orders  = (m["Orders"] || "").split("|")[0] || "0";
      const ordersN = num(orders);

      out.push({ country, queue, opsY, avail, orders: ordersN });
    }
    return out;
  }

  /* ============== Transformaciones ============== */
  function groupByCountry(rows){
    const map = new Map();
    for (const r of rows){ if(!map.has(r.country)) map.set(r.country, []); map.get(r.country).push(r); }
    for (const arr of map.values()){
      arr.sort((a,b)=> {
        const ka=queueOrderKey(a.queue), kb=queueOrderKey(b.queue);
        return ka===kb ? a.queue.localeCompare(b.queue) : ka-kb;
      });
    }
    return map;
  }

  /* ============== Render: Pa√≠s (cards) ============== */
  function barOps(y){
    return `<div class="bar-wrap"><div class="bar green" style="transform:scaleX(0)"></div>
            <div style="position:relative;z-index:1;padding:0 6px;font-weight:700">${y}</div></div>`;
  }
  function renderCountryCards(rows){
    const root = document.getElementById("result"); root.innerHTML = "";
    const g = groupByCountry(rows); const countries = [...g.keys()].sort((a,b)=>a.localeCompare(b));
    let fullAvail=0, fullOrders=0;

    countries.forEach(cty=>{
      const items = g.get(cty);
      const sumA = items.reduce((s,x)=>s+x.avail,0);
      const sumO = items.reduce((s,x)=>s+x.orders,0);
      fullAvail += sumA; fullOrders += sumO;
      const mA = Math.max(1,...items.map(x=>x.avail));
      const mO = Math.max(1,...items.map(x=>x.orders));

      const html = `
        <section class="country-card">
          <div class="country-hd">
            <span class="name">${cty}</span>
            <span class="pill">Queues: ${items.length}</span>
            <span class="pill">Full Total (Avail): ${sumA}</span>
            <span class="pill">Full Total (Orders): ${sumO}</span>
          </div>
          <table class="country-table">
            <thead>
              <tr><th>Queue</th><th style="width:170px">Operators (Y)</th>
                  <th style="width:220px">Orders available</th>
                  <th style="width:220px">Total orders</th></tr>
            </thead>
            <tbody>
              ${items.map(x=>`
                <tr>
                  <td>${x.queue}</td>
                  <td>${barOps(x.opsY)}</td>
                  <td>${barHTML(x.avail,mA,false)}</td>
                  <td>${barHTML(x.orders,mO,true)}</td>
                </tr>`).join("")}
            </tbody>
            <tfoot><tr><td><strong>Totales pa√≠s</strong></td><td></td><td>${sumA}</td><td>${sumO}</td></tr></tfoot>
          </table>
        </section>`;
      root.insertAdjacentHTML("beforeend", html);
    });

    document.getElementById("chipAvail").textContent  = `Full Total (Avail): ${fullAvail}`;
    document.getElementById("chipOrders").textContent = `Full Total (Orders): ${fullOrders}`;
    document.getElementById("resume").textContent     = `Resultados ‚Äî ${rows.length} filas ¬∑ ${countries.length} pa√≠ses`;
  }

  /* ============== Render: Global 2 columnas ============== */
  function renderGlobalTwoCol(rows){
    const root = document.getElementById("result"); root.innerHTML = "";
    const g = groupByCountry(rows); const countries = [...g.keys()].sort((a,b)=>a.localeCompare(b));
    let fullAvail=0, fullOrders=0;
    const grid = document.createElement("div"); grid.className = "global-grid";
    const maxA = Math.max(1, ...rows.map(x=>x.avail)); const maxO = Math.max(1, ...rows.map(x=>x.orders));

    countries.forEach(cty=>{
      const items = g.get(cty);
      const sumA = items.reduce((s,x)=>s+x.avail,0);
      const sumO = items.reduce((s,x)=>s+x.orders,0);
      fullAvail+=sumA; fullOrders+=sumO;

      grid.insertAdjacentHTML("beforeend", `
        <section class="gcard">
          <div class="ghead">
            <div class="tag">${cty.toUpperCase()}</div>
            <div class="title"><span>Queues: ${items.length}</span>
              <span class="gsmall">Avail: ${sumA} ¬∑ Orders: ${sumO}</span></div>
          </div>
          <table class="gtable">
            <thead><tr>
              <th>Queues</th><th style="width:110px">Number of operators</th>
              <th style="width:160px">Orders available</th>
              <th style="width:160px">Total orders</th></tr></thead>
            <tbody>
              ${items.map(x=>`
                <tr>
                  <td>${x.queue}</td>
                  <td style="text-align:center">${x.opsY}</td>
                  <td>${barHTML(x.avail,maxA,false)}</td>
                  <td>${barHTML(x.orders,maxO,true)}</td>
                </tr>`).join("")}
            </tbody>
            <tfoot><tr><td><strong>Totales pa√≠s</strong></td><td></td><td>${sumA}</td><td>${sumO}</td></tr></tfoot>
          </table>
        </section>`);
    });

    root.appendChild(grid);
    document.getElementById("chipAvail").textContent  = `Full Total (Avail): ${fullAvail}`;
    document.getElementById("chipOrders").textContent = `Full Total (Orders): ${fullOrders}`;
    document.getElementById("resume").textContent     = `Resultados ‚Äî ${rows.length} filas ¬∑ ${countries.length} pa√≠ses`;
  }

  /* ============== Control / Estado (DELEGACI√ìN) ============== */
  let CURRENT_ROWS = [];
  let CURRENT_VIEW = "country";

  function applyFilterAndRender(){
    const term = (document.getElementById("q")?.value || "").trim().toLowerCase();
    const data = term ? CURRENT_ROWS.filter(r =>
        r.country.toLowerCase().includes(term) || r.queue.toLowerCase().includes(term)
      ) : CURRENT_ROWS;
    (CURRENT_VIEW === "country" ? renderCountryCards : renderGlobalTwoCol)(data);
  }

  // Delegaci√≥n segura para funcionar dentro del shell
  document.addEventListener("click", (ev)=>{
    const btnProc   = ev.target.closest("#btnProcess");
    const btnClear  = ev.target.closest("#btnClear");
    const btnVC     = ev.target.closest("#viewCountry");
    const btnVG     = ev.target.closest("#viewGlobal");
    if (btnProc){
      const txt = document.getElementById("raw")?.value || "";
      CURRENT_ROWS = parseInput(txt);
      applyFilterAndRender();
    } else if (btnClear){
      const ta = document.getElementById("raw"); if (ta) ta.value = "";
      CURRENT_ROWS = []; applyFilterAndRender();
    } else if (btnVC){
      CURRENT_VIEW = "country";
      document.getElementById("viewCountry")?.setAttribute("aria-pressed","true");
      document.getElementById("viewGlobal")?.setAttribute("aria-pressed","false");
      applyFilterAndRender();
    } else if (btnVG){
      CURRENT_VIEW = "global2";
      document.getElementById("viewCountry")?.setAttribute("aria-pressed","false");
      document.getElementById("viewGlobal")?.setAttribute("aria-pressed","true");
      applyFilterAndRender();
    }
  });

  document.addEventListener("input", (ev)=>{
    if (ev.target && ev.target.id === "q") applyFilterAndRender();
  });

  window.addEventListener("load", ()=> applyFilterAndRender());
  </script>
</body>
</html>

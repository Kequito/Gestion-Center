<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="gc-base" content="/Gestion-Center/"/>
  <title>Delta Report 2</title>
  <script defer src="../assets/bw/shell.js"></script>
  <style>
    /* ---- Ajustes propios de la p√°gina ---- */
    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:10px 0 12px }
    .toolbar .grow{ flex:1 1 320px }
    .gc-panel h3{ margin:0 0 8px }

    textarea#raw{ width:100%; min-height:220px; resize:vertical; font-family:ui-monospace,Menlo,Consolas,monospace }

    /* Chips info */
    .legend{ display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 }
    .legend .gc-chip--ok{ background:#10b981; border-color:#10b981; color:#fff }

    /* Barras en celdas */
    .bar-wrap{ position:relative; height:22px; background:#f3f4f6; border-radius:6px; overflow:hidden }
    .bar{ position:absolute; inset:0 0 0 0; transform-origin:left center; background:#ef4444; opacity:.25 }
    .bar.green{ background:#10b981; opacity:.25 }

    /* ===== Vista "Por pa√≠s" (cards) ===== */
    .country-card{ border:1px solid var(--gray-300); border-radius:12px; overflow:hidden; margin-bottom:14px; background:#fff }
    .country-hd{
      background:#000; color:#fff; padding:8px 12px; display:flex; align-items:center; gap:10px; flex-wrap:wrap
    }
    .flag{ width:18px; height:12px; border-radius:2px; box-shadow:0 0 0 1px rgba(255,255,255,.5) }
    .country-hd .name{ font-weight:800; text-transform:capitalize; display:flex; align-items:center; gap:8px }
    .country-hd .pill{ background:#111; border:1px solid #222; border-radius:999px; padding:4px 8px; font-weight:700 }
    .country-table{ width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed }
    .country-table th, .country-table td{ padding:10px 12px; border-bottom:1px solid var(--gray-200) }
    .country-table thead th{ background:#000; color:#fff; text-align:left }
    .country-table tfoot td{ font-weight:800; background:var(--gray-100) }

    /* ===== Vista global 3 columnas (tarjetas iguales) ===== */
    .global-grid{
      display:grid; gap:14px;
      grid-template-columns:repeat(3, minmax(280px, 1fr));
    }
    @media (max-width:1400px){ .global-grid{ grid-template-columns:repeat(2, minmax(320px,1fr)) } }
    @media (max-width:900px){ .global-grid{ grid-template-columns:1fr } }

    .gcard{ border:1px solid var(--gray-300); border-radius:12px; overflow:hidden; background:#fff; display:flex; flex-direction:column; min-height: 260px; }
    .ghead{
      display:grid; grid-template-columns:110px 1fr; align-items:stretch; min-height:48px;
    }
    .ghead .tag{
      display:flex; align-items:center; justify-content:center; gap:6px;
      font-weight:900; font-size:13px; color:#111; text-transform:uppercase;
      background:linear-gradient(180deg,#e5e7eb,#cbd5e1);
      border-right:1px solid var(--gray-300);
      padding:8px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis; /* evita "deformar" por nombres largos */
    }
    .ghead .title{
      background:#000; color:#fff; padding:8px 12px; font-weight:800;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .gsmall{ font-size:12px; opacity:.8; white-space:nowrap }

    .gtable{ width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; }
    .gtable th,.gtable td{ padding:8px 10px; border-bottom:1px solid var(--gray-200) }
    .gtable thead th{ background:#000; color:#fff; font-size:12px }
    .gtable tfoot td{ background:var(--gray-100); font-weight:800 }
    .gtable td:first-child { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; } /* colas largas sin romper tarjeta */

    /* Bot√≥n activo negro (no ‚Äúse vuelve blanco‚Äù) heredando GC */
    .gc-btn--primary[aria-pressed="true"]{
      filter:brightness(1.05); outline:2px solid var(--black)
    }
  </style>
</head>
<body>
<gc-shell hero-title="Delta Report 2" hero-subtitle="Deltas en formato GC ‚Äî ignora PS y PS-Auto">
  <section class="gc-panel">
    <div class="toolbar">
      <input id="q" class="grow gc-btn gc-btn--ghost" placeholder="üîé Buscar pa√≠s o cola‚Ä¶ (ej: Peru, 3-3)"/>
      <button id="btnProcess" type="button" class="gc-btn gc-btn--primary">‚öôÔ∏è Procesar texto</button>
      <button id="btnClear" type="button" class="gc-btn">üßπ Limpiar</button>
      <a class="gc-btn gc-btn--ghost" target="_blank" rel="noopener"
         href="https://panel.2wcall.com/queue/control/index?QueueSearch%5Bid%5D=&QueueSearch%5Bname%5D=&QueueSearch%5Bpartner_id%5D=&QueueSearch%5Bcountry_id%5D%5B0%5D=26&QueueSearch%5Bcountry_id%5D%5B1%5D=28&QueueSearch%5Bcountry_id%5D%5B2%5D=67&QueueSearch%5Bcountry_id%5D%5B3%5D=88&QueueSearch%5Bcountry_id%5D%5B4%5D=3&QueueSearch%5Bcountry_id%5D%5B5%5D=84&QueueSearch%5Bcountry_id%5D%5B6%5D=39&QueueSearch%5Bcountry_id%5D%5B7%5D=96&QueueSearch%5Bcountry_id%5D%5B8%5D=103&QueueSearch%5Bpriorities%5D=&QueueSearch%5Btype_primary%5D=&QueueSearch%5Bis_primary%5D=0&per-page=500">üîó Fuente (Panel)</a>
      <span class="u-right"></span>
      <button id="viewCountry" type="button" class="gc-btn gc-btn--primary" aria-pressed="true">Vista por pa√≠s</button>
      <button id="viewGlobal"  type="button" class="gc-btn">Vista global (3 columnas)</button>
    </div>

    <div class="legend">
      <span class="gc-chip gc-chip--dark">verde = mayor</span>
      <span class="gc-chip">rojo = menor</span>
      <span class="gc-chip">click en cabeceras para ordenar</span>
      <span class="gc-chip gc-chip--ok" id="chipAvail">Full Total (Avail): 0</span>
      <span class="gc-chip gc-chip--ok" id="chipOrders">Full Total (Orders): 0</span>
    </div>

    <div class="gc-panel">
      <h3>Entrada</h3>
      <textarea id="raw" placeholder="Pega aqu√≠ el bloque con encabezados (tabulado). Se ignoran PS y PS-Auto."></textarea>
    </div>

    <div class="gc-panel" id="out">
      <h3 id="resume">Resultados ‚Äî 0 filas ¬∑ 0 pa√≠ses</h3>
      <div id="result"></div>
    </div>
  </section>
</gc-shell>

<script>
/* ================== Utils ================== */
const orderMap = {"1-1":0, "2-2":1, "3-3":2, "4-4":3, "5-2":4, "5-5":5};
function queueOrderKey(q){
  const m = /(\d)\s*-\s*(\d)/.exec(q || "");
  if (!m) return 999;
  const key = `${m[1]}-${m[2]}`;
  if (key in orderMap) return orderMap[key];
  return 500 + (+m[1])*10 + (+m[2]);
}
const FLAG = {
  "mexico":"mx","colombia":"co","costa rica":"cr","ecuador":"ec","peru":"pe","paraguay":"py",
  "uruguay":"uy","venezuela":"ve","chile":"cl"
};
function flagUrl(country){
  const code = FLAG[(country||"").toLowerCase()] || "xx";
  return `https://flagcdn.com/w20/${code}.png`;
}
function clean(s){ return String(s||"").trim(); }
function numFirst(s){
  const m = String(s||"").match(/-?\d+/);
  return m ? parseInt(m[0],10) : 0;
}
function splitFirstPipe(s){ // "11 | 0" -> 11
  const m = String(s||"").split("|");
  return m.length ? numFirst(m[0]) : 0;
}
function rightPipe(s){ // "17 | 4" -> 4
  const m = String(s||"").split("|");
  return m.length > 1 ? numFirst(m[1]) : 0;
}
function capacityLeft(s){ // "0 -> 11" -> 0
  return numFirst(s);
}

/* ============ header resolver (tolerante a variaciones) ============ */
const ALIAS = {
  country: [/^country$/i],
  name: [/^name$/i, /^description$/i],
  numops: [/^number of operators$/i],
  capacity: [/^capacity$/i],
  orders: [/^orders$/i],
  ordertype: [/^order type$/i]
};
function findIdx(headers, aliasArr){
  const idx = headers.findIndex(h => aliasArr.some(rx => rx.test(h)));
  return idx >= 0 ? idx : -1;
}

/* ================== Parser ================== */
function parseInput(txt){
  if (!txt) return [];
  const lines = txt.split(/\r?\n/).filter(l => l.trim().length);
  let headerIdx = lines.findIndex(l => l.includes("\t") && /country/i.test(l));
  if (headerIdx === -1) headerIdx = 0;

  const headersRaw = lines[headerIdx].split("\t");
  const headers = headersRaw.map(h => h.trim());

  const idxCountry  = findIdx(headers, ALIAS.country);
  const idxName     = findIdx(headers, ALIAS.name);
  const idxOps      = findIdx(headers, ALIAS.numops);
  const idxCapacity = findIdx(headers, ALIAS.capacity);
  const idxOrders   = findIdx(headers, ALIAS.orders);
  const idxType     = findIdx(headers, ALIAS.ordertype);

  const rows = [];
  for (let i = headerIdx + 1; i < lines.length; i++){
    let line = lines[i];
    if (!line || !line.includes("\t")) continue;
    if (/^[‚ò∞=]+$/.test(line.trim())) continue;

    const cells = line.split("\t");
    const val = (idx) => (idx >= 0 ? cells[idx] : "");

    const countryRaw = clean(val(idxCountry)).replace(/^\d+\.\s*/,"");
    const queueName  = clean(val(idxName)) || "";
    const typeStr    = clean(val(idxType));

    // Ignorar PS / Post-sale / PS-Auto en cualquier campo relevante
    const sAll = `${queueName} ${typeStr}`.toLowerCase();
    if (/(^|\W)(ps(-auto)?|post[-\s]?sale(_auto)?)/i.test(sAll)) continue;

    // Lectura EXACTA solicitada:
    // - Operators(Y): segundo n√∫mero de "Number of operators"
    // - Orders available: n√∫mero izquierdo de Capacity (a -> b  ‚áí a)
    // - Total orders: primer n√∫mero de Orders (a | b ‚áí a)
    const opsY   = rightPipe(val(idxOps));
    const avail  = capacityLeft(val(idxCapacity));
    const orders = splitFirstPipe(val(idxOrders));

    if (!countryRaw || !queueName) continue;

    rows.push({
      country: countryRaw,
      queue: queueName,
      opsY, avail, orders
    });
  }
  return rows;
}

/* ============== Transformaciones ============== */
function groupByCountry(rows){
  const map = new Map();
  for (const r of rows){
    if (!map.has(r.country)) map.set(r.country, []);
    map.get(r.country).push(r);
  }
  for (const arr of map.values()){
    arr.sort((a,b)=>{
      const ka = queueOrderKey(a.queue);
      const kb = queueOrderKey(b.queue);
      if (ka !== kb) return ka - kb;
      return a.queue.localeCompare(b.queue);
    });
  }
  return map;
}
function barHTML(value, max, green=false){
  const pct = max > 0 ? Math.min(1, value/max) : 0;
  return `
    <div class="bar-wrap" title="${value}">
      <div class="bar ${green?'green':''}" style="transform:scaleX(${pct})"></div>
      <div style="position:relative;z-index:1;padding:0 6px;font-weight:700">${value}</div>
    </div>`;
}

/* ============== Render: Pa√≠s (cards) ============== */
function renderCountryCards(rows){
  const root = document.getElementById("result");
  root.innerHTML = "";
  const g = groupByCountry(rows);
  const countries = [...g.keys()].sort((a,b)=> a.localeCompare(b));
  let fullAvail = 0, fullOrders = 0;

  countries.forEach(country=>{
    const items = g.get(country);
    const sumAvail = items.reduce((s,x)=> s + x.avail, 0);
    const sumOrders = items.reduce((s,x)=> s + x.orders, 0);
    fullAvail += sumAvail; fullOrders += sumOrders;

    const mAvail = Math.max(1, ...items.map(x=>x.avail));
    const mOrders = Math.max(1, ...items.map(x=>x.orders));

    const table = `
      <table class="country-table gc-table--compact" role="grid">
        <thead>
          <tr>
            <th style="width:34%">Queues</th>
            <th style="width:18%">Number of operators</th>
            <th style="width:24%">Orders available</th>
            <th style="width:24%">Total orders</th>
          </tr>
        </thead>
        <tbody>
          ${items.map(x=>`
            <tr>
              <td title="${x.queue}">${x.queue}</td>
              <td style="text-align:center;font-weight:800">${x.opsY}</td>
              <td>${barHTML(x.avail,  mAvail,  false)}</td>
              <td>${barHTML(x.orders, mOrders, true)}</td>
            </tr>`).join("")}
        </tbody>
        <tfoot>
          <tr>
            <td><strong>Totales pa√≠s</strong></td>
            <td><!-- sin suma de ops --></td>
            <td>${sumAvail}</td>
            <td>${sumOrders}</td>
          </tr>
        </tfoot>
      </table>`;

    const card = document.createElement("section");
    card.className = "country-card";
    card.innerHTML = `
      <div class="country-hd">
        <span class="name"><img class="flag" src="${flagUrl(country)}" alt=""> ${country}</span>
        <span class="pill">Queues: ${items.length}</span>
        <span class="pill">Avail: ${sumAvail}</span>
        <span class="pill">Orders: ${sumOrders}</span>
      </div>
      ${table}
    `;
    root.appendChild(card);
  });

  document.getElementById("chipAvail").textContent  = `Full Total (Avail): ${fullAvail}`;
  document.getElementById("chipOrders").textContent = `Full Total (Orders): ${fullOrders}`;
  document.getElementById("resume").textContent = `Resultados ‚Äî ${rows.length} filas ¬∑ ${countries.length} pa√≠ses`;
}

/* ============== Render: Global (3 columnas, tarjetas iguales) ============== */
function renderGlobalThreeCol(rows){
  const root = document.getElementById("result");
  root.innerHTML = "";
  const g = groupByCountry(rows);
  const countries = [...g.keys()].sort((a,b)=> a.localeCompare(b));
  let fullAvail = 0, fullOrders = 0;

  const grid = document.createElement("div");
  grid.className = "global-grid";

  const maxAvailGlobal  = Math.max(1, ...rows.map(x=>x.avail));
  const maxOrdersGlobal = Math.max(1, ...rows.map(x=>x.orders));

  countries.forEach(country=>{
    const items = g.get(country);
    const sumAvail = items.reduce((s,x)=> s + x.avail, 0);
    const sumOrders = items.reduce((s,x)=> s + x.orders, 0);
    fullAvail += sumAvail; fullOrders += sumOrders;

    const card = document.createElement("section");
    card.className = "gcard";
    card.innerHTML = `
      <div class="ghead">
        <div class="tag"><img class="flag" src="${flagUrl(country)}" alt=""> ${country}</div>
        <div class="title">
          <span>Queues: ${items.length}</span>
          <span class="gsmall">Avail: ${sumAvail} ¬∑ Orders: ${sumOrders}</span>
        </div>
      </div>
      <table class="gtable" role="grid">
        <thead>
          <tr>
            <th>Queues</th>
            <th style="width:110px">Num. operators</th>
            <th style="width:160px">Orders available</th>
            <th style="width:160px">Total orders</th>
          </tr>
        </thead>
        <tbody>
          ${items.map(x=>`
            <tr>
              <td title="${x.queue}">${x.queue}</td>
              <td style="text-align:center">${x.opsY}</td>
              <td>${barHTML(x.avail,  maxAvailGlobal,  false)}</td>
              <td>${barHTML(x.orders, maxOrdersGlobal, true)}</td>
            </tr>
          `).join("")}
        </tbody>
        <tfoot>
          <tr>
            <td><strong>Totales pa√≠s</strong></td>
            <td><!-- sin suma de ops --></td>
            <td>${sumAvail}</td>
            <td>${sumOrders}</td>
          </tr>
        </tfoot>
      </table>
    `;
    grid.appendChild(card);
  });

  root.appendChild(grid);
  document.getElementById("chipAvail").textContent  = `Full Total (Avail): ${fullAvail}`;
  document.getElementById("chipOrders").textContent = `Full Total (Orders): ${fullOrders}`;
  document.getElementById("resume").textContent = `Resultados ‚Äî ${rows.length} filas ¬∑ ${countries.length} pa√≠ses`;
}

/* ============== Control / Estado ============== */
let CURRENT_ROWS = [];
let CURRENT_VIEW = "country"; // "country" | "global3"

function applyFilterAndRender(){
  const term = document.getElementById("q").value.trim().toLowerCase();
  const rows = term
    ? CURRENT_ROWS.filter(r =>
        r.country.toLowerCase().includes(term) ||
        r.queue.toLowerCase().includes(term))
    : CURRENT_ROWS.slice();

  if (CURRENT_VIEW === "country") renderCountryCards(rows);
  else renderGlobalThreeCol(rows);
}

document.getElementById("btnProcess").addEventListener("click", ()=>{
  const txt = document.getElementById("raw").value;
  CURRENT_ROWS = parseInput(txt);
  applyFilterAndRender();
});
document.getElementById("btnClear").addEventListener("click", ()=>{
  document.getElementById("raw").value = "";
  CURRENT_ROWS = [];
  applyFilterAndRender();
});
document.getElementById("q").addEventListener("input", applyFilterAndRender);

document.getElementById("viewCountry").addEventListener("click", ()=>{
  CURRENT_VIEW = "country";
  document.getElementById("viewCountry").setAttribute("aria-pressed","true");
  document.getElementById("viewGlobal").setAttribute("aria-pressed","false");
  applyFilterAndRender();
});
document.getElementById("viewGlobal").addEventListener("click", ()=>{
  CURRENT_VIEW = "global3";
  document.getElementById("viewCountry").setAttribute("aria-pressed","false");
  document.getElementById("viewGlobal").setAttribute("aria-pressed","true");
  applyFilterAndRender();
});
</script>
</body>
</html>

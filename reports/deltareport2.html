<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GC Â· Deltas de Leads</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --font:'Lexend', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      --bg:#0a0a0a; --panel:#111; --card:#0f1115; --muted:#2a2e37;
      --text:#e8e8e8; --sub:#b5b8bf; --border:#20242c;
      --ok:#89d47f; --warn:#ffd27a; --bad:#ff7a7a;
      --radius:14px; --radius-sm:10px; --gap:14px; --shadow:0 10px 30px rgba(0,0,0,.35);
      --country-w:170px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:#0b0d10; color:var(--text); font-family:var(--font);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    header{
      position:sticky; top:0; z-index:10; backdrop-filter:saturate(1.2) blur(6px);
      background:linear-gradient(180deg, rgba(11,13,16,.9), rgba(11,13,16,.4));
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:1300px; margin:0 auto; padding:18px 18px;}
    h1{margin:0; font-weight:700; letter-spacing:.3px; font-size:22px}
    .tools{display:flex; gap:12px; margin-top:14px; flex-wrap:wrap}
    textarea{
      width:100%; min-height:160px; background:#0e1218; color:var(--text); border:1px solid var(--border);
      border-radius:var(--radius); padding:12px 14px; resize:vertical; box-shadow:var(--shadow);
    }
    .btn{
      appearance:none; border:1px solid var(--border); background:#151a21; color:var(--text);
      padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600;
    }
    .btn.primary{background:#1e2630}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .input{background:#10151b; border:1px solid var(--border); color:var(--text); padding:10px 12px; border-radius:12px}
    .hint{color:var(--sub); font-size:12px}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:var(--gap); margin-top:18px}
    @media (max-width:1024px){.grid{grid-template-columns:1fr}}
    .card{background:#0e1218; border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow)}
    .card h3{margin:0; padding:12px 14px; border-bottom:1px solid var(--border); font-size:16px}
    .status{padding:12px 14px; color:var(--sub); font-size:13px}

    /* ====== Tabla ====== */
    .table-wrap{overflow:auto; border-top:1px solid var(--border); border-bottom:1px solid var(--border); border-radius:0 0 var(--radius) var(--radius)}
    table{width:100%; border-collapse:separate; border-spacing:0}
    thead th{
      position:sticky; top:0; background:#0c1016; border-bottom:1px solid var(--border);
      text-align:left; font-weight:700; font-size:13px; padding:10px;
    }
    th, td{padding:10px; font-size:13px; border-bottom:1px solid #141921}
    tbody tr:hover td{background:#0f141b}
    .sticky-country{position:sticky; left:0; background:#0e1218; box-shadow:1px 0 0 var(--border)}
    .country-chip{
      display:inline-flex; align-items:center; font-weight:700; padding:8px 10px; border-radius:12px;
    }
    .country-row{background:#0b0f15}
    .country-toggle{cursor:pointer; user-select:none}
    .pill{font-variant-numeric:tabular-nums; font-weight:700; padding:6px 10px; border-radius:10px; display:inline-block}
    .bad{background:rgba(255,0,0,.1)}
    .ok{background:rgba(0,255,0,.1)}
    .muted{color:var(--sub)}
    .right{text-align:right}
    .center{text-align:center}
    .sort{cursor:pointer}
    .kpi{font-weight:700}
    .fade{opacity:.7}

    /* Heatmap via CSS variable --h */
    td[data-h]{background:linear-gradient(90deg, rgba(56,142,60,.18) var(--h,0%), transparent 0)}
    td.badmap[data-h]{background:linear-gradient(90deg, rgba(183,28,28,.25) var(--h,0%), transparent 0)}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>GC Â· Deltas de Leads</h1>
      <div class="tools">
        <input id="search" class="input" placeholder="Buscar paÃ­s o colaâ€¦" />
        <button id="btnProcess" class="btn primary">Procesar texto</button>
        <button id="btnClear" class="btn">Limpiar</button>
        <span id="loadHint" class="hint">Pega el bloque de texto tal como sale del sistema. Se ignorarÃ¡n filas PS y PS-Auto.</span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <h3>Entrada</h3>
      <div class="status">
        <textarea id="raw" placeholder="Pega aquÃ­ el textoâ€¦"></textarea>
      </div>
    </div>

    <div id="out" class="card" style="margin-top:14px; display:none;">
      <h3>Resultados <span id="resume" class="muted"></span></h3>
      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th class="sticky-country">Country</th>
              <th class="sort" data-sort="queue">Queues</th>
              <th class="center sort" data-sort="ops">Number of operators</th>
              <th class="center sort" data-sort="avail">Orders available</th>
              <th class="center sort" data-sort="total">Total orders</th>
              <th class="center sort" data-sort="full">Full Total</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="status" id="legend">
        <span class="pill ok">verde = mayor</span> Â·
        <span class="pill bad">rojo = menor</span> Â·
        Click en cabeceras para ordenar Â· Click en el **paÃ­s** para colapsar/expandir.
      </div>
    </div>
  </main>

  <script>
    const $ = (s,p=document)=>p.querySelector(s);
    const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));
    const rawEl = $('#raw');
    const out = $('#out');
    const tbody = $('#tbody');
    const resume = $('#resume');

    const queueAllow = /(?:^|\\s)(?:1-1|2-2|3-3|4-4|5-2|5-5)(?:\\s|$)/;
    const isPS = /(PS|Post-sale|Post-sale_Auto)/i;

    function parse(){
      const text = rawEl.value.replace(/\\r/g,'').trim();
      if(!text){ tbody.innerHTML=''; out.style.display='none'; return; }
      const lines = text.split(/\\n/).filter(l=>l.trim());
      const rows = [];
      for(const line of lines){
        // Split by tabs first; if not, split by multiple spaces
        const parts = line.split(/\\t+/);
        if(parts.length < 10) continue;

        const countryRaw = parts[1] || '';
        const name = (parts[2] || parts[3] || '').trim();
        if(!name) continue;

        if(isPS.test(name)) continue;                 // Excluir PS
        if(!queueAllow.test(name)) continue;          // Solo colas objetivo

        // Country: "28. Colombia" -> "Colombia"
        const country = countryRaw.replace(/^\\d+\\.\\s*/,'').trim();

        // Number of operators: "17 | 4" => 4 (disponibles / activo)
        const opsRaw = (parts[4]||'').trim();
        const ops = parseInt((opsRaw.split('|')[1]||'').trim()||'0',10);

        // Orders: "A | B"
        // En el dump estÃ¡ en la columna "Orders", que suele ser parts[9] (puede moverse).
        // Buscamos la primera celda que contenga el patrÃ³n "x | y"
        let ordersCell = parts.find(c => /\\d+\\s*\\|\\s*\\d+/.test(c)) || '';
        const [totalStr, availStr] = ordersCell.split('|').map(s=>s? s.replace(/[^\\d]/g,'') : '0');
        const total = parseInt(totalStr||'0',10);
        const avail = parseInt(availStr||'0',10);

        rows.push({country, queue:name, ops, avail, total});
      }
      return rows;
    }

    function groupByCountry(rows){
      const map = new Map();
      for(const r of rows){
        if(!map.has(r.country)) map.set(r.country, {country:r.country, rows:[], full:0});
        map.get(r.country).rows.push(r);
        map.get(r.country).full += r.total;
      }
      // Ordenar paÃ­ses por full desc
      return Array.from(map.values()).sort((a,b)=>b.full-a.full);
    }

    function render(rows){
      const groups = groupByCountry(rows);
      const allOps   = rows.map(r=>r.ops);
      const allAvail = rows.map(r=>r.avail);
      const allTotal = rows.map(r=>r.total);
      const minMax = a => ({min:Math.min(...a,0), max:Math.max(...a,1)});
      const mmOps=minMax(allOps), mmAvail=minMax(allAvail), mmTotal=minMax(allTotal);

      tbody.innerHTML = '';
      for(const g of groups){
        // Fila de paÃ­s (resumen)
        const trC = document.createElement('tr');
        trC.className='country-row';
        trC.innerHTML = `
          <td class="sticky-country country-toggle" colspan="5">
            <span class="country-chip">ðŸ‡¨ðŸ‡±ðŸ‡¨ðŸ‡´ðŸ‡¨ðŸ‡·ðŸ‡ªðŸ‡¨ðŸ‡²ðŸ‡½ðŸ‡µðŸ‡ªðŸ‡µðŸ‡¾ðŸ‡ºðŸ‡¾ðŸ‡»ðŸ‡ª`.replace('ðŸ‡¨ðŸ‡±','') + `</span>
            <strong style="font-size:14px">${g.country}</strong>
          </td>
          <td class="center kpi">${g.full.toLocaleString()}</td>`;
        trC.dataset.country = g.country;
        tbody.appendChild(trC);

        // Filas hijas
        for(const r of g.rows){
          const tr = document.createElement('tr');
          tr.dataset.country = g.country;

          const hOps   = scale(r.ops, mmOps);
          const hAvail = scale(r.avail, mmAvail);
          const hTotal = scale(r.total, mmTotal);

          tr.innerHTML = `
            <td class="sticky-country muted">${g.country}</td>
            <td>${r.queue}</td>
            <td class="center" data-h style="--h:${hOps}%">${fmt(r.ops)}</td>
            <td class="center badmap" data-h style="--h:${hAvail}%">${fmt(r.avail)}</td>
            <td class="center" data-h style="--h:${hTotal}%">${fmt(r.total)}</td>
            <td class="center muted">${fmt(g.full)}</td>
          `;
          tbody.appendChild(tr);
        }
      }
      out.style.display='';
      resume.textContent = `â€” ${rows.length} filas Â· ${new Set(rows.map(r=>r.country)).size} paÃ­ses`;
      attachCountryToggle();
    }

    function scale(v, {min,max}){
      if(max===min) return 0;
      return Math.round(((v-min)/(max-min))*100);
    }
    const fmt = n => Number(n||0).toLocaleString('en-US');

    function attachCountryToggle(){
      // Colapsar/expandir
      const rows = $$('#tbody tr.country-row');
      rows.forEach(row=>{
        row.addEventListener('click', ()=>{
          const c = row.dataset.country;
          const open = row.classList.toggle('fade');
          $$('#tbody tr').forEach(r=>{
            if(r!==row && r.dataset.country===c) r.style.display = (open ? 'none' : '');
          });
        });
      });
    }

    // Sort (simple, por columna)
    let sortKey = null, sortDir = 1;
    $$('#tbl thead th.sort').forEach(th=>{
      th.addEventListener('click', ()=>{
        const key = th.dataset.sort;
        if(sortKey===key) sortDir*=-1; else { sortKey=key; sortDir=1; }
        const rows = parse() || [];
        rows.sort((a,b)=>{
          const A = key==='queue' ? a.queue.localeCompare(b.queue) :
                    key==='ops'   ? a.ops :
                    key==='avail' ? a.avail :
                    key==='total' ? a.total : 0;
          const B = key==='queue' ? b.queue.localeCompare(a.queue) :
                    key==='ops'   ? b.ops :
                    key==='avail' ? b.avail :
                    key==='total' ? b.total : 0;
          return (A-B)*sortDir;
        });
        render(rows);
      });
    });

    // Search
    $('#search').addEventListener('input', (e)=>{
      const q = e.target.value.toLowerCase().trim();
      const rows = (parse() || []).filter(r =>
        r.country.toLowerCase().includes(q) || r.queue.toLowerCase().includes(q)
      );
      render(rows);
    });

    // Buttons
    $('#btnProcess').addEventListener('click', ()=>{
      const rows = parse() || [];
      render(rows);
    });
    $('#btnClear').addEventListener('click', ()=>{
      rawEl.value=''; out.style.display='none'; $('#search').value='';
    });
  </script>
</body>
</html>

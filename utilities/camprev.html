<!DOCTYPE html>
<html lang="es" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gesti√≥n Center ‚Äî Selector de Apoyo 2.0</title>

    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=Lexend:wght@300;400;600;700&display=swap" rel="stylesheet"/>

    <!-- üîí Ocultar hasta validar sesi√≥n (con fallback) -->
    <style>html{visibility:hidden}</style>
    <script>
      (function(){ window.__gc_vis_fallback = setTimeout(()=>{document.documentElement.style.visibility='visible'},1200); })();
    </script>
    <script type="module" src="/assets/guard.js"></script>

    <style>
      :root{
        --radius:16px; --radius-sm:12px; --radius-xs:10px;
        --font-title:'Outfit',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
        --font-body:'Lexend',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
        --t-fast:.15s; --t-med:.22s; --t-slow:.6s; --curve:cubic-bezier(.2,.7,.2,1);
        --elev-1:0 6px 20px rgba(0,0,0,.25); --elev-2:0 12px 34px rgba(0,0,0,.35);
        --sidebar-w:280px; --sidebar-w-compact:72px;
      }
      [data-theme="dark"]{
        --bg-app:#070b1a; --bg-aside:#0c1228;
        --bg-card:linear-gradient(160deg, rgba(17,24,49,.88), rgba(17,24,49,.7));
        --txt:#e9f1ff; --txt-muted:#b8c6de; --stroke:rgba(255,255,255,.10);
        --primary:#5b8bff; --accent:#7ae3ff;
        --chip-ok:#22c55e; --chip-warn:#f59e0b; --chip-bad:#ef4444;
        --table-bg:rgba(20,28,56,.7); --table-head:#111a39; --table-border:rgba(255,255,255,.10);
        --btn:#30478b; --btn-hover:#3f62c5; --btn-alt:#2a3d5e;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{margin:0; font-family:var(--font-body); color:var(--txt); background:var(--bg-app); overflow-x:hidden}

      /* Luces + cuadr√≠cula sutil */
      #bg-fx{position:fixed; inset:0; z-index:-2; pointer-events:none;
        background:
          radial-gradient(1100px 1100px at 10% -10%, color-mix(in oklab, var(--primary) 30%, transparent), transparent 60%),
          radial-gradient(900px 900px at 90% 0%, color-mix(in oklab, var(--accent) 35%, transparent), transparent 55%);
        background-repeat:no-repeat; background-attachment:fixed}
      #bg-grid{position:fixed; inset:0; z-index:-1; opacity:.07; pointer-events:none;
        background:
          linear-gradient(color-mix(in oklab, var(--txt) 9%, transparent) 1px, transparent 1px) 0 0 / 28px 28px,
          linear-gradient(90deg, color-mix(in oklab, var(--txt) 9%, transparent) 1px, transparent 1px) 0 0 / 28px 28px}

      @media (prefers-reduced-motion:no-preference){
        .reveal{opacity:0; transform:translateY(8px); transition:opacity var(--t-slow) ease, transform var(--t-slow) ease}
        .reveal.show{opacity:1; transform:none}
      }

      /* ===== Sidebar (igual ecosistema) ===== */
      aside{
        position:fixed; inset:0 auto 0 0; width:var(--sidebar-w); z-index:25;
        backdrop-filter:saturate(120%) blur(8px);
        background:color-mix(in oklab, var(--bg-aside) 96%, transparent);
        border-right:1px solid var(--stroke);
        display:flex; flex-direction:column; padding:14px 12px; gap:12px; overflow:auto; contain:content; --pad-x:10px;
      }
      aside::before,aside::after{content:""; position:sticky; display:block; height:14px; pointer-events:none; z-index:5}
      aside::before{top:0; background:linear-gradient(#0000, rgba(0,0,0,.25))}
      aside::after{bottom:0; background:linear-gradient(rgba(0,0,0,.25), #0000)}

      .brand{display:flex; align-items:center; justify-content:center; padding:12px; border-radius:var(--radius);
        border:1px solid var(--stroke);
        background:linear-gradient(132deg, color-mix(in oklab, var(--primary) 18%, transparent), color-mix(in oklab, var(--accent) 12%, transparent));
        transition:transform var(--t-fast) var(--curve)}
      .brand:hover{transform:scale(1.01)}
      .brand img{width:160px; height:auto; object-fit:contain; filter:drop-shadow(0 6px 14px rgba(0,0,0,.35))}

      .sidebar-toggle{display:flex; align-items:center; justify-content:center; gap:8px; width:100%;
        border:1px solid var(--stroke); padding:10px; border-radius:12px; background:rgba(255,255,255,.04);
        color:var(--txt); cursor:pointer; font-weight:700}
      .sidebar-toggle:hover{filter:brightness(1.05)} .sidebar-toggle:active{transform:translateY(1px)}

      nav{position:relative; display:flex; flex-direction:column; gap:10px}
      .nav-group{border:1px solid var(--stroke); border-radius:14px; overflow:hidden; background:color-mix(in oklab, var(--bg-aside) 92%, transparent)}
      .nav-head{width:100%; text-align:left; padding:10px 12px; border:0; background:transparent; color:var(--txt);
        font:700 13px/1 var(--font-title); letter-spacing:.3px; cursor:pointer; display:flex; align-items:center; gap:8px}
      .nav-head .chev{transition:transform var(--t-med) var(--curve)}
      .nav-group.is-collapsed .nav-head .chev{transform:rotate(-90deg)}
      .nav-body{overflow:hidden; transition:grid-template-rows .35s var(--curve), opacity .25s ease; display:grid; grid-template-rows:1fr; opacity:1}
      .nav-group.is-collapsed .nav-body{grid-template-rows:0fr; opacity:.0}
      .nav-body-inner{min-height:0; padding:6px; display:flex; flex-direction:column; gap:8px}

      .nav-item{display:flex; align-items:center; gap:10px; padding:12px var(--pad-x); border-radius:10px; text-decoration:none; color:var(--txt); font-size:15px; border:1px solid transparent;
        transition:background var(--t-med) ease, transform var(--t-fast) ease; min-height:40px}
      .nav-item:hover{background:color-mix(in oklab, var(--bg-aside) 80%, transparent); transform:translateX(2px)}
      .nav-item.active{background:linear-gradient(90deg, color-mix(in oklab, var(--primary) 20%, transparent), color-mix(in oklab, var(--accent) 14%, transparent)); border-color:var(--stroke)}

      .spacer{flex:1}
      .role-card{display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:14px; border:1px solid var(--stroke); background:color-mix(in oklab, var(--bg-aside) 92%, transparent)}
      .role-dot{width:14px; height:14px; border-radius:50%}
      .role-badge{font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--stroke); background:rgba(255,255,255,.06)}
      .logout{width:100%; border:1px solid var(--stroke); background:linear-gradient(180deg, #ef4444, #d62c2c); color:#fff; padding:12px; border-radius:12px; cursor:pointer; font-weight:700}

      /* ===== Main ===== */
      main{ margin-left:var(--sidebar-w); padding:24px 22px 40px; transition:margin-left var(--t-med) var(--curve) }
      .hero{ position:relative; border-radius:var(--radius); padding:18px 20px; background:linear-gradient(135deg, color-mix(in oklab, var(--primary) 14%, transparent), color-mix(in oklab, var(--accent) 12%, transparent)); border:1px solid var(--stroke); overflow:hidden; margin-bottom:14px }
      .hero h1{margin:0; font:700 24px/1.2 var(--font-title)}
      .blob{ position:absolute; right:-90px; top:-90px; width:240px; height:240px; border-radius:50%; background:radial-gradient(circle at 30% 30%, color-mix(in oklab, var(--accent) 40%, transparent), transparent 60%); filter:blur(18px) }

      .card{ position:relative; border-radius:var(--radius); padding:14px 16px; overflow:hidden; background:var(--bg-card); border:1px solid var(--stroke); box-shadow:var(--elev-1) }
      .filters{ display:grid; grid-template-columns:repeat(5, minmax(180px,1fr)); gap:12px; align-items:end; background:var(--bg-card); border:1px solid var(--stroke); border-radius:var(--radius); padding:12px; margin:10px 0 12px }
      .filter-group{ display:flex; flex-direction:column; gap:6px }
      .filter-group label{ font-size:12px; color:var(--txt-muted) }
      .filter-group select,.filter-group input[type="text"],.filter-group textarea{ padding:9px 12px; border-radius:12px; border:1px solid var(--table-border); background:var(--table-bg); color:var(--txt); height:40px; outline:none; appearance:none }
      .filter-group textarea{ height:auto; min-height:40px; resize:vertical; line-height:1.2; font-family:var(--font-body) }
      .grid-span-3{ grid-column: span 3 }
      .rowstats{ display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap; margin:4px 0 10px }
      .chip{ background:#334766; border:1px solid #2a3d5e; border-radius:999px; padding:6px 10px; font-size:12px; font-weight:700 }
      .counter{ margin-left:auto; font-weight:800; font-size:14px; padding:8px 12px; border-radius:999px; background:#334766; border:1px solid #2a3d5e }

      /* ====== Toolbar buttons (forzar estilo) ====== */
      .toolbar{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 14px }
      .toolbar button{
        appearance:none; -webkit-appearance:none;
        padding:10px 14px; font-size:14px; cursor:pointer; border:1px solid color-mix(in oklab, var(--primary) 30%, var(--stroke));
        border-radius:12px; background:var(--btn); color:#fff; box-shadow:0 2px 6px rgba(0,0,0,.25);
        transition:background var(--t-med), transform var(--t-fast), filter var(--t-med);
      }
      .toolbar button:hover{ background:var(--btn-hover) }
      .toolbar button:active{ transform:translateY(1px) }
      .toolbar .btn-alt{ background:var(--btn-alt); border-color:color-mix(in oklab, var(--accent) 30%, var(--stroke)) }

      /* ====== Tabla ====== */
      table{ width:100%; border-collapse:separate; border-spacing:0; background:var(--table-bg); border:1px solid var(--table-border); border-radius:12px; overflow:hidden; box-shadow:0 4px 10px rgba(0,0,0,.18) }
      thead th{ background:var(--table-head); color:#fff; padding:10px; text-align:center; position:sticky; top:0; z-index:2; user-select:none; cursor:pointer }
      tbody td{ padding:10px; border-top:1px solid var(--table-border); text-align:center }
      thead th:first-child, tbody td:first-child{ text-align:left }
      .perop{ font-family:ui-monospace,Menlo,Consolas,monospace; font-size:13px; opacity:.95; cursor:copy }

      .sort-none::after{ content:"" } .sort-desc::after{ content:" ‚Üì"; font-weight:900 } .sort-asc::after{ content:" ‚Üë"; font-weight:900 }
      .pct{ font-weight:800 } .pct.red{ color:#ff8a80 } .pct.orange{ color:#ffcc80 } .pct.green{ color:#80e27e }
      #toast{ position:fixed; bottom:18px; right:20px; background:#222; color:#fff; padding:12px 18px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.35); display:none; z-index:1000 }

      /* Compacto */
      body.sidebar-compact aside{ width:var(--sidebar-w-compact) }
      body.sidebar-compact main{ margin-left:var(--sidebar-w-compact) }
      body.sidebar-compact .brand img{ width:42px }
      body.sidebar-compact .nav-head .txt, body.sidebar-compact .nav-item .label, body.sidebar-compact .sidebar-toggle .lbl, body.sidebar-compact .role-text{ display:none }
      body.sidebar-compact .nav-item{ justify-content:center; padding-inline:0 }

      @media (max-width:1080px){
        main{margin-left:0; padding:16px}
        aside{position:sticky; width:auto; inset:auto; border-right:none; border-bottom:1px solid var(--stroke)}
        .filters{grid-template-columns:repeat(2, minmax(140px,1fr))}
      }
    </style>
  </head>
  <body>
    <div id="bg-fx" aria-hidden="true"></div>
    <div id="bg-grid" aria-hidden="true"></div>

    <!-- ===== SIDEBAR ===== -->
    <aside class="reveal" id="gc-aside">
      <a class="brand" href="./index.html" id="brandLink" aria-label="Inicio" title="Inicio">
        <picture>
          <source srcset="./images/logogestioncenter.webp" type="image/webp"/>
          <img id="brandLogo" src="./images/logogestioncenter.png" alt="Gesti√≥n Center" loading="lazy" decoding="async"/>
        </picture>
      </a>

      <button class="sidebar-toggle" id="btnSidebarToggle" aria-pressed="false" title="Compactar / Expandir">
        <span class="icon">‚áÜ</span><span class="lbl">Cambiar ancho</span>
      </button>

      <nav id="gc-nav" role="navigation" aria-label="Navegaci√≥n principal">
        <!-- ‚ùå Eliminado el indicador azul -->
        <a href="./index.html" class="nav-item" title="Inicio">üè† <span class="label">Inicio</span></a>

        <section class="nav-group" data-key="grp-reportes">
          <button class="nav-head" title="Reportes"><span class="chev">‚ñæ</span> <span class="txt">üìä Reportes</span></button>
          <div class="nav-body"><div class="nav-body-inner">
            <a href="/reports/newreport.html" class="nav-item" title="New Report">üß∞ <span class="label">New Report</span></a>
            <a href="/reports/psreport.html" class="nav-item" title="Post-Sale Report">üöö <span class="label">Post-Sale Report</span></a>
          </div></div>
        </section>

        <section class="nav-group" data-key="grp-operaciones">
          <button class="nav-head" title="Operaciones"><span class="chev">‚ñæ</span> <span class="txt">üõ†Ô∏è Operaciones</span></button>
          <div class="nav-body"><div class="nav-body-inner">
            <a href="/operations/distribucion.html" class="nav-item" title="Distribuci√≥n">üìã <span class="label">Distribuci√≥n</span></a>
            <a href="/operations/biops.html" class="nav-item" title="BI de OPs + Links">üîó <span class="label">BI de OPs + Links</span></a>
          </div></div>
        </section>

        <section class="nav-group" data-key="grp-cobertura">
          <button class="nav-head" title="Cobertura"><span class="chev">‚ñæ</span> <span class="txt">üåé Cobertura</span></button>
          <div class="nav-body"><div class="nav-body-inner">
            <a href="./cobertura.html" class="nav-item" title="Mapa de cobertura">üó∫Ô∏è <span class="label">Mapa de cobertura</span></a>
            <a href="./newcobertura.html" class="nav-item" title="New Cobertura 1.1">üß≠ <span class="label">New Cobertura 1.1</span></a>
          </div></div>
        </section>

        <section class="nav-group" data-key="grp-utils">
          <button class="nav-head" title="Utilidades"><span class="chev">‚ñæ</span> <span class="txt">üß© Utilidades</span></button>
          <div class="nav-body"><div class="nav-body-inner">
            <a href="/utilities/camprev.html" class="nav-item active" aria-current="page" title="Selector de Apoyo 2.0">üë• <span class="label">Selector de Apoyo 2.0</span></a>
          </div></div>
        </section>
      </nav>

      <div class="spacer"></div>

      <div class="role-card" id="roleCard">
        <div class="role-dot" id="roleDot" style="background:linear-gradient(135deg,#94a3b8,#64748b)"></div>
        <div class="role-text">
          <strong id="roleName">Invitado</strong>
          <span class="role-badge" id="roleBadge" style="margin-left:6px">‚≠ê Invitado</span><br/>
          <small id="roleDesc">Acceso limitado</small>
        </div>
      </div>

      <button class="logout" onclick="gcLogout()">Salir</button>
    </aside>

    <!-- ===== CONTENIDO ===== -->
    <main>
      <section class="hero reveal">
        <div class="blob" aria-hidden="true"></div>
        <h1>üë• Selector de Apoyo ‚Äî Ver 2.0</h1>
      </section>

      <section class="card reveal" style="--delay:.05s">
        <div class="filters">
          <div class="filter-group"><label for="fltTL">Team Leader</label><select id="fltTL"><option value="">Todos</option></select></div>
          <div class="filter-group"><label for="fltCamp">Campa√±a</label><select id="fltCamp"><option value="">Todas</option></select></div>
          <div class="filter-group"><label for="fltDesc">Descanso</label><select id="fltDesc"><option value="">Todos</option></select></div>
          <div class="filter-group"><label for="fltTurno">Turno</label><select id="fltTurno"><option value="">Todos</option></select></div>
          <div class="filter-group"><label for="fltSearch">Buscar</label><input id="fltSearch" type="text" placeholder="Operador o PEROP1AM"/></div>

          <div class="filter-group grid-span-3">
            <label for="fltList">Lista PEROP1AM (uno por l√≠nea, o separados por , ;)</label>
            <textarea id="fltList" rows="4" placeholder="Ejemplo:
PEROP1AM-41058
PEROP1AM-39726
41058"></textarea>
          </div>

          <div class="filter-group">
            <label>Modo lista PEROP</label>
            <label class="toggle" title="Presiona X para alternar">
              <input type="checkbox" id="toggleInclude" checked/>
              <span id="toggleLabel">Incluir lista</span>
            </label>
          </div>

          <div class="counter" id="rowCounter">Mostrando 0 registros</div>
        </div>

        <div class="rowstats">
          <div class="chip" id="chipRows">0 filas</div>
          <div class="chip" id="chipTLs">0 TLs √∫nicos</div>
          <div class="chip" id="chipCamps">0 campa√±as</div>
        </div>

        <div class="toolbar">
          <button id="btnReset">üßπ Restablecer filtros</button>
          <button id="btnExport">‚¨áÔ∏è Exportar (CSV)</button>
          <button id="btnCopyPerop" class="btn-alt">üìã Copiar PEROPs filtrados</button>
          <button id="btnCopyNames" class="btn-alt">üìã Copiar Nombres filtrados</button>
        </div>
      </section>

      <section class="card reveal" style="--delay:.1s">
        <div style="overflow:auto">
          <table id="tblCampRev" title="Click: ordenar ‚Ä¢ Shift+Click: a√±adir como orden secundario ‚Ä¢ Clic repetido: descendente ‚Üí ascendente ‚Üí quitar">
            <thead>
              <tr id="headRow">
                <th data-col="teamLeader" class="sort-none">Team Leader</th>
                <th data-col="nombre" class="sort-none">Operador</th>
                <th data-col="perop" class="sort-none">PEROP1AM</th>
                <th data-col="campania" class="sort-none">Campa√±a</th>
                <th data-col="orders" class="sort-none">Total Orders</th>
                <th data-col="approve" class="sort-none">%Approve</th>
                <th data-col="reject" class="sort-none">%Reject</th>
                <th data-col="trash" class="sort-none">%Trash</th>
                <th data-col="avg" class="sort-none">Avg Check</th>
                <th data-col="descanso" class="sort-none">Descanso</th>
                <th data-col="turno" class="sort-none">Turno</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </main>

    <div id="toast"></div>

    <script type="module">
      // ========= Activar item actual (sin indicador) =========
      const navEl = document.getElementById('gc-nav');
      const items=[...navEl.querySelectorAll('a.nav-item')];
      function setActive(){
        const current=(location.pathname.split('/').pop()||'camprev.html').toLowerCase();
        let active=items[0];
        items.forEach(a=>{
          const href=(a.getAttribute('href')||'').replace(/^\.?\//,'').split('#')[0].split('/').pop().toLowerCase();
          if(href && href===current) active=a;
          a.classList.toggle('active', a===active);
          a.toggleAttribute('aria-current', a===active ? 'page':false);
        });
      }
      setActive();

      // ========= Grupos colapsables =========
      document.querySelectorAll('.nav-group').forEach(g=>{
        const key=g.dataset.key, head=g.querySelector('.nav-head');
        const saved=localStorage.getItem(key);
        if(saved==='0') g.classList.add('is-collapsed');
        head.addEventListener('click', ()=>{
          g.classList.toggle('is-collapsed');
          localStorage.setItem(key, g.classList.contains('is-collapsed')?'0':'1');
        });
      });

      // ========= Reveal + parallax =========
      const reduced=window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if(!reduced && 'IntersectionObserver' in window){
        const io=new IntersectionObserver((entries)=>{ for(const e of entries){ if(e.isIntersecting){ e.target.classList.add('show'); io.unobserve(e.target); } } }, {threshold:.12, rootMargin:'0px 0px -10% 0px'});
        document.querySelectorAll('.reveal').forEach(el=>{ const d=el.style.getPropertyValue('--delay')||'0s'; el.style.transitionDelay=d; io.observe(el); });
      } else { document.querySelectorAll('.reveal').forEach(el=>el.classList.add('show')); }
      const bg=document.getElementById('bg-grid'); let rafId=null;
      function parallax(e){ const x=(e.clientX/window.innerWidth-.5)*6, y=(e.clientY/window.innerHeight-.5)*6; if(rafId) cancelAnimationFrame(rafId); rafId=requestAnimationFrame(()=>{ bg.style.transform=`translate(${x}px, ${y}px)`; }); }
      if(!reduced) window.addEventListener('mousemove', parallax);

      // ========= Role UI (simple) =========
      const ROLE_STYLE={ 'invitado':{name:'Invitado',desc:'Acceso limitado',badge:'‚≠ê Invitado',color:'#94a3b8',gradient:'linear-gradient(135deg,#94a3b8,#64748b)'} };
      function applyRoleUI(){ const cfg=ROLE_STYLE['invitado']; document.getElementById('roleName').textContent=cfg.name; document.getElementById('roleDesc').textContent=cfg.desc; document.getElementById('roleBadge').textContent=cfg.badge; document.getElementById('roleDot').style.background=cfg.gradient; }
      applyRoleUI();

      // ========= Utils =========
      const toast=(m)=>{const t=document.getElementById('toast');t.textContent=m;t.style.display='block';t.style.opacity=1;setTimeout(()=>{t.style.transition='opacity .5s';t.style.opacity=0;},2600);setTimeout(()=>{t.style.display='none';t.style.transition='';},3200)}
      const norm = s => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim().toLowerCase();
      const debounce=(fn,ms=180)=>{let h;return (...a)=>{clearTimeout(h);h=setTimeout(()=>fn(...a),ms)}}
      const STATE_KEY='selector_apoyo_v2_state';

      // ========= Base din√°mica =========
      function getBase(){
        const isGhProject = location.hostname.endsWith('github.io');
        const PROJECT_SLUG = 'Gestion-Center';
        return isGhProject ? `/${PROJECT_SLUG}/` : '/';
      }

      // ========= Estado =========
      let rawDistrib=[]; let rawCamp=[]; let dataFinal=[]; let filtered=[]; let sortState=[];

      // ========= Carga (rutas correctas) =========
      async function loadJSON(url){ const sep=url.includes('?')?'&':'?'; const r=await fetch(url+sep+'t='+(Date.now())); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
      async function loadData(){
        try{
          const base=getBase();
          const [distrib,camp]=await Promise.all([
            loadJSON(base + 'operations/datadistribucion.json'),
            loadJSON(base + 'utilities/datacamprev.json')
          ]);
          rawDistrib=distrib; rawCamp=camp;
          dataFinal=rawCamp.reduce((acc,row)=>{
            const op=rawDistrib.find(o=>String(o.C)===String(row.A));
            if(op){
              acc.push({
                teamLeader: op.A||'', nombre: op.B||'', perop: row.A||'', campania: row.B||'',
                orders: Number(row.C)||0, approve: String(row.E||''), reject: String(row.M||''), trash: String(row.O||''),
                avg: Number(row.P)||0, descanso: op.E||'', turno: op.F||''
              });
            }
            return acc;
          },[]);
          buildFilters(dataFinal);
          restoreState();
          applyFiltersAndRender();
          toast('‚úÖ Datos cargados');
        }catch(e){
          console.error(e);
          toast('‚ùå No se pudieron cargar los JSON');
        }finally{
          try{ clearTimeout(window.__gc_vis_fallback); }catch(_){}
          document.documentElement.style.visibility='visible';
        }
      }

      // ========= Filtros =========
      function uniqSorted(arr){ return [...new Set(arr.filter(v=>v!=null && String(v).trim()!==''))].sort((a,b)=>String(a).localeCompare(String(b),'es')); }
      function fillSelect(sel, values){
        sel.innerHTML='<option value="">'+(sel.id==='fltCamp'?'Todas':'Todos')+'</option>'+
          values.map(v=>`<option value="${String(v).replaceAll('"','&quot;')}">${v}</option>`).join('');
      }
      function buildFilters(rows){
        fillSelect(document.getElementById('fltTL'),   uniqSorted(rows.map(r=>r.teamLeader)));
        fillSelect(document.getElementById('fltCamp'), uniqSorted(rows.map(r=>r.campania)));
        fillSelect(document.getElementById('fltDesc'), uniqSorted(rows.map(r=>r.descanso)));
        fillSelect(document.getElementById('fltTurno'),uniqSorted(rows.map(r=>r.turno)));
      }
      function parsePeropList(raw){
        if(!raw) return { full:new Set(), digits:new Set() };
        const tokens=raw.split(/[\n,;]+/g).map(s=>s.replace(/\s+/g,'').toUpperCase()).filter(Boolean);
        const full=new Set(tokens);
        const digits=new Set(tokens.map(t=>{ const m=t.match(/(\d{3,})$/); return m?m[1]:''; }).filter(Boolean));
        return { full, digits };
      }

      // ========= Filtrado + orden acumulativo =========
      function applyFiltersAndRender(){
        const vTL = norm(document.getElementById('fltTL').value);
        const vCa = norm(document.getElementById('fltCamp').value);
        const vDe = norm(document.getElementById('fltDesc').value);
        const vTu = norm(document.getElementById('fltTurno').value);

        const qRaw = norm(document.getElementById('fltSearch').value);
        const qTokens = qRaw.split(/\s+/).filter(Boolean);

        const includeMode = document.getElementById('toggleInclude').checked;
        const lists = parsePeropList(document.getElementById('fltList').value);

        filtered = dataFinal.filter(r=>{
          const a=norm(r.teamLeader), b=norm(r.nombre), c=norm(r.perop), d=norm(r.campania), e=norm(r.descanso), f=norm(r.turno);

          if (vTL && a!==vTL) return false;
          if (vCa && d!==vCa) return false;
          if (vDe && e!==vDe) return false;
          if (vTu && f!==vTu) return false;

          const peropClean=String(r.perop).replace(/\s+/g,'').toUpperCase();
          const peropNum=(peropClean.match(/(\d{3,})$/)||[])[1]||'';
          const hasList=(lists.full.size>0||lists.digits.size>0);
          if (hasList){
            const inList=lists.full.has(peropClean)||(peropNum && lists.digits.has(peropNum));
            if (includeMode && !inList) return false;
            if (!includeMode &&  inList) return false;
          }

          if (qTokens.length){
            const ok=qTokens.every(tok=> b.includes(tok)||c.includes(tok));
            if(!ok) return false;
          }
          return true;
        });

        if (sortState.length){
          filtered.sort((x,y)=>{
            for (const {col,mode} of sortState){
              let A=x[col], B=y[col];
              if(['orders','avg'].includes(col)){ A=Number(A)||0; B=Number(B)||0; }
              else if(['approve','reject','trash'].includes(col)){ A=parseFloat(String(A).replace('%',''))||0; B=parseFloat(String(B).replace('%',''))||0; }
              else { A=String(A); B=String(B); }
              const cmp=(typeof A==='number'&&typeof B==='number')?(A-B):A.localeCompare(B,'es',{numeric:true,sensitivity:'base'});
              if(cmp!==0) return mode===1 ? -cmp : cmp; // 1=desc, 2=asc
            }
            return 0;
          });
        }

        renderTable(filtered);
        updateChips(filtered);
        saveState();
      }

      function colorPct(val,type){
        const n=parseFloat(String(val).replace('%',''))||0;
        if(type==="approve"){ if(n<=24) return "red"; if(n<=29) return "orange"; return "green"; }
        if(type==="reject"||type==="trash"){ if(n<=7) return "green"; if(n<=14) return "orange"; return "red"; }
        return "";
      }
      function renderTable(rows){
        const tbody=document.querySelector('#tblCampRev tbody'); tbody.innerHTML='';
        const frag=document.createDocumentFragment();
        rows.forEach(r=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td>${r.teamLeader}</td>
            <td>${r.nombre}</td>
            <td class="perop" data-copy="${r.perop}">${r.perop}</td>
            <td>${r.campania}</td>
            <td>${r.orders}</td>
            <td class="pct ${colorPct(r.approve,'approve')}">${r.approve}</td>
            <td class="pct ${colorPct(r.reject,'reject')}">${r.reject}</td>
            <td class="pct ${colorPct(r.trash,'trash')}">${r.trash}</td>
            <td>$${(Number(r.avg)||0).toLocaleString('en-US',{minimumFractionDigits:0})}</td>
            <td>${r.descanso}</td>
            <td>${r.turno}</td>`;
          frag.appendChild(tr);
        });
        tbody.appendChild(frag);
        document.getElementById('rowCounter').textContent=`Mostrando ${rows.length} registro${rows.length===1?'':'s'}`;
        tbody.querySelectorAll('td.perop').forEach(td=>{
          td.title='Click para copiar PEROP';
          td.addEventListener('click', async ()=>{
            const v=td.dataset.copy||td.textContent.trim();
            try{ await navigator.clipboard.writeText(v); toast('üìã PEROP copiado'); }catch{ toast('‚ùå No se pudo copiar'); }
          });
        });
      }
      function updateChips(rows){
        const tlSet=new Set(rows.map(r=>r.teamLeader).filter(Boolean));
        const campSet=new Set(rows.map(r=>r.campania).filter(Boolean));
        document.getElementById('chipRows').textContent=`${rows.length} fila${rows.length===1?'':'s'}`;
        document.getElementById('chipTLs').textContent=`${tlSet.size} TL${tlSet.size===1?'':'s'} √∫nicos`;
        document.getElementById('chipCamps').textContent=`${campSet.size} campa√±a${campSet.size===1?'':'s'}`;
      }

      // ===== Orden acumulativo (click/shift+click) =====
      function resetHeadSortClasses(){ document.querySelectorAll('#headRow th').forEach(th=>{ th.classList.remove('sort-asc','sort-desc'); th.classList.add('sort-none'); }); }
      function refreshHeadSortClasses(){ resetHeadSortClasses(); sortState.forEach(({col,mode})=>{ const th=document.querySelector(`#headRow th[data-col="${col}"]`); if(th&&mode){ th.classList.remove('sort-none'); th.classList.add(mode===1?'sort-desc':'sort-asc'); } }); }
      function cycleSort(th, e = { shiftKey:false }){
        const col = th?.dataset?.col; if(!col) return;
        const idx = sortState.findIndex(s => s.col === col);
        let next = 1;
        if (idx !== -1){
          const was = sortState[idx].mode;
          if (was === 1) next = 2;
          else if (was === 2){ sortState.splice(idx,1); refreshHeadSortClasses(); applyFiltersAndRender(); return; }
          sortState.splice(idx,1);
        }
        const entry = { col, mode: next };
        if (e.shiftKey) sortState.push(entry); else sortState.unshift(entry);
        refreshHeadSortClasses(); applyFiltersAndRender();
      }

      // ===== Exportar / Copiar =====
      function exportCSV(){
        if(!filtered.length){ toast('‚ÑπÔ∏è No hay filas para exportar'); return; }
        const headers=['Team Leader','Operador','PEROP1AM','Campa√±a','Total Orders','%Approve','%Reject','%Trash','Avg Check','Descanso','Turno'];
        const rows=filtered.map(r=>[r.teamLeader,r.nombre,r.perop,r.campania,r.orders,r.approve,r.reject,r.trash,r.avg,r.descanso,r.turno]);
        const csv=[headers,...rows].map(row=>row.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob=new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download=`camprev_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click();
        document.body.removeChild(a); URL.revokeObjectURL(url);
      }
      async function copyList(getter,label){
        const arr=filtered.map(getter).filter(Boolean); if(!arr.length){ toast('‚ÑπÔ∏è Nada para copiar'); return; }
        const text=arr.join('\n'); try{ await navigator.clipboard.writeText(text); toast(`üìã ${label} copiad${arr.length===1?'o':'os'} (${arr.length})`); }catch{ toast('‚ùå No se pudo copiar'); }
      }

      // ===== Persistencia =====
      function saveState(){
        const state={ fltTL:fltTL.value, fltCamp:fltCamp.value, fltDesc:fltDesc.value, fltTurno:fltTurno.value, fltSearch:fltSearch.value, fltList:fltList.value, includeMode:toggleInclude.checked, sortState };
        try{ localStorage.setItem(STATE_KEY, JSON.stringify(state)); }catch{}
      }
      function restoreState(){
        try{
          const raw=localStorage.getItem(STATE_KEY); if(!raw) return;
          const s=JSON.parse(raw);
          fltTL.value=s.fltTL??''; fltCamp.value=s.fltCamp??''; fltDesc.value=s.fltDesc??''; fltTurno.value=s.fltTurno??'';
          fltSearch.value=s.fltSearch??''; fltList.value=s.fltList??'';
          toggleInclude.checked=!!s.includeMode; toggleLabel.textContent=s.includeMode?'Incluir lista':'Excluir lista';
          sortState=Array.isArray(s.sortState)?s.sortState:[]; refreshHeadSortClasses();
        }catch{}
      }

      // ===== Eventos UI =====
      const fltTL=document.getElementById('fltTL');
      const fltCamp=document.getElementById('fltCamp');
      const fltDesc=document.getElementById('fltDesc');
      const fltTurno=document.getElementById('fltTurno');
      const fltSearch=document.getElementById('fltSearch');
      const fltList=document.getElementById('fltList');
      const toggleInclude=document.getElementById('toggleInclude');
      const toggleLabel=document.getElementById('toggleLabel');

      document.getElementById('btnReset').addEventListener('click',()=>{ fltTL.value=''; fltCamp.value=''; fltDesc.value=''; fltTurno.value=''; fltSearch.value=''; fltList.value=''; toggleInclude.checked=true; toggleLabel.textContent='Incluir lista'; sortState=[]; resetHeadSortClasses(); applyFiltersAndRender(); toast('üîÑ Filtros restablecidos'); });
      document.getElementById('btnExport').addEventListener('click', exportCSV);
      document.getElementById('btnCopyPerop').addEventListener('click',()=>copyList(r=>r.perop,'PEROPs'));
      document.getElementById('btnCopyNames').addEventListener('click',()=>copyList(r=>r.nombre,'Nombres'));

      const onInput=debounce(applyFiltersAndRender,160);
      [fltTL,fltCamp,fltDesc,fltTurno].forEach(el=>el.addEventListener('change',applyFiltersAndRender));
      [fltSearch,fltList].forEach(el=>el.addEventListener('input',onInput));
      toggleInclude.addEventListener('change',()=>{ toggleLabel.textContent=toggleInclude.checked?'Incluir lista':'Excluir lista'; applyFiltersAndRender(); });

      document.querySelectorAll('#headRow th').forEach(th=> th.addEventListener('click',(e)=>cycleSort(th, e)));

      // Init
      resetHeadSortClasses();
      loadData();

      if(typeof window.gcLogout!=='function'){ console.warn('gcLogout no est√° definido en guard.js'); }
      try{ clearTimeout(window.__gc_vis_fallback); }catch(_){}
    </script>

    <!-- Normalizador de rutas (GitHub Pages / dominio propio) -->
    <script>
    (() => {
      const isGhProject = location.hostname.endsWith('github.io');
      const PROJECT_SLUG = 'Gestion-Center';
      const base = isGhProject ? `/${PROJECT_SLUG}/` : '/';

      document.querySelectorAll('nav a.nav-item[href], .brand[href]').forEach(a => {
        const href = a.getAttribute('href');
        if (!href || href.startsWith('#') || /^https?:\/\//i.test(href)) return;
        const clean = href.replace(/^\.?\//, '');
        a.setAttribute('href', base + clean);
      });

      const logo = document.querySelector('#brandLink img');
      if (logo) {
        let src = logo.getAttribute('src') || './images/logogestioncenter.png';
        if (!/^https?:\/\//i.test(src)) { src = src.replace(/^\.?\//, ''); logo.setAttribute('src', base + src); }
        const source = document.querySelector('#brandLink source');
        if (source) { let s = source.getAttribute('srcset') || './images/logogestioncenter.webp'; s = s.replace(/^\.?\//, ''); source.setAttribute('srcset', base + s); }
      }
    })();
    </script>
  </body>
</html>

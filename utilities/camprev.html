<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gestión Center — Selector de Apoyo 2.0</title>

    <!-- Shell BW: aplica bw.css y sidebar -->
    <script type="module" src="../assets/bw/shell.js"></script>

    <style>
      :root{ --bd:var(--gray-300); --txt-muted:var(--gray-700) }
      .cp-title{ margin:0; font-size:22px }

      /* Filtros */
      .filters{ display:grid; grid-template-columns:repeat(5,minmax(180px,1fr)); gap:12px; align-items:end }
      .filter-group{ display:flex; flex-direction:column; gap:6px }
      .filter-group label{ font-size:12px; color:var(--txt-muted) }
      .filter-group select,.filter-group input,.filter-group textarea{
        padding:10px 12px; border:1px solid var(--bd); border-radius:10px; height:40px; background:#fff; color:inherit; font:inherit; outline:none
      }
      .filter-group textarea{ height:auto; min-height:40px; resize:vertical; line-height:1.2 }
      .grid-span-3{ grid-column:span 3 }

      /* Tabla */
      .sort-none::after{content:""} .sort-desc::after{content:" ↓";font-weight:900} .sort-asc::after{content:" ↑";font-weight:900}
      .pct{font-weight:800} .pct.red{color:#ef4444} .pct.orange{color:#f59e0b} .pct.green{color:#22c55e}
      .perop{font-family:ui-monospace,Menlo,Consolas,monospace; font-size:13px; cursor:copy}

      #toast{ position:fixed; right:20px; bottom:18px; background:#111827; color:#fff; padding:12px 18px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.35); display:none; z-index:1000 }
      @media (max-width:1080px){ .filters{grid-template-columns:repeat(2,minmax(140px,1fr))} }
    </style>
  </head>
  <body>
    <gc-shell hero="off">
      <!-- Título -->
      <section class="gc-panel" style="margin-bottom:12px">
        <h1 class="cp-title">👥 Selector de Apoyo — Ver 2.0</h1>
      </section>

      <!-- Controles -->
      <section class="gc-panel" style="margin-bottom:12px">
        <div class="filters" style="margin-bottom:10px">
          <div class="filter-group"><label for="fltTL">Team Leader</label><select id="fltTL"><option value="">Todos</option></select></div>
          <div class="filter-group"><label for="fltCamp">Campaña</label><select id="fltCamp"><option value="">Todas</option></select></div>
          <div class="filter-group"><label for="fltDesc">Descanso</label><select id="fltDesc"><option value="">Todos</option></select></div>
          <div class="filter-group"><label for="fltTurno">Turno</label><select id="fltTurno"><option value="">Todos</option></select></div>
          <div class="filter-group"><label for="fltSearch">Buscar</label><input id="fltSearch" type="text" placeholder="Operador o PEROP1AM"/></div>

          <div class="filter-group grid-span-3">
            <label for="fltList">Lista PEROP1AM (uno por línea, o separados por , ;)</label>
            <textarea id="fltList" rows="4" placeholder="Ejemplo:
PEROP1AM-41058
PEROP1AM-39726
41058"></textarea>
          </div>

          <div class="filter-group">
            <label>Modo lista PEROP</label>
            <label style="display:inline-flex;align-items:center;gap:8px">
              <input type="checkbox" id="toggleInclude" checked style="width:18px;height:18px;accent-color:#16a34a">
              <span id="toggleLabel" style="font-size:13px;color:var(--gray-700)">Incluir lista</span>
            </label>
          </div>

          <div class="u-right">
            <span class="gc-chip gc-chip--dark" id="rowCounter">Mostrando 0 registros</span>
          </div>
        </div>

        <div class="gc-chipset" style="margin-bottom:10px">
          <span class="gc-chip" id="chipRows">0 filas</span>
          <span class="gc-chip" id="chipTLs">0 TLs únicos</span>
          <span class="gc-chip" id="chipCamps">0 campañas</span>
        </div>

        <div class="gc-toolbar">
          <button id="btnReset" class="gc-btn"><span class="gc-icon">🧹</span> Restablecer filtros</button>
          <!-- Eliminado Exportar (CSV) -->
          <button id="btnCopyPerop" class="gc-btn"><span class="gc-icon">📋</span> Copiar PEROPs filtrados</button>
          <button id="btnCopyNames" class="gc-btn"><span class="gc-icon">📋</span> Copiar Nombres filtrados</button>
          <button id="btnCopyBoth" class="gc-btn gc-btn--primary"><span class="gc-icon">📋</span> Copiar Nombres — PEROPs filtrados</button>
        </div>
      </section>

      <!-- Tabla -->
      <section class="gc-panel">
        <div style="overflow:auto">
          <table id="tblCampRev" class="gc-table gc-table--sticky"
                 title="Click: ordenar • Shift+Click: añadir como orden secundario • Clic repetido: descendente → ascendente → quitar">
            <thead>
              <tr id="headRow">
                <th data-col="teamLeader" class="sort-none">Team Leader</th>
                <th data-col="nombre" class="sort-none">Operador</th>
                <th data-col="perop" class="sort-none">PEROP1AM</th>
                <th data-col="campania" class="sort-none">Campaña</th>
                <th data-col="orders"   class="sort-none" style="text-align:right">Total Orders</th>
                <th data-col="approve"  class="sort-none" style="text-align:right">%Approve</th>
                <th data-col="reject"   class="sort-none" style="text-align:right">%Reject</th>
                <th data-col="trash"    class="sort-none" style="text-align:right">%Trash</th>
                <th data-col="avg"      class="sort-none" style="text-align:right">Avg Check</th>
                <th data-col="descanso" class="sort-none">Descanso</th>
                <th data-col="turno"    class="sort-none">Turno</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <div id="toast"></div>
    </gc-shell>

    <script type="module">
      /* =================== Helpers =================== */
      const $ = id => document.getElementById(id);
      const toast=(m)=>{const t=$('toast');t.textContent=m;t.style.display='block';t.style.opacity=1;setTimeout(()=>{t.style.transition='opacity .5s';t.style.opacity=0;},2600);setTimeout(()=>{t.style.display='none';t.style.transition='';},3200)}
      const norm = s => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim().toLowerCase();
      const debounce=(fn,ms=180)=>{let h;return (...a)=>{clearTimeout(h);h=setTimeout(()=>fn(...a),ms)}}
      const STATE_KEY='selector_apoyo_v2_state';

      function fallbackBase(){
        const host  = location.hostname;
        const parts = location.pathname.split("/").filter(Boolean);
        const repo  = "Gestion-Center";
        if (host.endsWith("github.io")) return `${location.origin}/${(parts[0]||repo)}/`;
        const idx = parts.indexOf(repo);
        if (idx !== -1) return `${location.origin}/${parts.slice(0, idx+1).join("/")}/`;
        return `${location.origin}/${repo}/`;
      }
      const BASE = (window.__GC_BASE__ || fallbackBase());
      const abs  = (p) => new URL(String(p||'').replace(/^\//,''), BASE).href;

      async function tryFetch(urls){
        let lastErr=null;
        for(const u of urls){
          try{
            const r=await fetch(u);
            if(r.ok) return await r.json();
            lastErr = new Error(`HTTP ${r.status} en ${u}`);
          }catch(e){ lastErr=e; }
        }
        throw lastErr || new Error('No se pudo cargar');
      }
      function candidatesOperations(){
        return [
          abs('operations/datadistribucion.json'),
          new URL('../operations/datadistribucion.json', location.href).href,
          `${location.origin}/Gestion-Center/operations/datadistribucion.json`,
        ];
      }
      function candidatesUtilities(){
        return [
          abs('utilities/datacamprev.json'),
          new URL('./datacamprev.json', location.href).href,
          `${location.origin}/Gestion-Center/utilities/datacamprev.json`,
        ];
      }

      let dataFinal=[], filtered=[], sortState=[];

      function uniqSorted(arr){ return [...new Set(arr.filter(v=>v!=null && String(v).trim()!==''))].sort((a,b)=>String(a).localeCompare(String(b),'es')); }
      function fillSelect(sel, values){
        sel.innerHTML='<option value="">'+(sel.id==='fltCamp'?'Todas':'Todos')+'</option>'+
          values.map(v=>`<option value="${String(v).replaceAll('"','&quot;')}">${v}</option>`).join('');
      }
      function buildFilters(rows){
        fillSelect($('fltTL'),   uniqSorted(rows.map(r=>r.teamLeader)));
        fillSelect($('fltCamp'), uniqSorted(rows.map(r=>r.campania)));
        fillSelect($('fltDesc'), uniqSorted(rows.map(r=>r.descanso)));
        fillSelect($('fltTurno'),uniqSorted(rows.map(r=>r.turno)));
      }
      function parsePeropList(raw){
        if(!raw) return { full:new Set(), digits:new Set() };
        const tokens=raw.split(/[\n,;]+/g).map(s=>s.replace(/\s+/g,'').toUpperCase()).filter(Boolean);
        const full=new Set(tokens);
        const digits=new Set(tokens.map(t=>{ const m=t.match(/(\d{3,})$/); return m?m[1]:''; }).filter(Boolean));
        return { full, digits };
      }

      function colorPct(val,type){
        const n=parseFloat(String(val).replace('%',''))||0;
        if(type==="approve"){ if(n<=24) return "red"; if(n<=29) return "orange"; return "green"; }
        if(type==="reject"||type==="trash"){ if(n<=7) return "green"; if(n<=14) return "orange"; return "red"; }
        return "";
      }
      function renderTable(rows){
        const tbody=document.querySelector('#tblCampRev tbody'); tbody.innerHTML='';
        const frag=document.createDocumentFragment();
        rows.forEach(r=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td>${r.teamLeader}</td>
            <td>${r.nombre}</td>
            <td class="perop" data-copy="${r.perop}">${r.perop}</td>
            <td>${r.campania}</td>
            <td style="text-align:right">${r.orders}</td>
            <td class="pct ${colorPct(r.approve,'approve')}" style="text-align:right">${r.approve}</td>
            <td class="pct ${colorPct(r.reject,'reject')}"  style="text-align:right">${r.reject}</td>
            <td class="pct ${colorPct(r.trash,'trash')}"    style="text-align:right">${r.trash}</td>
            <td style="text-align:right">$${(Number(r.avg)||0).toLocaleString('en-US',{minimumFractionDigits:0})}</td>
            <td>${r.descanso}</td>
            <td>${r.turno}</td>`;
          frag.appendChild(tr);
        });
        tbody.appendChild(frag);
        $('rowCounter').textContent=`Mostrando ${rows.length} registro${rows.length===1?'':'s'}`;
        tbody.querySelectorAll('td.perop').forEach(td=>{
          td.title='Click para copiar PEROP';
          td.addEventListener('click', async ()=>{
            const v=td.dataset.copy||td.textContent.trim();
            try{ await navigator.clipboard.writeText(v); toast('📋 PEROP copiado'); }catch{ toast('❌ No se pudo copiar'); }
          });
        });
      }
      function updateChips(rows){
        const tlSet=new Set(rows.map(r=>r.teamLeader).filter(Boolean));
        const campSet=new Set(rows.map(r=>r.campania).filter(Boolean));
        $('chipRows').textContent=`${rows.length} fila${rows.length===1?'':'s'}`;
        $('chipTLs').textContent=`${tlSet.size} TL${tlSet.size===1?'':'s'} únicos`;
        $('chipCamps').textContent=`${campSet.size} campaña${campSet.size===1?'':'s'}`;
      }

      function resetHeadSortClasses(){ document.querySelectorAll('#headRow th').forEach(th=>{ th.classList.remove('sort-asc','sort-desc'); th.classList.add('sort-none'); }); }
      function refreshHeadSortClasses(){ resetHeadSortClasses(); sortState.forEach(({col,mode})=>{ const th=document.querySelector(`#headRow th[data-col="${col}"]`); if(th&&mode){ th.classList.remove('sort-none'); th.classList.add(mode===1?'sort-desc':'sort-asc'); } }); }
      function cycleSort(th, e = { shiftKey:false }){
        const col = th?.dataset?.col; if(!col) return;
        const idx = sortState.findIndex(s => s.col === col);
        let next = 1;
        if (idx !== -1){
          const was = sortState[idx].mode;
          if (was === 1) next = 2;
          else if (was === 2){ sortState.splice(idx,1); refreshHeadSortClasses(); applyFiltersAndRender(); return; }
          sortState.splice(idx,1);
        }
        const entry = { col, mode: next };
        if (e.shiftKey) sortState.push(entry); else sortState.unshift(entry);
        refreshHeadSortClasses(); applyFiltersAndRender();
      }

      function applyFiltersAndRender(){
        const vTL = norm($('fltTL').value);
        const vCa = norm($('fltCamp').value);
        const vDe = norm($('fltDesc').value);
        const vTu = norm($('fltTurno').value);

        const qRaw = norm($('fltSearch').value);
        const qTokens = qRaw.split(/\s+/).filter(Boolean);

        const includeMode = $('toggleInclude').checked;
        const lists = parsePeropList($('fltList').value);

        filtered = dataFinal.filter(r=>{
          const a=norm(r.teamLeader), b=norm(r.nombre), c=norm(r.perop), d=norm(r.campania), e=norm(r.descanso), f=norm(r.turno);
          if (vTL && a!==vTL) return false;
          if (vCa && d!==vCa) return false;
          if (vDe && e!==vDe) return false;
          if (vTu && f!==vTu) return false;

          const peropClean=String(r.perop).replace(/\s+/g,'').toUpperCase();
          const peropNum=(peropClean.match(/(\d{3,})$/)||[])[1]||'';
          const hasList=(lists.full.size>0||lists.digits.size>0);
          if (hasList){
            const inList=lists.full.has(peropClean)||(peropNum && lists.digits.has(peropNum));
            if (includeMode && !inList) return false;
            if (!includeMode &&  inList) return false;
          }

          if (qTokens.length){
            const ok=qTokens.every(tok=> b.includes(tok)||c.includes(tok));
            if(!ok) return false;
          }
          return true;
        });

        if (sortState.length){
          filtered.sort((x,y)=>{
            for (const {col,mode} of sortState){
              let A=x[col], B=y[col];
              if(['orders','avg'].includes(col)){ A=Number(A)||0; B=Number(B)||0; }
              else if(['approve','reject','trash'].includes(col)){ A=parseFloat(String(A).replace('%',''))||0; B=parseFloat(String(B).replace('%',''))||0; }
              else { A=String(A); B=String(B); }
              const cmp=(typeof A==='number'&&typeof B==='number')?(A-B):A.localeCompare(B,'es',{numeric:true,sensitivity:'base'});
              if(cmp!==0) return mode===1 ? -cmp : cmp;
            }
            return 0;
          });
        }

        renderTable(filtered);
        updateChips(filtered);
        saveState();
      }

      function saveState(){
        const s={
          fltTL:$('fltTL').value, fltCamp:$('fltCamp').value, fltDesc:$('fltDesc').value, fltTurno:$('fltTurno').value,
          fltSearch:$('fltSearch').value, fltList:$('fltList').value, includeMode:$('toggleInclude').checked, sortState
        };
        try{ localStorage.setItem(STATE_KEY, JSON.stringify(s)); }catch{}
      }
      function restoreState(){
        try{
          const raw=localStorage.getItem(STATE_KEY); if(!raw) return;
          const s=JSON.parse(raw);
          $('fltTL').value=s.fltTL??''; $('fltCamp').value=s.fltCamp??''; $('fltDesc').value=s.fltDesc??''; $('fltTurno').value=s.fltTurno??'';
          $('fltSearch').value=s.fltSearch??''; $('fltList').value=s.fltList??'';
          $('toggleInclude').checked=!!s.includeMode; $('toggleLabel').textContent=s.includeMode?'Incluir lista':'Excluir lista';
          sortState=Array.isArray(s.sortState)?s.sortState:[]; refreshHeadSortClasses();
        }catch{}
      }

      async function copyList(getter,label){
        const arr=filtered.map(getter).filter(Boolean); if(!arr.length){ toast('ℹ️ Nada para copiar'); return; }
        const text=arr.join('\n'); try{ await navigator.clipboard.writeText(text); toast(`📋 ${label} copiad${arr.length===1?'o':'os'} (${arr.length})`); }catch{ toast('❌ No se pudo copiar'); }
      }
      async function copyNamesPerops(){
        if(!filtered.length){ toast('ℹ️ Nada para copiar'); return; }
        const text=filtered.map(r=>`${r.nombre}\t${r.perop}`).join('\n');
        try{ await navigator.clipboard.writeText(text); toast(`📋 Nombres — PEROPs copiados (${filtered.length})`); }catch{ toast('❌ No se pudo copiar'); }
      }

      /* =================== INIT (esperando a gc-shell) =================== */
      (async function init(){
        // Espera a que el custom element esté listo y haya renderizado el DOM
        await customElements.whenDefined('gc-shell');
        await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));

        // Cargar data
        try{
          const distrib = await tryFetch(candidatesOperations());
          const camp    = await tryFetch(candidatesUtilities());
          dataFinal=camp.reduce((acc,row)=>{
            const op=distrib.find(o=>String(o.C)===String(row.A));
            if(op){
              acc.push({
                teamLeader: op.A||'', nombre: op.B||'', perop: row.A||'', campania: row.B||'',
                orders: Number(row.C)||0, approve: String(row.E||''), reject: String(row.M||''), trash: String(row.O||''),
                avg: Number(row.P)||0, descanso: op.E||'', turno: op.F||''
              });
            }
            return acc;
          },[]);
        }catch(e){
          console.error('[camprev] Error cargando JSON:', e);
          toast('❌ No se pudieron cargar los JSON');
          return;
        }

        buildFilters(dataFinal);
        restoreState();
        applyFiltersAndRender();
        toast('✅ Datos cargados');

        // Listeners (ya con DOM definitivo)
        $('headRow').addEventListener('click', (e)=>{
          const th = e.target.closest('th[data-col]'); if(!th) return; cycleSort(th, e);
        });
        const onInput=debounce(applyFiltersAndRender,160);
        ['fltTL','fltCamp','fltDesc','fltTurno'].forEach(id=>$(id).addEventListener('change',applyFiltersAndRender));
        ['fltSearch','fltList'].forEach(id=>$(id).addEventListener('input',onInput));
        $('toggleInclude').addEventListener('change',()=>{ $('toggleLabel').textContent=$('toggleInclude').checked?'Incluir lista':'Excluir lista'; applyFiltersAndRender(); });

        $('btnReset').addEventListener('click',()=>{
          $('fltTL').value=''; $('fltCamp').value=''; $('fltDesc').value=''; $('fltTurno').value='';
          $('fltSearch').value=''; $('fltList').value='';
          $('toggleInclude').checked=true; $('toggleLabel').textContent='Incluir lista';
          sortState=[]; resetHeadSortClasses(); applyFiltersAndRender(); toast('🔄 Filtros restablecidos');
        });

        $('btnCopyPerop').addEventListener('click',()=>copyList(r=>r.perop,'PEROPs'));
        $('btnCopyNames').addEventListener('click',()=>copyList(r=>r.nombre,'Nombres'));
        $('btnCopyBoth').addEventListener('click',copyNamesPerops);

        // atajo: X alterna incluir/excluir
        document.addEventListener('keydown',(e)=>{ if(e.key.toLowerCase()==='x'){ const t=$('toggleInclude'); t.checked=!t.checked; $('toggleLabel').textContent=t.checked?'Incluir lista':'Excluir lista'; applyFiltersAndRender(); } });
      })();
    </script>
  </body>
</html>

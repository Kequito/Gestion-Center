<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gesti√≥n Center ‚Äî Selector de Apoyo 2.0</title>

    <!-- Shell del ecosistema BW (desde /utilities/ sube un nivel) -->
    <script type="module" src="../assets/bw/shell.js"></script>

    <style>
      /* ===== Camprev ‚Äî estilos m√≠nimos complementarios (el resto viene de bw.css) ===== */

      :root{
        --bd: var(--gray-300);
        --txt-muted: var(--gray-700);
      }

      /* Panel superior con t√≠tulo */
      .cp-title{ margin:0; font-size:22px }

      /* Filtros */
      .filters{
        display:grid; grid-template-columns:repeat(5, minmax(180px,1fr));
        gap:12px; align-items:end;
      }
      .filter-group{ display:flex; flex-direction:column; gap:6px }
      .filter-group label{ font-size:12px; color:var(--txt-muted) }
      .filter-group select,
      .filter-group input[type="text"],
      .filter-group textarea{
        padding:10px 12px; border-radius:10px; border:1px solid var(--bd);
        background:#fff; height:40px; outline:none; appearance:none;
        font:inherit; color:inherit;
      }
      .filter-group textarea{ height:auto; min-height:40px; resize:vertical; line-height:1.2 }
      .grid-span-3{ grid-column: span 3; }

      /* Tabla: indicadores de orden */
      .sort-none::after{ content:"" }
      .sort-desc::after{ content:" ‚Üì"; font-weight:900 }
      .sort-asc::after{ content:" ‚Üë"; font-weight:900 }

      /* Colores de % */
      .pct{ font-weight:800 }
      .pct.red{ color:#ef4444 } .pct.orange{ color:#f59e0b } .pct.green{ color:#22c55e }

      .perop{ font-family:ui-monospace,Menlo,Consolas,monospace; font-size:13px; cursor:copy }

      /* Toast */
      #toast{
        position:fixed; bottom:18px; right:20px; background:#111827; color:#fff;
        padding:12px 18px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.35);
        display:none; z-index:1000
      }

      /* Responsivo */
      @media (max-width:1080px){
        .filters{ grid-template-columns:repeat(2, minmax(140px,1fr)) }
      }
    </style>
  </head>
  <body>
    <!-- Shell sin hero (hero="off") mantiene sidebar BW y aplica bw.css -->
    <gc-shell hero="off">
      <!-- ===== T√≠tulo ===== -->
      <section class="gc-panel" style="margin-bottom:12px">
        <h1 class="cp-title">üë• Selector de Apoyo ‚Äî Ver 2.0</h1>
      </section>

      <!-- ===== Controles ===== -->
      <section class="gc-panel" style="margin-bottom:12px">
        <div class="filters" style="margin-bottom:10px">
          <div class="filter-group">
            <label for="fltTL">Team Leader</label>
            <select id="fltTL"><option value="">Todos</option></select>
          </div>
          <div class="filter-group">
            <label for="fltCamp">Campa√±a</label>
            <select id="fltCamp"><option value="">Todas</option></select>
          </div>
          <div class="filter-group">
            <label for="fltDesc">Descanso</label>
            <select id="fltDesc"><option value="">Todos</option></select>
          </div>
          <div class="filter-group">
            <label for="fltTurno">Turno</label>
            <select id="fltTurno"><option value="">Todos</option></select>
          </div>
          <div class="filter-group">
            <label for="fltSearch">Buscar</label>
            <input id="fltSearch" type="text" placeholder="Operador o PEROP1AM"/>
          </div>

          <div class="filter-group grid-span-3">
            <label for="fltList">Lista PEROP1AM (uno por l√≠nea, o separados por , ;)</label>
            <textarea id="fltList" rows="4" placeholder="Ejemplo:
PEROP1AM-41058
PEROP1AM-39726
41058"></textarea>
          </div>

          <div class="filter-group">
            <label>Modo lista PEROP</label>
            <label title="Presiona X para alternar" style="display:inline-flex;align-items:center;gap:8px">
              <input type="checkbox" id="toggleInclude" checked style="width:18px;height:18px;accent-color:#16a34a"/>
              <span id="toggleLabel" style="font-size:13px;color:var(--gray-700)">Incluir lista</span>
            </label>
          </div>

          <div class="u-right">
            <span class="gc-chip gc-chip--dark" id="rowCounter">Mostrando 0 registros</span>
          </div>
        </div>

        <div class="gc-chipset" style="margin-bottom:10px">
          <span class="gc-chip" id="chipRows">0 filas</span>
          <span class="gc-chip" id="chipTLs">0 TLs √∫nicos</span>
          <span class="gc-chip" id="chipCamps">0 campa√±as</span>
        </div>

        <div class="gc-toolbar">
          <button id="btnReset" class="gc-btn">
            <span class="gc-icon">üßπ</span> Restablecer filtros
          </button>
          <button id="btnExport" class="gc-btn gc-btn--primary">
            <span class="gc-icon">‚¨áÔ∏è</span> Exportar (CSV)
          </button>
          <button id="btnCopyPerop" class="gc-btn">
            <span class="gc-icon">üìã</span> Copiar PEROPs filtrados
          </button>
          <button id="btnCopyNames" class="gc-btn">
            <span class="gc-icon">üìã</span> Copiar Nombres filtrados
          </button>
        </div>
      </section>

      <!-- ===== Tabla ===== -->
      <section class="gc-panel">
        <div style="overflow:auto">
          <table id="tblCampRev" class="gc-table gc-table--sticky"
                 title="Click: ordenar ‚Ä¢ Shift+Click: a√±adir como orden secundario ‚Ä¢ Clic repetido: descendente ‚Üí ascendente ‚Üí quitar">
            <thead>
              <tr id="headRow">
                <th data-col="teamLeader" class="sort-none">Team Leader</th>
                <th data-col="nombre" class="sort-none">Operador</th>
                <th data-col="perop" class="sort-none">PEROP1AM</th>
                <th data-col="campania" class="sort-none">Campa√±a</th>
                <th data-col="orders" class="sort-none" style="text-align:right">Total Orders</th>
                <th data-col="approve" class="sort-none" style="text-align:right">%Approve</th>
                <th data-col="reject" class="sort-none" style="text-align:right">%Reject</th>
                <th data-col="trash" class="sort-none" style="text-align:right">%Trash</th>
                <th data-col="avg" class="sort-none" style="text-align:right">Avg Check</th>
                <th data-col="descanso" class="sort-none">Descanso</th>
                <th data-col="turno" class="sort-none">Turno</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <div id="toast"></div>
    </gc-shell>

    <script type="module">
      /* =========================================================
         Camprev ‚Äî l√≥gica con bw.css + gc-shell
         ========================================================= */

      // ===== BASE robusto (usa __GC_BASE__ si shell ya lo calcul√≥) =====
      function fallbackBase(){
        const host  = location.hostname;
        const parts = location.pathname.split("/").filter(Boolean);
        const repo  = "Gestion-Center";
        if (host.endsWith("github.io")){
          return `${location.origin}/${(parts[0]||repo)}/`;
        }
        const idx = parts.indexOf(repo);
        if (idx !== -1) return `${location.origin}/${parts.slice(0, idx+1).join("/")}/`;
        return `${location.origin}/${repo}/`;
      }
      const BASE = (window.__GC_BASE__ || fallbackBase());
      const abs  = (p) => new URL(String(p||'').replace(/^\//,''), BASE).href;

      // ===== Helpers =====
      const toast=(m)=>{const t=document.getElementById('toast');t.textContent=m;t.style.display='block';t.style.opacity=1;setTimeout(()=>{t.style.transition='opacity .5s';t.style.opacity=0;},2600);setTimeout(()=>{t.style.display='none';t.style.transition='';},3200)}
      const norm = s => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim().toLowerCase();
      const debounce=(fn,ms=180)=>{let h;return (...a)=>{clearTimeout(h);h=setTimeout(()=>fn(...a),ms)}}
      const STATE_KEY='selector_apoyo_v2_state';

      let rawDistrib=[]; let rawCamp=[]; let dataFinal=[]; let filtered=[]; let sortState=[];

      // Espera a que el shell haya pintado el contenido (tabla presente)
      function waitFor(sel, timeout=8000){
        return new Promise((res,rej)=>{
          const t0=performance.now();
          (function loop(){
            const el=document.querySelector(sel);
            if(el) return res(el);
            if(performance.now()-t0>timeout) return rej(new Error('timeout waiting '+sel));
            requestAnimationFrame(loop);
          })();
        });
      }

      // ===== Carga =====
      async function loadJSON(url){
        const sep=url.includes('?')?'&':'?';
        const r=await fetch(url+sep+'t='+(Date.now()));
        if(!r.ok) throw new Error('HTTP '+r.status);
        return r.json();
      }
      async function loadData(){
        const [distrib,camp]=await Promise.all([
          loadJSON(abs('operations/datadistribucion.json')),
          loadJSON(abs('utilities/datacamprev.json')),
        ]);
        rawDistrib=distrib; rawCamp=camp;

        dataFinal=rawCamp.reduce((acc,row)=>{
          const op=rawDistrib.find(o=>String(o.C)===String(row.A));
          if(op){
            acc.push({
              teamLeader: op.A||'', nombre: op.B||'', perop: row.A||'', campania: row.B||'',
              orders: Number(row.C)||0, approve: String(row.E||''), reject: String(row.M||''), trash: String(row.O||''),
              avg: Number(row.P)||0, descanso: op.E||'', turno: op.F||''
            });
          }
          return acc;
        },[]);
      }

      // ===== Filtros =====
      function uniqSorted(arr){ return [...new Set(arr.filter(v=>v!=null && String(v).trim()!==''))].sort((a,b)=>String(a).localeCompare(String(b),'es')); }
      function fillSelect(sel, values){
        sel.innerHTML='<option value="">'+(sel.id==='fltCamp'?'Todas':'Todos')+'</option>'+
          values.map(v=>`<option value="${String(v).replaceAll('"','&quot;')}">${v}</option>`).join('');
      }
      function buildFilters(rows){
        fillSelect(document.getElementById('fltTL'),   uniqSorted(rows.map(r=>r.teamLeader)));
        fillSelect(document.getElementById('fltCamp'), uniqSorted(rows.map(r=>r.campania)));
        fillSelect(document.getElementById('fltDesc'), uniqSorted(rows.map(r=>r.descanso)));
        fillSelect(document.getElementById('fltTurno'),uniqSorted(rows.map(r=>r.turno)));
      }
      function parsePeropList(raw){
        if(!raw) return { full:new Set(), digits:new Set() };
        const tokens=raw.split(/[\n,;]+/g).map(s=>s.replace(/\s+/g,'').toUpperCase()).filter(Boolean);
        const full=new Set(tokens);
        const digits=new Set(tokens.map(t=>{ const m=t.match(/(\d{3,})$/); return m?m[1]:''; }).filter(Boolean));
        return { full, digits };
      }

      // ===== Render =====
      function colorPct(val,type){
        const n=parseFloat(String(val).replace('%',''))||0;
        if(type==="approve"){ if(n<=24) return "red"; if(n<=29) return "orange"; return "green"; }
        if(type==="reject"||type==="trash"){ if(n<=7) return "green"; if(n<=14) return "orange"; return "red"; }
        return "";
      }
      function renderTable(rows){
        const tbody=document.querySelector('#tblCampRev tbody'); tbody.innerHTML='';
        const frag=document.createDocumentFragment();
        rows.forEach(r=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td>${r.teamLeader}</td>
            <td>${r.nombre}</td>
            <td class="perop" data-copy="${r.perop}">${r.perop}</td>
            <td>${r.campania}</td>
            <td style="text-align:right">${r.orders}</td>
            <td class="pct ${colorPct(r.approve,'approve')}" style="text-align:right">${r.approve}</td>
            <td class="pct ${colorPct(r.reject,'reject')}" style="text-align:right">${r.reject}</td>
            <td class="pct ${colorPct(r.trash,'trash')}" style="text-align:right">${r.trash}</td>
            <td style="text-align:right">$${(Number(r.avg)||0).toLocaleString('en-US',{minimumFractionDigits:0})}</td>
            <td>${r.descanso}</td>
            <td>${r.turno}</td>`;
          frag.appendChild(tr);
        });
        tbody.appendChild(frag);
        document.getElementById('rowCounter').textContent=`Mostrando ${rows.length} registro${rows.length===1?'':'s'}`;
        tbody.querySelectorAll('td.perop').forEach(td=>{
          td.title='Click para copiar PEROP';
          td.addEventListener('click', async ()=>{
            const v=td.dataset.copy||td.textContent.trim();
            try{ await navigator.clipboard.writeText(v); toast('üìã PEROP copiado'); }catch{ toast('‚ùå No se pudo copiar'); }
          });
        });
      }
      function updateChips(rows){
        const tlSet=new Set(rows.map(r=>r.teamLeader).filter(Boolean));
        const campSet=new Set(rows.map(r=>r.campania).filter(Boolean));
        document.getElementById('chipRows').textContent=`${rows.length} fila${rows.length===1?'':'s'}`;
        document.getElementById('chipTLs').textContent=`${tlSet.size} TL${tlSet.size===1?'':'s'} √∫nicos`;
        document.getElementById('chipCamps').textContent=`${campSet.size} campa√±a${campSet.size===1?'':'s'}`;
      }

      // ===== Orden acumulativo =====
      function resetHeadSortClasses(){ document.querySelectorAll('#headRow th').forEach(th=>{ th.classList.remove('sort-asc','sort-desc'); th.classList.add('sort-none'); }); }
      function refreshHeadSortClasses(){ resetHeadSortClasses(); sortState.forEach(({col,mode})=>{ const th=document.querySelector(`#headRow th[data-col="${col}"]`); if(th&&mode){ th.classList.remove('sort-none'); th.classList.add(mode===1?'sort-desc':'sort-asc'); } }); }
      function cycleSort(th, e = { shiftKey:false }){
        const col = th?.dataset?.col; if(!col) return;
        const idx = sortState.findIndex(s => s.col === col);
        let next = 1; // DESC
        if (idx !== -1){
          const was = sortState[idx].mode;
          if (was === 1) next = 2;           // ASC
          else if (was === 2){               // NONE
            sortState.splice(idx,1); refreshHeadSortClasses(); applyFiltersAndRender(); return;
          }
          sortState.splice(idx,1);
        }
        const entry = { col, mode: next };
        if (e.shiftKey) sortState.push(entry); else sortState.unshift(entry);
        refreshHeadSortClasses(); applyFiltersAndRender();
      }

      // ===== Aplicar filtros =====
      function applyFiltersAndRender(){
        const vTL = norm(document.getElementById('fltTL').value);
        const vCa = norm(document.getElementById('fltCamp').value);
        const vDe = norm(document.getElementById('fltDesc').value);
        const vTu = norm(document.getElementById('fltTurno').value);

        const qRaw = norm(document.getElementById('fltSearch').value);
        theTokens = qRaw.split(/\s+/).filter(Boolean);
        const qTokens = theTokens;

        const includeMode = document.getElementById('toggleInclude').checked;
        const lists = parsePeropList(document.getElementById('fltList').value);

        filtered = dataFinal.filter(r=>{
          const a=norm(r.teamLeader), b=norm(r.nombre), c=norm(r.perop), d=norm(r.campania), e=norm(r.descanso), f=norm(r.turno);
          if (vTL && a!==vTL) return false;
          if (vCa && d!==vCa) return false;
          if (vDe && e!==vDe) return false;
          if (vTu && f!==vTu) return false;

          const peropClean=String(r.perop).replace(/\s+/g,'').toUpperCase();
          const peropNum=(peropClean.match(/(\d{3,})$/)||[])[1]||'';
          const hasList=(lists.full.size>0||lists.digits.size>0);
          if (hasList){
            const inList=lists.full.has(peropClean)||(peropNum && lists.digits.has(peropNum));
            if (includeMode && !inList) return false;
            if (!includeMode &&  inList) return false;
          }

          if (qTokens.length){
            const ok=qTokens.every(tok=> b.includes(tok)||c.includes(tok));
            if(!ok) return false;
          }
          return true;
        });

        if (sortState.length){
          filtered.sort((x,y)=>{
            for (const {col,mode} of sortState){
              let A=x[col], B=y[col];
              if(['orders','avg'].includes(col)){ A=Number(A)||0; B=Number(B)||0; }
              else if(['approve','reject','trash'].includes(col)){ A=parseFloat(String(A).replace('%',''))||0; B=parseFloat(String(B).replace('%',''))||0; }
              else { A=String(A); B=String(B); }
              const cmp=(typeof A==='number'&&typeof B==='number')?(A-B):A.localeCompare(B,'es',{numeric:true,sensitivity:'base'});
              if(cmp!==0) return mode===1 ? -cmp : cmp; // 1=desc, 2=asc
            }
            return 0;
          });
        }

        renderTable(filtered);
        updateChips(filtered);
        saveState();
      }

      // ===== Persistencia =====
      function saveState(){
        const s={
          fltTL:fltTL.value, fltCamp:fltCamp.value, fltDesc:fltDesc.value, fltTurno:fltTurno.value,
          fltSearch:fltSearch.value, fltList:fltList.value, includeMode:toggleInclude.checked, sortState
        };
        try{ localStorage.setItem(STATE_KEY, JSON.stringify(s)); }catch{}
      }
      function restoreState(){
        try{
          const raw=localStorage.getItem(STATE_KEY); if(!raw) return;
          const s=JSON.parse(raw);
          fltTL.value=s.fltTL??''; fltCamp.value=s.fltCamp??''; fltDesc.value=s.fltDesc??''; fltTurno.value=s.fltTurno??'';
          fltSearch.value=s.fltSearch??''; fltList.value=s.fltList??'';
          toggleInclude.checked=!!s.includeMode; toggleLabel.textContent=s.includeMode?'Incluir lista':'Excluir lista';
          sortState=Array.isArray(s.sortState)?s.sortState:[]; refreshHeadSortClasses();
        }catch{}
      }

      // ===== Boot =====
      (async function boot(){
        await waitFor('#tblCampRev');

        try{
          await loadData();
          buildFilters(dataFinal);
          restoreState();
          applyFiltersAndRender();
          toast('‚úÖ Datos cargados');
        }catch(e){
          console.error(e); toast('‚ùå No se pudieron cargar los JSON');
        }

        // Delegaci√≥n sort
        document.getElementById('headRow').addEventListener('click', (e)=>{
          const th = e.target.closest('th[data-col]');
          if(!th) return;
          cycleSort(th, e);
        });

        // Filtros
        const onInput=debounce(applyFiltersAndRender,160);
        ['fltTL','fltCamp','fltDesc','fltTurno'].forEach(id=>{
          document.getElementById(id).addEventListener('change', applyFiltersAndRender);
        });
        ['fltSearch','fltList'].forEach(id=>{
          document.getElementById(id).addEventListener('input', onInput);
        });
        toggleInclude.addEventListener('change', ()=>{
          toggleLabel.textContent = toggleInclude.checked?'Incluir lista':'Excluir lista';
          applyFiltersAndRender();
        });

        // Acciones
        document.getElementById('btnReset').addEventListener('click', ()=>{
          fltTL.value=''; fltCamp.value=''; fltDesc.value=''; fltTurno.value='';
          fltSearch.value=''; fltList.value='';
          toggleInclude.checked=true; toggleLabel.textContent='Incluir lista';
          sortState=[]; resetHeadSortClasses(); applyFiltersAndRender(); toast('üîÑ Filtros restablecidos');
        });
        document.getElementById('btnExport').addEventListener('click', exportCSV);
        document.getElementById('btnCopyPerop').addEventListener('click',()=>copyList(r=>r.perop,'PEROPs'));
        document.getElementById('btnCopyNames').addEventListener('click',()=>copyList(r=>r.nombre,'Nombres'));

        // Atajo: X alterna modo lista
        document.addEventListener('keydown',(e)=>{
          if(e.key.toLowerCase()==='x'){
            toggleInclude.checked=!toggleInclude.checked;
            toggleLabel.textContent=toggleInclude.checked?'Incluir lista':'Excluir lista';
            applyFiltersAndRender();
          }
        });
      })();

      // ===== Exportar / Copiar =====
      function exportCSV(){
        if(!filtered.length){ toast('‚ÑπÔ∏è No hay filas para exportar'); return; }
        const headers=['Team Leader','Operador','PEROP1AM','Campa√±a','Total Orders','%Approve','%Reject','%Trash','Avg Check','Descanso','Turno'];
        const rows=filtered.map(r=>[r.teamLeader,r.nombre,r.perop,r.campania,r.orders,r.approve,r.reject,r.trash,r.avg,r.descanso,r.turno]);
        const csv=[headers,...rows].map(row=>row.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob=new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download=`camprev_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click();
        document.body.removeChild(a); URL.revokeObjectURL(url);
      }
      async function copyList(getter,label){
        const arr=filtered.map(getter).filter(Boolean); if(!arr.length){ toast('‚ÑπÔ∏è Nada para copiar'); return; }
        const text=arr.join('\n'); try{ await navigator.clipboard.writeText(text); toast(`üìã ${label} copiad${arr.length===1?'o':'os'} (${arr.length})`); }catch{ toast('‚ùå No se pudo copiar'); }
      }
    </script>
  </body>
</html>

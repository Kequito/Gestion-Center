<!DOCTYPE html>
<html lang="es" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gesti√≥n Center ‚Äî v2.0 (BW)</title>

    <!-- Fuente √∫nica -->
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;700&display=swap" rel="stylesheet"/>

    <!-- üîí Ocultar hasta validar sesi√≥n -->
    <style>html{visibility:hidden}</style>

    <!-- Bootloader: evita blanco y carga guard con BASE absoluto -->
    <script type="module">
      // Watchdog anti-pantalla-blanca
      window.__guardWatchdog = setTimeout(() => {
        try { document.documentElement.style.visibility = 'visible'; } catch(e){}
      }, 2500);

      // BASE robusto (GitHub Pages repo vs dominio propio)
      const isGh = location.hostname.endsWith('github.io');
      const parts = location.pathname.split('/').filter(Boolean);
      const repo = isGh ? (parts[0] || '') : '';
      const BASE = isGh ? `/${repo}/` : '/';
      const abs = (p) => new URL(p.replace(/^\//,''), location.origin + BASE).href;

      try {
        await import(abs('assets/guard.js'));
      } catch (e) {
        console.error('[index2] No se pudo cargar guard.js:', e);
        if (typeof window.gcLogout !== 'function') {
          window.gcLogout = () => { location.href = abs('login.html'); };
        }
        document.documentElement.style.visibility = 'visible';
      } finally {
        if (window.__guardWatchdog) clearTimeout(window.__guardWatchdog);
      }
    </script>

    <noscript><style>html{visibility:visible}</style></noscript>

    <style>
      /* =========================
         Dise√±o B/N minimal ‚Äî rendimiento
         ========================= */
      :root{
        --font:'Lexend', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        --black:#0a0a0a;
        --white:#ffffff;
        --gray-900:#111111;
        --gray-700:#3f3f3f;
        --gray-500:#737373;
        --gray-300:#d4d4d4;
        --gray-200:#e5e5e5;
        --gray-100:#f5f5f5;

        --sidebar-w:280px;
        --sidebar-w-compact:72px;
        --radius:12px;
      }

      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0; font-family:var(--font);
        background:var(--white); color:var(--gray-900);
        -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      }

      /* ===== Sidebar ===== */
      aside{
        position:fixed; inset:0 auto 0 0; z-index:20;
        width:var(--sidebar-w);
        background:var(--black); color:var(--white);
        border-right:1px solid var(--gray-300);
        display:flex; flex-direction:column; gap:12px;
        padding:12px; overflow:auto;
      }
      .brand{
        display:flex; align-items:center; justify-content:center;
        border:1px solid var(--gray-300); border-radius:var(--radius);
        padding:10px; text-decoration:none; background:var(--gray-900);
      }
      .brand img{width:160px; height:auto; display:block}

      .sidebar-toggle{
        width:100%; border:1px solid var(--gray-300);
        background:transparent; color:var(--white);
        border-radius:10px; padding:10px 12px; font-weight:700; cursor:pointer;
        display:flex; align-items:center; justify-content:center; gap:8px;
        min-height:44px; line-height:1.1; white-space:nowrap;
      }
      .sidebar-toggle .icon{ font-size:16px }

      nav{display:flex; flex-direction:column; gap:10px}

      .nav-group{
        border:1px solid var(--gray-300); border-radius:12px;
        overflow:hidden; background:#0f0f0f;
      }
      .nav-head{
        width:100%; background:transparent; color:var(--white);
        text-align:left; padding:10px 12px; border:0; cursor:pointer;
        font-weight:700; display:flex; align-items:center; gap:8px;
      }
      .nav-body{ display:block; padding:6px }
      .nav-group.is-collapsed .nav-body{ display:none }   /* <- colapsable OK */

      .nav-item{
        display:flex; align-items:center; gap:10px;
        color:var(--white); text-decoration:none;
        padding:12px 12px; border-radius:10px;
        margin:4px; background:transparent;
      }
      .nav-item:hover{ background:#141414 }
      .nav-item.active{
        background:var(--white); color:var(--gray-900);
        border-left:3px solid var(--gray-900); border-radius:10px;
      }

      .spacer{flex:1}

      .role-card{
        display:flex; align-items:center; gap:10px;
        padding:10px; border:1px solid var(--gray-300); border-radius:10px;
        background:#0f0f0f; color:var(--white);
      }
      .role-dot{width:14px; height:14px; border-radius:50%; background:var(--gray-500)}
      .role-badge{font-size:12px; padding:2px 8px; border:1px solid var(--gray-300); border-radius:999px}

      .logout{
        width:100%; padding:12px; border-radius:10px;
        border:1px solid var(--gray-300); background:#1a1a1a; color:#fff; cursor:pointer; font-weight:700;
      }

      /* ===== Main ===== */
      main{ margin-left:var(--sidebar-w); padding:20px }
      .hero{
        border:1px solid var(--gray-300); border-radius:var(--radius);
        padding:14px; background:var(--gray-100);
      }
      .hero h1{margin:0 0 6px; font-size:22px}
      .hero p{margin:0; color:var(--gray-700); font-size:14px}

      .grid{display:grid; gap:12px; margin-top:14px; grid-template-columns:repeat(2, minmax(280px, 1fr))}
      .card{
        border:1px solid var(--gray-300); border-radius:var(--radius);
        padding:12px; background:var(--white);
      }
      .card h3{margin:0 0 8px; font-size:15px}
      .card a{
        display:flex; align-items:center; gap:8px;
        color:var(--gray-900); text-decoration:none; padding:8px 0; border-top:1px solid var(--gray-200)
      }
      .card a:first-of-type{border-top:0}
      .card a:hover{ background:var(--gray-100) }

      /* ===== Compacto ===== */
      body.sidebar-compact aside{ width:var(--sidebar-w-compact) }
      body.sidebar-compact main{ margin-left:var(--sidebar-w-compact) }
      body.sidebar-compact .brand img{ width:42px }
      body.sidebar-compact .nav-head .txt,
      body.sidebar-compact .nav-item .label,
      body.sidebar-compact .sidebar-toggle .lbl,
      body.sidebar-compact .role-text{ display:none }

      /* ‚úÖ ajustes visuales compactos para que NO se mezclen */
      body.sidebar-compact .nav-head{ justify-content:center; padding:8px }
      body.sidebar-compact .nav-body{ padding:4px 2px }
      body.sidebar-compact .nav-item{
        margin:6px; padding:10px 0;
        justify-content:center; min-height:40px;
        border-radius:12px;
      }
      body.sidebar-compact .nav-item.active{
        border-left:none;          /* no borde que deforma */
        background:var(--white);
        color:var(--gray-900);
        outline:2px solid var(--white); /* halo blanco sutil */
      }

      /* ===== Responsive ===== */
      @media (max-width:1080px){
        main{margin-left:0}
        aside{position:sticky; width:auto; inset:auto}
        body.sidebar-compact aside{width:auto}
        body.sidebar-compact main{margin-left:0}
        .grid{grid-template-columns:1fr}
      }

      /* Foco accesible (alto contraste) */
      .nav-item:focus-visible,
      .nav-head:focus-visible,
      .sidebar-toggle:focus-visible,
      .logout:focus-visible,
      .brand:focus-visible{
        outline:2px solid var(--white); outline-offset:2px;
      }
    </style>
  </head>
  <body>
    <!-- ===== SIDEBAR ===== -->
    <aside id="gc-aside">
      <a class="brand" href="./index.html" id="brandLink" aria-label="Inicio" title="Inicio">
        <picture>
          <source srcset="./images/logogestioncenter.webp" type="image/webp"/>
        <img id="brandLogo" src="./images/logogestioncenter.png" alt="Gesti√≥n Center" loading="lazy" decoding="async"/>
        </picture>
      </a>

      <button class="sidebar-toggle" id="btnSidebarToggle" aria-pressed="false" title="Compactar / Expandir">
        <span class="icon">‚áÜ</span><span class="lbl">Cambiar ancho</span>
      </button>

      <nav id="gc-nav" role="navigation" aria-label="Navegaci√≥n principal">
        <a href="./index.html" class="nav-item" title="Inicio">üè† <span class="label">Inicio</span></a>

        <!-- REPORTES -->
        <section class="nav-group" data-key="grp-reportes">
          <button class="nav-head" title="Reportes" aria-expanded="true">
            <span class="chev">‚ñæ</span> <span class="txt">Reportes</span>
          </button>
          <div class="nav-body">
            <a href="/reports/newreport.html" class="nav-item" title="New Report">üß∞ <span class="label">New Report</span></a>
            <a href="/reports/psreport.html" class="nav-item" title="Post-Sale Report">üöö <span class="label">Post-Sale Report</span></a>
          </div>
        </section>

        <!-- OPERACIONES -->
        <section class="nav-group" data-key="grp-operaciones">
          <button class="nav-head" title="Operaciones" aria-expanded="true">
            <span class="chev">‚ñæ</span> <span class="txt">Operaciones</span>
          </button>
          <div class="nav-body">
            <a href="/operations/distribucion.html" class="nav-item" title="Distribuci√≥n">üìã <span class="label">Distribuci√≥n</span></a>
            <a href="/operations/biops.html" class="nav-item" title="BI de OPs + Links">üîó <span class="label">BI de OPs + Links</span></a>
          </div>
        </section>

        <!-- COBERTURA -->
        <section class="nav-group" data-key="grp-cobertura">
          <button class="nav-head" title="Cobertura" aria-expanded="true">
            <span class="chev">‚ñæ</span> <span class="txt">Cobertura</span>
          </button>
          <div class="nav-body">
            <a href="./cobertura.html" class="nav-item" title="Mapa de cobertura">üó∫Ô∏è <span class="label">Mapa de cobertura</span></a>
            <a href="./newcobertura.html" class="nav-item" title="New Cobertura 1.1">üß≠ <span class="label">New Cobertura 1.1</span></a>
          </div>
        </section>

        <!-- UTILIDADES -->
        <section class="nav-group" data-key="grp-utils">
          <button class="nav-head" title="Utilidades" aria-expanded="true">
            <span class="chev">‚ñæ</span> <span class="txt">Utilidades</span>
          </button>
          <div class="nav-body">
            <a href="/utilities/camprev.html" class="nav-item" title="Selector de Apoyo 2.0">üë• <span class="label">Selector de Apoyo 2.0</span></a>
          </div>
        </section>
      </nav>

      <div class="spacer"></div>

      <div class="role-card" id="roleCard" title="Rango del usuario">
        <div class="role-dot" id="roleDot"></div>
        <div class="role-text">
          <strong id="roleName">Invitado</strong>
          <span class="role-badge" id="roleBadge" style="margin-left:6px">Invitado</span><br/>
          <small id="roleDesc">Acceso limitado</small>
        </div>
      </div>

      <button class="logout" onclick="gcLogout()">Salir</button>
    </aside>

    <!-- ===== CONTENIDO ===== -->
    <main>
      <section class="hero">
        <h1>Hola Kevin, listo para romperla hoy üí™</h1>
        <p>Sesi√≥n verificada ‚úÖ | Accesos r√°pidos y estado general.</p>
      </section>

      <section class="grid">
        <article class="card">
          <h3>Reportes</h3>
          <a href="/reports/newreport.html">üß∞ <span>New Report</span></a>
          <a href="/reports/psreport.html">üöö <span>Post-Sale Report</span></a>
        </article>

        <article class="card">
          <h3>Operaciones</h3>
          <a href="/operations/distribucion.html">üìã <span>Distribuci√≥n</span></a>
          <a href="/operations/biops.html">üîó <span>BI de OPs + Links</span></a>
        </article>

        <article class="card">
          <h3>Cobertura</h3>
          <a href="./cobertura.html">üåé <span>Mapa de cobertura</span></a>
          <a href="./newcobertura.html">üß≠ <span>New Cobertura 1.1</span></a>
        </article>

        <article class="card">
          <h3>Utilidades</h3>
          <a href="/utilities/camprev.html">üë• <span>Selector de Apoyo 2.0</span></a>
        </article>
      </section>
    </main>

    <script type="module">
      // ===== Activo simple por ruta =====
      const items=[...document.querySelectorAll('nav .nav-item')];
      function setActive(){
        const current=(location.pathname.split('/').pop()||'index.html').toLowerCase();
        let active=items[0];
        items.forEach(a=>{
          const href=(a.getAttribute('href')||'').split('#')[0].split('/').pop().toLowerCase();
          if(href && href===current) active=a;
          a.classList.toggle('active', a===active);
          a.toggleAttribute('aria-current', a===active ? 'page':false);
        });
      }
      setActive();
      window.addEventListener('popstate', setActive);

      // ===== Grupos colapsables (memoria + aria) =====
      document.querySelectorAll('.nav-group').forEach(g=>{
        const key = g.dataset.key || 'grp-' + Math.random().toString(36).slice(2);
        const head = g.querySelector('.nav-head');

        // restaurar estado
        const saved = localStorage.getItem(key);
        if (saved === '0') g.classList.add('is-collapsed');
        head.setAttribute('aria-expanded', g.classList.contains('is-collapsed') ? 'false' : 'true');

        // click seguro
        head.addEventListener('click', (ev)=>{
          ev.preventDefault();
          ev.stopPropagation();
          const isNowCollapsed = g.classList.toggle('is-collapsed');
          head.setAttribute('aria-expanded', isNowCollapsed ? 'false' : 'true');
          localStorage.setItem(key, isNowCollapsed ? '0' : '1');
        });
      });

      // ===== Compact / Expand =====
      const btnToggle=document.getElementById('btnSidebarToggle');
      const compactKey='gc-sidebar-compact';
      function setCompactState(on){
        document.body.classList.toggle('sidebar-compact', !!on);
        btnToggle.setAttribute('aria-pressed', on ? 'true' : 'false');
        localStorage.setItem(compactKey, on ? '1' : '0');
      }
      btnToggle.addEventListener('click', ()=> setCompactState(!document.body.classList.contains('sidebar-compact')));
      setCompactState(localStorage.getItem(compactKey)==='1');

      // ===== Role UI (BN) =====
      const ROLE_STYLE={
        'owner':{name:'Owner',desc:'Control total'},
        'admin':{name:'Admin',desc:'Administraci√≥n'},
        'supervisor':{name:'Supervisor',desc:'Lidera TLs'},
        'team leader':{name:'Team Leader',desc:'Lidera equipo'},
        'analista':{name:'Analista',desc:'Calidad / Datos'},
        'calidad':{name:'Calidad',desc:'Auditor√≠a'},
        'operador':{name:'Operador',desc:'Ventas / Gesti√≥n'},
        'invitado':{name:'Invitado',desc:'Acceso limitado'}
      };
      function getRole(){
        const qp=new URLSearchParams(location.search).get('role');
        const w=(window.gcRole||'').toString().trim();
        const ls=(localStorage.getItem('gc-role')||'').trim();
        return (qp||w||ls||'Invitado');
      }
      function applyRoleUI(roleRaw){
        const roleDot=document.getElementById('roleDot');
        const roleName=document.getElementById('roleName');
        const roleDesc=document.getElementById('roleDesc');
        const roleBadge=document.getElementById('roleBadge');

        const r=roleRaw.toLowerCase();
        const key=Object.keys(ROLE_STYLE).find(k=>r.includes(k))||'invitado';
        const cfg=ROLE_STYLE[key];

        roleDot.style.background = '#737373';
        roleName.textContent = cfg.name;
        roleDesc.textContent = cfg.desc;
        roleBadge.textContent = cfg.name;
        localStorage.setItem('gc-role', cfg.name);
      }
      applyRoleUI(getRole());

      // ===== Seguridad: logout expuesto por guard.js =====
      if(typeof window.gcLogout!=='function'){
        console.warn('gcLogout no est√° definido. Exp√≥n: window.gcLogout = async () => { /* signOut + redirect */ }');
      }
    </script>

    <!-- üîí Normalizador de rutas (GitHub Pages / dominio propio) -->
    <script>
    (() => {
      const isGhProject = location.hostname.endsWith('github.io');
      const PROJECT_SLUG = 'Gestion-Center';
      const base = isGhProject ? `/${PROJECT_SLUG}/` : '/';

      document.querySelectorAll('nav a.nav-item[href], .brand[href], .card a[href]').forEach(a => {
        const href = a.getAttribute('href');
        if (!href || href.startsWith('#') || /^https?:\/\//i.test(href)) return;
        const clean = href.replace(/^\.?\//, '');
        a.setAttribute('href', base + clean);
      });

      // Normaliza logo (soporta fallback png)
      const logo = document.querySelector('#brandLink img');
      if (logo) {
        let src = logo.getAttribute('src') || './images/logogestioncenter.png';
        if (!/^https?:\/\//i.test(src)) {
          src = src.replace(/^\.?\//, '');
          logo.setAttribute('src', base + src);
        }
        const source = document.querySelector('#brandLink source');
        if (source) {
          let s = source.getAttribute('srcset') || './images/logogestioncenter.webp';
          s = s.replace(/^\.?\//, '');
          source.setAttribute('srcset', base + s);
        }
      }
    })();
    </script>
  </body>
</html>

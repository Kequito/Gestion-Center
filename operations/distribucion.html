<!DOCTYPE html>
<html lang="es" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>üìã Distribuci√≥n ‚Äî Gesti√≥n Center</title>

    <!-- Base absoluto para el ecosistema -->
    <meta name="gc-base" content="/Gestion-Center/">

    <!-- Shell (inyecta bw.css + guard.js + sidebar) -->
    <script type="module" src="../assets/bw/shell.js"></script>
  </head>
  <body>
    <!-- Contenedor del ecosistema -->
    <gc-shell hero-title="üìã Distribuci√≥n de Operadores" hero-subtitle="Filtros r√°pidos ¬∑ Orden 3 estados (‚áß multi-columna)">
      <!-- ================== CONTENIDO ================== -->

      <!-- Hero lo pinta el shell -->

      <!-- Programados por pa√≠s -->
      <section class="gc-panel">
        <h2>üóìÔ∏è Operadores programados por pa√≠s</h2>
        <div class="gc-toolbar">
          <div class="filter-group">
            <label for="progFecha">Fecha</label>
            <input type="date" id="progFecha" />
          </div>
          <div class="filter-group">
            <label for="progTurno">Turno</label>
            <select id="progTurno">
              <option value="ambos">Ambos</option>
              <option value="am">AM (07:00‚Äì16:00)</option>
              <option value="pm">PM (13:00‚Äì22:00)</option>
              <option value="noche">Noche (22:00‚Äì07:00)</option>
            </select>
          </div>
          <div class="gc-chip u-right" id="progTotal">Total: 0</div>
        </div>
        <div class="grid" id="progGrid"></div>
      </section>

      <!-- Filtros y tabla -->
      <section class="gc-panel" style="margin-top:16px">
        <h2>üìë Base de distribuci√≥n</h2>

        <div class="gc-toolbar">
          <div class="filter-group"><label for="fltTL">Team Leader</label><select id="fltTL"><option value="">Todos</option></select></div>
          <div class="filter-group"><label for="fltCampania">Campa√±a</label><select id="fltCampania"><option value="">Todas</option></select></div>
          <div class="filter-group"><label for="fltDescanso">Descanso</label><select id="fltDescanso"><option value="">Todos</option></select></div>
          <div class="filter-group"><label for="fltTurno">Turno</label><select id="fltTurno"><option value="">Todos</option></select></div>
          <div class="filter-group" style="min-width:260px"><label for="fltSearch">Buscar</label><input id="fltSearch" type="text" placeholder="Operador o PEROP1AM"/></div>
          <div class="gc-chip u-right" id="opCounter">Mostrando 0 operadores</div>
        </div>

        <div class="gc-toolbar" style="margin:12px 0">
          <button class="gc-btn" id="btnReset">üßπ Restablecer filtros</button>
          <button class="gc-btn" id="btnExport">‚¨áÔ∏è Exportar (CSV)</button>
        </div>

        <div style="overflow:auto; border-radius:12px">
          <table id="tablaDistribucion" class="gc-table gc-table--striped gc-table--sticky">
            <thead>
              <tr id="headRow">
                <th data-col="A" class="sort-none">Team Leader</th>
                <th data-col="B" class="sort-none">Operador</th>
                <th data-col="C" class="sort-none">PEROP1AM</th>
                <th data-col="D" class="sort-none">Campa√±a</th>
                <th data-col="E" class="sort-none">Descanso</th>
                <th data-col="F" class="sort-none">Turno</th>
                <th data-col="G" class="sort-none">Empresa</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="empty" style="display:none; padding:16px; text-align:center; color:#666">Sin resultados con los filtros actuales.</div>
        </div>
      </section>

      <!-- ================== /CONTENIDO ================== -->
    </gc-shell>

    <!-- ========= JS principal de distribuci√≥n ========= -->
    <script type="module">
      import { abs } from "../assets/bw/shell.js";

      // Helpers
      const norm = s => (s||"").toString().normalize("NFD").replace(/\p{Diacritic}/gu,"").trim().toLowerCase();
      const todayISO = () => new Date().toISOString().split("T")[0];

      // Data
      let dataRaw = [];
      const tabla = document.querySelector("#tablaDistribucion tbody");
      const empty = document.getElementById("empty");

      // Cargar JSON
      async function loadData(){
        try{
          const res = await fetch(abs("operations/datadistribucion.json"), { cache:"no-store" });
          dataRaw = await res.json();
          render();
          renderProg();
        }catch(e){ console.error("Error cargando JSON", e); }
      }

      // Render tabla
      function render(){
        const fltTL = document.getElementById("fltTL").value;
        const fltCamp = document.getElementById("fltCampania").value;
        const fltDesc = document.getElementById("fltDescanso").value;
        const fltTurn = document.getElementById("fltTurno").value;
        const q = norm(document.getElementById("fltSearch").value);

        const filtered = dataRaw.filter(op=>{
          if(fltTL && norm(op.teamLeader)!==norm(fltTL)) return false;
          if(fltCamp && norm(op.campania)!==norm(fltCamp)) return false;
          if(fltDesc && norm(op.descanso)!==norm(fltDesc)) return false;
          if(fltTurn && norm(op.turno)!==norm(fltTurn)) return false;
          if(q && !(norm(op.operador).includes(q) || norm(op.perop).includes(q))) return false;
          return true;
        });

        tabla.innerHTML = filtered.map(op=>`
          <tr>
            <td>${op.teamLeader}</td>
            <td>${op.operador}</td>
            <td class="perop">${op.perop}</td>
            <td>${op.campania}</td>
            <td>${op.descanso}</td>
            <td>${op.turno}</td>
            <td>${op.empresa||""}</td>
          </tr>
        `).join("");

        document.getElementById("opCounter").textContent = "Mostrando "+filtered.length+" operadores";
        empty.style.display = filtered.length? "none":"block";
      }

      // Programados por pa√≠s
      function renderProg(){
        const grid = document.getElementById("progGrid");
        const selFecha = document.getElementById("progFecha").value || todayISO();
        const selTurno = document.getElementById("progTurno").value;

        const dia = ["domingo","lunes","martes","miercoles","jueves","viernes","sabado"][new Date(selFecha).getDay()];

        const counts = {};
        dataRaw.forEach(op=>{
          if(norm(op.descanso)===dia) return;
          if(selTurno!=="ambos" && norm(op.turno)!==selTurno) return;
          counts[op.campania] = (counts[op.campania]||0)+1;
        });

        grid.innerHTML = Object.entries(counts).map(([pais,n])=>`
          <div class="gc-chip">${pais}: <strong>${n}</strong></div>
        `).join("");

        document.getElementById("progTotal").textContent = "Total: "+Object.values(counts).reduce((a,b)=>a+b,0);
      }

      // Eventos
      document.querySelectorAll("#fltTL,#fltCampania,#fltDescanso,#fltTurno").forEach(el=>el.addEventListener("change", render));
      document.getElementById("fltSearch").addEventListener("input", ()=>render());
      document.getElementById("btnReset").addEventListener("click", ()=>{document.querySelectorAll("select,input[type=text]").forEach(el=>el.value=""); render();});
      document.getElementById("progFecha").addEventListener("change", renderProg);
      document.getElementById("progTurno").addEventListener("change", renderProg);

      // Init
      document.getElementById("progFecha").value = todayISO();
      loadData();
    </script>
  </body>
</html>

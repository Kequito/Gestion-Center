<!DOCTYPE html>
<html lang="es" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gestión Center — v2.0 · Distribución</title>

    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=Lexend:wght@300;400;600;700&display=swap" rel="stylesheet"/>

    <!-- 🔒 Ocultar hasta validar sesión -->
    <style>html{visibility:hidden}</style>
    <!-- ⚠️ desde /operations/ subimos un nivel -->
    <script type="module" src="../assets/guard.js"></script>

    <style>
      /* =========================
         DESIGN SYSTEM — v2.0
         ========================= */
      :root{
        --radius:16px; --radius-sm:12px; --radius-xs:10px;
        --font-title:'Outfit', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        --font-body:'Lexend', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        --t-fast:.15s; --t-med:.25s; --t-slow:.6s; --curve:cubic-bezier(.2,.7,.2,1);
        --elev-1:0 6px 20px rgba(0,0,0,.25); --elev-2:0 12px 34px rgba(0,0,0,.35);
        --ctl-bg: rgba(255,255,255,.06); --ctl-bd: rgba(255,255,255,.10);
        --menu-bg:#0f182f; --menu-hov:#1b2544; --menu-txt:#e9f1ff; --menu-muted:#b8c6de;
      }
      [data-theme="dark"]{
        --bg-app:#070b1a; --bg-aside:#0c1228; --bg-card:linear-gradient(160deg, rgba(17,24,49,.88), rgba(17,24,49,.7));
        --txt:#e9f1ff; --txt-muted:#b8c6de; --stroke:rgba(255,255,255,.10);
        --primary:#5b8bff; --accent:#7ae3ff;
        --chip-ok:#22c55e; --chip-warn:#f59e0b; --chip-bad:#ef4444;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0; font-family:var(--font-body); color:var(--txt);
        background:
          radial-gradient(1100px 1100px at 10% -10%, color-mix(in oklab, var(--primary) 30%, transparent), transparent 60%),
          radial-gradient(900px 900px at 90% 0%, color-mix(in oklab, var(--accent) 35%, transparent), transparent 55%),
          var(--bg-app);
        overflow-x:hidden;
      }
      @media (prefers-reduced-motion:no-preference){
        .reveal{opacity:0; transform:translateY(8px); will-change:transform,opacity; transition:opacity var(--t-slow) ease, transform var(--t-slow) ease}
        .reveal.show{opacity:1; transform:none}
      }

      /* ====== Sidebar ====== */
      aside{
        position:fixed; inset:0 auto 0 0; width:280px; z-index:25;
        backdrop-filter:saturate(120%) blur(8px);
        background:color-mix(in oklab, var(--bg-aside) 96%, transparent);
        border-right:1px solid var(--stroke);
        display:flex; flex-direction:column; padding:22px 14px; gap:12px; overflow:auto;
      }
      .brand{
        display:flex; align-items:center; justify-content:center;
        padding:12px; border-radius:var(--radius); border:1px solid var(--stroke);
        background:linear-gradient(132deg, color-mix(in oklab, var(--primary) 18%, transparent), color-mix(in oklab, var(--accent) 12%, transparent));
        text-decoration:none;
      }
      .brand img{ width:160px; height:auto; object-fit:contain; filter:drop-shadow(0 6px 14px rgba(0,0,0,.35)); }

      nav{ position:relative; display:flex; flex-direction:column; gap:8px; }
      nav a{
        display:flex; align-items:center; gap:10px; padding:11px 12px; border-radius:12px;
        text-decoration:none; color:var(--txt); font-size:15px; border:1px solid transparent;
        transition:background var(--t-med) ease, transform var(--t-fast) ease;
      }
      nav a:hover{ background:color-mix(in oklab, var(--bg-aside) 80%, transparent); transform:translateX(2px) }
      nav a.active{
        background:linear-gradient(90deg, color-mix(in oklab, var(--primary) 20%, transparent), color-mix(in oklab, var(--accent) 14%, transparent));
        border-color:var(--stroke);
      }
      .nav-indicator{
        position:absolute; left:0; width:4px; height:40px; border-radius:0 3px 3px 0;
        background:linear-gradient(180deg, var(--primary), var(--accent));
        box-shadow:0 0 16px color-mix(in oklab, var(--accent) 65%, transparent);
        transition:transform var(--t-med) var(--curve), height var(--t-med) ease; will-change:transform,height;
      }
      .spacer{flex:1}
      .logout{
        width:100%; border:1px solid var(--stroke);
        background:linear-gradient(180deg, #ef4444, #d62c2c); color:#fff;
        padding:12px; border-radius:12px; cursor:pointer; font-weight:700;
        transition:transform var(--t-fast) ease, filter var(--t-med) ease;
      }
      .logout:hover{filter:brightness(1.05)} .logout:active{transform:translateY(1px)}

      /* ====== Main ====== */
      main{ margin-left:280px; padding:24px 22px 40px; }
      .hero{
        position:relative; border-radius:var(--radius); padding:18px 18px 18px 20px;
        background:linear-gradient(135deg, color-mix(in oklab, var(--primary) 14%, transparent), color-mix(in oklab, var(--accent) 12%, transparent));
        border:1px solid var(--stroke); overflow:hidden;
      }
      .hero h1{margin:0 0 6px; font:700 24px/1.2 var(--font-title)}
      .hero p{margin:0; color:var(--txt-muted); font-size:14px}
      .pill{
        display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
        background:linear-gradient(180deg, var(--accent), color-mix(in oklab, var(--accent) 50%, white));
        color:#0b1022; font-weight:700; border:1px solid color-mix(in oklab, var(--accent) 65%, white);
        box-shadow:0 8px 24px color-mix(in oklab, var(--accent) 35%, transparent), inset 0 1px 0 rgba(255,255,255,.6);
      }
      .blob{
        position:absolute; right:-90px; top:-90px; width:240px; height:240px; border-radius:50%;
        background:radial-gradient(circle at 30% 30%, color-mix(in oklab, var(--accent) 40%, transparent), transparent 60%);
        filter:blur(18px); pointer-events:none; transform:translateZ(0);
      }

      .grid{display:grid; gap:14px; margin-top:16px; grid-template-columns:repeat(2, minmax(290px, 1fr))}

      .section-card{
        position:relative; border-radius:var(--radius); padding:16px; overflow:hidden; isolation:isolate;
        background:var(--bg-card); border:1px solid var(--stroke); box-shadow:var(--elev-1);
        margin-top:16px;
      }
      .section-card h2{margin:0 0 8px; font:700 18px/1.15 var(--font-title)}
      .inline-controls{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; margin:10px 0 14px; }
      .filter-group{ display:flex; flex-direction:column; gap:6px; }
      .filter-group label{ font-size:12px; color:var(--txt-muted); }

      .filter-group input[type="text"], .filter-group input[type="date"]{
        padding:8px 12px; border-radius:12px; border:1px solid var(--ctl-bd); background:var(--ctl-bg);
        color:var(--menu-txt); min-width:170px; height:38px; outline:none;
      }
      .filter-group select{
        padding:8px 12px; border-radius:12px; border:1px solid var(--ctl-bd);
        background:var(--ctl-bg); color:var(--menu-txt); min-width:170px; height:38px; outline:none;
        color-scheme: dark; appearance:none;
        background-image:
          linear-gradient(45deg, transparent 50%, var(--menu-txt) 50%),
          linear-gradient(135deg, var(--menu-txt) 50%, transparent 50%);
        background-position:
          calc(100% - 18px) 16px, calc(100% - 12px) 16px;
        background-size:6px 6px, 6px 6px;
        background-repeat:no-repeat;
      }
      .filter-group select option,
      .filter-group select optgroup{
        background:var(--menu-bg); color:var(--menu-txt);
      }
      .filter-group select option:checked{ background:var(--menu-hov) !important; color:var(--menu-txt) }
      .filter-group select option:hover{ background:var(--menu-hov) !important }
      .filter-group select:focus{
        box-shadow:0 0 0 3px color-mix(in oklab, var(--primary) 35%, transparent);
        border-color: color-mix(in oklab, var(--primary) 45%, var(--ctl-bd));
      }

      .counter{ margin-left:auto; font-weight:800; font-size:14px; padding:8px 12px; border-radius:999px;
        background:rgba(255,255,255,.06); border:1px solid var(--stroke); }

      .grid-tiles{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
      @media (max-width: 1100px){ .grid-tiles{ grid-template-columns:repeat(2,1fr);} }
      @media (max-width: 720px){ .grid-tiles{ grid-template-columns:1fr;} }
      .country-tile{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px;
        background:rgba(255,255,255,.04); border:1px solid var(--stroke); border-radius:12px; }
      .country-left{ display:flex; align-items:center; gap:10px; }
      .bandera{ width:28px; height:auto; border-radius:4px; box-shadow:0 1px 3px rgba(0,0,0,.25); }
      .cname{ font-weight:700; }
      .badge{ min-width:46px; height:46px; border-radius:12px; background:#fff; color:#0b1022; display:grid; place-items:center; font-weight:900; font-size:18px; border:2px solid #cfe1ff; box-shadow:0 2px 6px rgba(0,0,0,.25); }

      .toolbar{ display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 14px; }
      .btn{ padding:10px 14px; font-size:14px; cursor:pointer; border:none; border-radius:12px; background:var(--primary); color:#0b1022; font-weight:700; box-shadow:var(--elev-1); }
      .btn:hover{ filter:brightness(1.05) } .btn:active{ transform:translateY(1px) }

      table{ width:100%; border-collapse:separate; border-spacing:0; background:rgba(255,255,255,.035);
             border:1px solid var(--stroke); border-radius:12px; overflow:hidden; box-shadow:var(--elev-1); }
      thead th{ position:sticky; top:0; z-index:1; background:linear-gradient(0deg, rgba(91,139,255,.25), rgba(91,139,255,.15));
        color:#fff; padding:10px; text-align:center; user-select:none; cursor:pointer; letter-spacing:.2px; border-bottom:1px solid var(--stroke); }
      tbody td{ padding:10px; border-top:1px solid var(--stroke); text-align:center; }
      thead th:first-child, tbody td:first-child{ text-align:left; }
      .perop{ font-family:ui-monospace,Menlo,Consolas,monospace; font-size:13px; opacity:.9; }
      .sort-none::after{ content:""; } .sort-desc::after{ content:" ↓"; font-weight:900; } .sort-asc::after{ content:" ↑"; font-weight:900; }
      .sort-index{ font-size:10px; margin-left:6px; padding:1px 5px; border-radius:999px; background:rgba(255,255,255,.15); }
      #empty{ padding:18px; text-align:center; color:var(--txt-muted); }

      @media (max-width:1080px){
        main{margin-left:0; padding:16px}
        aside{position:sticky; width:auto; inset:auto; border-right:none; border-bottom:1px solid var(--stroke)}
        .grid{grid-template-columns:1fr}
      }

      #toast{ position:fixed; bottom:18px; right:20px; background:#111827; color:#fff; padding:12px 18px; border-radius:12px; box-shadow:var(--elev-2); display:none; z-index:1000; border:1px solid var(--stroke) }
    </style>
  </head>
  <body>
    <!-- Fondo -->
    <div id="bg-grid" aria-hidden="true" style="position:fixed; inset:0; z-index:-1; opacity:.07; pointer-events:none;
      background:
        linear-gradient(color-mix(in oklab, var(--txt) 9%, transparent) 1px, transparent 1px) 0 0 / 28px 28px,
        linear-gradient(90deg, color-mix(in oklab, var(--txt) 9%, transparent) 1px, transparent 1px) 0 0 / 28px 28px;"></div>

    <!-- SIDEBAR -->
    <aside class="reveal">
      <!-- ⚠️ desde /operations/ el index está 1 nivel arriba -->
      <a class="brand" href="../index.html" aria-label="Inicio">
        <img id="brandLogo" src="../images/logogestioncenter.webp" alt="Gestión Center">
      </a>
      <nav role="navigation" aria-label="Navegación principal">
        <div class="nav-indicator" aria-hidden="true"></div>

        <a href="../index.html" class="nav-item">🏠 <span>Inicio</span></a>

        <!-- Reportes -->
        <a href="/reports/newreport.html" class="nav-item">🧰 <span>New Report</span></a>
        <a href="/reports/psreport.html" class="nav-item">🚚 <span>Post-Sale Report</span></a>

        <!-- Operaciones -->
        <a href="/operations/distribucion.html" class="nav-item active">📋 <span>Distribución</span></a>
        <a href="/operations/biops.html" class="nav-item">🔗 <span>BI de OPs + Links</span></a>

        <!-- Cobertura -->
        <a href="/cobertura.html" class="nav-item">🌎 <span>Cobertura</span></a>
        <a href="/newcobertura.html" class="nav-item">🧭 <span>New Cobertura 1.1</span></a>

        <!-- Utilidades -->
        <a href="/camprev.html" class="nav-item">👥 <span>Selector de Apoyo Ver 2.0</span></a>
        <a href="/pintado.html" class="nav-item">🧮 <span>Queues Heatmap</span></a>
        <a href="/tablita.html" class="nav-item">📄 <span>Tablita :3</span></a>
        <a href="/login.html" class="nav-item">🧪 <span>Test</span></a>
      </nav>
      <div class="spacer"></div>
      <button class="logout" onclick="gcLogout()">Salir</button>
    </aside>

    <!-- CONTENIDO -->
    <main>
      <section class="hero reveal">
        <div class="blob" aria-hidden="true"></div>
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap">
          <div>
            <h1>📋 Distribución de Operadores</h1>
            <p>Mismo look & feel v2.0 · Filtros rápidos · Orden 3 estados (⇧ para multi-columna)</p>
          </div>
          <div class="pill" id="fechaHora">Cargando...</div>
        </div>
      </section>

      <!-- Programados por país -->
      <section class="section-card reveal" style="--delay:.05s" id="programadosCard">
        <h2>🗓️ Operadores programados por país</h2>
        <div class="inline-controls">
          <div class="filter-group"><label for="progFecha">Fecha</label><input type="date" id="progFecha"></div>
          <div class="filter-group">
            <label for="progTurno">Turno</label>
            <select id="progTurno">
              <option value="ambos">Ambos</option>
              <option value="am">AM (07:00–16:00)</option>
              <option value="pm">PM (13:00–22:00)</option>
              <option value="noche">Noche (22:00–07:00)</option>
            </select>
          </div>
          <div class="counter" id="progTotal">Total: 0</div>
        </div>
        <div class="grid-tiles" id="progGrid"></div>
      </section>

      <!-- Filtros y tabla -->
      <section class="section-card reveal" style="--delay:.1s">
        <h2>📑 Base de distribución</h2>

        <div class="inline-controls" style="margin-top:6px">
          <div class="filter-group"><label for="fltTL">Team Leader</label><select id="fltTL"><option value="">Todos</option></select></div>
          <div class="filter-group"><label for="fltCampania">Campaña</label><select id="fltCampania"><option value="">Todas</option></select></div>
          <div class="filter-group"><label for="fltDescanso">Descanso</label><select id="fltDescanso"><option value="">Todos</option></select></div>
          <div class="filter-group"><label for="fltTurno">Turno</label><select id="fltTurno"><option value="">Todos</option></select></div>
          <div class="filter-group" style="min-width:260px"><label for="fltSearch">Buscar</label><input id="fltSearch" type="text" placeholder="Operador o PEROP1AM"/></div>
          <div class="counter" id="opCounter">Mostrando 0 operadores</div>
        </div>

        <div class="toolbar">
          <button class="btn" id="btnReset">🧹 Restablecer filtros</button>
          <button class="btn" id="btnExport">⬇️ Exportar (CSV)</button>
        </div>

        <div style="overflow:auto; border-radius:12px">
          <table id="tablaDistribucion">
            <thead>
              <tr id="headRow">
                <th data-col="A" class="sort-none">Team Leader</th>
                <th data-col="B" class="sort-none">Operador</th>
                <th data-col="C" class="sort-none">PEROP1AM</th>
                <th data-col="D" class="sort-none">Campaña</th>
                <th data-col="E" class="sort-none">Descanso</th>
                <th data-col="F" class="sort-none">Turno</th>
                <th data-col="G" class="sort-none">Empresa</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="empty" style="display:none">Sin resultados con los filtros actuales.</div>
        </div>
      </section>
    </main>

    <div id="toast"></div>

    <script type="module">
      // ========= Nave activo + indicador =========
      const items = [...document.querySelectorAll('nav .nav-item')];
      const indicator = document.querySelector('.nav-indicator');
      function setActive(){
        let active = document.querySelector('nav a.active') || items[0];
        const rect = active.getBoundingClientRect();
        const p = active.parentElement.getBoundingClientRect();
        const y = rect.top - p.top + active.parentElement.scrollTop;
        indicator.style.height = rect.height + 'px';
        indicator.style.transform = `translateY(${y}px)`;
      }
      setActive();
      const nav = document.querySelector('nav');
      nav.addEventListener('scroll', setActive);
      window.addEventListener('resize', setActive);

      // ========= Reveal al scroll =========
      const reduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if(!reduced && 'IntersectionObserver' in window){
        const io = new IntersectionObserver((entries)=>{
          for(const e of entries){
            if(e.isIntersecting){ e.target.classList.add('show'); io.unobserve(e.target); }
          }
        }, {threshold:.12, rootMargin:'0px 0px -10% 0px'});
        document.querySelectorAll('.reveal').forEach(el=>{
          const delay = el.style.getPropertyValue('--delay') || '0s';
          el.style.transitionDelay = delay; io.observe(el);
        });
      } else { document.querySelectorAll('.reveal').forEach(el=>el.classList.add('show')); }

      // ========= Parallax sutil del fondo =========
      const bg=document.getElementById('bg-grid');
      let rafId=null;
      function parallax(e){
        const x=(e.clientX / window.innerWidth - .5)*6;
        const y=(e.clientY / window.innerHeight - .5)*6;
        if(rafId) cancelAnimationFrame(rafId);
        rafId=requestAnimationFrame(()=>{ bg.style.transform=`translate(${x}px, ${y}px)`; });
      }
      if(!reduced) window.addEventListener('mousemove', parallax);

      // ========= Seguridad: logout expuesto por guard.js =========
      if (typeof window.gcLogout !== 'function') {
        console.warn('gcLogout no está definido. En guard.js expón la función global: window.gcLogout = async () => { /* signOut + redirect */ }');
      }

      // ========= Fecha/hora del hero =========
      const fechaHora = document.getElementById('fechaHora');
      function ahoraTick(){
        const a=new Date();
        fechaHora.textContent=`📅 ${a.toLocaleDateString('es-PE',{weekday:'long',year:'numeric',month:'long',day:'numeric'})} · 🕒 ${a.toLocaleTimeString('es-PE',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}`;
      }
      ahoraTick(); setInterval(ahoraTick,1000);
    </script>

    <!-- ========= Distribución: Lógica principal ========= -->
    <script>
      /* … (tu lógica JS completa tal cual la tenías, sin cambios) … */
    </script>

    <!-- 🔒 Normalizador de enlaces (GH Pages / dominio propio) -->
    <script>
    (() => {
      const isGhProject = location.hostname.endsWith('github.io');
      const PROJECT_SLUG = 'Gestion-Center';
      const base = isGhProject ? `/${PROJECT_SLUG}/` : '/';

      document.querySelectorAll('nav a.nav-item[href]').forEach(a => {
        const href = a.getAttribute('href');
        if (!href || href.startsWith('#') || /^https?:\/\//i.test(href)) return;
        const clean = href.replace(/^\.?\//, '');
        a.setAttribute('href', base + clean);
      });

      // Normaliza logo (desde subcarpeta)
      const logo = document.getElementById('brandLogo');
      if (logo) {
        let src = logo.getAttribute('src') || '../images/logogestioncenter.webp';
        if (!/^https?:\/\//i.test(src)) {
          src = src.replace(/^\.?\//, '');
          logo.setAttribute('src', base + src);
        }
      }
    })();
    </script>
  </body>
</html>

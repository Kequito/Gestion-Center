<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gesti√≥n Center ‚Äì Distribuci√≥n</title>
  <link href="https://fonts.googleapis.com/css2?family=Lexend&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-app:#1c2a45; --bg-aside:#152035; --txt:#ffffff; --txt-muted:#cfd8dc; --hover:#1c2a45;
      --primary-color:#0D47A1; --accent-color:#42a5f5; --table-bg:#22314f; --table-border:#2f446a; --header-bg:#0d47a1;
      --chip:#334766; --chip-bd:#2a3d5e;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:'Lexend',sans-serif; background:var(--bg-app); color:var(--txt); display:flex; min-height:100vh;}
    aside{ background:var(--bg-aside); width:220px; height:100vh; padding:40px 20px; display:flex; flex-direction:column; position:fixed; left:0; top:0; }
    .logo{ font-size:22px; font-weight:700; margin-bottom:32px; text-align:center; line-height:1.2; }
    nav a{ color:var(--txt); margin:14px 0; text-decoration:none; font-size:15px; padding:10px 12px; border-radius:8px; transition:background-color .25s,transform .05s; display:flex; gap:10px; white-space:normal; line-height:1.2; overflow-wrap:anywhere;}
    nav a:hover{ background:var(--hover); }
    nav a.active{ background:var(--hover); box-shadow:inset 0 0 0 1px rgba(255,255,255,.12); }
    .spacer{ flex:1; }

    main{ margin-left:220px; padding:28px; width:calc(100% - 220px); }
    .page-title{ display:flex; align-items:center; gap:12px; font-size:24px; font-weight:700; margin:0 0 4px; }
    .subtitle{ margin:0 0 10px; color:var(--txt-muted); font-size:14px; }
    .datetime{ font-size:14px; font-weight:600; margin:6px 0 16px; opacity:.9; }

    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 14px; }
    button{ padding:10px 14px; font-size:14px; cursor:pointer; border:none; border-radius:10px; background:var(--primary-color); color:#fff; box-shadow:0 2px 6px rgba(0,0,0,.25); }
    button:hover{ background:var(--accent-color); }
    button:active{ transform:translateY(1px); }

    .filters{ display:flex; align-items:flex-end; gap:12px; flex-wrap:wrap; background:rgba(255,255,255,.04); border:1px solid var(--table-border); border-radius:12px; padding:12px; margin:8px 0 16px; }
    .filter-group{ display:flex; flex-direction:column; gap:6px; }
    .filter-group label{ font-size:12px; color:var(--txt-muted); }
    .filter-group select, .filter-group input[type="text"], .filter-group input[type="date"]{
      padding:8px 12px; border-radius:10px; border:1px solid var(--primary-color); background:var(--table-bg); color:var(--txt); min-width:170px; height:38px;
    }
    .counter{ margin-left:auto; font-weight:800; font-size:14px; padding:8px 12px; border-radius:999px; background:var(--chip); border:1px solid var(--chip-bd); }

    /* ======= Widget: Programados por pa√≠s ======= */
    .card{ background:rgba(255,255,255,.04); border:1px solid var(--table-border); border-radius:14px; padding:14px; margin:18px 0; box-shadow:0 4px 10px rgba(0,0,0,.18); }
    .card h2{ margin:0 0 10px; font-size:18px; display:flex; align-items:center; gap:8px; }
    .inline-controls{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; margin:10px 0 14px; }
    .grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
    @media (max-width: 1100px){ .grid{ grid-template-columns:repeat(2,1fr);} }
    @media (max-width: 720px){ .grid{ grid-template-columns:1fr;} }
    .country-tile{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; background:var(--table-bg); border:1px solid var(--table-border); border-radius:12px; }
    .country-left{ display:flex; align-items:center; gap:10px; }
    .bandera{ width:28px; height:auto; border-radius:4px; box-shadow:0 1px 3px rgba(0,0,0,.25); }
    .cname{ font-weight:700; }
    .badge{ min-width:46px; height:46px; border-radius:12px; background:#fff; color:#0d47a1; display:grid; place-items:center; font-weight:900; font-size:18px; border:2px solid var(--header-bg); box-shadow:0 2px 6px rgba(0,0,0,.25); }

    /* ===== Tabla ===== */
    table{ width:100%; border-collapse:separate; border-spacing:0; background:var(--table-bg); border:1px solid var(--table-border); border-radius:12px; overflow:hidden; box-shadow:0 4px 10px rgba(0,0,0,.18); }
    thead th{
      position:sticky; top:0; z-index:1;
      background:var(--header-bg); color:#fff; padding:10px; text-align:center; user-select:none; cursor:pointer;
    }
    tbody td{ padding:10px; border-top:1px solid var(--table-border); text-align:center; }
    thead th:first-child, tbody td:first-child{ text-align:left; }
    .perop{ font-family:ui-monospace,Menlo,Consolas,monospace; font-size:13px; opacity:.9; }
    .sort-none::after{ content:""; } .sort-desc::after{ content:" ‚Üì"; font-weight:900; } .sort-asc::after{ content:" ‚Üë"; font-weight:900; }
    .sort-index{ font-size:10px; margin-left:6px; padding:1px 5px; border-radius:999px; background:rgba(255,255,255,.15); }

    #empty{ padding:18px; text-align:center; color:var(--txt-muted); }
    #toast{ position:fixed; bottom:18px; right:20px; background:#222; color:#fff; padding:12px 18px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,.35); display:none; z-index:1000; }
  </style>
</head>
<body>
  <aside>
    <div class="logo">üß≠ Gesti√≥n Center</div>
    <nav>
      <a href="index.html">üè† Inicio</a>
      <a href="plandetrabajo.html">‚úÖ Plan de trabajo</a>
      <a class="active" href="distribucion.html">üìã Distribuci√≥n</a>
      <a href="estadisticas.html">üìà Estad√≠sticas</a>
      <a href="cobertura.html">üåé Cobertura</a>
      <a href="camprev.html">üë• Selector de Apoyo Ver 2.0</a>
      <a href="postsale.html">üöö Post-Sale New Report </a>
      <a href="opo11.html">üß∞ New Report CC Per√∫</a>
      <a href="#contacto">üì¨ Contacto</a>
    </nav>
    <div class="spacer"></div>
  </aside>

  <main>
    <h1 class="page-title">üìã Distribuci√≥n de Operadores</h1>
    <p class="subtitle">Mismo look & feel que el New Report ¬∑ Filtros r√°pidos ¬∑ Orden 3 estados (‚áß para multi-columna)</p>
    <div id="fechaHora" class="datetime"></div>

    <!-- ========= Programados por pa√≠s ========= -->
    <section class="card" id="programadosCard">
      <h2>üóìÔ∏è Operadores programados</h2>
      <div class="inline-controls">
        <div class="filter-group">
          <label for="progFecha">Fecha</label>
          <input type="date" id="progFecha">
        </div>
        <div class="filter-group">
          <label for="progTurno">Turno</label>
          <select id="progTurno">
            <option value="ambos">Ambos</option>
            <option value="am">AM (07:00‚Äì16:00)</option>
            <option value="pm">PM (13:00‚Äì22:00)</option>
            <option value="noche">Noche (22:00‚Äì07:00)</option>
          </select>
        </div>
        <div class="counter" id="progTotal">Total: 0</div>
      </div>
      <div class="grid" id="progGrid"></div>
    </section>

    <!-- ========= Filtros ========= -->
    <div class="filters">
      <div class="filter-group"><label for="fltTL">Team Leader</label><select id="fltTL"><option value="">Todos</option></select></div>
      <div class="filter-group"><label for="fltCampania">Campa√±a</label><select id="fltCampania"><option value="">Todas</option></select></div>
      <div class="filter-group"><label for="fltDescanso">Descanso</label><select id="fltDescanso"><option value="">Todos</option></select></div>
      <div class="filter-group"><label for="fltTurno">Turno</label><select id="fltTurno"><option value="">Todos</option></select></div>
      <div class="filter-group"><label for="fltSearch">Buscar</label><input id="fltSearch" type="text" placeholder="Operador o PEROP1AM"/></div>
      <div class="counter" id="opCounter">Mostrando 0 operadores</div>
    </div>

    <div class="toolbar">
      <button id="btnReset">üßπ Restablecer filtros</button>
      <button id="btnExport">‚¨áÔ∏è Exportar (CSV)</button>
    </div>

    <table id="tablaDistribucion">
      <thead>
        <tr id="headRow">
          <th data-col="A" class="sort-none">Team Leader</th>
          <th data-col="B" class="sort-none">Operador</th>
          <th data-col="C" class="sort-none">PEROP1AM</th>
          <th data-col="D" class="sort-none">Campa√±a</th>
          <th data-col="E" class="sort-none">Descanso</th>
          <th data-col="F" class="sort-none">Turno</th>
          <th data-col="G" class="sort-none">Empresa</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="empty" style="display:none">Sin resultados con los filtros actuales.</div>
  </main>

  <div id="toast"></div>

  <script>
    // ===== Utilidades =====
    const toast=(m)=>{const t=document.getElementById('toast');t.textContent=m;t.style.display='block';t.style.opacity=1;setTimeout(()=>{t.style.transition='opacity .5s';t.style.opacity=0;},2200);setTimeout(()=>{t.style.display='none';t.style.transition='';},2800)};
    const pad2=n=>String(n).padStart(2,'0');
    const norm = s => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
    function ahoraTick(){ const a=new Date(); fechaHora.textContent=`üìÖ ${a.toLocaleDateString('es-PE',{weekday:'long',year:'numeric',month:'long',day:'numeric'})} ‚Äì üïí ${a.toLocaleTimeString('es-PE',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}`; }
    ahoraTick(); setInterval(ahoraTick,1000);
    const collator = new Intl.Collator('es', {numeric:true, sensitivity:'base'});

    // ===== Estado =====
    let dataRaw=[], filtered=[], originalIndexMap=new WeakMap();
    let sortPriority=[]; // [{col:'F', dir:1|-1}, ...] 1=desc, -1=asc
    const STORAGE_KEY='dist_state_v1';

    // ===== Carga de datos =====
    async function loadData(){
      try{
        const res=await fetch('datadistribucion.json',{cache:'no-store'});
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        dataRaw=await res.json();
        // √≠ndice estable para ordenamientos estables
        dataRaw.forEach((r,i)=>originalIndexMap.set(r,i));
        buildFilters(dataRaw);
        initProgramadosUI();
        restoreState(); // carga filtros/orden si hay
        computeProgramados();
        applyFiltersAndRender();
        toast('‚úÖ Datos de distribuci√≥n cargados');
      }catch(e){ console.error(e); toast('‚ùå No se pudo cargar datadistribucion.json'); }
    }

    // ===== Filtros/tabla =====
    function uniqSorted(a){ return [...new Set(a.filter(v=>v!=null && String(v).trim()!==''))].sort((x,y)=>String(x).localeCompare(String(y),'es')); }
    function fillSelect(sel, vals){ sel.innerHTML='<option value="">'+(sel.id==='fltCampania'?'Todas':'Todos')+'</option>'+vals.map(v=>`<option value="${String(v).replaceAll('"','&quot;')}">${v}</option>`).join(''); }
    function buildFilters(rows){
      fillSelect(fltTL,uniqSorted(rows.map(r=>r.A)));
      fillSelect(fltCampania,uniqSorted(rows.map(r=>r.D)));
      fillSelect(fltDescanso,uniqSorted(rows.map(r=>r.E)));
      fillSelect(fltTurno,uniqSorted(rows.map(r=>r.F)));
    }

    function applyFiltersAndRender(){
      const vTL=norm(fltTL.value), vCa=norm(fltCampania.value), vDe=norm(fltDescanso.value), vTu=norm(fltTurno.value), vQ=norm(fltSearch.value);
      filtered = dataRaw.filter(r=>{
        const sA=norm(r.A), sB=norm(r.B), sC=norm(r.C), sD=norm(r.D), sE=norm(r.E), sF=norm(r.F);
        return (!vTL||sA===vTL)&&(!vCa||sD===vCa)&&(!vDe||sE===vDe)&&(!vTu||sF===vTu)&&(!vQ||sB.includes(vQ)||sC.includes(vQ));
      });

      // Ordenamiento multi-columna (estable)
      if(sortPriority.length){
        filtered.sort((a,b)=>{
          for(const {col,dir} of sortPriority){
            const av = a[col] ?? '', bv = b[col] ?? '';
            const c = collator.compare(String(av), String(bv));
            if(c !== 0) return c * dir;
          }
          // estabilidad
          return originalIndexMap.get(a) - originalIndexMap.get(b);
        });
      }

      renderTable(filtered);
      saveState(); // guarda filtros/orden actuales
    }

    function paisDesdeCampania(camp){
      const s = norm(camp);
      for(const [pais, regs] of Object.entries(MATCH)){
        if(regs.some(rx=>rx.test(s))) return pais;
      }
      return null;
    }

    function renderTable(rows){
      const tb=document.querySelector('#tablaDistribucion tbody'); tb.innerHTML='';
      if(!rows.length){ document.getElementById('empty').style.display='block'; }
      else { document.getElementById('empty').style.display='none'; }

      rows.forEach(r=>{
        const pais = paisDesdeCampania(r.D||'');
        const flag = flagImg(pais);
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${r.A||''}</td>
          <td>${r.B||''}</td>
          <td class="perop">${r.C||''}</td>
          <td>${flag?`${flag} `:''}${r.D||''}</td>
          <td>${r.E||''}</td>
          <td>${r.F||''}</td>
          <td>${r.G||''}</td>
        `;
        tb.appendChild(tr);
      });
      opCounter.textContent=`Mostrando ${rows.length} operador${rows.length===1?'':'es'}`;
    }

    function resetHeadSortClasses(){
      document.querySelectorAll('#headRow th').forEach(th=>{
        th.classList.remove('sort-asc','sort-desc'); th.classList.add('sort-none');
        const badge = th.querySelector('.sort-index'); if(badge) badge.remove();
      });
    }
    function repaintSortBadges(){
      resetHeadSortClasses();
      const mapIndex = new Map(sortPriority.map((s,i)=>[s.col, i+1]));
      document.querySelectorAll('#headRow th').forEach(th=>{
        const col=th.dataset.col;
        const entry = sortPriority.find(s=>s.col===col);
        if(entry){
          th.classList.remove('sort-none');
          th.classList.add(entry.dir===1?'sort-desc':'sort-asc');
          const sup=document.createElement('span'); sup.className='sort-index'; sup.textContent=mapIndex.get(col);
          th.appendChild(sup);
        }
      });
    }
    function toggleSort(th, additive){ // additive = Shift
      const col=th.dataset.col;
      // 3 estados: quitar -> desc (1) -> asc (-1) -> quitar
      const idx = sortPriority.findIndex(s=>s.col===col);
      if(!additive) sortPriority = (idx>-1) ? [sortPriority[idx]] : []; // si no es shift, dejamos solo esta col (respetando su estado si exist√≠a)
      if(idx===-1){
        sortPriority.push({col, dir:1}); // desc por defecto
      }else{
        const cur = sortPriority[idx];
        if(cur.dir===1){ cur.dir=-1; }
        else { sortPriority.splice(idx,1); } // se quita
      }
      repaintSortBadges();
      applyFiltersAndRender();
    }

    function exportCSV(){
      if(!filtered.length){ toast('‚ÑπÔ∏è No hay filas para exportar'); return; }
      const headers=['Team Leader','Operador','PEROP1AM','Campa√±a','Descanso','Turno','Empresa'];
      const rows=filtered.map(r=>[r.A||'',r.B||'',r.C||'',r.D||'',r.E||'',r.F||'',r.G||'']);
      const csv=[headers,...rows].map(row=>row.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`distribucion_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    // ====== Programados con banderas (FlagCDN) ======
    const ISO2 = { 'Chile':'cl','Colombia':'co','Costa Rica':'cr','Ecuador':'ec','Mexico':'mx','Paraguay':'py','Peru':'pe','Uruguay':'uy','Venezuela':'ve' };
    const MATCH = {
      'Chile':[/\bchile\b/], 'Colombia':[/colom/], 'Costa Rica':[/costa\s*rica|costarica/],
      'Ecuador':[/ecuad/], 'Mexico':[/\bmexic|\bmx\b/], 'Paraguay':[/paragu/],
      'Peru':[/\bper[u√∫]|\bpe\b/], 'Uruguay':[/urug/], 'Venezuela':[/venez/]
    };
    function flagImg(pais){ const code = ISO2[pais||'']; return code ? `<img class="bandera" src="https://flagcdn.com/w40/${code}.png" alt="${pais}">` : ''; }

    // Ventanas seleccionables (minutos desde 00:00, Noche cruza +24h)
    const SEL_WINDOWS = { am:[7*60,16*60], pm:[13*60,22*60], noche:[22*60,31*60] };

    // Parse "13:00-22:00" o "13:00‚Äì22:00" -> [ini,fin] en minutos; si fin<ini, suma 24h
    function parseShiftMinutes(s){
      if(!s) return null;
      const txt = String(s).replace(/[‚Äì‚Äî]/g,'-');
      const re  = /(\d{1,2})[:.](\d{2})/g;
      const t   = [...txt.matchAll(re)].map(m => (+m[1])*60 + (+m[2]));
      if(t.length >= 2){
        let [ini, fin] = [t[0], t[1]];
        if(fin < ini) fin += 24*60; // cruza medianoche (22:00-07:00)
        return [ini, fin];
      }
      const n = norm(txt);
      if(/\bam\b/.test(n)) return [7*60,16*60];
      if(/\bpm\b/.test(n)) return [13*60,22*60];
      return null;
    }
    function overlaps(selKey, shift){
      if(selKey === 'ambos') return true;
      if(!shift) return false;
      const [s1,e1] = shift;
      const [ws,we] = SEL_WINDOWS[selKey];
      const ov = Math.max(0, Math.min(e1, we) - Math.max(s1, ws));
      return ov > 0;
    }

    function initProgramadosUI(){
      const t=new Date();
      progFecha.value = `${t.getFullYear()}-${pad2(t.getMonth()+1)}-${pad2(t.getDate())}`;

      const orden = ['Chile','Colombia','Costa Rica','Ecuador','Mexico','Paraguay','Peru','Uruguay','Venezuela'];
      progGrid.innerHTML = orden.map(p=>`
        <div class="country-tile" id="tile-${ISO2[p]}">
          <div class="country-left">
            ${flagImg(p)}
            <div class="cname">${p}</div>
          </div>
          <div class="badge" data-count>0</div>
        </div>
      `).join('');

      progFecha.addEventListener('change', computeProgramados);
      progTurno.addEventListener('change', computeProgramados);
    }

    function computeProgramados(){
      if(!dataRaw.length) return;
      const fecha = new Date(progFecha.value+'T00:00:00');
      if(isNaN(fecha)) return;
      const diaIdx = fecha.getDay();
      // D√≠a en may√∫sculas SIN tildes para comparar
      const dias = ['domingo','lunes','martes','miercoles','jueves','viernes','sabado'];
      const dia = dias[diaIdx].toUpperCase();
      const turnoSel = document.getElementById('progTurno').value; // ambos|am|pm|noche

      const counts = {Chile:0,Colombia:0,'Costa Rica':0,Ecuador:0,Mexico:0,Paraguay:0,Peru:0,Uruguay:0,Venezuela:0};

      for(const r of dataRaw){
        const pais = paisDesdeCampania(r.D||''); if(!pais) continue;
        // Normalizar descanso para ignorar tildes (MI√âRCOLES vs MIERCOLES)
        const descanso = norm(r.E||'').toUpperCase();
        const trabajaHoy = (descanso !== dia);

        const shift = parseShiftMinutes(r.F||'');
        const pasaTurno = overlaps(turnoSel, shift);

        if(trabajaHoy && pasaTurno) counts[pais] += 1;
      }

      let total=0;
      for(const [pais, n] of Object.entries(counts)){
        total += n;
        const el = document.querySelector(`#tile-${ISO2[pais]} [data-count]`);
        if(el) el.textContent = n;
      }
      progTotal.textContent = `Total: ${total}`;
    }

    // ===== Persistencia de estado =====
    function saveState(){
      const state = {
        filters:{
          tl: fltTL.value, ca: fltCampania.value, de: fltDescanso.value, tu: fltTurno.value, q: fltSearch.value
        },
        sort: sortPriority
      };
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch{}
    }
    function restoreState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const s = JSON.parse(raw);
        if(s.filters){
          fltTL.value = s.filters.tl ?? '';
          fltCampania.value = s.filters.ca ?? '';
          fltDescanso.value = s.filters.de ?? '';
          fltTurno.value = s.filters.tu ?? '';
          fltSearch.value = s.filters.q ?? '';
        }
        if(Array.isArray(s.sort)) sortPriority = s.sort.filter(x=>x && x.col && (x.dir===1||x.dir===-1));
        repaintSortBadges();
      }catch{}
    }

    // ===== Eventos =====
    btnReset.addEventListener('click',()=>{
      fltTL.value=''; fltCampania.value=''; fltDescanso.value=''; fltTurno.value=''; fltSearch.value='';
      sortPriority=[]; repaintSortBadges();
      applyFiltersAndRender();
      try{ localStorage.removeItem(STORAGE_KEY);}catch{}
    });
    btnExport.addEventListener('click',exportCSV);

    // Click en cabeceras: click normal = solo esa col; Shift-click = a√±adir/alternar multi
    document.querySelectorAll('#headRow th').forEach(th=>{
      th.addEventListener('click',(ev)=>toggleSort(th, ev.shiftKey));
    });

    // Debounce para b√∫squeda
    let qTimer=null;
    fltSearch.addEventListener('input',()=>{
      clearTimeout(qTimer);
      qTimer=setTimeout(applyFiltersAndRender, 180);
    });
    ['fltTL','fltCampania','fltDescanso','fltTurno'].forEach(id=>{
      const el=document.getElementById(id); el.addEventListener('change',applyFiltersAndRender);
    });

    // Inicio
    loadData();
  </script>
</body>
</html>

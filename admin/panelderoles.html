<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Panel Admin ‚Äî Gesti√≥n Center</title>

  <!-- MUY IMPORTANTE: base para rutas absolutas en GitHub Pages -->
  <meta name="gc-base" content="/Gestion-Center/"/>

  <!-- Oculta de inmediato para evitar flicker hasta validar rol -->
  <style>html{visibility:hidden}</style>

  <!-- Ecosistema GC -->
  <script type="module" src="../assets/guard.js"></script>
  <script type="module" src="../assets/bw/shell.js"></script>
  <link rel="stylesheet" href="../assets/bw/bw.css">
</head>
<body>
  <gc-shell hero-title="Panel de administraci√≥n" hero-subtitle="Gestiona roles y utilidades de acceso">
    <section class="grid-2">
      <!-- Estado del admin -->
      <article class="card">
        <h2>üë§ Tu estado</h2>
        <p style="margin-top:8px">
          <strong>Email:</strong> <span id="meEmail">‚Äî</span><br>
          <strong>UID:</strong> <span id="meUid">‚Äî</span>
          <button id="btnCopyUid" class="btn sm" style="margin-left:6px">Copiar</button><br>
          <strong>Rango:</strong> <span id="meRank" class="badge">‚Äî</span>
        </p>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="btnRefresh" class="btn">Refrescar claims</button>
          <button id="btnLogout" class="btn danger">Cerrar sesi√≥n</button>
        </div>
        <p id="meMsg" class="muted" style="margin-top:10px"></p>
      </article>

      <!-- Asignar rol -->
      <article class="card">
        <h2>üõ°Ô∏è Asignar / actualizar rol</h2>
        <p class="muted" style="margin-top:4px">
          Puedes ingresar un <strong>UID</strong> o un <strong>email</strong> de Firebase.
        </p>
        <div class="form" style="margin-top:10px">
          <label>UID o email</label>
          <input id="targetId" placeholder="uid_123... o correo@empresa.com" autocomplete="off"/>

          <label>Rol</label>
          <select id="targetRole">
            <option value="admin">Admin</option>
            <option value="supervisor">Supervisor</option>
            <option value="tl">Team Leader</option>
            <option value="invitado">Invitado</option>
          </select>
          <div style="margin-top:10px">
            <button id="btnAssign" class="btn primary">Asignar rol</button>
          </div>
          <p id="assignMsg" class="muted" style="margin-top:8px"></p>
        </div>
        <details style="margin-top:10px">
          <summary>¬øQu√© hace esto?</summary>
          <p class="muted">
            Llama a una Cloud Function (Callable) que usa el Admin SDK para escribir el claim
            <code>rank</code> del usuario destino (<em>admin | supervisor | tl | invitado</em>).
            Luego el usuario debe refrescar su sesi√≥n para ver el nuevo rol.
          </p>
        </details>
      </article>
    </section>
  </gc-shell>

  <script type="module">
    import { getAuth, reload } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";

    // --------- BASE robusta ----------
    function computeBase(){
      if (window.__GC_BASE__) {
        return window.__GC_BASE__.endsWith("/") ? window.__GC_BASE__ : (window.__GC_BASE__ + "/");
      }
      const meta = document.querySelector('meta[name="gc-base"]')?.content || "/Gestion-Center/";
      const abs  = new URL(String(meta).replace(/^\//,""), location.origin).href;
      return abs.endsWith("/") ? abs : abs + "/";
    }
    const BASE = computeBase();
    const urlFromBase = (path)=> new URL(String(path||"").replace(/^\//,""), BASE).href;
    const go = (path)=> location.replace(urlFromBase(path));

    // --------- DOM refs ----------
    const $ = (sel)=>document.querySelector(sel);
    const meEmail = $("#meEmail");
    const meUid   = $("#meUid");
    const meRank  = $("#meRank");
    const meMsg   = $("#meMsg");

    const btnCopyUid = $("#btnCopyUid");
    const btnRefresh = $("#btnRefresh");
    const btnLogout  = $("#btnLogout");

    const targetId   = $("#targetId");
    const targetRole = $("#targetRole");
    const btnAssign  = $("#btnAssign");
    const assignMsg  = $("#assignMsg");

    // --------- Firebase ----------
    const auth = getAuth();
    const fn   = getFunctions();

    // --------- Helpers UI ----------
    function badgeColor(rank){
      const r = String(rank||"").toLowerCase();
      if (r==="admin") return "#ef4444";
      if (r==="supervisor") return "#a855f7";
      if (r==="tl") return "#3b82f6";
      return "#22c55e"; // invitado / sin rol
    }

    // --------- Gate de ADMIN (con reintentos) ----------
    async function requireAdmin(){
      const u = auth.currentUser;

      if (!u){
        console.warn("[panelderoles] No hay usuario. Redirigiendo a login.");
        go("login.html");
        return false;
      }

      // Mostrar "verificando" mientras resolvemos los claims
      meMsg.textContent = "Verificando rol‚Ä¶";
      document.documentElement.style.visibility = "visible";

      // Hasta 8 intentos (~4 segundos) para cubrir propagaci√≥n de claims
      const MAX_TRIES = 8;
      for (let i=0; i<MAX_TRIES; i++){
        try{
          // Fuerza refresh completo del user y token
          await reload(u);
          await u.getIdToken(true);
          const t = await u.getIdTokenResult(false);
          const rank = String(t.claims?.rank || "invitado").toLowerCase();

          console.log("[panelderoles] intento", i+1, "rank =", rank);

          if (rank === "admin"){
            // Usuario v√°lido ‚Üí pintar y listo
            meEmail.textContent = u.email || "(sin email)";
            meUid.textContent   = u.uid;
            meRank.textContent  = rank;
            meRank.style.background = badgeColor(rank);
            meMsg.textContent = "Acceso concedido ‚úÖ";
            return true;
          }
        }catch(err){
          console.warn("[panelderoles] error obteniendo claims (intento", i+1, "):", err);
        }
        // Espera 500ms antes del pr√≥ximo intento
        await new Promise(r=>setTimeout(r, 500));
      }

      // Si agotamos intentos, negar acceso con mensaje claro y regresar al inicio
      meMsg.textContent = "Acceso restringido: se requiere rol ADMIN.";
      await new Promise(r=>setTimeout(r, 800));
      go("index.html");
      return false;
    }

    // --------- Utilidades ----------
    btnCopyUid.addEventListener("click", async ()=>{
      try { await navigator.clipboard.writeText(meUid.textContent); meMsg.textContent = "UID copiado ‚úÖ"; }
      catch { meMsg.textContent = "No se pudo copiar el UID"; }
      setTimeout(()=>meMsg.textContent="", 1500);
    });

    btnRefresh.addEventListener("click", async ()=>{
      try {
        const u = auth.currentUser;
        await reload(u);
        await u.getIdToken(true);
        const t = await u.getIdTokenResult(false);
        const rank = String(t.claims?.rank || "invitado").toLowerCase();
        meRank.textContent = rank;
        meRank.style.background = badgeColor(rank);
        meMsg.textContent = "Claims actualizados ‚úÖ (rol: " + rank + ")";
      } catch(e){
        meMsg.textContent = "No se pudieron refrescar los claims";
        console.warn(e);
      }
      setTimeout(()=>meMsg.textContent="", 2500);
    });

    btnLogout.addEventListener("click", async ()=>{
      try { await auth.signOut(); }
      finally { go("login.html"); }
    });

    // --------- Callable: asignar rol ----------
    btnAssign.addEventListener("click", async ()=>{
      assignMsg.textContent = "";
      const id   = (targetId.value || "").trim();
      const role = (targetRole.value || "").trim().toLowerCase();

      if (!id){ assignMsg.textContent = "Ingresa un UID o un email."; return; }
      if (!["admin","supervisor","tl","invitado"].includes(role)){
        assignMsg.textContent = "Rol inv√°lido."; return;
      }

      try{
        const callable = httpsCallable(fn, "admin-setUserRank");
        const resp = await callable({ id, role });
        assignMsg.textContent = `OK ‚úÖ ${resp?.data?.message || "Rol actualizado"}`;
      }catch(err){
        console.warn(err);
        if (String(err)?.includes("function not found")){
          assignMsg.textContent = "La Function admin-setUserRank no est√° desplegada.";
        } else if (err?.code === "permission-denied"){
          assignMsg.textContent = "No autorizado para ejecutar la Function.";
        } else {
          assignMsg.textContent = err?.message || "Error llamando a la Function.";
        }
      }
    });

    // --------- Kickoff ----------
    requireAdmin();
  </script>
</body>
</html>

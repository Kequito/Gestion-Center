<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Panel Admin ‚Äî Gesti√≥n Center</title>

  <!-- Base para rutas absolutas en GitHub Pages -->
  <meta name="gc-base" content="/Gestion-Center/"/>

  <!-- Oculta hasta validar rol y montar el shell -->
  <style>html{visibility:hidden}</style>

  <!-- Guard primero (auth + BASE expuesta) -->
  <script type="module" src="../assets/guard.js"></script>

  <!-- Estilos del tema -->
  <link rel="stylesheet" href="../assets/bw/bw.css">
</head>
<body>
  <!-- Contenido sin shell; el shell se montar√° luego de verificar admin -->
  <div id="app" style="padding:16px;max-width:1100px;margin:auto">
    <h1 style="margin:0 0 8px">Panel de administraci√≥n</h1>
    <p id="bootMsg" class="muted">Verificando rol‚Ä¶</p>

    <section class="grid-2" style="display:none" id="content">
      <!-- Estado del admin -->
      <article class="card">
        <h2>üë§ Tu estado</h2>
        <p style="margin-top:8px">
          <strong>Email:</strong> <span id="meEmail">‚Äî</span><br>
          <strong>UID:</strong> <span id="meUid">‚Äî</span>
          <button id="btnCopyUid" class="btn sm" style="margin-left:6px">Copiar</button><br>
          <strong>Rango:</strong> <span id="meRank" class="badge">‚Äî</span>
        </p>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="btnRefresh" class="btn">Refrescar claims</button>
          <button id="btnLogout" class="btn danger">Cerrar sesi√≥n</button>
        </div>
        <p id="meMsg" class="muted" style="margin-top:10px"></p>
      </article>

      <!-- Asignar rol -->
      <article class="card">
        <h2>üõ°Ô∏è Asignar / actualizar rol</h2>
        <p class="muted" style="margin-top:4px">
          Puedes ingresar un <strong>UID</strong> o un <strong>email</strong> de Firebase.
        </p>
        <div class="form" style="margin-top:10px">
          <label>UID o email</label>
          <input id="targetId" placeholder="uid_123... o correo@empresa.com" autocomplete="off"/>

          <label>Rol</label>
          <select id="targetRole">
            <option value="admin">Admin</option>
            <option value="supervisor">Supervisor</option>
            <option value="tl">Team Leader</option>
            <option value="invitado">Invitado</option>
          </select>
          <div style="margin-top:10px">
            <button id="btnAssign" class="btn primary">Asignar rol</button>
          </div>
          <p id="assignMsg" class="muted" style="margin-top:8px"></p>
        </div>
        <details style="margin-top:10px">
          <summary>¬øQu√© hace esto?</summary>
          <p class="muted">
            Llama a una Cloud Function (Callable) que usa el Admin SDK para escribir el claim
            <code>rank</code> del usuario destino (<em>admin | supervisor | tl | invitado</em>).
            Luego el usuario debe refrescar su sesi√≥n para ver el nuevo rol.
          </p>
        </details>
      </article>
    </section>
  </div>

  <script type="module">
    import { getAuth, reload } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";

    // --------- BASE robusta ----------
    function computeBase(){
      if (window.__GC_BASE__) {
        return window.__GC_BASE__.endsWith("/") ? window.__GC_BASE__ : (window.__GC_BASE__ + "/");
      }
      const meta = document.querySelector('meta[name="gc-base"]')?.content || "/Gestion-Center/";
      const abs  = new URL(String(meta).replace(/^\//,""), location.origin).href;
      return abs.endsWith("/") ? abs : abs + "/";
    }
    const BASE = computeBase();
    const urlFromBase = (path)=> new URL(String(path||"").replace(/^\//,""), BASE).href;
    const go = (path)=> location.replace(urlFromBase(path));

    // --------- DOM refs ----------
    const $ = (sel)=>document.querySelector(sel);
    const bootMsg = $("#bootMsg");
    const content = $("#content");
    const meEmail = $("#meEmail");
    const meUid   = $("#meUid");
    const meRank  = $("#meRank");
    const meMsg   = $("#meMsg");
    const btnCopyUid = $("#btnCopyUid");
    const btnRefresh = $("#btnRefresh");
    const btnLogout  = $("#btnLogout");
    const targetId   = $("#targetId");
    const targetRole = $("#targetRole");
    const btnAssign  = $("#btnAssign");
    const assignMsg  = $("#assignMsg");

    // --------- Firebase ----------
    const auth = getAuth();
    const fn   = getFunctions();

    // --------- Helpers UI ----------
    const badgeColor = (rank)=>{
      const r = String(rank||"").toLowerCase();
      if (r==="admin") return "#ef4444";
      if (r==="supervisor") return "#a855f7";
      if (r==="tl") return "#3b82f6";
      return "#22c55e";
    };

    async function waitForAdmin(maxMs=4000){
      const u = auth.currentUser;
      if (!u) return {ok:false, reason:"no-user"};

      const deadline = Date.now() + maxMs;
      let attempt = 0;

      while (Date.now() < deadline) {
        attempt++;
        try {
          await reload(u);
          await u.getIdToken(true);
          const t = await u.getIdTokenResult(false);
          const rank = String(t.claims?.rank || "invitado").toLowerCase();
          console.log("[panelderoles] intento", attempt, "rank =", rank);
          if (rank === "admin") return {ok:true, rank};
        } catch (e) {
          console.warn("[panelderoles] error claims intento", attempt, e);
        }
        await new Promise(r=>setTimeout(r, 300));
      }
      return {ok:false, reason:"timeout"};
    }

    async function mountShell(){
      // Monta el shell SOLO cuando ya sabemos que eres admin
      await import("../assets/bw/shell.js");
      // Envu√©lvelo con el tag real si tu shell necesita el custom element expl√≠cito
      // Aqu√≠ usamos el contenido ya presente; el shell deber√≠a ‚Äúenhance‚Äù o montar layout.
    }

    async function bootstrap(){
      // Mostrar estado inicial
      bootMsg.textContent = "Verificando rol‚Ä¶";

      // 1) Espera admin
      const u = auth.currentUser;
      if (!u) { go("login.html"); return; }

      const res = await waitForAdmin(4000);
      if (!res.ok) {
        bootMsg.textContent = "Acceso restringido: se requiere rol ADMIN.";
        await new Promise(r=>setTimeout(r, 800));
        go("index.html");
        return;
      }

      // 2) Montar shell ahora que el claim es correcto
      bootMsg.textContent = "Cargando interfaz‚Ä¶";
      await mountShell();

      // 3) Pintar datos y mostrar contenido
      const t = await u.getIdTokenResult(false);
      const rank = String(t.claims?.rank || "invitado").toLowerCase();
      meEmail.textContent = u.email || "(sin email)";
      meUid.textContent   = u.uid;
      meRank.textContent  = rank;
      meRank.style.background = badgeColor(rank);

      content.style.display = "";
      bootMsg.textContent = "Acceso concedido ‚úÖ";

      // 4) Finalmente, muestra la p√°gina sin flicker
      document.documentElement.style.visibility = "visible";
    }

    // --------- Utilidades ----------
    btnCopyUid?.addEventListener("click", async ()=>{
      try { await navigator.clipboard.writeText(meUid.textContent); meMsg.textContent = "UID copiado ‚úÖ"; }
      catch { meMsg.textContent = "No se pudo copiar el UID"; }
      setTimeout(()=>meMsg.textContent="", 1500);
    });

    btnRefresh?.addEventListener("click", async ()=>{
      try {
        const u = auth.currentUser;
        await reload(u);
        await u.getIdToken(true);
        const t = await u.getIdTokenResult(false);
        const rank = String(t.claims?.rank || "invitado").toLowerCase();
        meRank.textContent = rank;
        meRank.style.background = badgeColor(rank);
        meMsg.textContent = "Claims actualizados ‚úÖ (rol: " + rank + ")";
      } catch(e){
        meMsg.textContent = "No se pudieron refrescar los claims";
        console.warn(e);
      }
      setTimeout(()=>meMsg.textContent="", 2500);
    });

    btnLogout?.addEventListener("click", async ()=>{
      try { await auth.signOut(); }
      finally { go("login.html"); }
    });

    // --------- Callable: asignar rol ----------
    btnAssign?.addEventListener("click", async ()=>{
      assignMsg.textContent = "";
      const id   = (targetId.value || "").trim();
      const role = (targetRole.value || "").trim().toLowerCase();

      if (!id){ assignMsg.textContent = "Ingresa un UID o un email."; return; }
      if (!["admin","supervisor","tl","invitado"].includes(role)){
        assignMsg.textContent = "Rol inv√°lido."; return; }

      try{
        const callable = httpsCallable(fn, "admin-setUserRank");
        const resp = await callable({ id, role });
        assignMsg.textContent = `OK ‚úÖ ${resp?.data?.message || "Rol actualizado"}`;
      }catch(err){
        console.warn(err);
        if (String(err)?.includes("function not found")){
          assignMsg.textContent = "La Function admin-setUserRank no est√° desplegada.";
        } else if (err?.code === "permission-denied"){
          assignMsg.textContent = "No autorizado para ejecutar la Function.";
        } else {
          assignMsg.textContent = err?.message || "Error llamando a la Function.";
        }
      }
    });

    // --------- Arranque ----------
    bootstrap();
  </script>
</body>
</html>
